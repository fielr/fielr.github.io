const e=Array.from({length:100});function t(t,...n){e.shift(),e.push({level:t,message:n.map(e=>{if(typeof e==`string`)return e;if(e instanceof Error)return e.stack;try{return JSON.stringify(e)}catch{return e?.toString()}}).join(`, `)})}function n(...e){console.debug(`WCE`,`${globalThis.FBC_VERSION}:`,...e),t(`debug`,...e)}function r(...e){console.info(`WCE`,`${globalThis.FBC_VERSION}:`,...e),t(`info`,...e)}function i(...e){console.warn(`WCE`,`${globalThis.FBC_VERSION}:`,...e),t(`warn`,...e)}function a(...e){console.error(`WCE`,`${globalThis.FBC_VERSION}:`,...e),t(`error`,...e)}function o(e){return new Promise(t=>window.setTimeout(t,e))}async function s(e,t=()=>!1){for(;!e();){if(t())return!1;await o(10)}return!0}function c(e){return typeof e==`string`}function l(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function u(e){return l(e)&&typeof e.Type==`string`&&typeof e.Content==`string`}function d(e){return l(e)&&typeof e.IsPlayer==`function`}function f(e){return c(e)||Array.isArray(e)&&e.every(c)}function p(e){return Array.isArray(e)&&e.every(e=>h(e)||e===null)}function m(e){return l(e)&&typeof e.Name==`string`&&typeof e.Group==`string`}function h(e){return Array.isArray(e)&&e.every(m)}function g(e,t=-(2**53-1)){return e??t}function _(e){return structuredClone(e)}function v(e){return l(e)?Object.entries(e):[]}function y(e){if(e===null)return null;try{return JSON.parse(e)}catch(e){return a(`parsing JSON`,e),null}}function b(e,t,n,r,i,a){let o=window.MainCanvas.getContext(`2d`);if(!o)throw Error(`could not get canvas 2d context`);let s=o.textAlign;o.textAlign=`left`,DrawTextFit(e,t,n,r,i,a),o.textAlign=s}function x(e,t,n,r,i){let a=window.MainCanvas.getContext(`2d`);if(!a)throw Error(`could not get canvas 2d context`);let o=a.textAlign;a.textAlign=i,DrawRect(e,t,n,65,`#FFFF88`),DrawEmptyRect(e,t,n,65,`black`,2),DrawTextFit(r,i===`left`?e+3:e+n/2,t+33,n-6,`black`),a.textAlign=o}function S(e){let t=document.createElement(`div`);t.setAttribute(`class`,`ChatMessage bce-notification`),t.setAttribute(`data-time`,ChatRoomCurrentTime()),t.setAttribute(`data-sender`,Player.MemberNumber?.toString()),typeof e==`string`?t.appendChild(document.createTextNode(e)):Array.isArray(e)?t.append(...e):t.appendChild(e),ChatRoomAppendChat(t)}async function C(e,t=5e3,n={}){await s(()=>!!Player&&new Date(ServerBeep?.Timer||0)<new Date),ServerBeep={Timer:Date.now()+t,Message:e,...n}}function w(e){ServerSend(`ChatRoomChat`,{Content:`Beep`,Type:`Action`,Dictionary:[{Tag:`Beep`,Text:`msg`},{Tag:`发送私聊`,Text:`msg`},{Tag:`Biep`,Text:`msg`},{Tag:`Sonner`,Text:`msg`},{Tag:`msg`,Text:e}]})}function T(e){let t=!1,n=Player.Appearance.find(e=>e.Asset.Group.Name===`Pronouns`);return n?(n.Property?n.Property.Effect?n.Property.Effect.includes(e)||(n.Property.Effect.push(e),t=!0):(n.Property.Effect=[e],t=!0):(n.Property={Effect:[e]},t=!0),t&&ServerPlayerIsInChatRoom()&&ChatRoomCharacterUpdate(Player),t):(i(`Could not find pronouns asset.`),t)}function D(e){let t=Player.Appearance.find(e=>e.Asset.Group.Name===`Pronouns`),n=!1;return t?.Property?.Effect?.includes(e)&&(t.Property.Effect=t.Property.Effect.filter(t=>t!==e),n=!0),n&&ServerPlayerIsInChatRoom()&&ChatRoomCharacterUpdate(Player),n}function O(){T(`Leash`)}function k(){D(`Leash`)}const A=`6.3.9`,j=63.9,M=[`R113`,`R114`],N=`WCE v6.3.9
* BC R114 compatibility and other fixes
* improved extended wardrobe safety (let's you choose when to overwrite data)
* new imporved build system

WCE v6.3
* configure layer hiding in layering menus

WCE v6.2
* WCE 6.2 is a fork of the old FBC 5.8 and tries to bring all it's amazing features back
* new Anti Garble system, layering improvements, local wardrobe and other fixes and improvements
* please recheck your WCE settings, because many things have changed
`,ee=`https://wce-docs.vercel.app`,P=`bce-colors`,te=`https://github.com/KittenApps/WCE/blob/main/LICENSE`,F=99.6,I=`BCEMsg`,ne=`bce-dark-input`,L=24,R=96,re=R*4,z=`Hidden`,B=Object.freeze({Activity:`Activity`,ArousalSync:`ArousalSync`,Hello:`Hello`}),ie=`bce-whisper-input`,ae=[],oe=[],V={Top:11,OverrideBehaviour:10,ModifyBehaviourHigh:6,ModifyBehaviourMedium:5,ModifyBehaviourLow:4,AddBehaviour:3,Observe:0},H=bcModSdk.registerMod({name:`WCE`,version:A,fullName:`Wholesome Club Extensions`,repository:`https://github.com/KittenApps/WCE.git`},{allowReplace:!1});function U(e,t,n){ae.includes(e)&&M.includes(GameVersion)&&(i(`Attempted patching of ${e} despite detected deviation. Impact may be: ${n}\n\nSee /wcedebug in a chatroom for more information or copy(await fbcDebug()) in console.`),oe.push(n)),H.patchFunction(e,t)}const se=[];function W(e,t){return se.some(e=>e[1]===t)?null:(se.push([e,t]),ServerSocket.on(e,t))}function ce(){H.hookFunction(`ServerInit`,V.AddBehaviour,(e,t)=>{let n=t(e);for(let[e,t]of se)ServerSocket.on(e,t);return n})}let G=null;async function le(){await s(()=>!!window.bcx),G=window.bcx?.getModApi(`WCE`)??null}function K(e,t={}){let n=Object.freeze({CN:{"Automatic Arousal Expressions (Replaces Vanilla)":`自动欲望表情 (替换原版)`,"Activity Expressions":`活动表示`,"Alternate Arousal (Replaces Vanilla, requires hybrid/locked arousal meter)":`另一种欲望 (替换原版, 需要混合或锁定欲望条)`,"Alternative speech stutter":`另一种言语不清`,"Extended wardrobe slots (96)":`扩展衣柜保存槽 (96个)`,"Replace wardrobe list with character previews":`使用角色预览替换衣柜保存列表`,"Clear Drawing Cache Hourly":`每小时清除绘图缓存`,"Instant messenger":`即时通讯`,"Chat Links and Embeds":`聊天链接和嵌入`,"Use Ctrl+Enter to OOC":`使用Ctrl+Enter进行OOC发言`,"Use italics for input when whispering":`悄悄话使用斜体字`,"Improve colors for readability":`改善颜色以提高可读性`,"Show friend presence notifications":`显示好友在线通知`,"Understand All Gagged and when Deafened":`在被堵住嘴和被堵住耳朵时可以听懂所有发言`,"Reveal Lockpicking Order Based on Skill":`根据技能显示撬锁/开锁顺序`,"Allow layering menus while bound":`允许在捆绑时用分层菜单`,"Limited gag anti-cheat: cloth-gag equivalent garbling":`有限的堵嘴反作弊: 和布堵嘴相同的乱码`,"Full gag anti-cheat: use equipped gags to determine garbling":`完整的堵嘴反作弊: 使用当前装备的堵嘴来确定乱码`,"Extra gag anti-cheat: even more garbling for the most extreme gags":`扩展的堵嘴反作弊: 对于使用最极端的堵嘴更加混乱`,"Require glasses to see":`需要眼镜才能看清`,"Automatic Relogin on Disconnect":`断线后自动重连`,"Show gag cheat and anti-cheat options in chat":`在聊天室里显示堵嘴作弊和反作弊选项`,"Automatically ghost+blocklist unnaturally new users":`自动对不自然的用户无视并添加黑名单`,"Confirm leaving the game":`离开游戏前需要确认`,"Discreet mode (disable drawing)":`谨慎模式 (禁用绘图)`,"Make automatic progress while struggling":`在挣扎时自动增加进度`,"Allow leashing without wearing a leashable item (requires leasher to have WCE too)":`允许在不佩戴牵引绳的情况下也可以进行牵引（需要牵引者也安装有WCE）`,"Enable buttplug.io (requires refresh)":`启用buttplug.io（需要刷新网页)`,"This page allows configuration of the synchronization of bluetooth connected toys.":`此页面允许配置将BC震动器状态同步到蓝牙连接的玩具`,"Save & browse seen profiles (requires refresh)":`保存并浏览已知的个人资料 (需要刷新)`,"Chat & Social":`聊天 & 社交`,"Activities & Arousal":`活动 & 欲望`,"Appearance & Wardrobe":`外观 & 衣柜`,"Immersion & Anti-Cheat":`沉浸体验 & 反作弊`,Performance:`表现`,Misc:`杂项`,Cheats:`作弊`,ah:`啊`,aah:`啊❤`,mnm:`唔姆`,nn:`嗯啊`,mnh:`嗯哈`,mngh:`唔啊`,haa:`哈啊`,nng:`嗯嗯❤`,mnng:`唔啊❤`,"FBC Developer":`FBC 开发者`,"WCE Developer":`WCE 开发者`,Incompatibility:`不兼容`,"Show recent WCE changelog":`显示最近的WCE更新日志`,"Include binds?":`包括束缚？`,"Include locks?":`包括锁？`,"Include height, body type, hair, etc?":`包括身高，体型，头发等？`,"Copy the looks string below":`复制下面的外观字符串`,"Paste your looks here":`在这里粘贴你的外观`,"No looks string provided":`没有提供外观字符串`,"Applied looks":`应用外观`,"Could not parse looks":`无法解析外观`,"[membernumber] [message]: beep someone":`[用户编号] [消息]: 发送beep`,"Wholesome Club Extensions (WCE) Settings":`Wholesome Club Extensions (WCE)设置`,"Join Discord":`加入Discord`,License:`授权`,Information:`信息`,"Still connecting or connection failed...":`正在连接或连接失败...`,Scan:`搜索`,"Device Name":`设备名称`,"Synchronized Slot":`同步栏位`,"Click on a setting to see its description":`点击设置以查看其描述`,"WCE Settings":`WCE设置`,"Saved Logins (WCE)":`已保存的登录 (WCE)`,"Save (WCE)":`保存 (WCE)`,"Reconnected!":`重新连接！`,ERROR:`错误`,"Reset all expressions":`重置所有表情`,"['list' or name of emote]: run an animation":`['list' 或 表情名称]: 运行一个动画`,"['list' or list of poses]: set your pose":`['list' 或 姿势列表]: 设置你的姿势`,"Load without body parts":`加载时不包括身体部位`,"Exclude body parts":`排除身体部位`,Gagging:`堵嘴`,"Antigarble anti-cheat strength":`反堵嘴反作弊强度`,"Understand: Yes":`理解: 是`,"Understand gagspeak: No":`理解堵嘴说话: 否`,"Understand gagspeak: Yes":`理解堵嘴说话: 是`,"Having recovered your glasses you can see again!":`找回了你的眼镜，你可以看见了！`,"Having lost your glasses your eyesight is impaired!":`失去了你的眼镜，你的视力受损了！`,"([WCE] Force them to become a Club Slave.)":`([WCE] 强制他们成为俱乐部奴隶。)`,"(She will become a Club Slave for the next hour.)":`(她将成为俱乐部奴隶，持续一个小时。)`,"Search for a friend":`搜索好友`,"Sending beeps is currently restricted by BCX rules":`发送beep目前受到BCX规则的限制`,Online:`在线`,Offline:`离线`,"Instant Messenger (Disabled by BCX)":`即时通讯器 (被BCX禁用)`,"Instant Messenger":`即时通讯器`,"WCE Changelog":`WCE更新日志`,"Trust this session":`信任此会话`,"(embed)":`(嵌入)`,"(This origin is trusted by authors of WCE)":`(此来源已被WCE作者信任)`,"Deny for session":`拒绝此会话`,"Allow for session":`允许此会话`,OnlineChat:`在线聊天`,"Scans for connected buttplug.io toys":`扫描已连接的buttplug.io玩具`,"buttplug.io is not connected":`buttplug.io未连接`,"Scanning stopped":`扫描停止`,"Scanning for toys":`扫描玩具`,"Last seen: ":`最后在线: `,"No profile found":`未找到个人资料`,Open:`打开`,"Saved Profiles":`已保存的个人资料`,"Personal notes (only you can read these):":`个人笔记 (只有你可以读到):`,"[WCE] Notes":`[WCE] 笔记`,"Toggle Editing Mode":`切换编辑模式`,"Paste the craft here":`在这里粘贴制作物品`,"Copy the craft here":`在这里复制制作物品`,Import:`导入`,Export:`导出`,"Description:":`描述:`,"Animation Engine":`动画引擎`,"Show numeric arousal meter":`显示欲望条数值`,"Show friends going offline too":`显示朋友离线通知`,"Show friend presence notifications in chat, when possible":`在聊天室里显示好友在线通知`,"Show sent messages while waiting for server":`在等待服务器时显示已发送的消息`,"Show whisper button on chat messages (requires refresh)":`在聊天消息上显示悄悄话按钮 （需要刷新网页)`,"Rich online profile":`丰富的在线个人资料`,"Allow IMs to bypass BCX beep restrictions":`允许即时通讯绕过BCX beep限制`,"Hide the hidden items icon":`不显示隐藏的物品图标`,"Enable anti-cheat":`启用反作弊`,"Blacklist detected cheaters automatically":`自动将检测到的作弊者加入黑名单`,"Enable uwall anti-cheat":`启用uwall反作弊`,"Prompt before loading content from a 3rd party domain":`在加载第三方域名的内容前提示`,"Share Addons":`分享插件设置`,"Buttplug Devices":`Buttplug设备`}}),r=n[TranslationLanguage]?.[e]??e;for(let[e,n]of Object.entries(t))for(;r.includes(e);)r=r.replace(e,n);return r}async function ue(){if(G?.getRuleState(`block_club_slave_work`)?.isEnforced){w(K(`BCX rules forbid $PlayerName from becoming a Club Slave.`,{$PlayerName:CharacterNickname(Player)}));return}if(w(K(`$PlayerName gets grabbed by two maids and escorted to management to serve as a Club Slave.`,{$PlayerName:CharacterNickname(Player)})),!ChatRoomData){a(`ChatRoomData is null in bceStartClubSlave. Was it called outside a chat room?`);return}let e=ChatRoomData.Name;if(ChatRoomLeave(!1),ChatRoomLeashPlayer=null,CommonSetScreen(`Room`,`Management`),await s(()=>!!ManagementMistress),!ManagementMistress)throw Error(`ManagementMistress is missing`);PoseSetActive(Player,`Kneel`,!1),ManagementMistress.Stage=`320`,ManagementMistress.CurrentDialog=K(`(You get grabbed by a pair of maids and brought to management.) Your owner wants you to be a Club Slave. Now strip.`),CharacterSetCurrent(ManagementMistress),await s(()=>CurrentScreen!==`Management`||!CurrentCharacter),de(e)}function de(e){ChatRoomJoinLeash=e,DialogLeave(),CurrentScreen===`ChatRoom`&&ChatRoomLeave(!1),e?ChatRoomStart(`X`,``,null,null,`Introduction`,BackgroundsTagList):(ChatRoomSetLastChatRoom(null),CommonSetScreen(`Room`,`MainHall`))}async function fe(){async function e(){await s(()=>!!CommonCSVCache[`Screens/Online/ChatRoom/Dialog_Online.csv`]&&CommonCSVCache[`Screens/Online/ChatRoom/Dialog_Online.csv`].length>150);let e=[[`160`,`100`,K(`([WCE] Force them to become a Club Slave.)`),K(`(She will become a Club Slave for the next hour.)`),`bceSendToClubSlavery()`,`bceCanSendToClubSlavery()`],[`160`,`160`,K(`([WCE] Force them to become a Club Slave.)`),K(`(Requires both to use compatible versions of WCE and the target to not already be a club slave.)`),``,`!bceCanSendToClubSlavery()`]],t=CommonCSVCache[`Screens/Online/ChatRoom/Dialog_Online.csv`].findIndex(e=>e[0]===`160`)+1;CommonCSVCache[`Screens/Online/ChatRoom/Dialog_Online.csv`].splice(t,0,...e);function n(n){!n.Dialog||n.Dialog.some(e=>e.FBC)||n.Dialog.splice(t,0,...e.map(e=>({Stage:e[0],NextStage:e[1],Option:e[2],Result:e[3],Function:e[4]===``?null:`ChatRoom${e[4]}`,Prerequisite:e[5],Group:null,Trait:null,FBC:!0})))}for(let e of ChatRoomCharacter.filter(e=>!e.IsPlayer()&&e.IsOnline()))n(e);H.hookFunction(`CharacterBuildDialog`,V.AddBehaviour,([e,t,r,i],a)=>{let o=a([e,t,r,!1]);return d(e)&&e.IsOnline()&&n(e),i&&DialogMenuMode===`dialog`&&DialogMenuMapping.dialog.Reload(null,null,{reset:!0}),o})}let t=e();function n(){let e={Type:z,Content:I,Sender:Player.MemberNumber,Dictionary:[{message:{type:B.Activity,version:A,activity:`ClubSlavery`}}]};ServerSend(`ChatRoomChat`,e),DialogLeave()}function r(){let e=CurrentCharacter;return e?e.BCECapabilities?.includes(`clubslave`)&&!e.Appearance.some(e=>e.Asset.Name===`ClubSlaveCollar`):!1}globalThis.bceGotoRoom=de,globalThis.ChatRoombceSendToClubSlavery=n,globalThis.ChatRoombceCanSendToClubSlavery=r,await t}function q(e=null,t=!1){if(!ze()||!ServerIsConnected||!ServerPlayerIsInChatRoom())return;let n=[`clubslave`,`layeringHide`];Z.preventLayeringByOthers&&n.push(`preventLayeringByOthers`);let r={Type:z,Content:I,Sender:Player.MemberNumber,Dictionary:[]},i={message:{type:B.Hello,version:A,alternateArousal:!!Z.alternateArousal,replyRequested:t,capabilities:n}};e&&(r.Target=e),Z.alternateArousal&&(i.message.progress=Player.BCEArousalProgress||Player.ArousalSettings?.Progress||0,i.message.enjoyment=Player.BCEEnjoyment||1),Z.shareAddons&&(i.message.otherAddons=bcModSdk.getModsInfo()),r.Dictionary.push(i),ServerSend(`ChatRoomChat`,r)}async function pe(){await s(()=>ServerSocket&&ServerIsConnected);function e(e){let t={};if(Array.isArray(e.Dictionary)){let n=e.Dictionary;t=n?.find(e=>e.message)?.message||t}else{let n=e.Dictionary;t=n?.message||t}return t}function t(e,a,o=!1){if(n(`Processing BCE message`,e,a,o?`(deferred)`:``),!e?.ArousalSettings&&!o){i(`No arousal settings found for`,e,`; deferring execution to microtask.`),queueMicrotask(()=>t(e,a,!0));return}switch(e?.ArousalSettings||i(`No arousal settings found for`,e),a.type){case B.Hello:r(e,a);break;case B.ArousalSync:e.BCEArousal=a.alternateArousal||!1,e.BCEArousalProgress=a.progress||0,e.BCEEnjoyment=a.enjoyment||1;break;case B.Activity:e.MemberNumber===Player.Ownership?.MemberNumber&&!Player.Appearance.some(e=>e.Asset.Name===`ClubSlaveCollar`)&&ue();break}}function r(e,t){e.FBC=t.version??`0.0`,e.BCEArousal=t.alternateArousal||!1,e.BCEArousalProgress=t.progress||e.ArousalSettings?.Progress||0,e.BCEEnjoyment=t.enjoyment||1,e.BCECapabilities=t.capabilities??[],t.replyRequested&&q(e.MemberNumber),e.FBCOtherAddons=t.otherAddons}W(`ChatRoomMessage`,n=>{if(n.Type===z&&n.Content===`BCEMsg`){let r=Character.find(e=>e.MemberNumber===n.Sender);if(!r)return;let i=e(n);t(r,i)}}),W(`ChatRoomSyncMemberJoin`,e=>{e.SourceMemberNumber!==Player.MemberNumber&&q(e.SourceMemberNumber)}),W(`ChatRoomSync`,()=>{q()})}const me=[];function J(e,t){return me.push({cb:e,intval:t,lastTime:performance.now()}),()=>{me.splice(me.findIndex(t=>t.cb===e),1)}}H.hookFunction(`GameRun`,V.Top,(e,t)=>{if(document.hidden)return t(e);let n=performance.now();return me.forEach(e=>{n-e.lastTime>e.intval&&(e.lastTime=n,e.cb())}),t(e)}),H.hookFunction(`GameRunBackground`,V.Top,(e,t)=>{if(!document.hidden)return t(e);let n=performance.now();return me.forEach(e=>{n-e.lastTime>e.intval&&(e.lastTime=n,e.cb())}),t(e)});function he(e,t){H.callOriginal(`ServerAccountBeep`,[{MemberNumber:Player.MemberNumber||-1,BeepType:``,MemberName:`WCE`,ChatRoomName:e,Private:!0,Message:t,ChatRoomSpace:``}])}const Y={deviceSettings:new Map};async function ge(){if(!Z.toySync)return;let{ButtplugClient:e,ButtplugBrowserWebsocketClientConnector:t}=await import(`./buttplug.js`);r(`Loaded Buttplug.io`);let o=new e(`WCE Toy Sync`);o.addListener(`deviceadded`,e=>{n(`Device connected`,e),S(K(`Vibrator connected: $DeviceName`,{$DeviceName:e.name}));let t=Y.deviceSettings.get(e.name);t&&delete t.LastIntensity}),o.addListener(`deviceremoved`,e=>{n(`Device disconnected`,e),S(K(`Vibrator disconnected: $DeviceName`,{$DeviceName:e.name}))}),o.addListener(`scanningfinished`,e=>{n(`Scanning finished`,e)});let s=new t(Z.toySyncAddress||`ws://127.0.0.1:12345`);try{await o.connect(s),r(`Connected buttplug.io`)}catch(e){FUSAM.modals.openAsync({prompt:K(`buttplug.io is enabled, but server could not be contacted at $toySyncAddress. Is Intiface Desktop running? Is another client connected to it?`,{$toySyncAddress:Z.toySyncAddress}),buttons:{submit:`OK`}}),a(`buttplug.io could not connect to server`,e);return}Y.client=o;let c=J(()=>{if(!o.connected){c();return}for(let e of o.devices.filter(e=>e.vibrateAttributes.length>0)){let t=Y.deviceSettings?.get(e.name);if(!t)continue;let r=t.SlotName,a=Player.Appearance.find(e=>e.Asset.Group.Name===r)?.Property?.Intensity;if(t.LastIntensity===a)continue;if(t.LastIntensity=a,typeof a!=`number`||a<0)e.vibrate(0);else switch(a){case 0:e.vibrate(.1),n(e.name,r,`intensity 0.1`);break;case 1:e.vibrate(.4),n(e.name,r,`intensity 0.4`);break;case 2:e.vibrate(.75),n(e.name,r,`intensity 0.75`);break;case 3:e.vibrate(1),n(e.name,r,`intensity 1`);break;default:i(`Invalid intensity in `,r,`:`,a);break}}},3e3);CommandCombine([{Tag:`toybatteries`,Description:K(`Shows the battery status of all connected buttplug.io toys`),Action:()=>{if(!o.connected){S(`buttplug.io is not connected`);return}let e=o.devices.filter(e=>e.hasBattery);if(e.length===0){S(`No battery devices connected`);return}Promise.all(e.map(e=>e.battery())).then(t=>{for(let n=0;n<e.length;n++){let r=t[n]*100;S(`${e[n].name}: ${r}%`)}})}},{Tag:`toyscan`,Description:K(`Scans for connected buttplug.io toys`),Action:()=>{if(!o.connected){S(K(`buttplug.io is not connected`));return}if(o.isScanning){o.stopScanning(),S(K(`Scanning stopped`));return}o.startScanning(),S(K(`Scanning for toys`))}}]),await o.startScanning()}let _e,ve=!1;async function ye(e){let{Dexie:t}=await import(`./dexie.js`),n=new t(`wce-local-wardrobe`);n.version(1).stores({wardrobe:`id, appearance`}),_e=n.table(`wardrobe`);let r=await _e.toArray()||[];await s(()=>e.length===R),e.push(...r.map(e=>xe(e.appearance)))}async function be(e){await _e.bulkPut(e.map((e,t)=>({id:t,appearance:e})))}function xe(e){return Array.isArray(e)?e.map(e=>{if(typeof e.Property?.Type==`string`&&!CommonIsObject(e.Property?.TypeRecord)){let t=AssetGet(`Female3DCG`,e.Group,e.Name);t&&(e.Property.TypeRecord=ExtendedItemTypeToRecord(t,e.Property.Type))}return e}):e}async function Se(e,t){if(!Z.extendedWardrobe)return e;if(Player.OnlineSettings?.BCEWardrobe){let e=`Old OnlineSettings extended wardrobe data detected. Do you want to migrate them?`,t={submit:`Yes`,ignore:`Ignore (keep old, ask later)`,delete:`No (delete old)`};Player.ExtensionSettings.FBCWardrobe&&(e+=` WARNING: This will override your already existing wardrobe data (in the new format) and may lead to data loss!`,t.submit=`Yes (override)`);let[n]=await FUSAM.modals.openAsync({prompt:e,buttons:t});n===`submit`?(Player.ExtensionSettings.FBCWardrobe=Player.OnlineSettings.BCEWardrobe,ServerPlayerExtensionSettingsSync(`FBCWardrobe`),r(`Migrated wardrobe from OnlineSettings to ExtensionSettings`),delete Player.OnlineSettings.BCEWardrobe):n===`delete`&&(r(`deleted old wardrobe in OnlineSettings`),delete Player.OnlineSettings.BCEWardrobe)}let n=Player.ExtensionSettings.FBCWardrobe;if(WardrobeSize=R,WardrobeFixLength(),!n){let n=`Looks like you are enabling the extended wardrobe for the first time on this character. Proceeding will create a new empty extended wardrobe for the current character. If you expect an already existing extended wardrobe for this character to be imported from a different device: choose Cancel instead.`,r=`No extended wardrobe data found. Do you want to create a new empty extended wardrobe? WARNING: This will lead to permanent data loss of your extended wardrobe. In case of a temporary server issue you should choose Cancel here (extended wardrobe slots will not be persistent until after a reload extended wardrobe is available again or an empty one is created).`,[i]=await FUSAM.modals.openAsync({prompt:t?r:n,buttons:{cancel:`Cancel`,submit:`OK`}});return i===`submit`&&(ve=!0),e}try{let t=y(LZString.decompressFromUTF16(n));if(p(t)){for(let n=L;n<R;n++){let r=n-L;if(r>=t.length)break;e[n]=xe(t[r])}ve=!0}}catch(e){a(`Failed to load extended wardrobe`,e),he(`Wardrobe error`,`Failed to load extended wardrobe.\n\nBackup: ${n}`),r(`Backup wardrobe`,n)}return e}async function Ce(){await s(()=>!!ServerSocket),H.hookFunction(`CharacterCompressWardrobe`,V.Top,([e],t)=>{if(p(e)){let t=e.slice(L,R);if(t.length>0&&ve){Player.ExtensionSettings.FBCWardrobe=LZString.compressToUTF16(JSON.stringify(t));let n=e.slice(R);n.length>0&&be(n),e=e.slice(0,L),ServerPlayerExtensionSettingsSync(`FBCWardrobe`)}}return t([e])}),H.hookFunction(`WardrobeLoadCharacterNames`,V.ModifyBehaviourMedium,(e,t)=>{if(!Z.localWardrobe)return t(e);Player.WardrobeCharacterNames||(Player.WardrobeCharacterNames=[]);let n=!1;for(;Player.WardrobeCharacterNames.length<=WardrobeSize;)Player.WardrobeCharacterNames.length<R?(Player.WardrobeCharacterNames.push(Player.Name),n=!0):Player.WardrobeCharacterNames.push(`Local`);return n&&ServerAccountUpdate.QueueData({WardrobeCharacterNames:Player.WardrobeCharacterNames.slice(0,R)}),null})}const X=new Map;function we(){let e=[`https://fs.kinkop.eu`,`https://i.imgur.com`],t=!1;function n(n,r=null){t||(t=!0,FUSAM.modals.open({prompt:K(`Do you want to allow 3rd party ${r??`content`} to be loaded from $origin? $trusted`,{$origin:n,$trusted:e.includes(n)?K(`(This origin is trusted by authors of WCE)`):``}),callback:e=>{t=!1,e===`submit`?X.set(n,`allowed`):e===`cancel`&&X.set(n,`denied`)},buttons:{cancel:K(`Deny for session`),submit:K(`Allow for session`)}}))}H.hookFunction(`ChatAdminRoomCustomizationProcess`,V.OverrideBehaviour,(e,t)=>{if(!Z.customContentDomainCheck)return t(e);try{let[{ImageURL:r,MusicURL:i}]=e,a=r&&new URL(r).origin,o=i&&new URL(i).origin;if(a&&!X.has(a)?n(a,`image`):o&&!X.has(o)&&n(o,`music`),(!r||X.get(a)===`allowed`)&&(!i||X.get(o)===`allowed`))return t(e)}catch{}return null}),H.hookFunction(`ChatAdminRoomCustomizationClick`,V.Observe,(e,t)=>{for(let e of[ElementValue(`InputImageURL`).trim(),ElementValue(`InputMusicURL`).trim()])try{let t=new URL(e);X.set(t.origin,`allowed`)}catch{}return t(e)})}const Te=`\\uf130\\u005d`,Ee={Image:`img`,None:``,Untrusted:`none-img`};function De(e){try{let t=new URL(e);return[`http:`,`https:`].includes(t.protocol)?t:!1}catch{return!1}}const Oe=[`..`,`--`],ke=[`...`,`~`,`~..`,`~~`,`..~`],Ae=[`ah`,`aah`,`mnn`,`nn`,`mnh`,`mngh`,`haa`,`nng`,`mnng`];function je(e,t){if(!e?.length)return{results:[e],stutter:!1};function n(e){return/^\p{L}/u.test(e)?`${e.substring(0,/[\uD800-\uDFFF]/u.test(e[0])?2:1)}-${e}`:e}let r=Math.max(0,...Player.Appearance.filter(e=>(e.Property?.Intensity??-1)>-1).map(e=>e.Property?.Intensity??0)),i=Player.ArousalSettings?.Progress??0,a=r*5,o=Math.max(0,i-10+a)*.5/100,s=Math.max(0,i/2-20+a*2)*.5/100,c=!1,l=Math.random();for(let i=Math.min(4,Math.max(1,r));i>=1;i--)(l<o/i||i===1&&t&&o>0)&&(e=n(e),c=!0);let u=[e];if(r>0&&Math.random()<s){let e=Oe[Math.floor(Math.random()*Oe.length)],t=Ae[Math.floor(Math.random()*Ae.length)],n=ke[Math.floor(Math.random()*ke.length)];u.push(` `,`${e}${K(t)}${n}`),c=!0}return{results:u,stutter:c}}function Me(e){let t=[`cdn.discordapp.com`,`media.discordapp.com`,`i.imgur.com`,`tenor.com`,`c.tenor.com`,`media.tenor.com`,`i.redd.it`,`puu.sh`,`fs.kinkop.eu`].includes(e.host)||X.get(e.origin)===`allowed`;return/\/[^/]+\.(png|jpe?g|webp|gif)$/iu.test(e.pathname)?t?Ee.Image:Ee.Untrusted:Ee.None}function Ne(e,t){let r=[],i=``;for(let a of e.childNodes){if(a.nodeType!==Node.TEXT_NODE){r.push(a);continue}let o=a.textContent??``,s=[o];i+=o;for(let i=0;i<s.length;i++){let a=s[i].search(/[\s\r\n]/u);if(a>=1)s.splice(i+1,0,s[i].substring(a)),s[i]=s[i].substring(0,a);else if(a===0){s.splice(i+1,0,s[i].substring(1)),[s[i]]=s[i],r.push(document.createTextNode(s[i]));continue}let o=De(s[i].replace(/(^\(+|\)+$)/gu,``));if(o){let i=null,a=document.createElement(`a`);r.push(a);let s=Me(o);switch(s){case Ee.Image:{let e=document.createElement(`img`);e.src=o.href,e.alt=o.href,e.onload=t,e.classList.add(`bce-img`),a.classList.add(`bce-img-link`),i=e}break;default:if(i=document.createTextNode(o.href),s!==Ee.None){let i=document.createElement(`a`);i.onclick=r=>{r.preventDefault(),r.stopPropagation();let i=r.target;FUSAM.modals.open({prompt:K(`Do you want to add $origin to trusted origins?`,{$origin:o.origin}),callback:r=>{if(r===`submit`){X.set(o.origin,`allowed`);let r=i.parentElement;if(!r)throw Error(`clicked promptTrust has no parent`);r.removeChild(i);let a=r.querySelector(`.ChatMessageName`);r.innerHTML=``,a&&(r.appendChild(a),r.appendChild(document.createTextNode(` `)));let s=r.getAttribute(`bce-original-text`);if(!s)throw Error(`clicked promptTrust has no original text`);r.appendChild(document.createTextNode(s)),Ne(e,t),n(`updated trusted origins`,X)}},buttons:{submit:K(`Trust this session`)}})},i.href=`#`,i.title=K(`Trust this session`),i.textContent=K(`(embed)`),r.push(document.createTextNode(` `)),r.push(i)}break}a.href=o.href,a.title=o.href,a.target=`_blank`,a.appendChild(i)}else if(/^#[0-9a-fA-F]{3}([0-9a-fA-F]{3})?$/u.test(s[i])){let e=document.createElement(`span`);e.classList.add(`bce-color`),e.style.background=s[i],r.push(e),r.push(document.createTextNode(s[i]))}else r.push(document.createTextNode(s[i]))}}for(;e.firstChild;)e.removeChild(e.firstChild);for(let t of r)e.appendChild(t);e.setAttribute(`bce-original-text`,i)}function Pe(e){let t=document.createElement(`div`);t.setAttribute(`class`,`ChatMessage bce-notification`),t.setAttribute(`data-time`,ChatRoomCurrentTime()),t.setAttribute(`data-sender`,Player.MemberNumber?.toString()),typeof e==`string`?t.appendChild(document.createTextNode(e)):Array.isArray(e)?t.append(...e):t.appendChild(e),ChatRoomAppendChat(t),Ne(t,()=>{ElementIsScrolledToEnd(`TextAreaChatLog`)&&ElementScrollToEnd(`TextAreaChatLog`)})}function Fe(){H.hookFunction(`ChatRoomKeyDown`,V.ModifyBehaviourMedium,([e],t)=>{let n=document.getElementById(`InputChat`);if(n&&document.activeElement===n){if(e.key===`Enter`&&!e.shiftKey){if(Z.ctrlEnterOoc&&e.ctrlKey&&n.value.trim().length!==0){let e=n.value,t=``;if(!e)return S(`Nothing to send!`),!0;if(e.startsWith(`/w `)){let n=e.split(` `);e=n.slice(2).join(` `),t=`${n.slice(0,2).join(` `)} `}else if(e.startsWith(`/`)&&!e.startsWith(`//`))return S(`Tried to OOC send a command. Use double // to confirm sending to chat.`),!0;n.value=`${t}(${e.replace(/\)/g,Te)}`}return ChatRoomSendChat(),!0}if(e.metaKey&&(e.key===`ArrowUp`||e.key===`ArrowDown`))return ChatRoomScrollHistory(e.key===`ArrowUp`),!0}return t([e])}),H.hookFunction(`ChatRoomMessageDisplay`,V.ModifyBehaviourMedium,([e,t,n,r],i)=>i([e,t.replace(new RegExp(Te,`g`),`)`),n,r])),H.hookFunction(`SpeechTransformProcess`,V.ModifyBehaviourMedium,([t,n,r,i],a)=>{let{msg:o,hasStuttered:s}=e(n||``),c=a([t,o,r.filter(e=>e!==`stutter`||!Z.stutters),i]);return s&&c.effects.push(`stutter`),c});function e(e){let t=[e],n=!0,r=!1,i=[],a=!1;for(let e=0;e<t.length;e++){let o=t[e].search(/[\s\r\n]/u);if(o>=1)t.splice(e+1,0,t[e].substring(o)),t[e]=t[e].substring(0,o);else if(o===0){t.splice(e+1,0,t[e].substring(1)),[t[e]]=t[e],i.push(t[e]);continue}let s=t[e].search(/[()]/u);if(s>0?(t.splice(e+1,0,t[e].substring(s+1)),t.splice(e+1,0,t[e].substring(s,s+1)),t[e]=t[e].substring(0,s)):s===0&&t[e].length>1&&(t.splice(e+1,0,t[e].substring(1)),[t[e]]=t[e]),t[e]===`(`&&(r=!0),De(t[e])&&!r)i.push(`( `),i.push(t[e]),i.push(` )`);else if(Z.stutters&&!r){let{results:r,stutter:o}=je(t[e],n);a||=o,i.push(...r),n=!1}else i.push(t[e]);t[e]===`)`&&(r=!1)}return{msg:i.join(``),hasStuttered:a}}function t(){if(CurrentScreen!==`ChatRoom`||!Z.augmentChat)return;let e=`TextAreaChatLog`,t=`data-bce-handled`,n=document.querySelectorAll(`.ChatMessage:not([${t}=true])`);for(let r of n)if(r.setAttribute(t,`true`),(r.classList.contains(`ChatMessageChat`)||r.classList.contains(`ChatMessageWhisper`))&&!r.classList.contains(`bce-pending`)){let t=ElementIsScrolledToEnd(e);Ne(r,()=>{t&&ElementScrollToEnd(e)}),t&&ElementScrollToEnd(e)}}J(t,500)}let Ie;function Le(){H.hookFunction(`ChatRoomGenerateChatRoomChatMessage`,V.Top,([e,t],n)=>{if(!Z.antiGarble)return n([e,t]);let r=SpeechGetOOCRanges(t).pop();Player.ChatSettings.OOCAutoClose&&typeof r==`object`&&t.charAt(r.start+r.length-1)!==`)`&&r.start+r.length===t.length&&r.length!==1&&(t+=`)`);let i={effects:[],text:t},a;if(e!==`Whisper`||Z.antiGarbleWhisperLevel!==`off`){i=SpeechTransformProcess(Player,t,SpeechTransformSenderEffects);let n=SpeechTransformShouldBabyTalk(Player),r=SpeechTransformGagGarbleIntensity(Player),o=SpeechTransformStutterIntensity(Player);if(r>0||Z[`antiGarble${e}BabyTalk`]===`remove`&&n||Z[`antiGarble${e}Stutter`]===`remove`&&o>0){if(Player.RestrictionSettings?.NoSpeechGarble)a=t;else if(Z[`antiGarble${e}Level`]!==`full`){if(a=t,Z[`antiGarble${e}BabyTalk`]===`preserve`&&n&&(a=SpeechTransformBabyTalk(a)),[`low`,`medium`,`high`].includes(Z[`antiGarble${e}Level`])){let t=Math.min(r,{low:1,medium:3,high:5}[Z[`antiGarble${e}Level`]]);a=SpeechTransformGagGarble(a,t)}Z[`antiGarble${e}Stutter`]===`preserve`&&o>0&&(a=Z.stutters?je(a,!0).results.join(``):SpeechTransformStutter(a,o))}}i.text===a&&(a=void 0)}let o=[{Effects:i.effects,Original:a}];return{Content:i.text,Type:e,Dictionary:o}});let e=Q.antiGarbleChatBabyTalk.options;function t(){if(this.disabled||this.getAttribute(`aria-disabled`)===`true`)return;let t=this.parentElement.classList.contains(`wce-whisper`)?`antiGarbleWhisperBabyTalk`:`antiGarbleChatBabyTalk`,n=e.indexOf(Z[t]);Z[t]=e[(n+1)%e.length],i(this.id)}function n(){if(this.disabled||this.getAttribute(`aria-disabled`)===`true`)return;let t=this.parentElement.classList.contains(`wce-whisper`)?`antiGarbleWhisperStutter`:`antiGarbleChatStutter`,n=e.indexOf(Z[t]);Z[t]=e[(n+1)%e.length],i(this.id)}function r(){let e=this.parentElement.parentElement.classList.contains(`wce-whisper`)?`antiGarbleWhisperLevel`:`antiGarbleChatLevel`;Z[e]=this.value,i()}function i(e){let t={"wce-chat-baby-talk":{state:`antiGarbleChatBabyTalk`,whisperState:`antiGarbleWhisperBabyTalk`},"wce-chat-stutters":{state:`antiGarbleChatStutter`,whisperState:`antiGarbleWhisperStutter`}},n=document.getElementById(`chat-room-buttons`),r=n.classList.contains(`wce-whisper`),i=document.getElementById(`wce-chat-garble`);if(!e){let e=document.getElementById(i?.getAttribute(`aria-describedby`));if(i&&e){let t=r?`antiGarbleWhisperLevel`:`antiGarbleChatLevel`;i.value=Z[t],i.dataset.state=Z[t],e.innerText=`${r?`Whisper`:`Chat`} garble level: ${Z[t]}`}}let a=[`full`,`off`].includes(i?.value),o=e?[[e,t[e]]]:Object.entries(t);for(let[e,{state:t,whisperState:n}]of o){let i=document.getElementById(e),o=document.getElementById(i?.getAttribute(`aria-describedby`));if(i&&o){let s=r?n:t;i.dataset.state=Z[s],o.innerText=`${r?`Whisper`:`Chat`} ${e===`wce-chat-stutters`?`stutters`:`baby talk`}: ${Z[s]}`,i.setAttribute(`aria-disabled`,a)}}}function a(e){let t=document.getElementById(`chat-room-buttons`);t&&(e&&!t.classList.contains(`wce-whisper`)?(t.classList.add(`wce-whisper`),i()):!e&&t.classList.contains(`wce-whisper`)&&(t.classList.remove(`wce-whisper`),i()))}Ie=function(e){let a=e?.querySelector(`#chat-room-buttons`);a&&!a.querySelector(`.wce-chat-room-button`)&&(ElementMenu.PrependItem(a,ElementCreate({tag:`div`,style:{display:`none`},classList:[`wce-chat-room-select-div`,`wce-chat-room-button`],children:[{tag:`label`,attributes:{id:`wce-chat-garble-label`,for:`wce-chat-garble`}},{tag:`select`,attributes:{id:`wce-chat-garble`,"aria-describedby":`wce-chat-garble-tooltip`},classList:[`wce-chat-room-select`],eventListeners:{change:r},children:Q.antiGarbleWhisperLevel.options.map(e=>({tag:`option`,attributes:{value:e},children:[e]}))},{tag:`div`,attributes:{id:`wce-chat-garble-tooltip`,role:`tooltip`},classList:[`button-tooltip`,`button-tooltip-left`],children:[]}]})),ElementMenu.AppendButton(a,ElementButton.Create(`wce-chat-baby-talk`,t,{noStyling:!0},{button:{classList:[`chat-room-button`,`wce-chat-room-button`],style:{display:`none`}}})),ElementMenu.AppendButton(a,ElementButton.Create(`wce-chat-stutters`,n,{noStyling:!0},{button:{classList:[`chat-room-button`,`wce-chat-room-button`],style:{display:`none`}}})),i())};let o=!1;H.hookFunction(`ChatRoomCreateElement`,V.ModifyBehaviourHigh,(e,t)=>{if(!Z.antiGarbleChatOptions)return t(e);if(!o){let e=document.getElementById(`InputChat`),t=document.getElementById(`chat-room-buttons-collapse`);e&&t&&(e.addEventListener(`input`,function(){let e=this.value.startsWith(`/w `)||this.value.startsWith(`/whisper `);a(e)}),t.addEventListener(`click`,t=>{ChatRoomChatInputChangeHandler.call(e,t)}),o=!0)}let n=t(e);return Ie(n),n}),H.hookFunction(`ChatRoomSetTarget`,V.ModifyBehaviourHigh,([e,...t],n)=>{let r=Number.isInteger(e)&&e!==-1;return a(r),n([e,...t])}),ChatRoomRegisterMessageHandler({Description:`show OriginalMsg while deafened`,Priority:90,Callback:(e,t,n,r)=>(e.Type===`Chat`&&Z.antiDeaf&&Player.GetDeafLevel()>0&&!r.OriginalMsg&&(r.OriginalMsg=n),!1)}),CurrentScreen===`ChatRoom`&&ChatRoomResize(!1)}let Z={},Re=!1;const Q={animationEngine:{label:`Animation Engine`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{e&&Player.ArousalSettings&&(Player.ArousalSettings.AffectExpression=!1),e||(Z.expressions=!1,Z.activityExpressions=!1),n(`animationEngine`,e)},category:`activities`,description:`Enables the animation engine. This will replace the game's expression and pose system.`},expressions:{label:`Automatic Arousal Expressions (Replaces Vanilla)`,type:`checkbox`,value:!1,disabled:()=>!Z.animationEngine,sideEffects:e=>{n(`expressions`,e)},category:`activities`,description:`Automatically express arousal when performing an activity (requires Animation Engine).`},activityExpressions:{label:`Activity Expressions`,type:`checkbox`,value:!1,disabled:()=>!Z.animationEngine,sideEffects:e=>{n(`activityExpressions`,e)},category:`activities`,description:`Automatically express reactions to certain activities (requires Animation Engine).`},alternateArousal:{label:`Alternate Arousal (Replaces Vanilla, requires hybrid/locked arousal meter)`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{q(),Player.BCEArousal=!!e,Player.BCEArousalProgress=Math.min(F,Player.ArousalSettings?.Progress??0),n(`alternateArousal`,e)},category:`activities`,description:`More intense activities will affect arousal faster.`},stutters:{label:`Alternative speech stutter`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`stutters`,e)},category:`activities`,description:`More stuttering at high arousal, moans between words with vibrators.`},numericArousalMeter:{label:`Show numeric arousal meter`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`numericArousalMeter`,e)},category:`activities`,description:`Shows the numeric value of arousal meters when expanded.`},layeringHide:{label:`[Beta] Allow configuring layer hiding in layering menu`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`layeringHide`,e)},category:`appearance`,description:`Allows you to configure which lower layers an item should hide or not (changes only visible to other WCE players).`},copyColor:{label:`Enable option to copy color to all item's of the same type`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`copyColor`,e)},category:`appearance`,description:`Enable option to copy color to all item's of the same type.`},extendedWardrobe:{label:`Extended wardrobe slots (96)`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:(e,t)=>{n(`extendedWardrobe`,e),e?Player.Wardrobe?(WardrobeSize=R,Se(Player.Wardrobe,t).then(e=>CharacterCompressWardrobe(e))):i(`Player.Wardrobe not found, skipping wardrobe extension`):(Z.localWardrobe=!1,WardrobeSize=L,WardrobeFixLength(),CharacterAppearanceWardrobeOffset=0)},category:`appearance`,description:`Increase the amount of wardrobe slots to save more outfits.`},localWardrobe:{label:`Local Wardrobe (+288)`,type:`checkbox`,value:!1,disabled:()=>!Z.extendedWardrobe,sideEffects:e=>{n(`localWardrobe`,e),e?Player.Wardrobe?(WardrobeSize=re,ye(Player.Wardrobe),CharacterCompressWardrobe(Player.Wardrobe)):i(`Player.Wardrobe not found, skipping wardrobe extension`):Z.extendedWardrobe&&(WardrobeSize=R,WardrobeFixLength(),CharacterAppearanceWardrobeOffset=0)},category:`appearance`,description:`Enables the Local Wardrobe - save 288 additional outfits on your device (not synced between devices, but shared between alts on the same device).`},privateWardrobe:{label:`Replace wardrobe list with character previews`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`privateWardrobe`,e)},category:`appearance`,description:`Allows you to preview all saved outfits at a glance, no more having to remember names.`},confirmWardrobeSave:{label:`Confirm overriding wardrobe outfits`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`confirmWardrobeSave`,e)},category:`appearance`,description:`When saving over an already existing wardrobe outfit you'll ask for confirmation, preventing accidentally overwriting outfits.`},automateCacheClear:{label:`Clear Drawing Cache Hourly`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`automateCacheClear`,e)},category:`performance`,description:`Automatically clears the drawing cache every hour, preventing memory usage from growing out of control during long play sessions.`},manualCacheClear:{label:`Adds a clear / reload drawing cache button`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`manualCacheClear`,e)},category:`performance`,description:`Adds a button to the chat room menu to clear and reload the drawing cache of all characters, helping to fix buged / non-loaded assets.`},instantMessenger:{label:`Instant messenger`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`instantMessenger`,e)},category:`chat`,description:`Allows you to send messages to other players without having to open the friends list, with enhancements.`},augmentChat:{label:`Chat Links and Embeds`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`augmentChat`,e)},category:`chat`,description:`Adds clickable links and image embeds from trusted domains only (e.g. imgur) to chat messages.`},ctrlEnterOoc:{label:`Use Ctrl+Enter to OOC`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`ctrlEnterOoc`,e)},category:`chat`,description:`Allows you to use Ctrl+Enter to send OOC messages.`},whisperInput:{label:`Use italics for input when whispering`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`whisperInput`,e)},category:`chat`,description:`Changes the input field to italics when you're in whisper mode to make it more obvious.`},chatColors:{label:`Improve colors for readability`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{e?document.body.classList.add(P):document.body.classList.remove(P),n(`chatColors`,e)},category:`chat`,description:`Improves contrast between the colors used for chat messages to comply with web accessibility standards.`},friendPresenceNotifications:{label:`Show friend presence notifications`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`friendPresenceNotifications`,e)},category:`chat`,description:`Enables friend presence tracking and shows a notification when a friend logs in.`},friendOfflineNotifications:{label:`Show friends going offline too`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`friendOfflineNotifications`,e)},category:`chat`,description:`Shows a notification when a friend logs out. (Requires friend presence)`},friendNotificationsInChat:{label:`Show friend presence notifications in chat, when possible`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`friendNotificationsInChat`,e)},category:`chat`,description:`Shows friend presence notifications in chat, when possible. (Requires friend presence)`},pastProfiles:{label:`Save & browse seen profiles (requires refresh)`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`pastProfiles`,e)},category:`chat`,description:`Saves the profiles for everyone you've seen and allows you to browse them using /profiles in chatrooms.`},pendingMessages:{label:`Show sent messages while waiting for server`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`showSentMessages`,e)},category:`chat`,description:`Shows messages you've sent while waiting for the server to respond, confirming you have sent the message and the server is just being slow.`},richOnlineProfile:{label:`Rich online profile`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`richOnlineProfile`,e)},category:`chat`,description:`Changes the online profile to support clickable links and embedded images.`},whisperTargetFixes:{label:`Improved whisper target handling`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`whisperTargetFixes`,e)},category:`chat`,description:`Automatically reset whisper target if they leave the room for more than one minute and after the first invalid whisper target warning message.`},antiGarble:{label:`Anti Garble`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:(e,t)=>{e?t||(Z.antiGarbleChatOptions=!0,Q.antiGarbleChatOptions.sideEffects(!0,t),Z.antiGarbleChatLevel=`none`,Z.antiGarbleChatBabyTalk=`remove`,Z.antiGarbleChatStutter=`ignore`,Z.antiGarbleWhisperLevel=`none`,Z.antiGarbleWhisperBabyTalk=`remove`,Z.antiGarbleWhisperStutter=`ignore`):(Z.antiGarbleChatOptions=!1,Q.antiGarbleChatOptions.sideEffects(!1,t),Z.antiGarbleChatLevel=`full`,Z.antiGarbleChatBabyTalk=`preserve`,Z.antiGarbleChatStutter=`preserve`,Z.antiGarbleWhisperLevel=`full`,Z.antiGarbleWhisperBabyTalk=`preserve`,Z.antiGarbleWhisperStutter=`preserve`),n(`antiGarble`,e)},category:`antigarble`,description:`Enables the anti-garble system. Allowing you to send less garbled version of your messages together with the garbled one to others, who could read it in brackets.`},antiGarbleChatOptions:{label:`Anti Garble chat options`,type:`checkbox`,value:!1,disabled:()=>!Z.antiGarble,sideEffects:(e,t)=>{n(`antiGarbleChatoptions`,e),!t&&e?Ie(document.getElementById(`chat-room-div`)):t||document.querySelectorAll(`.wce-chat-room-button`).forEach(e=>e.remove())},category:`antigarble`,description:`Adds quick options for your anti-garble settings to the chat input menu.`},antiGarbleChatLevel:{label:`Chat garble level:`,type:`select`,value:`none`,options:[`none`,`low`,`medium`,`high`,`full`],tooltips:[`Chat garble level: none (send a fully ungarbled message to the recipient, shown in brackets)`,`Chat garble level: low (send a partly ungarbled message, which is only garbled up to the low garbel level 1)`,`Chat garble level: medium (send a partly ungarbled message, which is only garbled up to the medium garbel level 3)`,`Chat garble level: high (send a partly ungarbled message, which is only garbled up to the high garbel level 5)`,`Chat garble level: full (always only sends the full garbled message, no ungarbled message in brackets)`],disabled:()=>!Z.antiGarble,sideEffects:e=>{n(`antiGarbleChatLevel`,e)},category:`antigarble`,description:`Sends an ungarbled (or lower garbled up to the selected value) chat message together with the garbled messages, which is shown on the recipient side in brackets (defaults to full = no ungarbling).`},antiGarbleChatStutter:{label:`Chat stutters:`,type:`select`,value:`preserve`,options:[`remove`,`ignore`,`preserve`],tooltips:[`Chat stutters: remove (always remove chat stutters, even if it is the only effect)`,`Chat stutters: ignore (remove chat stutters if ungarbling gag speech, but ignore it if it's the only effect)`,`Chat stutters: preserve (always preserve chat stutters in the ungarbled text in brackets)`],disabled:()=>!Z.antiGarble||Z.antiGarbleChatLevel===`full`,sideEffects:e=>{n(`antiGarbleChatoptions`,e)},category:`antigarble`,description:`Controls if stutters in chat messages are always removed, ignored (only removed if other ungarbling applied) or preserved.`},antiGarbleChatBabyTalk:{label:`Chat baby talk:`,type:`select`,value:`preserve`,options:[`remove`,`ignore`,`preserve`],tooltips:[`Chat baby talk: remove (always remove chat baby talk, even if it is the only effect)`,`Chat baby talk: ignore (remove chat baby talk if ungarbling gag speech, but ignore it if it's the only effect)`,`Chat baby talk: preserve (always preserve chat baby talk in the ungarbled text in brackets)`],disabled:()=>!Z.antiGarble||Z.antiGarbleChatLevel===`full`,sideEffects:e=>{n(`antiGarbleChatBabyTalk`,e)},category:`antigarble`,description:`Controls if baby talk in chat messages is always removed, ignored (only removed if other ungarbling applied) or preserved.`},antiGarbleWhisperLevel:{label:`Whisper garble level:`,type:`select`,value:`none`,options:[`none`,`low`,`medium`,`high`,`full`,`off`],tooltips:[`Whisper garble level: none (send a fully ungarbled whisper to the recipient, shown in brackets)`,`Whisper garble level: low (send a partly ungarbled whisper, which is only garbled up to the low garbel level 1)`,`Whisper garble level: medium (send a partly ungarbled whisper, which is only garbled up to the medium garbel level 3)`,`Whisper garble level: high (send a partly ungarbled whisper, which is only garbled up to the high garbel level 5)`,`Whisper garble level: full (always only sends the full garbled whisper, no ungarbled message in brackets)`,`Whisper garble level: off (don't garble whisper messages at all, normal message is ungarbled, no message in brackets)`],disabled:()=>!Z.antiGarble,sideEffects:e=>{n(`antiGarbleWhisperLevel`,e)},category:`antigarble`,description:`Sends an ungarbled (or lower garbled) whisper message together with the garbled messages, which is shown on the recipient side in brackets. (off = only sending the ungarbled messages as the original).`},antiGarbleWhisperStutter:{label:`Whispers stutters:`,type:`select`,value:`preserve`,options:[`remove`,`ignore`,`preserve`],tooltips:[`Whispers stutters: remove (always remove whispers stutters, even if it is the only effect)`,`Whispers stutters: ignore (remove whispers stutters if ungarbling gag speech, but ignore it if it's the only effect)`,`Whispers stutters: preserve (always preserve whispers stutters in the ungarbled text in brackets)`],disabled:()=>!Z.antiGarble||[`off`,`full`].includes(Z.antiGarbleWhisperLevel),sideEffects:e=>{n(`antiGarbleWhisperStutter`,e)},category:`antigarble`,description:`Controls if stutters in whispers are always removed, ignored (only removed if other ungarbling applied) or preserved.`},antiGarbleWhisperBabyTalk:{label:`Whispers baby talk:`,type:`select`,value:`preserve`,options:[`remove`,`ignore`,`preserve`],tooltips:[`Whispers baby talk: remove (always remove whispers baby talk, even if it is the only effect)`,`Whispers baby talk: ignore (remove whispers baby talk if ungarbling gag speech, but ignore it if it's the only effect)`,`Whispers baby talk: preserve (always preserve whispers baby talk in the ungarbled text in brackets)`],disabled:()=>!Z.antiGarble||[`off`,`full`].includes(Z.antiGarbleWhisperLevel),sideEffects:e=>{n(`antiGarbleWhisperBabyTalk`,e)},category:`antigarble`,description:`Controls if baby talk in whispers is always removed, ignored (only removed if other ungarbling applied) or preserved.`},lockpick:{label:`Reveal Lockpicking Order Based on Skill`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`lockpick`,e)},category:`cheats`,description:`Randomly reveals the order of some of the pins with higher lockpicking skill revealing more pins on average. Picking can still be impossible like other forms of struggling.`},allowLayeringWhileBound:{label:`Allow layering menus while bound`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`allowLayeringWhileBound`,e)},category:`cheats`,description:`Allows you to open menus while bound, even if they're disabled in the settings.`},autoStruggle:{label:`Make automatic progress while struggling`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`autoStruggle`,e)},category:`cheats`,description:`All three forms of struggling will be completed automatically in a realistic amount of time, if the restraint is possible to struggle out of.`},allowIMBypassBCX:{label:`Allow IMs to bypass BCX beep restrictions`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`allowIMBypassBCX`,e)},category:`cheats`,description:`This setting is temporary until BCX supports a focus mode rule.`},antiDeaf:{label:`Anti Deafen`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`antiDeaf`,e)},category:`cheats`,description:`Show original messages in brackets while deafened.`},toySync:{label:`Enable buttplug.io (requires refresh)`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`toySync`,e)},category:`buttplug`,description:`Allows the game to control your real vibrators. For a list of supported vibrators see https://buttplug.io`},blindWithoutGlasses:{label:`Require glasses to see`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{e||D(`BlurLight`),n(`blindWithoutGlasses`,e)},category:`immersion`,description:`You will be partially blinded while not wearing glasses.`},leashAlways:{label:`Allow leashing without wearing a leashable item (requires leasher to have WCE too)`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`leashAlways`,e),e?O():k()},category:`immersion`,description:`Allows you to be leashed between rooms even when you are not wearing an item that counts as a leash to allow roleplaying being carried in arms.`},hideHiddenItemsIcon:{label:`Hide the hidden items icon`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`hideHiddenItemsIcon`,e)},category:`immersion`,description:`You can choose to hide items (not on extreme difficulty). The game shows an icon on players that have hidden items. This option hides that icon.`},itemAntiCheat:{label:`Enable anti-cheat`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`itemAntiCheat`,e)},category:`immersion`,description:`Prevents certain console cheats from impacting your character. Whitelisted actors are exempt from this.`},antiCheatBlackList:{label:`Blacklist detected cheaters automatically`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`antiCheatBlackList`,e)},category:`immersion`,description:`Automatically blacklist detected cheaters. Whitelisted actors are exempt from this.`},uwall:{label:`Enable uwall anti-cheat`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`uwall`,e),Player?.OnlineSharedSettings&&typeof e==`boolean`?(Player.OnlineSharedSettings.Uwall=e,ServerAccountUpdate.QueueData({OnlineSharedSettings:Player.OnlineSharedSettings})):i(`Player.OnlineSharedSettings not found, skipping uwall`)},category:`immersion`,description:`Prevents certain other addon cheats from impacting your character.`},preventLayeringByOthers:{label:`Prevents other players from using layering on you`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:(e,t)=>{n(`preventLayeringByOthers`,e),t||q()},category:`immersion`,description:`Prevents other WCE players to make Layering based changes to your character.`},relogin:{label:`Automatic Relogin on Disconnect`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`relogin`,e)},category:`misc`,description:`Automatically re-enter your password after you disconnect from the game. For convenience or AFK. Requires the password for the current account to have been saved in the login screen. Passwords are saved in your browser's local storage in plain text.`},ghostNewUsers:{label:`Automatically ghost+blocklist unnaturally new users`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:e=>{n(`ghostNewUsers`,e)},category:`misc`,description:`Automatically ghost+blocklist unnaturally new users. This is useful for preventing malicious bots, but is not recommended to be enabled normally.`},confirmLeave:{label:`Confirm leaving the game`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`confirmLeave`,e)},category:`misc`,description:`When you leave the game, you will be prompted to confirm your decision. This is useful for preventing accidentally closing the tab, but will cause you to reconnect.`},discreetMode:{label:`Discreet mode (disable drawing)`,type:`checkbox`,value:!1,disabled:()=>!1,sideEffects:(e,t)=>{n(`discreetMode`,e),e?(document.getElementById(`favicon`).href=`data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==`,NotificationTitleUpdate()):t||(NotificationTitleUpdate(),document.getElementById(`favicon`).href=`Icons/Logo.png`)},category:`misc`,description:`Disables drawing on the screen. This is useful for preventing accidental drawing.`},customContentDomainCheck:{label:`Prompt before loading content from a 3rd party domain`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`customContentDomainCheck`,e)},category:`misc`,description:`Show a confirmation prompt before allowing content from a 3rd party domain to be loaded.`},shareAddons:{label:`Share Addons`,type:`checkbox`,value:!0,disabled:()=>!1,sideEffects:e=>{n(`shareAddons`,e)},category:`misc`,description:`Share a list of your installed addons with other WCE users in the room, visible via /versions chat command.`},buttplugDevices:{label:`Buttplug Devices`,type:`input`,value:``,disabled:()=>!1,sideEffects:e=>{if(n(`buttplugDevices`,e),e!==``)try{if(!c(e))throw Error(`expected string for buttplugDevices`);let t=y(e);if(!Array.isArray(t))throw Error(`expected array for devices`);for(let e of t)Y.deviceSettings.set(e.Name,e)}catch(e){a(e)}},category:`hidden`,description:``},toySyncAddress:{label:`Intiface Address`,type:`input`,value:`ws://127.0.0.1:12345`,disabled:()=>!1,sideEffects:e=>{n(`toySyncAddress`,e)},category:`hidden`,description:``}};function ze(){return Re}function Be(){return`bce.settings.${Player?.AccountName}`}async function Ve(){await s(()=>!!Player?.AccountName);let e=Be();if(n(`loading settings`),Object.keys(Z).length===0){let t=y(localStorage.getItem(e)),a=y(LZString.decompressFromBase64(Player.ExtensionSettings.FBC||(Player.OnlineSettings?.BCE??``))||null);a||(i(`No online settings found`),n(`onlineSettings`,Player.OnlineSettings),n(`extensionSettings`,Player.ExtensionSettings)),Player.OnlineSettings?.BCE&&(Player.ExtensionSettings.FBC=Player.OnlineSettings.BCE,ServerPlayerExtensionSettingsSync(`FBC`),r(`Migrated online settings to extension settings`),delete Player.OnlineSettings.BCE);let o=t?.version||0;if(a&&a.version>=o&&(r(`using online settings`),t=a),l(t)||(n(`no settings`,e),he(`Welcome to WCE`,`Welcome to Wholesome Club Extensions v${globalThis.FBC_VERSION}! As this is your first time using WCE on this account, you may want to check out the settings page for some options to customize your experience. You can find it in the game preferences. Enjoy!`),t={}),!l(t))throw Error(`failed to initialize settings`);for(let[e]of Object.entries(Q))if(!(e in t)){if(e===`activityExpressions`&&`expressions`in t){t[e]=t.expressions;continue}t[e]=Q[e].value}(t.version===void 0||t.version<j)&&Ge(),t.version=j,Z=t}}function He(){n(`saving settings`),Y.deviceSettings.size>0&&(Z.buttplugDevices=JSON.stringify(Array.from(Y.deviceSettings.values()))),localStorage.setItem(Be(),JSON.stringify(Z)),Player.ExtensionSettings.FBC=LZString.compressToBase64(JSON.stringify(Z)),ServerPlayerExtensionSettingsSync(`FBC`),n(`saved settings`,Z)}function Ue(e){return e in Q}function We(){n(`handling settings side effects`);for(let[e,t]of Object.entries(Z)){if(e===`version`)continue;if(!Ue(e)){i(`Deleting unknown setting`,e),delete Z[e];continue}Q[e].sideEffects(t,!0)}He(),Re=!0}async function Ge(){await s(()=>!!Player?.AccountName),await o(5e3),he(K(`WCE Changelog`),K(`WCE has received significant updates since you last used it. See /wcechangelog in a chatroom.`)),await s(()=>!!document.getElementById(`TextAreaChatLog`)),Pe(`Wholesome Club Extensions (WCE) changelog:\n${N}`)}function Ke(e){return Ue(e)?Z[e]:!1}function qe(e){switch(e.toLowerCase()){case`r113`:return{ActivityChatRoomArousalSync:`BFF3DED7`,ActivitySetArousal:`3AE28123`,ActivitySetArousalTimer:`1342AFE2`,ActivityTimerProgress:`6CD388A7`,AppearanceClick:`22CDB584`,AppearanceLoad:`4360C485`,AppearanceRun:`08D2AED9`,CharacterAppearanceBuildCanvas:`C05FE035`,CharacterAppearanceMustHide:`9C34DF21`,CharacterAppearanceVisible:`0740043C`,CharacterAppearanceWardrobeLoad:`A5B63A03`,CharacterBuildDialog:`9196D21D`,CharacterCompressWardrobe:`2A05ECD1`,CharacterDelete:`57AA5D48`,CharacterGetCurrent:`69F45A41`,CharacterLoadCanvas:`EAB81BC4`,CharacterLoadOnline:`407FEDDE`,CharacterNickname:`A794EFF5`,CharacterRefresh:`301DA9CF`,CharacterSetCurrent:`9B71AC3E`,CharacterSetFacialExpression:`FAF129E1`,CharacterSetActivePose:`566A14D7`,ChatAdminRoomCustomizationClick:`857766E7`,ChatAdminRoomCustomizationProcess:`AF01C65A`,ChatRoomAppendChat:`12890378`,ChatRoomCharacterUpdate:`DE2DC592`,ChatRoomCharacterViewDraw:`732C91C9`,ChatRoomCharacterViewIsActive:`CD8066FA`,ChatRoomCurrentTime:`A462DD3A`,ChatRoomDrawCharacterStatusIcons:`3D957FC2`,ChatRoomGenerateChatRoomChatMessage:`3BDE0884`,ChatRoomHideElements:`D58ECB5C`,ChatRoomHTMLEntities:`0A7ADB1D`,ChatRoomKeyDown:`A4974D73`,ChatRoomLeave:`BD1A285F`,ChatRoomListManipulation:`75D28A8B`,ChatRoomMapViewCharacterIsVisible:`286C447D`,ChatRoomMapViewCharacterOnWhisperRange:`B0D08E96`,ChatRoomMapViewIsActive:`D181020D`,ChatRoomMenuBuild:`BE8ACFBE`,ChatRoomMenuClick:`BE001739`,ChatRoomMenuDraw:`6DBEC23B`,ChatRoomMessage:`E75ED29B`,ChatRoomRegisterMessageHandler:`C432923A`,ChatRoomSendChat:`ACB10CE5`,ChatRoomStart:`2D8ADD08`,ChatRoomSyncMemberJoin:`2A9CB40B`,CommandCombine:`80F9D4AF`,CommandExecute:`D1DEB2AD`,CommonClick:`918C74F3`,CommonColorIsValid:`390A2CE4`,CommonSetScreen:`85E69EBB`,CraftingClick:`5E7225EA`,CraftingConvertSelectedToItem:`F5211D40`,CraftingRun:`4CD7AB08`,DialogCanUnlock:`A86B2558`,DialogLeave:`A31B5D3E`,DialogMenuButtonBuild:`88CE1D73`,DialogMenuButtonClick:`2CA1256C`,DrawArousalMeter:`BB0755AF`,DrawArousalThermometer:`7ED6D822`,DrawBackNextButton:`7263249E`,DrawButton:`B747DF6E`,DrawCharacter:`B175AF5E`,DrawCheckbox:`00FD87EB`,DrawImageEx:`E01BE7E7`,DrawImageResize:`D205975A`,DrawItemPreview:`6A7A1E2A`,DrawProcess:`7DA972D9`,DrawText:`C1BF0F50`,DrawTextFit:`F9A1B11E`,ElementCreate:`A3E07B07`,ElementCreateInput:`7F1709DA`,ElementCreateTextArea:`4E040819`,ElementIsScrolledToEnd:`1CC4FE11`,ElementPosition:`81836C4E`,ElementScrollToEnd:`1AC45575`,ElementValue:`4F26C62F`,FriendListShowBeep:`5B91D5DA`,GameRun:`337CB358`,GLDrawResetCanvas:`81214642`,InformationSheetRun:`5B5C7751`,InterfaceTextGet:`66603471`,InventoryGet:`E666F671`,"Layering.Load":`8FA7D9CB`,"Layering._ResetClickListener":`5EDCC26F`,LoginClick:`5B9765F8`,LoginDoLogin:`E9145D39`,LoginRun:`181BE041`,LoginStatusReset:`43C3FCD2`,MouseIn:`CA8B839E`,NotificationDrawFavicon:`AB88656B`,NotificationRaise:`E8F29646`,NotificationTitleUpdate:`0E92F3ED`,OnlineGameAllowChange:`3779F42C`,OnlineProfileClick:`521146DF`,OnlineProfileUnload:`A8651F30`,OnlineProfileLoad:`BE8B009B`,OnlineProfileRun:`7F57EF9A`,PoseSetActive:`22C02050`,PreferenceExit:`27E40748`,PreferenceInitPlayer:`B12FA731`,PreferenceSubscreenArousalClick:`84F49886`,PreferenceSubscreenArousalRun:`96A6157B`,PreferenceSubscreenImmersionClick:`0EF82344`,PreferenceSubscreenImmersionRun:`276FA30B`,RelogRun:`843E8F94`,RelogExit:`2DFB2DAD`,ServerAccountBeep:`8782A099`,ServerAppearanceBundle:`4D069622`,ServerAppearanceLoadFromBundle:`946537FD`,ServerConnect:`845E50A6`,ServerDisconnect:`701AC703`,ServerInit:`B6CEF7F1`,ServerOpenFriendList:`FA8D3CDE`,ServerPlayerAppearanceSync:`A014E0B7`,ServerPlayerExtensionSettingsSync:`1776666B`,ServerSend:`ABE74E75`,ServerSendQueueProcess:`BD4277AC`,SkillGetWithRatio:`3EB4BC45`,SpeechTransformBabyTalk:`C812EE0E`,SpeechTransformGagGarble:`691A05BF`,SpeechTransformGagGarbleIntensity:`F61ECBDA`,SpeechTransformProcess:`666DDA2F`,SpeechTransformShouldBabyTalk:`634BCD64`,SpeechTransformStutter:`A930F55E`,SpeechTransformStutterIntensity:`4754768A`,StruggleDexterityProcess:`D185D348`,StruggleFlexibilityCheck:`727CE05B`,StruggleFlexibilityProcess:`1A0B96EF`,StruggleLockPickDraw:`6FE841B9`,StruggleMinigameHandleExpression:`1B3ABF55`,StruggleMinigameStop:`FB05E8A9`,StruggleStrengthProcess:`B1A1457D`,TextGet:`4DDE5794`,TextLoad:`0D535190`,TimerInventoryRemove:`2588CA11`,TimerProcess:`BFB7FFE2`,TitleExit:`F13F533C`,ValidationSanitizeProperties:`843D3952`,WardrobeClick:`33405B1D`,WardrobeExit:`12D14AE4`,WardrobeFastLoad:`AAB9F25B`,WardrobeFastSave:`D1E906FD`,WardrobeFixLength:`CA3334C6`,WardrobeLoad:`C343A4C7`,WardrobeLoadCharacterNames:`F39DF5E3`,WardrobeRun:`633B3570`};default:return{ActivityChatRoomArousalSync:`BFF3DED7`,ActivitySetArousal:`3AE28123`,ActivitySetArousalTimer:`1342AFE2`,ActivityTimerProgress:`6CD388A7`,AppearanceClick:`22CDB584`,AppearanceLoad:`98060059`,AppearanceRun:`08D2AED9`,CharacterAppearanceBuildCanvas:`C05FE035`,CharacterAppearanceMustHide:`9C34DF21`,CharacterAppearanceVisible:`0740043C`,CharacterAppearanceWardrobeLoad:`CDB469AC`,CharacterBuildDialog:`9196D21D`,CharacterCompressWardrobe:`2A05ECD1`,CharacterDelete:`57AA5D48`,CharacterGetCurrent:`69F45A41`,CharacterLoadCanvas:`EAB81BC4`,CharacterLoadOnline:`407FEDDE`,CharacterNickname:`A794EFF5`,CharacterRefresh:`F50CDE75`,CharacterSetCurrent:`9B71AC3E`,CharacterSetFacialExpression:`FAF129E1`,CharacterSetActivePose:`566A14D7`,ChatAdminRoomCustomizationClick:`857766E7`,ChatAdminRoomCustomizationProcess:`AF01C65A`,ChatRoomAppendChat:`12890378`,ChatRoomCharacterUpdate:`DE2DC592`,ChatRoomCharacterViewDraw:`732C91C9`,ChatRoomCharacterViewIsActive:`CD8066FA`,ChatRoomCurrentTime:`A462DD3A`,ChatRoomDrawCharacterStatusIcons:`3D957FC2`,ChatRoomGenerateChatRoomChatMessage:`3BDE0884`,ChatRoomHideElements:`D58ECB5C`,ChatRoomHTMLEntities:`0A7ADB1D`,ChatRoomKeyDown:`A4974D73`,ChatRoomLeave:`BD1A285F`,ChatRoomListManipulation:`75D28A8B`,ChatRoomMapViewCharacterIsVisible:`286C447D`,ChatRoomMapViewCharacterOnWhisperRange:`B0D08E96`,ChatRoomMapViewIsActive:`D181020D`,ChatRoomMenuBuild:`BE8ACFBE`,ChatRoomMenuClick:`8EF164D0`,ChatRoomMenuDraw:`6DBEC23B`,ChatRoomMessage:`E75ED29B`,ChatRoomRegisterMessageHandler:`C432923A`,ChatRoomSendChat:`ACB10CE5`,ChatRoomStart:`BB69E93E`,ChatRoomSyncMemberJoin:`2A9CB40B`,CommandCombine:`80F9D4AF`,CommandExecute:`D1DEB2AD`,CommonClick:`918C74F3`,CommonColorIsValid:`390A2CE4`,CommonSetScreen:`13DC19A7`,CraftingClick:`5E7225EA`,CraftingConvertSelectedToItem:`F5211D40`,CraftingRun:`4CD7AB08`,DialogCanUnlock:`A86B2558`,DialogLeave:`9313B3E5`,DialogMenuButtonBuild:`88CE1D73`,DialogMenuButtonClick:`2CA1256C`,DrawArousalMeter:`BB0755AF`,DrawArousalThermometer:`7ED6D822`,DrawBackNextButton:`7263249E`,DrawButton:`B747DF6E`,DrawCharacter:`B175AF5E`,DrawCheckbox:`00FD87EB`,DrawImageEx:`E01BE7E7`,DrawImageResize:`D205975A`,DrawItemPreview:`6A7A1E2A`,DrawProcess:`7DA972D9`,DrawText:`C1BF0F50`,DrawTextFit:`F9A1B11E`,ElementCreate:`3C087F6E`,ElementCreateInput:`7F1709DA`,ElementCreateTextArea:`4E040819`,ElementIsScrolledToEnd:`1CC4FE11`,ElementPosition:`CDC30A13`,ElementScrollToEnd:`1AC45575`,ElementValue:`4F26C62F`,FriendListShowBeep:`5B91D5DA`,GameRun:`337CB358`,GLDrawResetCanvas:`81214642`,InformationSheetRun:`5B5C7751`,InterfaceTextGet:`66603471`,InventoryGet:`E666F671`,"Layering.Load":`0A971DA6`,"Layering._ResetClickListener":`5EDCC26F`,LoginClick:`5B9765F8`,LoginDoLogin:`E9145D39`,LoginRun:`ACA81C3B`,LoginStatusReset:`43C3FCD2`,MouseIn:`CA8B839E`,NotificationDrawFavicon:`AB88656B`,NotificationRaise:`E8F29646`,NotificationTitleUpdate:`0E92F3ED`,OnlineGameAllowChange:`3779F42C`,OnlineProfileClick:`521146DF`,OnlineProfileUnload:`A8651F30`,OnlineProfileLoad:`BE8B009B`,OnlineProfileRun:`7F57EF9A`,PoseSetActive:`22C02050`,PreferenceExit:`27E40748`,PreferenceInitPlayer:`0D2BAC05`,PreferenceSubscreenArousalClick:`84F49886`,PreferenceSubscreenArousalRun:`96A6157B`,PreferenceSubscreenImmersionClick:`0EF82344`,PreferenceSubscreenImmersionRun:`276FA30B`,RelogRun:`843E8F94`,RelogExit:`2DFB2DAD`,ServerAccountBeep:`8782A099`,ServerAppearanceBundle:`4D069622`,ServerAppearanceLoadFromBundle:`946537FD`,ServerConnect:`845E50A6`,ServerDisconnect:`146CB302`,ServerInit:`B6CEF7F1`,ServerOpenFriendList:`FA8D3CDE`,ServerPlayerAppearanceSync:`A014E0B7`,ServerPlayerExtensionSettingsSync:`1776666B`,ServerSend:`98EAB9FB`,ServerSendQueueProcess:`BD4277AC`,SkillGetWithRatio:`3EB4BC45`,SpeechTransformBabyTalk:`C812EE0E`,SpeechTransformGagGarble:`691A05BF`,SpeechTransformGagGarbleIntensity:`F61ECBDA`,SpeechTransformProcess:`666DDA2F`,SpeechTransformShouldBabyTalk:`634BCD64`,SpeechTransformStutter:`A930F55E`,SpeechTransformStutterIntensity:`4754768A`,StruggleDexterityProcess:`D185D348`,StruggleFlexibilityCheck:`727CE05B`,StruggleFlexibilityProcess:`1A0B96EF`,StruggleLockPickDraw:`6FE841B9`,StruggleMinigameHandleExpression:`1B3ABF55`,StruggleMinigameStop:`FB05E8A9`,StruggleStrengthProcess:`B1A1457D`,TextGet:`4DDE5794`,TextLoad:`0D535190`,TimerInventoryRemove:`2588CA11`,TimerProcess:`BFB7FFE2`,TitleExit:`F13F533C`,ValidationSanitizeProperties:`843D3952`,WardrobeClick:`33405B1D`,WardrobeExit:`12D14AE4`,WardrobeFastLoad:`C964B347`,WardrobeFastSave:`D1E906FD`,WardrobeFixLength:`CA3334C6`,WardrobeLoad:`C343A4C7`,WardrobeLoadCharacterNames:`F39DF5E3`,WardrobeRun:`633B3570`}}}async function Je(){await s(()=>GameVersion!==`R0`&&typeof ServerIsConnected==`boolean`&&ServerIsConnected),r(`Checking function integrity with GameVersion`,GameVersion);function e(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}for(let[t,n]of Object.entries(qe(GameVersion)||{})){if(n===`SKIP`)continue;let r=window,a=t.split(`.`);for(let n=0;n<a.length-1;n++)r=r[a[n]],e(r)||i(`Expected Function ${t} not found; ${a.slice(0,n+1).join(`.`)} is not object`);if(r=r[a.pop()],typeof r!=`function`){i(`Expected function ${t} is not a function.`);continue}let o=H.getOriginalHash(t);o!==n&&(i(`Function ${t} has been modified before WCE, potential incompatibility: ${o}`),ae.push(t))}}const Ye=`bce-input-warn`;function Xe(){let e=`
  .bce-beep-link {
    text-decoration: none;
  }
  #TextAreaChatLog .bce-notification,
  #TextAreaChatLog .bce-notification {
    background-color: #D696FF;
    color: black;
  }
  #TextAreaChatLog[data-colortheme="dark"] .bce-notification,
  #TextAreaChatLog[data-colortheme="dark2"] .bce-notification {
    background-color: #481D64;
    color: white;
  }
  .bce-img-link {
    vertical-align: top;
  }
  .bce-img {
    max-height: 25rem;
    max-width: 90%;
    display: inline;
    border:1px solid red;
    padding: 0.1rem;
  }
  .bce-color {
    width: 0.8em;
    height: 0.8em;
    display: inline-block;
    vertical-align: middle;
    border: 0.1em solid black;
    margin-right: 0.1em;
  }
  .${P} .${ne}.${Ye} {
    background-color: #400000 !important;
  }
  .${Ye} {
    background-color: yellow !important;
  }
  #TextAreaChatLog a,
  .bce-message a {
    color: #003f91;
    cursor: pointer;
  }
  #TextAreaChatLog a:visited,
  .bce-message a {
    color: #380091;
  }
  .${P} div.ChatMessageWhisper,
  .${P} div.ChatMessageWhisper {
    color: #646464;
  }
  .${P} #TextAreaChatLog[data-colortheme="dark"] div.ChatMessageWhisper,
  .${P} #TextAreaChatLog[data-colortheme="dark2"] div.ChatMessageWhisper {
    color: #828282;
  }
  #TextAreaChatLog[data-colortheme="dark"] a,
  #TextAreaChatLog[data-colortheme="dark2"] a,
  .bce-message a {
    color: #a9ceff;
  }
  #TextAreaChatLog[data-colortheme="dark"] a:visited,
  #TextAreaChatLog[data-colortheme="dark2"] a:visited,
  .bce-message a {
    color: #3d91ff;
  }
  .${ie} {
    font-style: italic;
  }
  .${P} .${ne} {
    background-color: #111;
    color: #eee;
    border-color: #333;
  }
  a.bce-button {
    text-decoration: none;
  }
  .bce-hidden {
    display: none !important;
  }
  .bce-false-hidden {
    position: absolute;
    border: 0;
    margin: 0;
    padding: 0;
    top: 0;
    left: 0;
    width: 0.1px;
    height: 0.1px;
    opacity: 0.01;
  }
  .bce-line-icon-wrapper {
    display: none;
    position: absolute;
    right: 1em;
  }
  .ChatMessage:hover .bce-line-icon-wrapper,
  .ChatMessage:focus .bce-line-icon-wrapper,
  .ChatMessage:focus-within .bce-line-icon-wrapper {
    display: inline;
  }
  .bce-line-icon {
    height: 1em;
    vertical-align: middle;
  }
  #bce-instant-messenger {
    display: flex;
    z-index: 100;
    position: fixed;
    width: 80%;
    height: 70%;
    top: 5%;
    left: 10%;
    padding: 0;
    margin: 0;
    flex-direction: row;
    background-color: #111;
    color: #eee;
    border: 0.2em solid white;
    resize: both;
    overflow: auto;
    max-width: 80%;
    max-height: 75%;
    min-width: 38%;
    min-height: 30%;
    overflow-wrap: break-word;
  }
  #bce-friend-list {
    width: 100%;
    overflow-x: hidden;
    overflow-y: scroll;
  }
  .bce-friend-list-entry {
    padding: 1em;
  }
  .bce-friend-list-entry-name {
    font-weight: bold;
    display: flex;
    flex-direction: column;
  }
  .bce-friend-list-selected {
    font-style: italic;
    border-top: 0.1em solid white;
    border-bottom: 0.1em solid white;
    background-color: #222;
  }
  #bce-message-container {
    width: 100%;
    height: 90%;
    font-size: 1.5rem;
    font-family: Arial, sans-serif;
  }
  #bce-message-right-container {
    width: 80%;
    display: flex;
    flex-direction: column;
    border-left: 0.1em solid white;
  }
  #bce-message-input {
    width: 100%;
    height: 10%;
    border: 0;
    padding: 0;
    margin: 0;
    background-color: #222;
    color: #eee;
    font-size: 1.5rem;
    font-family: system-ui;
  }
  .bce-friend-list-unread {
    background-color: #a22;
  }
  .bce-message-divider {
    margin: 0.5em 2em;
    border-bottom: 0.2em solid white;
  }
  .bce-message {
    padding: 0.2em 0.4em;
    position: relative;
    white-space: pre-wrap;
  }
  .bce-message::before {
    content: attr(data-time);
    float: right;
    color: gray;
    font-size: 0.5em;
    margin-right: 0.2em;
    font-style: italic;
  }
  .bce-message-sender {
    text-shadow: 0.05em 0.05em #eee;
    font-weight: bold;
  }
  .bce-message-Emote, .bce-message-Action {
    font-style: italic;
    color: gray;
  }
  .bce-message-Message .bce-message-sender {
    text-shadow: 0.05em 0.05em #eee;
  }
  .bce-friend-history {
    overflow-y: scroll;
    overflow-x: hidden;
    height: 100%;
  }
  .bce-friend-list-handshake-false,
  .bce-friend-list-handshake-pending {
    text-decoration: line-through;
    color: gray;
  }
  #bce-message-left-container {
    display: flex;
    flex-direction: column;
    width: 20%;
    height: 100%;
  }
  #bce-friend-search {
    border: 0;
    border-bottom: 0.1em solid white;
    padding: 0.5em;
    height: 1em;
    background-color: #222;
    color: #eee;
  }
  .bce-profile-open {
    margin-right: 0.5em;
  }
  .bce-pending {
    opacity: 0.4;
  }

  .lds-ellipsis {
    display: inline-block;
    position: relative;
    width: 80px;
    height: 1em;
  }
  .lds-ellipsis div {
    position: absolute;
    top: 44%;
    width: 13px;
    height: 13px;
    border-radius: 50%;
    background: #fff;
    animation-timing-function: cubic-bezier(0, 1, 1, 0);
  }
  .lds-ellipsis div:nth-child(1) {
    left: 8px;
    animation: lds-ellipsis1 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(2) {
    left: 8px;
    animation: lds-ellipsis2 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(3) {
    left: 32px;
    animation: lds-ellipsis2 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(4) {
    left: 56px;
    animation: lds-ellipsis3 0.6s infinite;
  }
  @keyframes lds-ellipsis1 {
    0% {
      transform: scale(0);
    }
    100% {
      transform: scale(1);
    }
  }
  @keyframes lds-ellipsis3 {
    0% {
      transform: scale(1);
    }
    100% {
      transform: scale(0);
    }
  }
  @keyframes lds-ellipsis2 {
    0% {
      transform: translate(0, 0);
    }
    100% {
      transform: translate(24px, 0);
    }
  }

  #bceNoteInput {
    z-index: 100 !important;
  }

  #layering {
    grid-template:
      "asset-header button-grid" min-content
      "asset-grid asset-grid" min-content
      "layer-header layer-header" min-content
      "layer-grid layer-grid" auto
      "layer-hide-header layer-hide-header" min-content
      "layer-hide-grid layer-hide-grid" auto
      / auto min-content
    ;
  }
  #layering-button-grid {
    top: 0;
    position: sticky;
  }
  #layering-hide-header {
    grid-area: layer-hide-header;
  }
  #layering-wce-hide-div {
    box-sizing: border-box;
    grid-area: layer-hide-grid;
    width: 100%;
    height: calc(100% - min(2vh, 1vw));
    padding-left: min(2vh, 1vw);
    padding-right: min(2vh, 1vw);
    align-self: self-start;
  }

  .wce-chat-room-select,
  #wce-chat-garble-label {
    font-size: 80%;
  }
  #TextAreaChatLog[data-colortheme="dark"] + #chat-room-bot .wce-chat-room-select,
  #TextAreaChatLog[data-colortheme="dark2"] + #chat-room-bot .wce-chat-room-select {
    color: #fff;
    background-color: #111;
    border-color: #555;
  }
  .wce-chat-room-select option[value="off"] {
    display: none;
  }
  .wce-whisper .wce-chat-room-select option[value="off"] {
    display: block;
  }
  #wce-chat-garble-label:after {
    content: "chat: ";
  }
  .wce-whisper #wce-chat-garble-label:after {
    content: "whis: ";
  }
  .wce-chat-room-select-div {
    grid-column: 1 / 4;
    direction: ltr;
    position: relative;
    display: grid;
    grid-template-columns: 28% 72%;
    justify-items: stretch;
    align-items: baseline;
  }
  @media (hover: hover) {
    .wce-chat-room-select-div:hover > .button-tooltip {
      visibility: visible;
    }
  }
  #wce-chat-baby-talk::before {
    background-image: url("https://fielr.github.io/scripts/wce/baby.png");
    mask-image: url("https://fielr.github.io/scripts/wce/baby.png");
  }
  #wce-chat-stutters::before {
    background-image: url("https://fielr.github.io/scripts/wce/stutter.png");
    mask-image: url("https://fielr.github.io/scripts/wce/stutter.png");
  }
  #wce-chat-baby-talk[data-state="ignore"]::before,
  #wce-chat-stutters[data-state="ignore"]::before {
    --button-color: #bbb;
  }
  #wce-chat-baby-talk[data-state="preserve"]::before,
  #wce-chat-stutters[data-state="preserve"]::before {
    --button-color: #666;
  }
  `,t=document.head||document.getElementsByTagName(`head`)[0],n=document.createElement(`style`);n.appendChild(document.createTextNode(e)),t.appendChild(n)}const Ze=[23476,27006,24890],Qe=[129178];function $e(){U(`DrawBackNextButton`,{"Disabled, ArrowWidth":`Disabled, ArrowWidth, tooltipPosition`,"DrawButtonHover(Left, Top, Width, Height,":`DrawButtonHover(tooltipPosition?.X || Left, tooltipPosition?.Y || Top, tooltipPosition?.Width || Width, tooltipPosition?.Height || Height,`},`DrawBackNextButton tooltip positions may be incorrect.`),U(`DrawButton`,{"HoveringText, Disabled":`HoveringText, Disabled, tooltipPosition`,"DrawButtonHover(Left, Top, Width, Height,":`DrawButtonHover(tooltipPosition?.X || Left, tooltipPosition?.Y || Top, tooltipPosition?.Width || Width, tooltipPosition?.Height || Height,`},`DrawButton tooltip positions may be incorrect.`),U(`CommandExecute`,{"key.indexOf(CommandsKey + cmd.Tag) == 0)":`key.substring(1) === cmd.Tag)`},`Whitelist commands will not work.`),U(`PreferenceSubscreenArousalRun`,{'DrawCheckbox(1250, 276, 64, 64, TextGet("ArousalAffectExpression"), Player.ArousalSettings.AffectExpression);':`DrawCheckbox(1250, 276, 64, 64, TextGet("ArousalAffectExpression"), Player.ArousalSettings.AffectExpression, fbcSettingValue("animationEngine"));`},`disabling conflicting Player.ArousalSettings.AffectExpression when Animation Engine is active`),H.hookFunction(`PreferenceSubscreenArousalClick`,V.ModifyBehaviourMedium,(e,t)=>Z.animationEngine&&PreferenceArousalIsActive()&&MouseIn(1250,276,64,64)?null:t(e)),U(`PreferenceSubscreenImmersionRun`,{'TextGet("ShowUngarbledMessages"), Player.ImmersionSettings.ShowUngarbledMessages, disableButtons);':`TextGet("ShowUngarbledMessages"), Player.ImmersionSettings.ShowUngarbledMessages, false);`},`Can't control show ungarbled messages while in Extreme mode.`),H.hookFunction(`PreferenceSubscreenImmersionClick`,V.ModifyBehaviourMedium,(e,t)=>PreferencePageCurrent===2&&MouseIn(500,592,64,64)&&(Player.GetDifficulty()>2||Player.GameplaySettings.ImmersionLockSetting&&Player.IsRestrained())?(Player.ImmersionSettings.ShowUngarbledMessages=!Player.ImmersionSettings.ShowUngarbledMessages,null):t(e)),PreferenceSubscreens.find(e=>e.name===`Arousal`).run=PreferenceSubscreenArousalRun,PreferenceSubscreens.find(e=>e.name===`Arousal`).click=PreferenceSubscreenArousalClick,PreferenceSubscreens.find(e=>e.name===`Immersion`).run=PreferenceSubscreenImmersionRun,PreferenceSubscreens.find(e=>e.name===`Immersion`).click=PreferenceSubscreenImmersionClick,H.hookFunction(`PreferenceLoad`,V.AddBehaviour,(e,t)=>{PreferenceDidAddOldStyleScreens=!1;let n=t(e);return PreferenceSubscreenList=[],n}),H.hookFunction(`InformationSheetRun`,V.AddBehaviour,(e,t)=>{if(!InformationSheetSelection?.MemberNumber)return t(e);let n=t(e),r=Ze.includes(InformationSheetSelection.MemberNumber),i=Qe.includes(InformationSheetSelection.MemberNumber);if(r||i){let e=window.MainCanvas.getContext(`2d`);if(!e)throw Error(`could not get canvas 2d context`);e.textAlign=`left`,DrawText(K(i?`WCE Developer`:`FBC Developer`),550,75,i?`fuchsia`:`hotpink`,`black`),e.textAlign=`center`}return n}),H.hookFunction(`ServerSend`,V.Top,(e,t)=>{let[n,r]=e;if(n!==`AccountUpdate`||!l(r))return t(e);if(`ExtensionSettings`in r)throw Error(`misuse of ExtensionSettings detected; write prevented`);return t(e)}),H.hookFunction(`ServerSendQueueProcess`,V.OverrideBehaviour,(e,t)=>ServerIsConnected?t(e):null)}function et(){if(typeof window.StartBcUtil==`function`){he(K(`Incompatibility`),K(`WCE is incompatible with BCUtil. Some functionality from WCE may not work. BCUtil's wardrobe, appearance, and instant messaging functionality are all available within WCE. Go to WCE settings and enable the relevant options, then disable BCUtil to migrate fully to WCE. This beep will appear every time WCE detects BCUtil as having loaded before WCE.`));return}U(`ServerAccountBeep`,{'ChatRoomSendLocal(`<a onclick="ServerOpenFriendList()">(\${ServerBeep.Message})</a>`);':`{
        const beepId = FriendListBeepLog.length - 1;
        ChatRoomSendLocal(\`<a id="bce-beep-reply-\${beepId}">↩️</a><a class="bce-beep-link" id="bce-beep-\${beepId}">(\${ServerBeep.Message}\${ChatRoomHTMLEntities(data.Message ? \`: \${bceStripBeepMetadata(data.Message.length > 150 ? data.Message.substring(0, 150) + "..." : data.Message)}\` : "")})</a>\`);
        if (document.getElementById("bce-beep-reply-" + beepId)) {
          document.getElementById(\`bce-beep-reply-\${beepId}\`).onclick = (e) => {
            e.preventDefault();
            ElementValue("InputChat", \`/beep \${data.MemberNumber} \${ElementValue("InputChat").replace(/^\\/(beep|w) \\S+ ?/u, '')}\`);
            document.getElementById('InputChat').focus();
          };
        }
        if (document.getElementById("bce-beep-" + beepId)) {
          document.getElementById(\`bce-beep-\${beepId}\`).onclick = (e) => {
            e.preventDefault();
            ServerOpenFriendList();
            FriendListModeIndex = 1;
            FriendListShowBeep(\`\${beepId}\`);
          };
        }
      }`},`Beeps are not enhanced by WCE.`)}async function tt(t){let n=new Map;n.set(`Browser`,navigator.userAgent),n.set(`Game Version`,`${GameVersion}${M.includes(GameVersion)?``:` (unsupported)`}`),n.set(`WebGL Version`,GLVersion),n.set(`WCE Version`,A),n.set(`Loaded via FUSAM`,typeof FUSAM==`object`&&FUSAM?.addons?.WCE?`Yes`:`No`),n.set(`WCE Enabled Settings`,`\n- ${v(Z).filter(([e,t])=>t||e===`version`).map(([e,t])=>`${e}: ${t.toString()}`).join(`
- `)}`),Y.client?.connected&&n.set(`Buttplug.io Devices`,Y.client.devices.map(e=>`${e.name} (${e.vibrateAttributes.map(e=>e.FeatureDescriptor).join(`,`)})`).join(`, `)),n.set(`SDK Mods`,`\n- ${bcModSdk.getModsInfo().map(e=>`${e.name} @ ${e.version}`).join(`
- `)}`),n.set(`Incomplete Functions`,zt.join(`, `)),n.set(`Modified Functions (non-SDK)`,ae.join(`, `)),n.set(`Skipped Functionality for Compatibility`,`\n- ${oe.join(`
- `)}`),n.set(`Log`,e.filter(e=>e).map(e=>`[${e.level.toUpperCase()}] ${e.message}`).join(`
`));let r=Array.from(n).map(([e,t])=>`${e}: ${t}`).join(`
`);return t&&(S(`${r}\n\n**The report has been copied to your clipboard.**`),console.debug(`${r}\n\n**The report has been copied to your clipboard.**`),await navigator.clipboard.writeText(r)),oe.length>0&&S(`If you are running another addon that modifies the game, but is not listed above, please tell its developer to use https://github.com/Jomshir98/bondage-club-mod-sdk to hook into the game instead. This is a very cheap and easy way for addon developers to almost guarantee compatibility with other addons.`),r}function nt(e,t=!1){let n=t?ChatRoomCharacterDrawlist:ChatRoomCharacter;if(ChatRoomMapViewIsActive()&&(n=n.filter(ChatRoomMapViewCharacterIsVisible)),e===null)return n;let r=[];return r=/^\d+$/u.test(e)?[n.find(t=>t.MemberNumber===parseInt(e))]:n.filter(t=>CharacterNickname(t).split(` `)[0]?.toLowerCase()===e?.toLowerCase()||t.Name.split(` `)[0].toLowerCase()===e?.toLowerCase()),r.filter(Boolean)}async function rt(){await s(()=>!!Commands),n(`registering additional commands`),CommandCombine([{Tag:`fbcdebug`,Description:K(`Get debug information to share with developers.`),Action:()=>{S(`Warning: /fbcdebug is deprecated, use /wcedebug instead!`),tt(!0)}},{Tag:`fbcchangelog`,Description:K(`Show recent WCE changelog`),Action:()=>{Pe(N),S(`Warning: /fbcchangelog is deprecated, use /wcechangelog instead!`)}},{Tag:`wcedebug`,Description:K(`Get debug information to share with developers.`),Action:()=>{tt(!0)}},{Tag:`wcechangelog`,Description:K(`Show recent WCE changelog`),Action:()=>{Pe(N)}},{Tag:`wcegotoroom`,Description:K(`[room name or empty] switches to the room or leaves room if empty (ignoring all restrictions)`),Action:(e,t)=>{de(t.substring(13).trim())}},{Tag:`exportlooks`,Description:K(`[target member number]: Copy your or another player's appearance in a format that can be imported with WCE or BCX`),Action:(e,t,[n])=>{let i=null;if(i=n?Character.find(e=>e.MemberNumber===parseInt(n))??null:Player,!i){r(`Could not find member`,n);return}let a=!1,o=!1,s=!1;FUSAM.modals.openAsync({prompt:K(`Include binds?`),buttons:{cancel:`No`,submit:`Yes`}}).then(([e])=>(o=e===`submit`,o?FUSAM.modals.openAsync({prompt:K(`Include locks?`),buttons:{cancel:`No`,submit:`Yes`}}).then(([e])=>{s=e===`submit`}):null)).then(()=>FUSAM.modals.openAsync({prompt:K(`Include height, body type, hair, etc?`),buttons:{cancel:`No`,submit:`Yes`}})).then(([e])=>{a=e===`submit`;let t=i.Appearance.filter(e=>e.Asset.Group.IsDefault&&!e.Asset.Group.Clothing),n=i.Appearance.filter(e=>e.Asset.Group.Category===`Appearance`&&e.Asset.Group.Clothing),r=i.Appearance.filter(e=>e.Asset.Group.Category===`Item`&&!e.Asset.Group.BodyCosplay),c=[...n];o&&c.push(...r),a&&c.push(...t);let l=c.map(e=>{let t=e.Property?{...e.Property}:{};return!s&&t.LockedBy&&(delete t.LockedBy,delete t.LockMemberNumber),t?.LockMemberNumber&&(t.LockMemberNumber=Player.MemberNumber),{Group:e.Asset.Group.Name,Name:e.Asset.Name,Color:e.Color,Difficulty:e.Difficulty,Property:t,Craft:e.Craft}}),u=i.IsPlayer()?`yourself`:CharacterNickname(i),d=LZString.compressToBase64(JSON.stringify(l));return FUSAM.modals.openAsync({prompt:K(K(`Copy the looks string below`)),input:{initial:d,readonly:!0,type:`textarea`},buttons:{submit:`Done`}}),navigator.clipboard.writeText(d).then(()=>{S(K(`Exported looks for $TargetName copied to clipboard`,{$TargetName:u}))})})}},{Tag:`importlooks`,Description:K(`Import looks from a string (BCX or WCE export)`),Action:()=>{if(!Player.CanChangeOwnClothes()||!OnlineGameAllowChange()){S(K(`You cannot change your appearance while bound or during online games, such as LARP.`));return}FUSAM.modals.open({prompt:K(`Paste your looks here`),input:{initial:``,readonly:!1,type:`textarea`},callback:(e,t)=>{if(e===`submit`){if(!t){S(K(`No looks string provided`));return}try{let e=t.startsWith(`[`)?y(t):y(LZString.decompressFromBase64(t));if(!Array.isArray(e)||e.length===0||!e[0].Group)throw Error(`Invalid bundle`);for(let t of Player.Appearance)if(t.Property?.LockedBy&&!DialogCanUnlock(Player,t)){let n={Group:t.Asset.Group.Name,Name:t.Asset.Name,Color:t.Color,Difficulty:t.Difficulty,Property:t.Property},r=e.findIndex(e=>e.Group===t.Asset.Group.Name);r<0?e.push(n):e[r]=n}ServerAppearanceLoadFromBundle(Player,`Female3DCG`,e,Player.MemberNumber),ChatRoomCharacterUpdate(Player),S(K(`Applied looks`))}catch(e){console.error(e),S(K(`Could not parse looks`))}}}})}},{Tag:`beep`,Description:K(`[membernumber] [message]: beep someone`),Action:(e,t,[n])=>{if(G?.getRuleState(`speech_restrict_beep_send`)?.isEnforced){S(K(`Sending beeps is restricted by BCX rule.`));return}let[,,...r]=t.split(` `),i=r?.join(` `);if(!n||!i||!/^\d+$/u.test(n)){S(K(`beep target or message not provided`));return}let a=parseInt(n);if(!Player.FriendList?.includes(a)){S(K(`$Target is not in your friend list`,{$Target:n}));return}let o=Player.FriendNames?.get(a);ServerSend(`AccountBeep`,{BeepType:``,MemberNumber:a,Message:i,IsSecret:!0}),FriendListBeepLog.push({MemberNumber:a,MemberName:o??`unknown (${a})`,Sent:!0,Private:!1,Time:new Date,Message:i});let s=FriendListBeepLog.length-1,c=document.createElement(`a`);c.href=`#beep-${s}`,c.onclick=e=>{e.preventDefault(),ServerOpenFriendList(),FriendListModeIndex=1,FriendListShowBeep(s)},c.textContent=K(`(Beep to $Name ($Number): $Message)`,{$Name:o??`unknown`,$Number:a.toString(),$Message:i.length>150?`${i.substring(0,150)}...`:i}),c.classList.add(`bce-beep-link`),S(c)}},{Tag:`w`,Description:K(`[target name] [message]: whisper the target player. Use first name only. Finds the first person in the room with a matching name, left-to-right, top-to-bottom.`),Action:(e,t,n)=>{if(n.length<2){S(K(`Whisper target or message not provided`));return}let[r]=n,[,,...i]=t.split(` `),a=i?.join(` `),o=nt(r);if(!r||!o||o.length===0)S(`Whisper target not found: ${r}`);else if(o.length>1)S(K(`Multiple whisper targets found: $Targets. You can still whisper the player by clicking their name or by using their member number.`,{$Targets:o.map(e=>`${CharacterNickname(e)} (${e.MemberNumber??``})`).join(`, `)}));else if(o[0].IsPlayer())S(`You can't whisper yourself!`);else if(!a)S(K(`No message provided`));else{let e=o[0].MemberNumber,t=ChatRoomTargetMemberNumber;ChatRoomTargetMemberNumber=e??-1,ElementValue(`InputChat`,`${a.length>0&&[`.`,`/`].includes(a[0])?`​`:``}${a}`),ChatRoomSendChat(),ChatRoomLastMessage.pop(),ChatRoomTargetMemberNumber=t}}},{Tag:`versions`,Description:K(`show versions of the club, WCE, BCX and other mods in use by players`),Action:(e,t,r)=>{function i(e){let t=e.OnlineSharedSettings?.GameVersion??`R0`,n=window.bcx?.getCharacterVersion(e.MemberNumber)?` BCX ${window.bcx.getCharacterVersion(e.MemberNumber)??`?`}`:``,r=e.FBC?`\nWCE v${e.FBC} Alt Arousal: ${e.BCEArousal?.toString()}`:``,i=e.FBCOtherAddons?.some(e=>![`BCX`,`FBC`,`WCE`].includes(e.name))?`\nOther Addons:\n- ${e.FBCOtherAddons.filter(e=>![`BCX`,`FBC`,`WCE`].includes(e.name)).map(e=>`${e.name} v${e.version} ${e.repository??``}`).join(`
- `)}`:``;return`${CharacterNickname(e)} (${e.MemberNumber??``}) club ${t}${n}${r}${i}`}let a=nt(r.length>0?r[0]:null,!0),o=a.map(i).filter(e=>e).join(`

`);S(o),n(o)}},{Tag:`ulistadd`,Description:K(`[membernumber]: adds a player to the list allowing to bypass Uwall.`),Action:(e,t,n)=>{if(n.length<1)S(`The ulistadd command must be followed by the member number of the player that you allow to bypass Uwall.`);else{let e=parseInt(n[0]),t=Player.OnlineSharedSettings.Ulist??[];!isNaN(e)&&e>0&&e!==Player.MemberNumber&&!t.includes(e)&&(Player.OnlineSharedSettings.Ulist=[...t,e],ServerAccountUpdate.QueueData({OnlineSharedSettings:Player.OnlineSharedSettings})),Z.uwall||S(`Warning: Uwall is not activated in WCE's settings.`)}}},{Tag:`ulistremove`,Description:K(`[membernumber]: removes a player from the list allowing to bypass Uwall.`),Action:(e,t,n)=>{if(n.length<1)S(`The ulistremove command must be followed by the member number of the player who is no more allowed to bypass Uwall.`);else{let e=parseInt(n[0]),{Ulist:t}=Player.OnlineSharedSettings;Array.isArray(t)&&!isNaN(e)&&e>0&&e!==Player.MemberNumber&&(Player.OnlineSharedSettings.Ulist=t.filter(t=>t!==e),ServerAccountUpdate.QueueData({OnlineSharedSettings:Player.OnlineSharedSettings})),Z.uwall||S(`Warning: Uwall is not activated in WCE's settings.`)}}},{Tag:`ulistshow`,Description:K(`displays the list of players allowed to bypass Uwall.`),Action:()=>{S(`Ulist: ${JSON.stringify(Player.OnlineSharedSettings.Ulist??[])}`),Z.uwall||S(`Warning: Uwall is not activated in WCE's settings.`)}}])}const it=900,at=200;async function ot(){await s(()=>!!PreferenceRegisterExtensionSetting),n(`initializing`);let e=8,t=70,r=225;function o(t){return Math.ceil(Object.values(Q).filter(e=>e.category===t).length/e)}let c=[1500,60,250,50],l=[1240,60,250,50],u=0,d=null,f=``,p=[`chat`,`activities`,`appearance`,`immersion`,`antigarble`,`performance`,`misc`,`cheats`,`buttplug`],m={chat:`Chat & Social`,activities:`Activities & Arousal`,appearance:`Appearance & Wardrobe`,immersion:`Immersion & Anti-Cheat`,antigarble:`Gagspeak & Anti-Garble`,performance:`Performance`,misc:`Misc`,cheats:`Cheats`,buttplug:`Buttplug.io Toys`,hidden:``},h=[`None`,...new Set(Asset.filter(e=>e.AllowEffect?.includes(`Vibrating`)||e.AllowEffect?.includes(`Egged`)).map(e=>e.Group.Name))],g=[1650,225,150,50];function _(e){return Object.entries(Q).filter(([t,n])=>n.category===e&&t!==`buttplugDevices`)}function v(){ElementCreateInput(`WceIntifaceAddress`,`text`,Z.toySyncAddress),ElementPosition(`WceIntifaceAddress`,-999,-999,550),u=0}function y(){Z.toySyncAddress=ElementValue(`WceIntifaceAddress`),ElementRemove(`WceIntifaceAddress`),He(),PreferenceSubscreenExtensionsClear()}function b(){let n=window.MainCanvas.getContext(`2d`);if(!n){a(`Could not get canvas context`);return}if(n.textAlign=`left`,DrawText(K(d?`WCE Settings - ${m[d]}`:`Wholesome Club Extensions (WCE) Settings`),300,125,`Black`,`Gray`),DrawButton(...c,``,`White`,``),DrawText(K(`License`),c[0]+20,c[1]+c[3]/2,`Black`,``),DrawButton(...l,``,`White`,``),DrawText(K(`Information`),l[0]+20,l[1]+l[3]/2,`Black`,``),DrawButton(1815,75,90,90,``,`White`,`Icons/Exit.png`),d){let i=r;for(let[n,r]of _(d).slice(u*e,u*e+e)){if(r.type===`select`&&Array.isArray(r.options)){let e=r,t=e.options.indexOf(Z[n]),a=e.options.length,o=e.disabled?.()||!1;DrawText(K(r.label),400,i+33,f===n?`Red`:`Black`,`Gray`),DrawBackNextButton(it,i,at,64,K(e.options[t]),o?`#ebebe4`:`White`,``,()=>K(`${r.label} ${e.options[(t-1+a)%a]}`),()=>K(`${r.label} ${e.options[(t+1+a)%a]}`),o)}else DrawCheckbox(300,i,64,64,K(r.label),!!Z[n],r.disabled(),f===n?`Red`:`Black`);i+=t}if(d===`buttplug`){if(DrawText(K(`This page allows configuration of the synchronization of bluetooth connected toys.`),300,350,`Black`,`Gray`),ElementPosition(`WceIntifaceAddress`,1300,r+32,550),Z.toySync)if(!Y.client?.connected)DrawText(K(`Still connecting or connection failed...`),300,450,`Black`,`Gray`);else{n.textAlign=`center`,DrawButton(...g,K(`Scan`),Y.client.isScanning?`Grey`:`White`,``,Y.client.isScanning?`Already scanning`:void 0,Y.client.isScanning),n.textAlign=`left`,DrawText(K(`Device Name`),300,420,`Black`,`Gray`),DrawText(K(`Synchronized Slot`),800,420,`Black`,`Gray`),i=500;for(let e of Y.client.devices.filter(e=>e.vibrateAttributes.length>0)){let r=Y.deviceSettings.get(e.name);r||(r={Name:e.name,SlotName:`None`},Y.deviceSettings.set(e.name,r));let a=h.indexOf(r.SlotName),o=0,s=0;if(s=a<=0?h.length-1:a-1,o=a===h.length-1?0:a+1,DrawText(e.name,300,i,`Black`,`Gray`),n.textAlign=`center`,DrawBackNextButton(800,i-32,450,64,K(r.SlotName),`white`,``,()=>K(h[s]),()=>K(h[o])),n.textAlign=`left`,i+=t,i>950)break}}}else{if(DrawText(K(`Click on a setting to see its description`),300,160,`Gray`,`Silver`),Ue(f))if(Q[f].type===`select`&&Array.isArray(Q[f].tooltips)){let e=Q[f],t=e.options.indexOf(Z[f]);x(300,800,1600,K(e.description),`left`),x(330,870,1570,K(e.tooltips[t]),`left`)}else x(300,830,1600,K(Q[f].description),`left`);o(d)>1&&(DrawText(`${u+1} / ${o(d)}`,1700,230,`Black`,`Gray`),DrawButton(1815,180,90,90,``,`White`,`Icons/Next.png`))}}else{let e=r;for(let n of p)DrawButton(300,e,400,64,``,`White`),DrawTextFit(K(m[n]),310,e+32,380,`Black`),e+=t}n.textAlign=`center`}function S(){let a=r;if(MouseIn(1815,75,90,90))d===null?y():(ElementPosition(`WceIntifaceAddress`,-999,-999,550),d=null);else if(MouseIn(...c))open(te,`_blank`);else if(MouseIn(...l))open(ee,`_blank`);else if(d!==null){if(MouseIn(1815,180,90,90)&&d!==`buttplug`)u+=1,u%=o(d);else for(let[r,i]of _(d).slice(u*e,u*e+e)){if(i.type===`select`&&Array.isArray(i.options)){let e=i,t=at/2,n=e.options.indexOf(Z[r]),o=e.options.length;MouseIn(it+t,a,t,64)&&!e.disabled?.()?Z[r]=e.options[(n+1+o)%o]:MouseIn(it,a,t,64)&&!e.disabled?.()&&(Z[r]=e.options[(n-1+o)%o])}else MouseIn(300,a,64,64)&&!i.disabled?.()&&(Z[r]=!Z[r],i.sideEffects(Z[r],!1));MouseIn(364,a,1e3,64)&&(f=r,n(`currentSetting`,f)),a+=t}if(d===`buttplug`&&Y.client?.connected){if(MouseIn(...g)){Y.client.isScanning||Y.client.startScanning();return}a=500;for(let e of Y.client.devices.filter(e=>e.vibrateAttributes.length>0)){if(!MouseIn(800,a-32,450,64)){a+=t;continue}let n=Y.deviceSettings.get(e.name);if(!n){i(`Could not find device settings for`,e.name,Y.deviceSettings),a+=t;continue}let r=h.indexOf(n.SlotName),o=0,s=0;if(s=r<=0?h.length-1:r-1,o=r===h.length-1?0:r+1,MouseX<1025?n.SlotName=h[s]:n.SlotName=h[o],a+=t,a>950)break}}}else for(let e of p){if(MouseIn(300,a,400,64)){d=e,u=0;break}a+=t}}PreferenceRegisterExtensionSetting({Identifier:`WCE`,ButtonText:K(`WCE Settings`),Image:`https://fielr.github.io/scripts/wce/icon.png`,click:S,run:b,exit:y,load:v});function C(e){e.key===`Escape`&&d!==null&&(d=null,ElementPosition(`WceIntifaceAddress`,-999,-999,550),e.stopPropagation(),e.preventDefault())}document.addEventListener(`keydown`,C,!0),document.addEventListener(`keypress`,C,!0)}async function st(){await s(()=>!!StruggleMinigames);function e(e){return()=>(e=Math.sin(e)*1e4,e-Math.floor(e))}let t=100,r=200,i=1575,a=300;H.hookFunction(`StruggleLockPickDraw`,V.AddBehaviour,(e,n)=>{if(Z.lockpick&&StruggleLockPickOrder){let e=StruggleLockPickOrder.map(e=>e);for(let n=0;n<e.length;n++){let o=i-r/2+(.5-e.length/2+n)*t;DrawText(`${StruggleLockPickOrder.indexOf(n)+1}`,o,a,`white`)}}return n(e)}),n(`hooking struggle for lockpick cheat draw`,StruggleMinigames),StruggleMinigames.LockPick.Draw=StruggleLockPickDraw}async function ct(){let{Dexie:e}=await import(`./dexie.js`),t=new e(`wce-saved-accounts`);t.version(2).stores({key:`id, key`,accounts:`id, data, iv, auth`});let r=t.table(`key`),a=t.table(`accounts`),l,u;try{u=await r.get({id:1})}catch(e){i(e),localStorage.removeItem(`bce.passwords`),await t.delete(),window.location.reload()}u?l=u.key:(l=await window.crypto.subtle.generateKey({name:`AES-GCM`,length:256},!1,[`encrypt`,`decrypt`]),await r.put({id:1,key:l}));async function d(){let e=localStorage.getItem(`bce.passwords`);if(e){let t=y(e)||{};return window.crypto?.subtle&&setTimeout(()=>{localStorage.removeItem(`bce.passwords`),m(t)},1),t}let t=await a.get({id:1});if(!t)return{};let{auth:n,iv:o,data:s}=t,c=new TextDecoder(`utf8`);try{let e=await window.crypto.subtle.decrypt({name:`AES-GCM`,iv:o,additionalData:n,tagLength:128},l,s);return y(c.decode(new Uint8Array(e)))||{}}catch(e){return i(e),localStorage.removeItem(`bce.passwords`),r.clear(),a.clear(),{}}}let f=await d();function p(){return f||{}}function m(e){if(window.crypto?.subtle){let t=window.crypto.getRandomValues(new Uint8Array(16)),n=window.crypto.getRandomValues(new Uint8Array(16)),r=new TextEncoder;f=e,window.crypto.subtle.encrypt({name:`AES-GCM`,iv:t,additionalData:n,tagLength:128},l,r.encode(JSON.stringify(e))).then(e=>a.put({id:1,iv:t,auth:n,data:new Uint8Array(e)},[1]))}else localStorage.removeItem(`bce.passwords`)}function h(){let e=``;CurrentScreen===`Login`?e=ElementValue(`InputName`).toUpperCase():CurrentScreen===`Relog`&&(e=Player.AccountName);let t=p();t[e]=ElementValue(`InputPassword`),m(t)}globalThis.bceUpdatePasswordForReconnect=h;function g(e){let t=p();Object.hasOwn(t,e)&&(delete t[e],m(t))}globalThis.bceClearPassword=g;let _=Date.now();async function v(){await s(()=>CurrentScreen===`Login`);let e={passwords:p(),posMaps:{}};H.hookFunction(`LoginRun`,V.Top,(t,n)=>{let r=n(t);Object.keys(e.passwords).length>0&&DrawText(K(`Saved Logins (WCE)`),170,35,`White`,`Black`),DrawButton(1250,387,180,50,K(`Save (WCE)`),`White`);let i=60;for(let t in e.passwords){if(!Object.hasOwn(e.passwords,t))continue;e.posMaps[i]=t,DrawButton(10,i,350,60,t,`White`),DrawButton(355,i,60,60,`X`,`White`),i+=70}return r}),H.hookFunction(`LoginClick`,V.Top,(t,n)=>{let r=n(t);MouseIn(1250,385,180,60)&&(h(),e.posMaps={},e.passwords=p());let i=Date.now();if(i-_<150)return r;for(let t in _=i,e.posMaps){if(!Object.hasOwn(e.posMaps,t))continue;let n=parseInt(t);MouseIn(10,n,350,60)?LoginDoLogin(e.posMaps[n],e.passwords[e.posMaps[n]]):MouseIn(355,n,60,60)&&(g(e.posMaps[n]),e.posMaps={},e.passwords=p())}return r}),CurrentScreenFunctions.Run=LoginRun,CurrentScreenFunctions.Click=LoginClick}v();let b=!1,x=!1;async function S(){if(!Player?.AccountName||!ServerIsConnected||LoginSubmitted||!ServerSocket.connected||b||x||!Z.relogin)return;b=!0;let e=p();if(n(`Attempting to log in again as`,Player.AccountName),!e[Player.AccountName]){i(`No saved credentials for account`,Player.AccountName);return}LoginDoLogin(Player.AccountName,e[Player.AccountName]),await s(()=>CurrentScreen!==`Relog`,()=>!b)||i(`Relogin failed, circuit was restored`),await o(500),H.callOriginal(`ServerAccountBeep`,[{MemberNumber:Player.MemberNumber||-1,BeepType:``,MemberName:`VOID`,ChatRoomName:`VOID`,Private:!0,Message:K(`Reconnected!`),ChatRoomSpace:``}])}H.hookFunction(`RelogRun`,V.Top,(e,t)=>{let n=[`ErrorDuplicatedLogin`];return n.includes(LoginErrorMessage)?b||(H.callOriginal(`ServerAccountBeep`,[{MemberNumber:Player.MemberNumber||-1,BeepType:``,MemberName:Player.Name,ChatRoomName:K(`ERROR`),Private:!0,Message:K(`Signed in from a different location! Refresh the page to re-enable relogin in this tab.`),ChatRoomSpace:``}]),b=!0,x=!0):S(),t(e)}),H.hookFunction(`RelogExit`,V.Top,(e,t)=>(b=!1,x=!1,t(e))),W(`connect`,()=>{b=!1}),H.hookFunction(`ServerDisconnect`,V.ModifyBehaviourHigh,(e,t)=>{let[,n]=e;e[1]=!1;let r=t(e);return n&&(i(`Forcefully disconnected`,e),ServerSocket.disconnect(),c(e[0])&&[`ErrorRateLimited`,`ErrorDuplicatedLogin`].includes(e[0])?(i(`Reconnecting...`),setTimeout(()=>{i(`Connecting...`),ServerInit()},3e3+Math.round(Math.random()*3e3))):i(`Disconnected.`)),r})}async function lt(){await s(()=>!!Player?.AppearanceLayers);function e(e,t){return t?.Property?.LockedBy===`ExclusivePadlock`?!e.IsPlayer():LogQuery(`KeyDeposit`,`Cell`)?!1:t?.Asset?.OwnerOnly?t.Asset.Enable&&e.IsOwnedByPlayer():t?.Asset?.LoverOnly?t.Asset.Enable&&e.IsLoverOfPlayer():t?.Asset?.FamilyOnly?t.Asset.Enable&&e.IsFamilyOfPlayer():DialogHasKey(e,t)}H.hookFunction(`Layering.Load`,V.AddBehaviour,(t,n)=>{if(Z.allowLayeringWhileBound&&(!InventoryItemHasEffect(Layering.Item,`Lock`)||e(Layering.Character,Layering.Item))&&(Layering.Readonly=!1),!Layering.Character.IsPlayer()&&Layering.Character.BCECapabilities?.includes(`preventLayeringByOthers`)&&(Layering.Readonly=!0),!Z.layeringHide||CurrentScreen===`Crafting`||!Layering.Character.BCECapabilities?.includes(`layeringHide`))return n(t);let r=n(t),i=Layering.Asset.Hide||[];if(i.length===0)return r;let a=Layering.Item.Property.wceOverrideHide||i,o=document.getElementById(Layering.ID.root);return o.classList.add(`scroll-box`),o.querySelector(`#layering-layer-div`)?.classList.remove(`scroll-box`),ElementCreate({tag:`h1`,attributes:{id:`layering-hide-header`},parent:o,children:[K(`[WCE] Configure layer hiding`)]}),ElementCreate({tag:`form`,attributes:{id:`layering-wce-hide-div`},classList:[`layering-layer-inner-grid`],parent:o,children:i.map(e=>({tag:`div`,classList:[`layering-pair`],children:[{tag:`input`,attributes:{type:`checkbox`,name:`checkbox-hide`,value:e,disabled:Layering.Readonly?!0:void 0,checked:a.includes(e)?!0:void 0},classList:[],eventListeners:{click:()=>{let e=document.getElementById(`layering-wce-hide-div`);Layering.Item.Property.wceOverrideHide=new FormData(e).getAll(`checkbox-hide`),i.length===Layering.Item.Property.wceOverrideHide.length&&delete Layering.Item.Property.wceOverrideHide,Layering._CharacterRefresh(Layering.Character,!1,!1)}}},{tag:`span`,classList:[`layering-pair-text`],children:[e]}]}))}),r}),H.hookFunction(`Layering._ResetClickListener`,V.AddBehaviour,(e,t)=>!Z.layeringHide||CurrentScreen===`Crafting`?t(e):(delete Layering.Item.Property.wceOverrideHide,document.querySelectorAll(`input[name=checkbox-hide]`).forEach(e=>{e.checked=!0}),t(e))),U(`CharacterAppearanceVisible`,{"if ((item.Asset.Hide != null) && (item.Asset.Hide.indexOf(GroupName) >= 0) && !Excluded) HidingItem = true;":`
        const hide = item.Property?.wceOverrideHide != null ? item.Property.wceOverrideHide : item.Asset.Hide;
        if ((hide != null) && (hide.indexOf(GroupName) >= 0) && !Excluded) HidingItem = true;`},`Override C.Appeareance.Asset.Hide won't work`);function t(e){let t={Hide:{}};for(let n of e)if(Array.isArray(n.Property?.wceOverrideHide)){let{wceOverrideHide:e,...r}=n.Property;t.Hide[n.Group]=e,n.Property=r}return Player.ExtensionSettings.WCEOverrides=LZString.compressToUTF16(JSON.stringify(t)),ServerPlayerExtensionSettingsSync(`WCEOverrides`),e}globalThis.wceServerAppearance=t,U(`ServerPlayerAppearanceSync`,{"D.Appearance = ServerAppearanceBundle(Player.Appearance);":`D.Appearance = wceServerAppearance(ServerAppearanceBundle(Player.Appearance));`},`wceOverrideHide would be stored in the BC database`),H.hookFunction(`ServerAppearanceLoadFromBundle`,V.ModifyBehaviourMedium,(e,t)=>{let n=t(e),[r]=e;if(r.IsPlayer()&&Array.isArray(r.Appearance)){let e=!1,t=y(LZString.decompressFromUTF16(Player.ExtensionSettings.WCEOverrides));for(let[n,i]of Object.entries(t?.Hide||{})){let t=InventoryGet(r,n);t&&!Array.isArray(t.Property?.wceOverrideHide)&&(t.Property??={},t.Property.wceOverrideHide=i,e=!0)}e&&ChatRoomCharacterUpdate(r)}return n}),H.hookFunction(`ChatRoomSyncMemberJoin`,V.AddBehaviour,(e,t)=>{let n=t(e);return Player.Appearance.some(e=>Array.isArray(e.Property?.wceOverrideHide))&&ChatRoomCharacterUpdate(Player),n}),H.hookFunction(`PreferenceExit`,V.AddBehaviour,(e,t)=>{let n=PreferenceSubscreen.name===`Main`,r=t(e);return n&&Player.Appearance.some(e=>Array.isArray(e.Property?.wceOverrideHide))&&ChatRoomCharacterUpdate(Player),r});let n=[`LeatherCrop`,`LeatherWhip`,`ShockCollarRemote`,`SpankingToys`,`VibratorRemote`],r=Asset.filter(e=>AssetGroup.filter(t=>t.Name.startsWith(`Item`)&&!/\d$/u.test(t.Name)&&t.Asset.find(t=>t.Name===e.Name)).length>1).filter((e,t,n)=>n.findIndex(t=>t.Name===e.Name)===t).map(e=>e.Name).filter(e=>!n.includes(e));function i(e,t){return!!t&&!!e.Appearance.find(e=>e===t)}H.hookFunction(`DialogMenuButtonBuild`,V.AddBehaviour,([e],t)=>{let n=t([e]);if(d(e)&&Z.copyColor&&Player.CanInteract()&&e?.FocusGroup?.Name&&!InventoryGroupIsBlocked(e,e.FocusGroup.Name)&&DialogMenuMode===`items`){let t=InventoryGet(e,e.FocusGroup.Name);i(e,t)&&r.includes(t.Asset.Name)&&DialogMenuButton.push(`Paint`)}return n}),H.hookFunction(`InterfaceTextGet`,V.AddBehaviour,(e,t)=>e[0]===`DialogMenuPaint`?K(`[WCE] Copy colors to other items of same type`):t(e)),H.hookFunction(`DialogMenuButtonClick`,V.AddBehaviour,(e,t)=>{let n=t(e);if(!n&&![`colorExpression`,`colorItem`,`extended`,`layering`,`tighten`].includes(DialogMenuMode)){let e=CharacterGetCurrent(),t=e.FocusGroup?InventoryGet(e,e.FocusGroup.Name):null;for(let n=0;n<DialogMenuButton.length;n++)if(MouseIn(1885-n*110,15,90,90)){let r=DialogMenuButton[n];if(t&&r===`Paint`)return o(e,t),!1}}return n});function a(e,t){if(e.Asset.Name===t.Asset.Name)if(Array.isArray(t.Color))if(Array.isArray(e.Color))for(let n=e.Color.length-1;n>=0;n--)e.Color[n]=t.Color[n%t.Color.length];else e.Color=t.Color[t.Color.length-1];else if(Array.isArray(e.Color))for(let n=0;n<e.Color.length;n++)e.Color[n]=t.Color??`Default`;else e.Color=_(t.Color)}function o(e,t){if(!(!Z.copyColor||!Player.CanInteract()||InventoryGroupIsBlocked(e,e.FocusGroup.Name)||!i(e,t)||!r.includes(t.Asset.Name))){for(let n of e.Appearance)a(n,t);CurrentScreen===`ChatRoom`?(ChatRoomCharacterUpdate(e),w(K(`$TargetName's $ItemName colors spread from their $ItemGroup`,{$TargetName:CharacterNickname(e),$ItemName:t.Asset.Description.toLowerCase(),$ItemGroup:t.Asset.Group.Description.toLowerCase()}))):CharacterRefresh(e)}}}function ut(){let e=1*60*60*1e3;H.hookFunction(`ChatRoomMenuBuild`,V.AddBehaviour,(e,t)=>{let n=t(e);return Z.manualCacheClear&&ChatRoomMenuButtons.splice(ChatRoomMenuButtons.indexOf(`Cut`),0,`clearCache`),n}),H.hookFunction(`ChatRoomMenuClick`,V.AddBehaviour,(e,t)=>{let n=t(e);if(Z.manualCacheClear){let e=992/ChatRoomMenuButtons.length;for(let t=0;t<ChatRoomMenuButtons.length;t++)MouseXIn(1005+e*t,e-2)&&ChatRoomMenuButtons[t]===`clearCache`&&r()}return n}),U(`ChatRoomMenuDraw`,{'let suffix = "";':`let suffix = "";
        if (name === "clearCache") {
          DrawButton(1005 + Space * Number(idx), 2, Space - 2, 60, "", color, null, "[WCE] clear and reload the drawing cache of all characters");
          DrawImage("Icons/Small/Reset.png", 976 + Space * Number(idx) + Space / 2, 4);
          continue;
        }`},`manual clearing and reloading of drawing cache`);async function t(){let t=Date.now(),n=await s(()=>CurrentScreen===`ChatRoom`&&!CurrentCharacter&&document.hasFocus(),()=>Date.now()-t>e);n&&Z.automateCacheClear&&r()}globalThis.bceClearCaches=t;function r(){n(`Clearing caches`),GLDrawCanvas&&(GLDrawCanvas.GL?.textureCache&&GLDrawCanvas.GL.textureCache.clear(),GLDrawResetCanvas()),n(`Clearing old characters from cache`);let e=Character.filter(e=>e.IsOnline?.()&&!ChatRoomCharacter.some(t=>t.MemberNumber===e.MemberNumber));e.forEach(e=>CharacterDelete(e)),Character.filter(e=>e.IsOnline?.()).forEach(e=>CharacterRefresh(e,!1,!1))}J(()=>{Z.automateCacheClear&&t()},e)}function dt(){H.hookFunction(`ChatRoomDrawCharacterStatusIcons`,V.AddBehaviour,([e,t,n,r],i)=>{let a=i([e,t,n,r]);if(d(e)&&typeof t==`number`&&typeof n==`number`&&typeof r==`number`&&e.FBC&&ChatRoomHideIconState===0){let i=[`1`,`2`,`3`,`4`,`5`].includes(e.FBC.split(`.`)[0])?`FBC`:`WCE`;DrawTextFit(i,t+290*r,n+14*r,60*r,e.FBCNoteExists?`Cyan`:`White`,`Black`),DrawTextFit(/^\d+\.\d+(\.\d+)?b?$/u.test(e.FBC)?e.FBC.replace(`b`,``):``,t+290*r,n+36*r,e.FBC.split(`.`).length===3?60*r:40*r,e.FBC.endsWith(`b`)?`Lightpink`:`White`,`Black`)}return a})}async function ft(){await s(()=>!!Player);let e=!1,t=null,n=null,r=!1;function i(){return e&&t?.IsPlayer()||CharacterAppearanceSelection?.IsPlayer()}U(`DrawProcess`,{'CurrentScreen !== "Crafting"':`CurrentScreen !== "Crafting" && CurrentScreen !== "Wardrobe"`},`Full wardrobe may display blur and blindness effects of the background`),U(`DrawCharacter`,{'|| CurrentScreen === "Crafting"':`|| CurrentScreen === "Crafting" || CurrentScreen === "Wardrobe"`},`Full wardrobe may display blur and blindness effects of the outfits`),H.hookFunction(`CharacterAppearanceWardrobeLoad`,V.OverrideBehaviour,(n,r)=>{let[i]=n;return Z.privateWardrobe&&CurrentScreen===`Appearance`?(e=!0,t=d(i)?i:CharacterGetCurrent(),CommonSetScreen(`Character`,`Wardrobe`),null):r(n)}),H.hookFunction(`AppearanceLoad`,V.AddBehaviour,(t,r)=>{let i=r(t);return e&&(CharacterAppearanceBackup=n),i}),H.hookFunction(`AppearanceRun`,V.AddBehaviour,(e,t)=>(CharacterAppearanceMode===`Wardrobe`&&i()&&(DrawCheckbox(1300,350,64,64,``,r,!1,`white`),b(K(`Load without body parts`),1374,380,630,`white`)),t(e))),H.hookFunction(`AppearanceClick`,V.ModifyBehaviourMedium,(e,t)=>CharacterAppearanceMode===`Wardrobe`&&MouseIn(1300,350,64,64)&&i()?(r=!r,null):t(e)),H.hookFunction(`WardrobeLoad`,V.AddBehaviour,(e,t)=>(n=CharacterAppearanceBackup,t(e))),H.hookFunction(`WardrobeRun`,V.AddBehaviour,(n,i)=>{let a=Player;e&&(Player=t);let o=i(n);return e&&(Player=a),DrawText(`Page: ${(WardrobeOffset/12|0)+1}/${WardrobeSize/12}`,300,35,`White`),DrawCheckbox(10,74,64,64,``,r,!1,`white`),b(K(`Exclude body parts`),84,106,300,`white`),o}),H.hookFunction(`WardrobeClick`,V.ModifyBehaviourMedium,(e,t)=>MouseIn(10,74,64,64)?(r=!r,null):t(e)),H.hookFunction(`WardrobeExit`,V.OverrideBehaviour,(t,n)=>e?(CommonSetScreen(`Character`,`Appearance`),e=!1,null):n(t)),H.hookFunction(`WardrobeFastLoad`,V.OverrideBehaviour,(n,i)=>{let[a]=n,o=a.Appearance.filter(e=>e.Asset.Group.IsDefault&&!e.Asset.Group.Clothing);if(e&&d(a)&&a.IsPlayer()){if(!t)throw Error(`targetCharacter is not defined in WardrobeFastLoad`);n[0]=t,a=t,n[2]=!1}let s=i(n);return r&&(a.Appearance=[...o,...a.Appearance.filter(e=>!e.Asset.Group.IsDefault||e.Asset.Group.Clothing)],CharacterLoadCanvas(a)),s}),H.hookFunction(`WardrobeFastSave`,V.OverrideBehaviour,(n,r)=>{let[i]=n;if(e&&d(i)&&i.IsPlayer()){if(!t)throw Error(`targetCharacter is not defined in WardrobeFastSave`);n[0]=t}return Z.confirmWardrobeSave&&Player.Wardrobe?.length>n[1]&&Player.Wardrobe[n[1]]?.some(e=>e.Group===`Pronouns`)&&!window.confirm(`Do you really want to override this wardrobe outfit?`)?null:r(n)}),H.hookFunction(`ServerPlayerIsInChatRoom`,V.AddBehaviour,(t,n)=>typeof CharacterAppearanceReturnRoom==`string`?e&&CharacterAppearanceReturnRoom===`ChatRoom`?null:n(t):e&&CharacterAppearanceReturnScreen?.[1]===`ChatRoom`||n(t));function a(t){Z.privateWardrobe&&t.key===`Escape`&&e&&(WardrobeExit(),t.stopPropagation(),t.preventDefault())}document.addEventListener(`keydown`,a,!0),document.addEventListener(`keypress`,a,!0)}const pt={Blush:[{Expression:`High`,Limit:100},{Expression:`Medium`,Limit:60},{Expression:`Low`,Limit:10},{Expression:null,Limit:0}],Eyebrows:[{Expression:`Soft`,Limit:80},{Expression:`Lowered`,Limit:50},{Expression:`Raised`,Limit:20},{Expression:null,Limit:0}],Fluids:[{Expression:`DroolMedium`,Limit:100},{Expression:`DroolLow`,Limit:40},{Expression:null,Limit:0}],Eyes:[{Expression:`Closed`,Limit:100},{Expression:`Surprised`,Limit:90},{Expression:`Horny`,Limit:70},{Expression:`Dazed`,Limit:20},{Expression:null,Limit:0}],Eyes2:[{Expression:`Closed`,Limit:100},{Expression:`Surprised`,Limit:90},{Expression:`Horny`,Limit:70},{Expression:`Dazed`,Limit:20},{Expression:null,Limit:0}],Pussy:[{Expression:`Hard`,Limit:50},{Expression:null,Limit:0}]},mt={PostOrgasm:{Type:`PostOrgasm`,Duration:2e4,Priority:1e4,Expression:{Blush:[{Expression:`Extreme`,Duration:5e3},{ExpressionModifier:-1,Duration:5e3},{ExpressionModifier:-1,Duration:5e3,Priority:1e3},{ExpressionModifier:-1,Duration:5e3,Priority:200}],Eyes:[{Expression:`Closed`,Duration:8500},{Expression:`Heart`,Duration:7500},{Expression:`Sad`,Duration:4e3,Priority:200}],Eyes2:[{Expression:`Closed`,Duration:8e3},{Expression:`Heart`,Duration:8e3},{Expression:`Sad`,Duration:4e3,Priority:200}],Mouth:[{Expression:`Ahegao`,Duration:5e3},{Expression:`Moan`,Duration:5e3},{Expression:`HalfOpen`,Duration:1e4,Priority:200}],Fluids:[{Expression:`DroolMessy`,Duration:5e3},{Expression:`DroolSides`,Duration:9e3,Priority:400},{Expression:`DroolLow`,Duration:6e3,Priority:200}],Eyebrows:[{Expression:`Soft`,Duration:1e4},{Expression:`Lowered`,Duration:5e3,Priority:200},{Expression:null,Duration:5e3,Priority:1}]}},Pout:{Type:`Pout`,Duration:-1,Expression:{Mouth:[{Expression:`Pout`,Duration:-1}],Eyes:[{Expression:`Dazed`,Duration:-1}],Eyes2:[{Expression:`Dazed`,Duration:-1}],Eyebrows:[{Expression:`Harsh`,Duration:-1}]}},ResetBrows:{Type:`ResetBrows`,Duration:-1,Expression:{Eyebrows:[{Expression:null,Duration:-1}]}},RaiseBrows:{Type:`RaiseBrows`,Duration:-1,Expression:{Eyebrows:[{Expression:`Raised`,Duration:-1}]}},Confused:{Type:`Confused`,Duration:-1,Expression:{Eyebrows:[{Expression:`OneRaised`,Duration:-1}]}},Smirk:{Type:`Smirk`,Duration:-1,Expression:{Mouth:[{Expression:`Smirk`,Duration:-1}]}},Wink:{Type:`Wink`,Duration:1500,Expression:{Eyes:[{Expression:`Closed`,Duration:1500}]}},Laugh:{Type:`Laugh`,Duration:8e3,Expression:{Mouth:[{Expression:`Laughing`,Duration:1e3},{Expression:`Grin`,Duration:200},{Expression:`Laughing`,Duration:1e3},{Expression:`Happy`,Duration:200},{Expression:`Laughing`,Duration:800},{Expression:`Grin`,Duration:400},{Expression:`Laughing`,Duration:800},{Expression:`Happy`,Duration:400},{Expression:`Laughing`,Duration:600},{Expression:`Grin`,Duration:600},{Expression:`Laughing`,Duration:600},{Expression:`Happy`,Duration:600},{Expression:`Laughing`,Duration:200},{Expression:`Grin`,Duration:200},{Expression:`Laughing`,Duration:200},{Expression:`Happy`,Duration:200}]}},Giggle:{Type:`Giggle`,Duration:4e3,Expression:{Mouth:[{Expression:`Laughing`,Duration:800},{Expression:`Grin`,Duration:200},{Expression:`Laughing`,Duration:700},{Expression:`Happy`,Duration:200},{Expression:`Laughing`,Duration:600},{Expression:`Grin`,Duration:200},{Expression:`Laughing`,Duration:500},{Expression:`Grin`,Duration:200},{Expression:`Laughing`,Duration:400},{Expression:`Happy`,Duration:200}]}},Chuckle:{Type:`Chuckle`,Duration:4e3,Expression:{Mouth:[{Expression:`Grin`,Duration:4e3}]}},Smile:{Type:`Smile`,Duration:-1,Expression:{Mouth:[{Expression:`Grin`,Duration:-1}]}},Blink:{Type:`Blink`,Duration:200,Expression:{Eyes:[{Expression:`Closed`,Duration:200}],Eyes2:[{Expression:`Closed`,Duration:200}]}},Grin:{Type:`Grin`,Duration:-1,Expression:{Eyes:[{Expression:`Horny`,Duration:-1}],Eyes2:[{Expression:`Horny`,Duration:-1}],Mouth:[{Expression:`Grin`,Duration:-1}]}},Cuddle:{Type:`Cuddle`,Duration:1e4,Priority:150,Expression:{Mouth:[{Expression:`Happy`,Duration:1e4}],Eyes:[{Expression:`ShylyHappy`,Duration:1e4}],Eyes2:[{Expression:`ShylyHappy`,Duration:1e4}],Eyebrows:[{Expression:`Raised`,Duration:1e4}]}},Blush:{Type:`Blush`,Duration:1e4,Expression:{Blush:[{ExpressionModifier:1,Duration:1e4}]}},Choke:{Type:`Choke`,Duration:4e3,Priority:150,Expression:{Blush:[{ExpressionModifier:3,Duration:4e3}],Eyes:[{Expression:`VeryLewd`,Duration:3e3},{Expression:`Sad`,Duration:1e3}],Eyes2:[{Expression:`VeryLewd`,Duration:3e3},{Expression:`Sad`,Duration:1e3}],Eyebrows:[{Expression:`Harsh`,Duration:4e3}]}},Stimulated:{Type:`Stimulated`,Duration:5e3,Priority:400,Expression:{Blush:[{ExpressionModifier:2,Duration:5e3}],Eyes:[{Expression:`VeryLewd`,Duration:4e3},{Expression:`Sad`,Duration:1e3}],Eyes2:[{Expression:`VeryLewd`,Duration:4e3},{Expression:`Sad`,Duration:1e3}],Eyebrows:[{Expression:`Soft`,Duration:5e3}]}},StimulatedLong:{Type:`StimulatedLong`,Duration:2e4,Priority:400,Expression:{Blush:[{ExpressionModifier:1,Duration:2e4}]}},Shock:{Type:`Shock`,Duration:15e3,Priority:1e3,Expression:{Blush:[{ExpressionModifier:5,Duration:1e4},{ExpressionModifier:-1,Duration:2e3},{ExpressionModifier:-1,Duration:2e3},{ExpressionModifier:-1,Duration:1e3}],Eyes:[{Expression:`Dizzy`,Duration:1e3},{Expression:`Scared`,Duration:8e3},{Expression:`Surprised`,Duration:7e3}],Eyes2:[{Expression:`Dizzy`,Duration:1e3},{Expression:`Scared`,Duration:8e3},{Expression:`Surprised`,Duration:7e3}],Eyebrows:[{Expression:`Soft`,Duration:15e3}],Mouth:[{Expression:`Pained`,Duration:1e4},{Expression:`Angry`,Duration:5e3}]}},ShockLight:{Type:`ShockLight`,Duration:5e3,Priority:900,Expression:{Blush:[{ExpressionModifier:2,Duration:5e3}],Eyes:[{Expression:`Dizzy`,Duration:2e3},{Expression:`Surprised`,Duration:3e3}],Eyes2:[{Expression:`Dizzy`,Duration:2e3},{Expression:`Surprised`,Duration:3e3}],Eyebrows:[{Expression:`Soft`,Duration:5e3}],Mouth:[{Expression:`Angry`,Duration:5e3}]}},Hit:{Type:`Hit`,Duration:7e3,Priority:500,Expression:{Blush:[{Expression:`VeryHigh`,Duration:7e3}],Eyes:[{Expression:`Daydream`,Duration:1e3},{Expression:`Closed`,Duration:3e3},{Expression:`Daydream`,Duration:3e3}],Eyes2:[{Expression:`Daydream`,Duration:1e3},{Expression:`Closed`,Duration:3e3},{Expression:`Daydream`,Duration:3e3}],Eyebrows:[{Expression:`Soft`,Duration:7e3}]}},Spank:{Type:`Spank`,Duration:3e3,Priority:300,Expression:{Eyes:[{Expression:`Lewd`,Duration:3e3}],Eyes2:[{Expression:`Lewd`,Duration:3e3}],Eyebrows:[{Expression:`Soft`,Duration:3e3}]}},Kiss:{Type:`Kiss`,Duration:2e3,Priority:200,Expression:{Mouth:[{Expression:`HalfOpen`,Duration:2e3}]}},KissOnLips:{Type:`KissOnLips`,Duration:2e3,Priority:200,Expression:{Eyes:[{Expression:`Closed`,Duration:2e3}],Eyes2:[{Expression:`Closed`,Duration:2e3}],Mouth:[{Expression:`HalfOpen`,Duration:2e3}],Blush:[{Skip:!0,Duration:1e3},{ExpressionModifier:1,Duration:1e3}]}},LongKiss:{Type:`LongKiss`,Duration:4e3,Priority:200,Expression:{Eyes:[{Expression:`Closed`,Duration:4e3}],Eyes2:[{Expression:`Closed`,Duration:4e3}],Mouth:[{Expression:`Open`,Duration:4e3}],Blush:[{Skip:!0,Duration:1e3},{ExpressionModifier:1,Duration:1e3},{ExpressionModifier:1,Duration:2e3}]}},Disoriented:{Type:`Disoriented`,Duration:8e3,Priority:250,Expression:{Eyes:[{Expression:`Dizzy`,Duration:8e3}],Eyes2:[{Expression:`Dizzy`,Duration:8e3}],Eyebrows:[{Expression:`Raised`,Duration:8e3}],Blush:[{ExpressionModifier:2,Duration:8e3}]}},Angry:{Type:`Angry`,Duration:-1,Expression:{Mouth:[{Expression:`Angry`,Duration:-1}],Eyes:[{Expression:`Angry`,Duration:-1}],Eyes2:[{Expression:`Angry`,Duration:-1}],Eyebrows:[{Expression:`Angry`,Duration:-1}]}},Sad:{Type:`Sad`,Duration:-1,Expression:{Mouth:[{Expression:`Frown`,Duration:-1}],Eyes:[{Expression:`Shy`,Duration:-1}],Eyes2:[{Expression:`Shy`,Duration:-1}],Eyebrows:[{Expression:`Soft`,Duration:-1}]}},Worried:{Type:`Worried`,Duration:-1,Expression:{Eyes:[{Expression:`Surprised`,Duration:-1}],Eyes2:[{Expression:`Surprised`,Duration:-1}],Eyebrows:[{Expression:`Soft`,Duration:-1}]}},Distressed:{Type:`Distressed`,Duration:-1,Expression:{Eyes:[{Expression:`Scared`,Duration:-1}],Eyes2:[{Expression:`Scared`,Duration:-1}],Eyebrows:[{Expression:`Soft`,Duration:-1}],Mouth:[{Expression:`Angry`,Duration:-1}]}},Reset:{Type:`Reset`,Duration:-1,Expression:{Mouth:[{Expression:null,Duration:-1}],Eyes:[{Expression:null,Duration:-1}],Eyes2:[{Expression:null,Duration:-1}],Eyebrows:[{Expression:null,Duration:-1}],Blush:[{Expression:null,Duration:-1}],Fluids:[{Expression:null,Duration:-1}]}},Cry:{Type:`Cry`,Duration:-1,Expression:{Fluids:[{Expression:`TearsMedium`,Duration:-1}]}},DroolReset:{Type:`DroolReset`,Duration:-1,Expression:{Fluids:[{Expression:null,Duration:-1}]}},DroolSides:{Type:`DroolSides`,Duration:-1,Expression:{Fluids:[{Expression:`DroolSides`,Duration:-1}]}},BareTeeth:{Type:`BareTeeth`,Duration:-1,Expression:{Mouth:[{Expression:`Angry`,Duration:-1}]}},Happy:{Type:`Happy`,Duration:-1,Expression:{Mouth:[{Expression:`Happy`,Duration:-1}]}},Frown:{Type:`Frown`,Duration:-1,Expression:{Mouth:[{Expression:`Frown`,Duration:-1}]}},Glare:{Type:`Glare`,Duration:-1,Expression:{Eyes:[{Expression:`Angry`,Duration:-1}],Eyes2:[{Expression:`Angry`,Duration:-1}],Eyebrows:[{Expression:`Harsh`,Duration:-1}]}},NarrowEyes:{Type:`NarrowEyes`,Duration:-1,Expression:{Eyes:[{Expression:`Horny`,Duration:-1}],Eyes2:[{Expression:`Horny`,Duration:-1}]}},OpenEyes:{Type:`OpenEyes`,Duration:-1,Expression:{Eyes:[{Expression:null,Duration:-1}],Eyes2:[{Expression:null,Duration:-1}]}},CloseEyes:{Type:`CloseEyes`,Duration:-1,Expression:{Eyes:[{Expression:`Closed`,Duration:-1}],Eyes2:[{Expression:`Closed`,Duration:-1}]}},CloseMouth:{Type:`CloseMouth`,Duration:-1,Expression:{Mouth:[{Expression:null,Duration:-1}]}},OpenMouth:{Type:`OpenMouth`,Duration:-1,Expression:{Mouth:[{Expression:`Moan`,Duration:-1}]}},LipBite:{Type:`LipBite`,Duration:-1,Expression:{Mouth:[{Expression:`LipBite`,Duration:-1}]}},Lick:{Type:`Lick`,Duration:4e3,Priority:200,Expression:{Mouth:[{Expression:`Ahegao`,Duration:4e3}],Blush:[{ExpressionModifier:1,Duration:4e3}]}},GagInflate:{Type:`GagInflate`,Duration:4e3,Priority:400,Expression:{Eyes:[{Expression:`Lewd`,Duration:4e3}],Eyes2:[{Expression:`Lewd`,Duration:4e3}],Blush:[{ExpressionModifier:2,Duration:2e3},{ExpressionModifier:-1,Duration:2e3}]}},Iced:{Type:`Iced`,Duration:4e3,Priority:500,Expression:{Eyes:[{Expression:`Surprised`,Duration:3e3},{Expression:null,Duration:1e3}],Eyes2:[{Expression:`Surprised`,Duration:3e3},{Expression:null,Duration:1e3}],Mouth:[{Expression:`Angry`,Duration:4e3}]}},AllFours:{Type:`AllFours`,Duration:-1,Poses:[{Pose:[`AllFours`],Duration:-1}]},SpreadKnees:{Type:`SpreadKnees`,Duration:-1,Poses:[{Pose:[`KneelingSpread`],Duration:-1}]},Hogtied:{Type:`Hogtied`,Duration:-1,Poses:[{Pose:[`Hogtied`],Duration:-1}]},Handstand:{Type:`Handstand`,Duration:-1,Poses:[{Pose:[`Suspension`,`OverTheHead`],Duration:-1}]},Stretch:{Type:`Stretch`,Priority:100,Duration:6e3,Poses:[{Pose:[`OverTheHead`],Duration:1e3},{Pose:[`Yoked`],Duration:1e3},{Pose:[`BaseUpper`],Duration:1e3},{Pose:[`Spread`],Duration:1e3},{Pose:[`LegsClosed`],Duration:1e3},{Pose:[`BaseLower`],Duration:1e3}]},SpreadLegs:{Type:`SpreadLegs`,Duration:-1,Poses:[{Pose:[`Spread`],Duration:-1}]},JumpingJacks:{Type:`JumpingJacks`,Priority:100,Duration:8e3,Poses:[{Pose:[`OverTheHead`,`Spread`],Duration:1e3},{Pose:[`BaseUpper`,`LegsClosed`],Duration:1e3},{Pose:[`OverTheHead`,`Spread`],Duration:1e3},{Pose:[`BaseUpper`,`LegsClosed`],Duration:1e3},{Pose:[`OverTheHead`,`Spread`],Duration:1e3},{Pose:[`BaseUpper`,`LegsClosed`],Duration:1e3},{Pose:[`OverTheHead`,`Spread`],Duration:1e3},{Pose:[`BaseUpper`,`LegsClosed`],Duration:1e3}]}},ht=[{Event:`Blush`,Type:`Activity`,Matchers:[{Tester:/^ChatOther-ItemMouth-PoliteKiss$/u}]},{Event:`Stretch`,Type:`Emote`,Matchers:[{Tester:/^stretches (her|his|their) whole body/u}]},{Event:`JumpingJacks`,Type:`Emote`,Matchers:[{Tester:/^does jumping[ -]?jacks/u}]},{Event:`AllFours`,Type:`Emote`,Matchers:[{Tester:/^(gets on all fours|starts crawling)/u}]},{Event:`SpreadKnees`,Type:`Emote`,Matchers:[{Tester:/^spreads(( (her|his|their) legs)? on)? (her|his|their) knees/u}]},{Event:`SpreadLegs`,Type:`Emote`,Matchers:[{Tester:/^spreads (her|his|their) legs apart/u}]},{Event:`Handstand`,Type:`Emote`,Matchers:[{Tester:/^(does a handstand|stands on (her|his|their) hands)/u}]},{Event:`Hogtied`,Type:`Emote`,Matchers:[{Tester:/^lies( down)? on (the floor|(her|his|their) (tummy|stomach))/u}]},{Event:`Blush`,Type:`Emote`,Matchers:[{Tester:/^blushes/u}]},{Event:`Chuckle`,Type:`Emote`,Matchers:[{Tester:/^chuckles/u}]},{Event:`Laugh`,Type:`Emote`,Matchers:[{Tester:/^laughs/u}]},{Event:`Giggle`,Type:`Emote`,Matchers:[{Tester:/^giggles/u}]},{Event:`Smirk`,Type:`Emote`,Matchers:[{Tester:/^(smirk(s|ing)|.*with a smirk)/u}]},{Event:`Wink`,Type:`Emote`,Matchers:[{Tester:/^winks/u}]},{Event:`Pout`,Type:`Emote`,Matchers:[{Tester:/^pouts/u}]},{Event:`Blink`,Type:`Emote`,Matchers:[{Tester:/^blinks/u}]},{Event:`Frown`,Type:`Emote`,Matchers:[{Tester:/^frowns/u}]},{Event:`Grin`,Type:`Emote`,Matchers:[{Tester:/^(grins|is grinning)/u}]},{Event:`Confused`,Type:`Emote`,Matchers:[{Tester:/^((seems|looks) (confused|curious|suspicious)|raises an eyebrow)/u}]},{Event:`CloseMouth`,Type:`Emote`,Matchers:[{Tester:/^closes (her|his|their) mouth/u}]},{Event:`OpenMouth`,Type:`Emote`,Matchers:[{Tester:/^opens (her|his|their) mouth/u}]},{Event:`Happy`,Type:`Emote`,Matchers:[{Tester:/^(looks|seems|is|gets|smiles) happ(il)?y/u}]},{Event:`Smile`,Type:`Emote`,Matchers:[{Tester:/^smiles/u}]},{Event:`Distressed`,Type:`Emote`,Matchers:[{Tester:/^(looks|seems|is|gets) distressed/u}]},{Event:`Sad`,Type:`Emote`,Matchers:[{Tester:/^(looks|seems|is|gets) sad/u}]},{Event:`Worried`,Type:`Emote`,Matchers:[{Tester:/^(looks|seems|is|gets) (worried|surprised)/u}]},{Event:`BareTeeth`,Type:`Emote`,Matchers:[{Tester:/^(bares (her|his|their) teeth|snarls)/u}]},{Event:`Angry`,Type:`Emote`,Matchers:[{Tester:/^(looks angr(il)?y|(gets|is|seems) angry)/u}]},{Event:`Glare`,Type:`Emote`,Matchers:[{Tester:/^(glares|looks harshly|gives a (glare|harsh look))/u}]},{Event:`OpenEyes`,Type:`Emote`,Matchers:[{Tester:/^opens (her|his|their) eyes/u}]},{Event:`NarrowEyes`,Type:`Emote`,Matchers:[{Tester:/^((squints|narrows) (her|his|their) eyes|narrowly opens (her|his|their) eyes)/u}]},{Event:`CloseEyes`,Type:`Emote`,Matchers:[{Tester:/^closes (her|his|their) eyes/u}]},{Event:`ResetBrows`,Type:`Emote`,Matchers:[{Tester:/^lowers (her|his|their) eyebrows/u}]},{Event:`RaiseBrows`,Type:`Emote`,Matchers:[{Tester:/^raises (her|his|their) eyebrows/u}]},{Event:`DroolSides`,Type:`Emote`,Matchers:[{Tester:/^drools/u}]},{Event:`Cry`,Type:`Emote`,Matchers:[{Tester:/^(starts to cry|sheds .* tears?|eyes( start( to)?)? leak)/u}]},{Event:`Reset`,Type:`Emote`,Matchers:[{Tester:/^'s (expression|face) returns to normal/u}]},{Event:`Shock`,Type:`Action`,Matchers:[{Tester:/^(ActionActivityShockItem|FuturisticVibratorShockTrigger|FuturisticChastityBeltShock\w+|(TriggerShock|(ShockCollar|Collar(Auto)?ShockUnit|(LoveChastityBelt|SciFiPleasurePanties)Shock)Trigger)(1|2))$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:`ShockLight`,Type:`Action`,Matchers:[{Tester:/^(TriggerShock|(ShockCollar|Collar(Auto)?ShockUnit|(LoveChastityBelt|SciFiPleasurePanties)Shock)Trigger)0$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:`Hit`,Type:`Action`,Matchers:[{Tester:/^ActionActivitySpankItem$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:`Spank`,Type:`Activity`,Matchers:[{Tester:/^ChatOther-ItemButt-Spank$/u,Criteria:{TargetIsPlayer:!0}},{Tester:/^ChatSelf-ItemButt-Spank$/u}]},{Event:`Cuddle`,Type:`Activity`,Matchers:[{Tester:/^ChatOther-.*-Cuddle$/u},{Tester:/^ChatSelf-.*-Cuddle$/u}]},{Event:`Stimulated`,Type:`Action`,Matchers:[{Tester:/^ActionActivityMasturbateItem$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:`StimulatedLong`,Type:`Activity`,Matchers:[{Tester:/^ChatOther-.*-(Masturbate|Penetrate).*$/u,Criteria:{TargetIsPlayer:!0}},{Tester:/^ChatSelf-.*-(Masturbate|Penetrate).*$/u}]},{Event:`KissOnLips`,Type:`Activity`,Matchers:[{Tester:/^ChatOther-ItemMouth-Kiss$/u}]},{Event:`Kiss`,Type:`Activity`,Matchers:[{Tester:/^ChatOther-.*-Kiss$/u,Criteria:{SenderIsPlayer:!0}}]},{Event:`Disoriented`,Type:`Action`,Matchers:[{Tester:/^(KneelDown|StandUp)Fail$/u}]},{Event:`LipBite`,Type:`Activity`,Matchers:[{Tester:/^ChatSelf-ItemMouth-Bite$/u}]},{Event:`Lick`,Type:`Activity`,Matchers:[{Tester:/^ChatOther-.*-(Lick|MasturbateTongue)$/u,Criteria:{SenderIsPlayer:!0}}]},{Event:`DroolReset`,Type:`Activity`,Matchers:[{Tester:/^ChatOther-ItemMouth-Caress$/u,Criteria:{TargetIsPlayer:!0}},{Tester:/^ChatSelf-ItemMouth-Caress$/u}]},{Event:`LongKiss`,Type:`Activity`,Matchers:[{Tester:/^ChatOther-ItemMouth-FrenchKiss$/u}]}];async function gt(){if(await s(()=>CurrentScreen===`ChatRoom`&&!!Player.ArousalSettings),!Player.ArousalSettings)throw Error(`Player.ArousalSettings is not defined`);U(`StruggleMinigameHandleExpression`,{'");':`", 3);`},`Resetting blush, eyes, and eyebrows after struggling`);function e(){return!!Z.animationEngine}globalThis.bceAnimationEngineEnabled=e,H.hookFunction(`StruggleMinigameStop`,V.ModifyBehaviourMedium,(e,t)=>(Z.animationEngine&&(StruggleExpressionStore=void 0,P([a],[o])),t(e))),globalThis.bce_ArousalExpressionStages||(globalThis.bce_ArousalExpressionStages=pt);let t=Object.freeze({Blush:[null,`Low`,`Medium`,`High`,`VeryHigh`,`Extreme`]}),n=`AutomatedByArousal`,r=`DEFAULT`,a=`GameTimer`,o=`ManualOverride`,u=`PostOrgasm`,p=[],m=0;function h(){return m=(m+1)%(2**53-1-1),m}let y={};function b(e){if(!e)return;switch(e.Type){case n:case u:if(!Z.expressions)return;break;case o:break;default:if(!Z.activityExpressions)return}let t=Date.now(),r=_(e);if(r.At=t,r.Until=t+r.Duration,r.Id=h(),typeof r.Priority!=`number`&&(r.Priority=1),r.Expression)for(let e of Object.values(r.Expression))for(let t of e)t.Id=h(),typeof t.Priority!=`number`&&(t.Priority=1),typeof t.Duration!=`number`&&(t.Duration=r.Duration);if(r.Poses)for(let e of r.Poses)e.Id=h(),typeof e.Priority!=`number`&&(e.Priority=1);p.push(r)}globalThis.fbcPushEvent=b,globalThis.bce_EventExpressions||(globalThis.bce_EventExpressions=mt),globalThis.bce_ActivityTriggers||(globalThis.bce_ActivityTriggers=ht);function x(e){return e?.some(e=>e&&`TargetCharacter`in e&&e.TargetCharacter===Player.MemberNumber)||!1}W(`ChatRoomMessage`,e=>{activityTriggers:for(let t of globalThis.bce_ActivityTriggers.filter(t=>t.Type===e.Type)){if(Player.GhostList.includes(e.Sender))break;for(let n of t.Matchers)if(n.Tester.test(e.Content)){if(n.Criteria){if(n.Criteria.SenderIsPlayer&&e.Sender!==Player.MemberNumber||n.Criteria.TargetIsPlayer&&!x(e.Dictionary)||n.Criteria.DictionaryMatchers&&!n.Criteria.DictionaryMatchers.some(t=>e.Dictionary?.find(e=>Object.keys(t).every(n=>t[n]===e[n]))))continue;b(globalThis.bce_EventExpressions[t.Event])}else if(e.Sender===Player.MemberNumber||x(e.Dictionary)){b(globalThis.bce_EventExpressions[t.Event]);break activityTriggers}}}});function C(e){let t=Player.Appearance.find(t=>t.Asset.Group.Name===e)?.Property??null;return[t?.Expression||null,!t?.RemoveTimer]}function w(e,t,n){t||=null;for(let r of Player.Appearance)if(r.Asset.Group.Name===e){r.Property||={},r.Property.Expression=t,n&&(r.Color=n);break}}let T={BodyFull:{Conflicts:[`BodyUpper`,`BodyLower`]},BodyUpper:{Conflicts:[`BodyFull`]},BodyLower:{Conflicts:[`BodyFull`]}};function D(e){return c(e)&&e in T}let O=[`Eyes`,`Eyes2`,`Eyebrows`,`Mouth`,`Fluids`,`Emoticon`,`Blush`,`Pussy`];b({Type:o,Duration:-1,Expression:O.map(e=>{let[t]=C(e);return[e,t]}).filter(e=>e[1]!==null).map(e=>[e[0],[{Expression:e[1]}]]).reduce((e,t)=>({...e,[t[0]]:t[1]}),{})});let k=0,A=0,j=!1,M=Player.ArousalSettings,N={None:0,Down:1,Up:2},ee=N.Up;function P(e,t=[]){if(delete Player.ExpressionQueue,p.push(...p.splice(0,p.length).map(r=>((e.includes(r.Type)||r.Duration<=0&&r.Type!==n&&!t.includes(r.Type))&&delete r.Expression,r))),!e.includes(o))b({Type:o,Duration:-1,Expression:v(y).reduce((e,[t,n])=>({...e,[t]:[{Expression:n}]}),{})});else for(let[e]of v(y))delete y[e]}CommandCombine([{Tag:`r`,Description:K(`[part of face or 'all']: resets expression overrides on part of or all of face`),Action:e=>{if(e.length===0||e===`all`)P([o]),S(K(`Reset all expressions`));else{let t=`${e[0].toUpperCase()}${e.substring(1).toLowerCase()}`;for(let e of p.map(e=>e.Expression).filter(Boolean))t===`Eyes`&&`Eyes2`in e&&delete e.Eyes2,t in e&&delete e[t];S(K(`Reset expression on $component`,{$component:t}))}}},{Tag:`anim`,Description:K(`['list' or name of emote]: run an animation`),Action:(e,t,n)=>{if(!Z.activityExpressions){S(K(`Activity expressions are not enabled in WCE settings. Unable to run animations.`));return}n[0]===`list`&&S(K(`Available animations: $anims`,{$anims:Object.keys(globalThis.bce_EventExpressions).join(`, `)}));let r=Object.keys(globalThis.bce_EventExpressions).find(e=>e.toLowerCase()===n[0]?.toLowerCase());r&&b(globalThis.bce_EventExpressions[r])}}]);function te(e){return PoseFemale3DCG.find(t=>t.Name===e)?.Category}function F(e){e=e.filter(e=>e).map(e=>e.toLowerCase()),p.forEach(e=>{e.Type===o?e.Poses=[]:e.Poses&&e.Poses.length>0&&e.Poses.forEach(e=>{if(e.Pose.length===0||typeof e.Pose[0]==`string`)return;let t=e.Pose;e.Pose=t.filter(e=>!!te(e))})});let t=PoseFemale3DCG.filter(t=>e.includes(t.Name.toLowerCase())).map(e=>e.Name);for(let e of t)PoseSetActive(Player,e,!1)}CommandCombine({Tag:`pose`,Description:K(`['list' or list of poses]: set your pose`),Action:(e,t,n)=>{if(n[0]===`list`){let e=[...new Set(PoseFemale3DCG.map(e=>e.Category))];for(let t of e){let e=PoseFemale3DCG.filter(e=>e.Category===t)?.map(e=>e.Name);e.sort(),S(`=> ${t}:\n${e.join(`
`)}\n\n`)}return}Z.animationEngine||S(K(`Warning: animation engine in WCE is disabled. Pose may not be synchronized or set. Enable animation engine in WCE settings.`)),F(n)}}),U(`TimerInventoryRemove`,{"CharacterSetFacialExpression(C, C.ExpressionQueue[0].Group, C.ExpressionQueue[0].Expression, undefined, undefined, true);":`if (bceAnimationEngineEnabled()) {
        fbcPushEvent({
          Type: "${a}",
          Duration: -1,
          Expression: {
            [C.ExpressionQueue[0].Group]: [{ Expression: C.ExpressionQueue[0].Expression, Duration: -1 }]
          }
        })
      } else {
        CharacterSetFacialExpression(C, C.ExpressionQueue[0].Group, C.ExpressionQueue[0].Expression, undefined, undefined, true);
      }`},`Game's timed expressions are not hooked to WCE's animation engine`),U(`ValidationSanitizeProperties`,{"delete property.Expression;":`delete property.Expression;
      if (bceAnimationEngineEnabled()) {
        if (item?.Asset?.Group?.Name) {
          CharacterSetFacialExpression(C, item.Asset.Group.Name, null);
          console.warn("(WCE) Animation engine acknowledged validation-based expression removal for face component", item)
        } else {
          console.warn("Unable to determine asset group name for item", item);
        }
      }`},`Prevent animation engine from getting into an endless loop when another addon includes an invalid expression`),H.hookFunction(`CharacterSetFacialExpression`,V.OverrideBehaviour,(e,t)=>{let[n,r,i,a,s]=e;if(!d(n)||!c(r)||!c(i)&&i!==null||!n.IsPlayer()||!Z.animationEngine)return t(e);let l=typeof a==`number`&&a>0?a*1e3:-1,u={},p=[];p=r===`Eyes`?[`Eyes`,`Eyes2`]:r===`Eyes1`?[`Eyes`]:[r],(!s||!f(s)||!CommonColorIsValid(s))&&(s=void 0);for(let e of p)u[e]=[{Expression:i,Duration:l,Color:s}],l<0&&(y[e]=i);let m={Type:o,Duration:l,Expression:u};return b(m),ne()});let I=[`CharacterSetActivePose`,`PoseSetActive`];for(let e of I)H.hookFunction(e,V.OverrideBehaviour,(e,t)=>{let[n,r]=e;if(!d(n)||!f(r)&&r!==null||!n.IsPlayer()||!Z.animationEngine)return t(e);let i={};!r||Array.isArray(r)&&r.every(e=>!e)?i.Pose=[`BaseUpper`,`BaseLower`]:i.Pose=[r],i.Duration=-1;let a={Type:o,Duration:-1,Poses:[i]};return b(a),ne()});W(`ChatRoomSyncPose`,e=>{if(!(e===null||!l(e))){if(!Array.isArray(e.Pose)){i(`data.Pose in ChatRoomSyncPose for ${e.MemberNumber?.toString()} is not an array`);return}Z.animationEngine&&e.MemberNumber===Player.MemberNumber&&F(e.Pose)}}),W(`ChatRoomSyncSingle`,e=>{e===null||!l(e)||Z.animationEngine&&e.Character?.MemberNumber===Player.MemberNumber&&F(e.Character.ActivePose??[])}),P([o,a]);function ne(){if(!Z.animationEngine||!Player?.AppearanceLayers)return;if(Player.Appearance.filter(e=>O.includes(e.Asset.Group.Name)&&e.Property?.RemoveTimer).forEach(e=>{delete e.Property.RemoveTimer}),!Player.ArousalSettings){i(`Player.ArousalSettings is not defined`);return}Player.ArousalSettings.AffectExpression=!1;let e=Player.ArousalSettings.OrgasmCount??0;A<e?A=e:A>e&&(Player.ArousalSettings.OrgasmCount=A,ActivityChatRoomArousalSync(Player));let a=!0;for(let e of O)C(e)[0]&&(a=!1);if(a){if(M.Progress=0,ee=N.Up,!j)for(let e of p){if(e.Type===n)continue;e.Expression={}}j=!0}else j=!1;let s=Player.ArousalSettings.Progress,c=ee;s<M.Progress?c=N.Down:s>M.Progress&&(c=N.Up),ee=c;function l(){let e=90,t=30,n=Player.ArousalSettings?.OrgasmCount||0,r=Math.min(300,60+n*5),i=(Date.now()-k)/1e4|0;return i>r?0:Math.min(Math.max(0,e-s),t*(r-i)/r)}let d=2;M.OrgasmStage!==d&&Player.ArousalSettings.OrgasmStage===d&&p.filter(e=>e.Type===u).length===0&&(b(globalThis.bce_EventExpressions.PostOrgasm),k=Date.now());let f={},m={},_={};function y(e,t,n,r){let i=t.Priority||n.Priority||0;(!_[r]||(_[r].Priority??0)<=i)&&(_[r]={Id:t.Id,Expression:e,Duration:t.Duration,Priority:i,Color:t.Color})}for(let e=0;e<p.length;e++){let n=p[e],a=n.Until??0,o=n.At??0,s=!1;if(a>Date.now()||a-o<0){let r=n.Expression??{};if(Object.keys(r).length>0)for(let i of Object.keys(r)){let a=Date.now()-o;for(let o=0;o<r[i].length;o++){let c=r[i][o];if(a-=c.Duration,a<0||c.Duration<0){if(s=!0,!c.Skip)if(c.ExpressionModifier&&i in t){let[r]=C(i);if(c.Applied)y(r,c,n,i);else{let a=t[i].indexOf(r)+c.ExpressionModifier;a>=t[i].length?a=t[i].length-1:a<0&&(a=0),y(t[i][a],c,n,i),p[e].Expression[i][o].Applied=!0}}else y(c.Expression??null,c,n,i);break}}}if(n.Poses?.length){let e=Date.now()-o;for(let t of n.Poses)if(e-=t.Duration,e<0||t.Duration<0){s=!0;for(let e of t.Pose){let r=t.Priority||n.Priority||0,a=te(e);if(!a){i(`Pose ${e} has no category`);continue}t.Id||(i(`Pose ${e} has no ID`),t.Id=h()),(!m[a]||m[a].Priority<=r)&&(m[a]={Id:t.Id,Pose:e,Category:a,Duration:t.Duration,Priority:r,Type:n.Type})}break}}}if(!s){let t=p.splice(e,1);if(e--,!Z.expressions&&t.length>0&&t[0].Expression)for(let e of Object.keys(t[0].Expression))y(null,{Duration:-1},{Priority:0,Type:r,Duration:500},e)}}for(let e=0;e<p.length;e++){let t=p[e].Expression,n=p[e].Poses;if(t)for(let e of Object.keys(t)){if(!_[e]||_[e].Duration>0)continue;let n=g(_[e].Id),r=g(_[e].Priority,0);for(let i=0;i<t[e].length;i++){let a=t[e][i];a.Duration<0&&(g(a.Id)<n||g(a.Priority,0)<r)&&(t[e].splice(i,1),i--)}t[e].length===0&&delete t[e]}if(n)for(let t=0;t<n.length;t++){let r=n[t],i=r.Pose,a=i.every(t=>{let n=te(t);return!!n&&m[n]?.Duration<0&&m[n]?.Id>g(r.Id)&&(m[n]?.Type===o||p[e].Type!==o)});r.Duration<0&&a&&(n.splice(t,1),t--)}Object.keys(p[e].Expression||{}).length===0&&p[e].Poses?.length===0&&(p.splice(e,1),e--)}let x=!1,S=!1;if(Player.ActivePose)for(let e=0;e<Player.ActivePose.length;e++){let t=Player.ActivePose[e],n=PoseFemale3DCG.find(e=>e.Name===t);!n?.Category&&Object.values(m).every(e=>e.Pose!==t)&&(S=[...Player.ActivePose],S.splice(e,1),e--,x=!0)}outer:for(let e of Object.keys(globalThis.bce_ArousalExpressionStages)){let[t]=C(e),r=null,i=!1;for(let n of globalThis.bce_ArousalExpressionStages[e]){let e=n.Limit-(c===N.Up?0:1);if(s+l()>=e)if(n.Expression!==t){r=n.Expression,i=!0;break}else continue outer}if(i){let t={};t[e]=[{Expression:r,Duration:-1,Priority:0}],b({Type:n,Duration:-1,Priority:0,Expression:t})}}for(let e of O){let[t]=C(e),n=_[e]||{Duration:-1,Expression:null};n.Expression!==t&&n.Expression!==void 0&&(f[e]={...n})}if(Object.keys(f).length>0){for(let e of Object.keys(f)){if(G?.getRuleState(`block_changing_emoticon`)?.isEnforced&&e===`Emoticon`)continue;w(e,f[e].Expression??null,f[e].Color),ServerSend(`ChatRoomCharacterExpressionUpdate`,{Name:f[e].Expression??null,Group:e,Appearance:ServerAppearanceBundle(Player.Appearance)})}x=!0}function P(){let e=Math.max(...Object.values(m).map(e=>e.Priority)),t=v(m).filter(t=>t[1].Priority===e),n=``;if(t.length>1){let e=Math.max(...t.map(e=>e[1].Id)),r=t.filter(t=>t[1].Id===e);[[n]]=r}else if(t.length===0)return 0;else [[n]]=t;let r=0;if(D(n)){let e=T[n].Conflicts||[];for(let t of Array.from(e).filter(e=>e in m))delete m[t],r++}return r}for(;P()>0;);Object.keys(m).length===0&&(m={BodyUpper:{Pose:`BaseUpper`,Duration:-1,Id:h(),Priority:0,Type:r},BodyLower:{Pose:`BaseLower`,Duration:-1,Id:h(),Priority:0,Type:r}});let F=/^Base(Lower|Upper)$/u,I=Object.values(m).map(e=>e.Pose).filter(e=>!F.test(e));JSON.stringify(Player.ActivePose)!==JSON.stringify(I)&&(S=I,x=!0),S&&(Player.ActivePose=S,ServerSend(`ChatRoomCharacterPoseUpdate`,{Pose:S})),x&&CharacterRefresh(Player,!1,!1),M={...Player.ArousalSettings}}J(ne,250)}async function _t(){await s(()=>!!ServerSocket&&ServerIsConnected),Player.BCEArousalProgress=Math.min(F,Player.ArousalSettings?.Progress??0),Player.BCEEnjoyment=1;let e=.2;W(`ChatRoomSyncArousal`,e=>{if(e.MemberNumber===Player.MemberNumber)return;let t=ChatRoomCharacter.find(t=>t.MemberNumber===e.MemberNumber);t&&queueMicrotask(()=>{if(t.BCEArousalProgress=Math.min(F,e.Progress||0),!t?.ArousalSettings){i(`No arousal settings found for`,t);return}t.ArousalSettings.Progress=Math.round(t.BCEArousalProgress)})}),U(`ActivitySetArousalTimer`,{"if (Progress > 0 && (C.ArousalSettings.Progress + Progress) > Max)\n		Progress = (Max - C.ArousalSettings.Progress >= 0) ? Max - C.ArousalSettings.Progress : 0;":`
      if (!C.BCEArousal) {
        if ((Progress > 0) && (C.ArousalSettings.Progress + Progress > Max)) Progress = (Max - C.ArousalSettings.Progress >= 0) ? Max - C.ArousalSettings.Progress : 0;
      } else {
        if (Max === 100) Max = 105;
        const fromMax = Max - (C.BCEArousal ? C.BCEArousalProgress : C.ArousalSettings.Progress);
        if (Progress > 0 && fromMax < Progress) {
          if (fromMax <= 0) {
            Progress = 0;
          } else if (C.BCEArousal) {
            Progress = Math.floor(fromMax / ${e} / (C.BCEEnjoyment || 1));
          } else {
            Progress = fromMax;
          }
        }
      }
    `,"if (Progress < -25) Progress = -25;":`
      if (!C.BCEArousal) {
        if (Progress < -25) Progress = -25;
      } else {
        if (Progress < -20) Progress = -20;
      }
      `,"if (Progress > 25) Progress = 25;":`
      if (!C.BCEArousal) {
        if (Progress > 25) Progress = 25;
      } else {
        if (Progress > 20) Progress = 20;
      }
      `},`Alternate arousal algorithm will be incorrect.`),H.hookFunction(`ActivityChatRoomArousalSync`,V.Observe,(e,t)=>{let[n]=e;if(d(n)&&n.IsPlayer()&&CurrentScreen===`ChatRoom`){let e={Type:z,Content:I,Dictionary:[{message:{type:B.ArousalSync,version:A,alternateArousal:Z.alternateArousal,progress:n.BCEArousalProgress,enjoyment:n.BCEEnjoyment}}]};ServerSend(`ChatRoomChat`,e)}return t(e)}),H.hookFunction(`ActivitySetArousal`,V.AddBehaviour,(e,t)=>{let[n,r]=e,i=t(e);return d(n)&&typeof r==`number`&&Math.abs(n.BCEArousalProgress-r)>3&&(n.BCEArousalProgress=Math.min(F,r)),i}),H.hookFunction(`ActivitySetArousalTimer`,V.AddBehaviour,(e,t)=>{let[n,,,r]=e;return d(n)&&typeof r==`number`&&(n.BCEEnjoyment=1+(r>1?Math.round(Math.log2(r)):0)),t(e)}),H.hookFunction(`ActivityTimerProgress`,V.AddBehaviour,(t,n)=>{let[r,i]=t;if(d(r)&&typeof i==`number`&&(r.BCEArousalProgress||=0,r.BCEEnjoyment||=1,r.BCEArousalProgress+=i*(i>0?r.BCEEnjoyment*e:1),r.BCEArousalProgress=Math.min(F,r.BCEArousalProgress),r.BCEArousal)){if(!r.ArousalSettings)throw Error(`No arousal settings found for ${r.Name}`);return r.ArousalSettings.Progress=Math.round(r.BCEArousalProgress),t[1]=0,n(t)}return n(t)}),U(`TimerProcess`,{"// If the character is egged, we find the highest intensity factor and affect the progress, low and medium vibrations have a cap\n							let Factor = -1;":`
      let Factor = -1;
      if (Character[C].BCEArousal) {
        let maxIntensity = 0;
        let vibes = 0;
        let noOrgasmVibes = 0;
        for (let A = 0; A < Character[C].Appearance.length; A++) {
          let Item = Character[C].Appearance[A];
          let ZoneFactor = PreferenceGetZoneFactor(Character[C], Item.Asset.ArousalZone) - 2;
          if (InventoryItemHasEffect(Item, "Egged", true) && typeof Item.Property?.Intensity === "number" && !isNaN(Item.Property.Intensity) && Item.Property.Intensity >= 0 && ZoneFactor >= 0) {
            if (Item.Property.Intensity >= 0) {
              vibes++;
              if (!PreferenceGetZoneOrgasm(Character[C], Item.Asset.ArousalZone)) {
                noOrgasmVibes++;
              }
              maxIntensity = Math.max(Item.Property.Intensity, maxIntensity);
              Factor += Item.Property.Intensity + ZoneFactor + 1;
            }
          }
        }
        // Adds the fetish value to the factor
        if (Factor >= 0) {
          var Fetish = ActivityFetishFactor(Character[C]);
          if (Fetish > 0) Factor = Factor + Math.ceil(Fetish / 3);
          if (Fetish < 0) Factor = Factor + Math.floor(Fetish / 3);
        }

        let maxProgress = 100;
        switch (maxIntensity) {
          case 0:
            maxProgress = 40 + vibes * 5;
            break;
          case 1:
            maxProgress = 70 + vibes * 5;
            break;
          default:
            maxProgress = vibes === 0 || vibes > noOrgasmVibes ? 100 : 95;
            break;
        }
        const topStepInterval = 2;
        let stepInterval = topStepInterval;
        if (Factor < 0) {
          ActivityVibratorLevel(Character[C], 0);
        } else {
          if (Factor < 1) {
            ActivityVibratorLevel(Character[C], 1);
            maxProgress = Math.min(maxProgress, 35);
            stepInterval = 5;
          } else if (Factor < 2) {
            ActivityVibratorLevel(Character[C], 1);
            maxProgress = Math.min(maxProgress, 65);
            stepInterval = 4;
          } else if (Factor < 3) {
            maxProgress = Math.min(maxProgress, 95);
            stepInterval = 3;
            ActivityVibratorLevel(Character[C], 2);
          } else {
            ActivityVibratorLevel(Character[C], Math.min(4, Math.floor(Factor)));
          }
          if (maxProgress === 100) {
            maxProgress = 105;
          }
          let maxIncrease = maxProgress - Character[C].ArousalSettings.Progress;
          if (TimerLastArousalProgressCount % stepInterval === 0 && maxIncrease > 0) {
            Character[C].BCEEnjoyment = 1 + (Factor > 1 ? Math.round(1.5*Math.log2(Factor)) : 0);
            ActivityTimerProgress(Character[C], 1);
          }
        }
      } else {
      `,"if ((Factor == -1)) {ActivityVibratorLevel(Character[C], 0);}\n\n						}":`if (Factor == -1) {
          ActivityVibratorLevel(Character[C], 0);
        }
      }
    } else {
      ActivityVibratorLevel(Character[C], 0);
    }
    `,"// No decay if there's a vibrating item running":`// No decay if there's a vibrating item running
    Character[C].BCEEnjoyment = 1;`},`Alternative arousal algorithm will be incorrect.`)}async function vt(){await s(()=>!!ServerSocket&&ServerIsConnected),W(`ChatRoomSyncMemberJoin`,e=>{Z.ghostNewUsers&&Date.now()-e.Character.Creation<3e4&&(ChatRoomListManipulation(Player.BlackList,!0,e.Character.MemberNumber.toString()),Player.GhostList||(Player.GhostList=[]),ChatRoomListManipulation(Player.GhostList,!0,e.Character.MemberNumber.toString()),n(`Blacklisted`,e.Character.Name,CharacterNickname(CharacterLoadOnline(e.Character,e.SourceMemberNumber)),e.Character.MemberNumber,`registered`,(Date.now()-e.Character.Creation)/1e3,`seconds ago`))})}async function yt(){await s(()=>!!Player&&!!Player.Appearance);function e(){let e=[`Glasses1`,`Glasses2`,`Glasses3`,`Glasses4`,`Glasses5`,`Glasses6`,`SunGlasses1`,`SunGlasses2`,`SunGlassesClear`,`CatGlasses`,`Goggles`,`VGlasses`,`GradientSunglasses`,`JokeGlasses`,`StreetEyewear`,`Pincenez`,`FuturisticVisor`,`InteractiveVisor`,`InteractiveVRHeadset`,`FuturisticMask`],t=!!Player.Appearance.find(t=>e.includes(t.Asset.Name));t?D(`BlurLight`)&&S(K(`Having recovered your glasses you can see again!`)):T(`BlurLight`)&&S(K(`Having lost your glasses your eyesight is impaired!`))}H.hookFunction(`CharacterAppearanceBuildCanvas`,V.Observe,(t,n)=>(Z.blindWithoutGlasses&&t[0].IsPlayer()&&e(),n(t)))}const bt=Object.freeze({FriendList:`FriendList`});async function xt(){await s(()=>!!Player&&ServerSocket&&ServerIsConnected);function e(){!Z.friendPresenceNotifications&&!Z.instantMessenger||CurrentScreen===`FriendList`||CurrentScreen===`Relog`||CurrentScreen===`Login`||ServerSend(`AccountQuery`,{Query:`OnlineFriends`})}J(e,2e4);let t=[];W(`AccountQueryResult`,e=>{if(CurrentScreen===`FriendList`||CurrentScreen===`Relog`||CurrentScreen===`Login`||!Z.friendPresenceNotifications||e.Query!==`OnlineFriends`)return;let n=e.Result.map(e=>e.MemberNumber),r=t.map(e=>e.MemberNumber).filter(e=>!n.includes(e)),i=n.filter(e=>!t.some(t=>t.MemberNumber===e));if(i.length){let t=i.map(t=>{let{MemberNumber:n,MemberName:r}=e.Result.find(e=>e.MemberNumber===t)??{MemberName:``,MemberNumber:-1};return`${r} (${n})`}).join(`, `);Z.friendNotificationsInChat&&CurrentScreen===`ChatRoom`?S(K(`Now online: $list`,{$list:t})):C(K(`Now online: $list`,{$list:t}),5e3,{ClickAction:bt.FriendList})}if(Z.friendOfflineNotifications&&r.length){let e=r.map(e=>{let{MemberNumber:n,MemberName:r}=t.find(t=>t.MemberNumber===e)??{MemberName:``,MemberNumber:-1};return`${r} (${n})`}).join(`, `);Z.friendNotificationsInChat&&CurrentScreen===`ChatRoom`?S(K(`Now offline: $list`,{$list:e})):C(K(`Now offline: $list`,{$list:e}),5e3,{ClickAction:bt.FriendList})}t=e.Result})}function St(){let e=new Map;function t(e,t){return!t.Name||!t.Property?.LockedBy||t.Property?.LockMemberNumber===e.MemberNumber?!0:(n(`Bad lock member number`,t.Property?.LockMemberNumber,`from`,e.MemberNumber),!1)}function r(e,r,i,a,o){let s={changed:0,prohibited:!1};if(e.IsPlayer())return s;let c=`${CharacterNickname(e)} (${e.MemberNumber??`-1`})`;function l(e){if(!e)return e;let t=_(e);return t&&(t.Property&&(a&&(delete t.Property.LockMemberNumber,delete t.Property.LockedBy,delete t.Property.RemoveTimer,delete t.Property.Effect),delete t.Property.BlinkState),o&&delete t.Color,t)}function u(){let t=(e?.Reputation?.find(e=>e.Type===`Dominant`)?.Value??0)>=50||e.Title===`Mistress`;t||e.MemberNumber===Player.Ownership?.MemberNumber||Player.Lovership?.some(t=>t.MemberNumber===e.MemberNumber)||((r?.Property?.LockedBy===`MistressPadlock`&&i?.Property?.LockedBy!==`MistressPadlock`||r?.Property?.LockedBy===`MistressTimerPadlock`&&i?.Property?.LockedBy!==`MistressTimerPadlock`)&&(n(`Not a mistress attempting to remove mistress lock`,c),s.prohibited=!0),(r?.Property?.LockedBy!==`MistressPadlock`&&i?.Property?.LockedBy===`MistressPadlock`||r?.Property?.LockedBy!==`MistressTimerPadlock`&&i?.Property?.LockedBy===`MistressTimerPadlock`)&&(n(`Not a mistress attempting to add mistress lock`,c),s.prohibited=!0),r?.Property?.LockedBy===`MistressTimerPadlock`&&Math.abs(g(r.Property?.RemoveTimer,2**53-1)-g(i?.Property?.RemoveTimer))>31*60*1e3&&(s.prohibited=!0,n(`Not a mistress attempting to change mistress lock timer more than allowed by public entry`,c)))}return i&&i.Property?.LockMemberNumber!==r?.Property?.LockMemberNumber&&(t(e,i)||(s.prohibited=!0)),u(),i=l(i),r=l(r),JSON.stringify(i)!==JSON.stringify(r)&&(n(c,`changed`,JSON.stringify(r),`to`,JSON.stringify(i),`changes:`,s),s.changed++),s}function i(t){if(typeof t.MemberNumber!=`number`)throw Error(`change from invalid source character with no member number`);let r=`${CharacterNickname(t)} (${t.MemberNumber??`-1`})`;n(`Rejected changes from`,r),S(K(`[Anti-Cheat] ${r} tried to make suspicious changes! Appearance changes rejected. Consider telling the user to stop, whitelisting the user (if trusted friend), or blacklisting the user (if the behaviour continues, chat command: "/blacklistadd ${t.MemberNumber}").`));let i=e.get(t.MemberNumber)||0;Date.now()-i>1e3*60*10&&(e.set(t.MemberNumber,Date.now()),w(K(`A magical shield on ${CharacterNickname(Player)} repelled the suspiciously magical changes attempted by ${r}! [WCE Anti-Cheat]`))),Z.antiCheatBlackList&&!Player.WhiteList.includes(t.MemberNumber)&&!Player.BlackList.includes(t.MemberNumber)&&(ChatRoomListManipulation(Player.BlackList,!0,t.MemberNumber.toString()),S(K(`[AntiCheat] ${r} blacklisted.`))),ChatRoomCharacterUpdate(Player)}H.hookFunction(`ChatRoomSyncItem`,V.OverrideBehaviour,(e,t)=>{let[n]=e;if(!Z.itemAntiCheat)return t(e);let a=n?.Item;if(a?.Target!==Player.MemberNumber||Player.WhiteList.includes(n.Source))return t(e);let o=ChatRoomCharacter.find(e=>e.MemberNumber===n.Source)||(n.Source===Player.MemberNumber?Player:null);if(!o)throw Error(`change from invalid source character not in the current room`);let s=Player.Appearance.some(e=>e.Asset.Name===`FuturisticCollar`),c=Player.Appearance.some(e=>e.Asset.Name===`FuturisticHarness`)||s,l=Player.Appearance.find(e=>e.Asset.Group.Name===a.Group),u=l?ServerAppearanceBundle([l])[0]:null,d=r(o,u,a,s,c);return d.prohibited?(i(o),null):t(e)}),H.hookFunction(`ChatRoomSyncSingle`,V.OverrideBehaviour,(e,a)=>{let[o]=e;if(!Z.itemAntiCheat||!o?.Character||o.Character.MemberNumber!==Player.MemberNumber||Player.WhiteList.includes(o.SourceMemberNumber))return a(e);let s=ChatRoomCharacter.find(e=>e.MemberNumber===o.SourceMemberNumber)||(o.SourceMemberNumber===Player.MemberNumber?Player:null);if(!s)throw Error(`change from invalid source character not in the current room`);if(s.IsPlayer())return a(e);function c(e){let t=new Map;return e.reduce((e,t)=>(t=_(t),delete t.Color,e.set(`${t.Group}/${t.Name}`,t),e),t)}let l=c(ServerAppearanceBundle(Player.Appearance.filter(e=>e.Asset.Group.Category===`Item`)));if(!o.Character.Appearance)throw Error(`no appearance data in sync single`);let u=c(o.Character.Appearance.filter(e=>ServerBundledItemToAppearanceItem(`Female3DCG`,e)?.Asset.Group.Category===`Item`)),d=Array.from(l.values()).some(e=>e.Name===`FuturisticCollar`)&&Array.from(u.values()).some(e=>e.Name===`FuturisticCollar`),f=Array.from(l.values()).some(e=>e.Name===`FuturisticHarness`)&&Array.from(u.values()).some(e=>e.Name===`FuturisticHarness`)||d;n(`Anti-Cheat validating bulk change from`,s.MemberNumber);let p=Array.from(u.keys()).reduce((e,n)=>{let i=u.get(n);if(!i)throw Error(`this should never happen: newItem is null inside map loop`);if(!l.has(n))return t(s,i)||(e.prohibited=!0),e.new++,e;let a=l.get(n)??null,o=r(s,a,i,d,f);return e.prohibited=e.prohibited||o.prohibited,e.changed+=o.changed,e},{new:0,changed:0,prohibited:!1}),m=Array.from(l.keys()).reduce((e,t)=>u.has(t)?e:e+1,0);return p.new+p.changed+m>2||p.prohibited?(n(`Anti-Cheat tripped on bulk change from`,s.MemberNumber,p,m),i(s),null):a(e)})}function Ct(){U(`ChatSearchQuery`,{"// Prevent spam searching the same thing.":`if (ChatRoomJoinLeash) { SearchData.Language = ""; }
	// Prevent spam searching the same thing.`},`Leashing between language filters`)}function wt(){function e(e){return e.split(``)[0].trimEnd()}globalThis.bceStripBeepMetadata=e;let t=document.createElement(`div`);t.classList.add(`bce-hidden`),t.id=`bce-instant-messenger`;let r=document.createElement(`div`);r.id=`bce-message-left-container`;let i=document.createElement(`div`);i.id=`bce-friend-list`;let a=document.createElement(`div`);a.id=`bce-message-right-container`;let o=document.createElement(`div`);o.id=`bce-message-container`;let s=document.createElement(`textarea`);s.id=`bce-message-input`,s.setAttribute(`maxlength`,`2000`),s.addEventListener(`keydown`,e=>{e.stopPropagation()});let u=document.createElement(`input`);u.id=`bce-friend-search`,u.setAttribute(`placeholder`,K(`Search for a friend`)),u.autocomplete=`off`,u.addEventListener(`keydown`,e=>{e.stopPropagation()});let d=`bce-friend-list-handshake-completed`,f=`bce-friend-list-handshake-false`;t.appendChild(r),t.appendChild(a),r.appendChild(u),r.appendChild(i),a.appendChild(o),a.appendChild(s),document.body.appendChild(t);function p(){return`bce-instant-messenger-state-${Player.AccountName.toLowerCase()}`}let m=-1,h=0,g=!1,_=new Map;function b(){let e=_.get(m);e&&(e.history.scrollTop=e.history.scrollHeight)}function x(){let e={};_.forEach((t,n)=>{if(t.historyRaw.length===0)return;let r=Math.min(t.historyRaw.length,100);e[n]={historyRaw:t.historyRaw.slice(-r)}}),localStorage.setItem(p(),JSON.stringify(e))}function S(e){let t=_.get(e);s.disabled=!t?.online,o.innerHTML=``;for(let e of _.values())e.listElement.classList.remove(`bce-friend-list-selected`);t&&(t.listElement.classList.add(`bce-friend-list-selected`),t.listElement.classList.remove(`bce-friend-list-unread`),o.appendChild(t.history),t.unread=0);let n=_.get(m);if(n){let e=n.history.querySelector(`.bce-message-divider`);e&&n.history.removeChild(e)}O(),m=e,b()}function w(e,r,i,a,o){let s=_.get(e);if(!s||i.BeepType)return;let c=y(i.Message?.split(`
`).find(e=>e.startsWith(``))?.substring(1)??`{}`)??{messageType:`Message`};c.messageType||=`Message`;let l=[`Message`,`Emote`,`Action`].includes(c.messageType)?c.messageType:`Message`,u=c?.messageColor??`#ffffff`,d=i.Message?.split(`
`).filter(e=>!e.startsWith(``)).join(`
`).trimEnd();if(!d){n(`skipped empty beep`,e,i,r,a);return}let f=s.history.scrollHeight-s.history.scrollTop-s.history.clientHeight<1,p=document.createElement(`div`);p.classList.add(`bce-message`),p.classList.add(r?`bce-message-sent`:`bce-message-received`),p.classList.add(`bce-message-${l}`),p.setAttribute(`data-time`,o.toLocaleString());let g=r?CharacterNickname(Player):i.MemberName??`<Unknown>`;switch(l){case`Emote`:p.textContent=`*${g}${d}*`;break;case`Action`:p.textContent=`*${d}*`;break;case`Message`:{let e=document.createElement(`span`);e.classList.add(`bce-message-sender`),u&&(e.style.color=u),e.textContent=`${g}: `,p.appendChild(e),p.appendChild(document.createTextNode(d))}break;default:p.textContent=d;break}if(!Player.MemberNumber)throw Error(`Player.MemberNumber is invalid`);let v=Player.MemberNumber;if(!r){if(!i.MemberNumber)throw Error(`beep.MemberNumber is invalid`);v=i.MemberNumber}if(!a){if(s.historyRaw.push({author:g,authorId:v,message:d,type:l,color:u,createdAt:Date.now()}),s.listElement.setAttribute(`data-last-updated`,Date.now().toString()),e!==m&&(s.listElement.classList.add(`bce-friend-list-unread`),s.unread++),s.unread===1&&(t.classList.contains(`bce-hidden`)||e!==m)){let e=document.createElement(`div`);e.classList.add(`bce-message-divider`),s.history.appendChild(e)}t.classList.contains(`bce-hidden`)&&h++}Ne(p,f?b:()=>null),s.history.appendChild(p),f&&b(),x()}function T(e){let t=_.get(e);if(!t){let n={statusText:document.createElement(`span`),listElement:document.createElement(`div`),historyRaw:[],history:document.createElement(`div`),unread:0,online:!1};n.listElement.id=`bce-friend-list-entry-${e}`,n.listElement.classList.add(`bce-friend-list-entry`),n.listElement.onclick=()=>{S(e)},n.history.classList.add(`bce-friend-history`);let r=document.createElement(`div`);r.classList.add(`bce-friend-list-entry-name`),r.textContent=Player.FriendNames?.get(e)||``,n.listElement.appendChild(r);let a=document.createElement(`div`);a.classList.add(`bce-friend-list-entry-member-number`),a.textContent=e.toString(),n.listElement.appendChild(a),n.listElement.appendChild(n.statusText),i.appendChild(n.listElement),_.set(e,n),t=n}return t}function D(){g=!0;let e=y(localStorage.getItem(p())||`{}`);for(let[t,n]of v(e)){let e=parseInt(t),r=T(e);r.historyRaw=n.historyRaw;for(let t of n.historyRaw)w(e,t.authorId===Player.MemberNumber,{Message:`${t.message}\n\n\uf124${JSON.stringify({messageType:t.type,messageColor:t.color})}`,MemberNumber:t.authorId,MemberName:t.author},!0,t.createdAt?new Date(t.createdAt):new Date(0)),t.createdAt&&r.listElement.setAttribute(`data-last-updated`,t.createdAt.toString())}}s.addEventListener(`keydown`,e=>{if(e.key===`Enter`&&!e.shiftKey){if(e.preventDefault(),G?.getRuleState(`speech_restrict_beep_send`)?.isEnforced&&!Z.allowIMBypassBCX){C(K(`Sending beeps is currently restricted by BCX rules`));return}let t=s.value;if(t.trim()===``)return;s.value=``;let n=`Message`;t.startsWith(`/me `)?(t=t.substring(4),/^[', ]/u.test(t)||(t=` ${t}`),n=`Emote`):t.startsWith(`/action `)?(t=t.substring(8),n=`Action`):/^\*[^*]/u.test(t)?(t=t.substring(1),/^[', ]/u.test(t)||(t=` ${t}`),n=`Emote`):t.startsWith(`**`)&&(t=t.substring(2),n=`Action`);let r={BeepType:``,MemberNumber:m,IsSecret:!0,Message:`${t}\n\n\uf124${JSON.stringify({messageType:n,messageColor:Player.LabelColor})}`};w(m,!0,r,!1,new Date),FriendListBeepLog.push({...r,MemberName:Player.FriendNames?.get(m)||`aname`,Sent:!0,Private:!1,Time:new Date}),ServerSend(`AccountBeep`,r)}}),u.onkeyup=()=>{let e=u.value.toLowerCase();for(let t of _.keys()){let n=_.get(t);if(!n)throw Error(`this should never happen, friend is null in map loop`);let r=Player.FriendNames?.get(t)?.toLowerCase();e===``?n.listElement.classList.remove(`bce-hidden`):!t.toString().includes(e)&&!r?.includes(e)?n.listElement.classList.add(`bce-hidden`):n.listElement.classList.remove(`bce-hidden`)}O()},W(`AccountQueryResult`,e=>{if(e.Query===`OnlineFriends`&&e.Result&&Z.instantMessenger){for(let t of e.Result){let e=T(t.MemberNumber);e.online=!0,e.statusText.textContent=K(`Online`),e.listElement.classList.remove(f),e.listElement.classList.add(d)}for(let t of Array.from(_.keys()).filter(t=>!e.Result.some(e=>e.MemberNumber===t))){let e=_.get(t);if(!e)throw Error(`this should never happen, f is null in map loop`);e.online=!1,e.statusText.textContent=K(`Offline`),e.listElement.classList.remove(d),e.listElement.classList.add(f)}e.Result.some(e=>e.MemberNumber===m)?s.disabled=!1:s.disabled=!0}});function O(){[...i.children].sort((e,t)=>{let n=!e.classList.contains(d),r=!t.classList.contains(d);if(n&&r||!n&&!r){let n=e.getAttribute(`data-last-updated`)??``,r=t.getAttribute(`data-last-updated`)??``,i=/^\d+$/u.test(n)?parseInt(n):0,a=/^\d+$/u.test(r)?parseInt(r):0;return a-i}return n?1:-1}).forEach(e=>{i.removeChild(e),i.appendChild(e)})}H.hookFunction(`ServerAccountBeep`,V.OverrideBehaviour,(e,t)=>{let[n]=e;n&&l(n)&&!n.BeepType&&Z.instantMessenger&&(g||D(),w(n.MemberNumber,!1,n,!1,new Date)),t(e)}),H.hookFunction(`ServerSend`,V.Observe,(e,t)=>{let[n,r]=e;if(n!==`AccountBeep`)return t(e);let i=r;return!i?.BeepType&&c(i?.Message)&&!i.Message.includes(``)&&(g||D(),w(i.MemberNumber,!0,i,!1,new Date)),t(e)});let k=[126,905,60,60];H.hookFunction(`DrawProcess`,V.AddBehaviour,(e,n)=>{n(e),Z.instantMessenger&&(!Z.allowIMBypassBCX&&(G?.getRuleState(`speech_restrict_beep_receive`)?.isEnforced||G?.getRuleState(`alt_hide_friends`)?.isEnforced&&Player.GetBlindLevel()>=3)?(t.classList.contains(`bce-hidden`)||j(),DrawButton(...k,``,`Gray`,`Icons/Small/Chat.png`,K(`Instant Messenger (Disabled by BCX)`),!1)):DrawButton(...k,``,h?`Red`:`White`,`Icons/Small/Chat.png`,K(`Instant Messenger`),!1))}),H.hookFunction(`CommonClick`,V.OverrideBehaviour,(e,n)=>{if(Z.instantMessenger&&MouseIn(...k)){if(!t.classList.contains(`bce-hidden`)){j();return}g||D(),O(),t.classList.toggle(`bce-hidden`),ServerSend(`AccountQuery`,{Query:`OnlineFriends`}),h=0,b(),NotificationReset(`Beep`);return}n(e)}),H.hookFunction(`NotificationRaise`,V.ModifyBehaviourHigh,(t,n)=>(t[0]===`Beep`&&t[1]?.body&&(t[1].body=e(t[1].body)),n(t)));function A(e){Z.instantMessenger&&e.key===`Escape`&&!t.classList.contains(`bce-hidden`)&&(j(),e.stopPropagation(),e.preventDefault())}function j(){t.classList.add(`bce-hidden`),s.blur(),u.blur()}document.addEventListener(`keydown`,A,!0),document.addEventListener(`keypress`,A,!0)}const Tt=/(^Backgrounds\/(?!Sheet(White)?|grey|White\.|BrickWall\.)|\b(Kneel|Arousal|Activity|Asylum|Cage|Cell|ChangeLayersMouth|Diaper|Kidnap|Logo|Player|Remote|Restriction|SpitOutPacifier|Struggle|Therapy|Orgasm\d|Poses|HouseVincula|Seducer\w+)\b|^data:|^Assets\/(?!Female3DCG\/Emoticon\/(Afk|Sleep|Read|Gaming|Hearing|Thumbs(Up|Down))\/))/u;function Et(){H.hookFunction(`CharacterSetActivePose`,V.Top,(e,t)=>Z.discreetMode?null:t(e)),H.hookFunction(`PoseSetActive`,V.Top,(e,t)=>Z.discreetMode?null:t(e)),H.hookFunction(`DrawImageEx`,V.Top,(e,t)=>{if(Z.discreetMode){if(!e)return!1;if(c(e[0])&&Tt.test(e[0]))return e[0].startsWith(`Backgrounds/`)?(e[0]=`Backgrounds/BrickWall.jpg`,t(e)):!1;if(e[0]instanceof HTMLCanvasElement||e[0]instanceof HTMLImageElement&&Tt.test(e[0].src))return!1}return t(e)}),H.hookFunction(`ChatRoomCharacterViewDraw`,V.Top,(e,t)=>{if(Z.discreetMode){let e,t=DrawGetCustomBackground(Player);if(t)e=`Backgrounds/${t}.jpg`;else if(ChatRoomCustomized&&ChatRoomCustomBackground)return!1;else e=`Backgrounds/${ChatRoomData.Background}.jpg`;if(Tt.test(e)){let e=ChatRoomCharacterViewCharacterCount,t=ChatRoomCharacterViewCharactersPerRow,n=ChatRoomCharacterViewWidth,r=ChatRoomCharacterViewHeight,i={inverted:Player.GraphicsSettings.InvertRoom&&Player.IsInverted(),blur:Player.GetBlurLevel(),darken:DrawGetDarkFactor(),tints:Player.GetTints(),sizeMode:ChatRoomData.Custom?.SizeMode};ChatRoomCharacterViewLoopCharacters((a,o,s,c,l)=>{if(a%t===0){let o=e<=t?r*(1-l)/2:0,s=RectMakeRect(0,o+a*100,n,r*l);DrawRoomBackground(`Backgrounds/BrickWall.jpg`,s,i)}DrawCharacter(ChatRoomCharacterDrawlist[a],o,s,l),DrawStatus(ChatRoomCharacterDrawlist[a],o,s,l),ChatRoomCharacterDrawlist[a].MemberNumber&&ChatRoomCharacterViewDrawOverlay(ChatRoomCharacterDrawlist[a],o,s,l)})}}return t(e)}),H.hookFunction(`NotificationTitleUpdate`,V.Top,(e,t)=>{if(Z.discreetMode){let e=NotificationGetTotalCount(NotificationAlertType.TITLEPREFIX);return document.title=`${e>0?`(${e}) `:``}${K(`OnlineChat`)}`,null}return t(e)})}function Dt(){H.hookFunction(`StruggleFlexibilityCheck`,V.OverrideBehaviour,(e,t)=>Z.autoStruggle&&StruggleProgressFlexCircles&&StruggleProgressFlexCircles.length>0?(StruggleProgressFlexCircles.splice(0,1),!0):t(e)),J(()=>{Z.autoStruggle&&(typeof StruggleProgress!=`number`||StruggleProgress<0||(StruggleProgressCurrentMinigame===`Strength`?StruggleStrengthProcess(!1):StruggleProgressCurrentMinigame===`Flexibility`&&StruggleProgressFlexCircles&&StruggleProgressFlexCircles.length>0&&StruggleFlexibilityProcess(!1)))},60),J(()=>{if(Z.autoStruggle&&!(typeof StruggleProgress!=`number`||StruggleProgress<0)&&StruggleProgressCurrentMinigame===`Dexterity`){let e=Math.max(-.5,Math.min(1,(85-Math.abs(StruggleProgressDexTarget-StruggleProgressDexCurrent))/75));e>.5&&StruggleDexterityProcess()}},0)}function Ot(){Z.leashAlways?O():k()}async function kt(){if(!Z.pastProfiles)return;let{Dexie:e}=await import(`./dexie.js`),t=new e(`bce-past-profiles`);t.version(3).stores({profiles:`memberNumber, name, lastNick, seen, characterBundle`,notes:`memberNumber, note, updatedAt`}),ElementCreateTextArea(`bceNoteInput`);let o=document.getElementById(`bceNoteInput`);o.maxLength=1e4,o.classList.add(`bce-hidden`);let s=t.table(`profiles`),c=t.table(`notes`);async function u(){try{let{quota:e,usage:t}=await navigator.storage.estimate();return n(`current quota usage ${t?.toLocaleString()??`?`} out of maximum ${e?.toLocaleString()??`?`}`),{quota:e??-1,usage:t??0}}catch(e){return a(`reading storage quota information`,e),{quota:-1,usage:-1}}}async function f(e){let t=await s.toArray();t.sort((e,t)=>e.seen-t.seen),t=t.slice(0,e),n(`deleting`,t),await s.bulkDelete(t.map(e=>e.memberNumber))}async function p(){let{quota:e,usage:t}=await u();t/e>.9&&(r(`storage quota above 90% utilization (${t}/${e}), cleaning some of the least recently seen profiles before saving new one`),await f(10))}async function m(e){await p();let t=e.Name,r=e.Nickname,i=[`ActivePose`,`Inventory`,`BlockItems`,`LimitedItems`,`FavoriteItems`,`ArousalSettings`,`OnlineSharedSettings`,`WhiteList`,`BlackList`,`Crafting`];for(let t of i)delete e[t];n(`saving profile of ${r??t} (${t})`);try{await s.put({memberNumber:e.MemberNumber,name:t,lastNick:r,seen:Date.now(),characterBundle:JSON.stringify(e)})}catch(e){let{quota:t,usage:n}=await u();a(`unable to save profile (${n}/${t}):`,e)}}H.hookFunction(`ChatRoomSync`,V.Top,(e,t)=>{let[n]=e;if(n?.Character?.length)for(let e of n.Character)m(_(e));t(e)}),H.hookFunction(`ChatRoomSyncSingle`,V.Top,(e,t)=>{let[n]=e;n?.Character?.MemberNumber&&m(_(n.Character)),t(e)}),H.hookFunction(`InformationSheetRun`,V.AddBehaviour,(e,t)=>{if(!InformationSheetSelection)throw Error(`InformationSheetSelection is null in InformationSheetRun`);if(InformationSheetSelection.BCESeen){let e=window.MainCanvas.getContext(`2d`);if(!e)throw Error(`could not get canvas 2d context`);e.textAlign=`left`,DrawText(K(`Last seen: `)+new Date(InformationSheetSelection.BCESeen).toLocaleString(),1200,75,`grey`,`black`),e.textAlign=`center`}return t(e)});async function h(e){try{let t=await s.get(e),n=CharacterLoadOnline(y(t.characterBundle),e);n.BCESeen=t.seen,CurrentScreen===`ChatRoom`&&(ChatRoomHideElements(),ChatRoomData&&(ChatRoomBackground=ChatRoomData.Background)),InformationSheetLoadCharacter(n)}catch(e){S(K(`No profile found`)),a(`reading profile`,e)}}CommandCombine({Tag:`profiles`,Description:K(`<filter> - List seen profiles, optionally searching by member number or name`),Action:e=>{(async e=>{let t=await s.toArray();t=t.filter(t=>!e||t.name.toLowerCase().includes(e)||t.memberNumber.toString().includes(e)||t.lastNick?.toLowerCase().includes(e)),t.sort((e,t)=>t.seen-e.seen);let n=t.length;t=t.slice(0,100),t.sort((e,t)=>-(t.lastNick??t.name).localeCompare(e.lastNick??e.name));let r=t.map(e=>{let t=document.createElement(`div`);t.textContent=K(`$nickAndName ($memberNumber) - Seen: $seen`,{$nickAndName:e.lastNick?`${e.lastNick} / ${e.name}`:e.name,$memberNumber:e.memberNumber.toString(),$seen:new Date(e.seen).toLocaleDateString()});let n=document.createElement(`a`);return n.textContent=K(`Open`),n.href=`#`,n.classList.add(`bce-profile-open`),n.addEventListener(`click`,t=>{t.preventDefault(),t.stopPropagation(),h(e.memberNumber)}),t.prepend(n),t}),i=document.createElement(`h3`);i.textContent=K(`Saved Profiles`),i.style.marginTop=`0`;let a=document.createElement(`div`);a.textContent=K(`showing $num most recent of $total total profiles matching search`,{$num:t.length.toLocaleString(),$total:n.toLocaleString()}),S([i,...r,a])})(e)}});let g=!1,v=0;function x(e){return l(e)&&typeof e.note==`string`}function C(){if(!InformationSheetSelection?.MemberNumber)throw Error(`invalid InformationSheetSelection in notes`);g=!0,o.classList.remove(`bce-hidden`),o.value=`Loading...`,c.get(InformationSheetSelection.MemberNumber).then(e=>{if(x(e))o.value=e?.note||``,v=e?.updatedAt||0;else throw Error(`invalid note`)}).catch(e=>{o.value=``,a(`getting note`,e)})}H.hookFunction(`CharacterLoadOnline`,V.Top,(e,t)=>{let n=t(e);return d(n)&&n.MemberNumber&&c.get(n.MemberNumber).then(e=>{n.FBCNoteExists=!!(x(e)&&e.note)}),n});function w(){o.classList.add(`bce-hidden`),g=!1}function T(e){e.key===`Escape`&&g&&(w(),e.stopPropagation(),e.preventDefault())}document.addEventListener(`keydown`,T,!0),document.addEventListener(`keypress`,T,!0),H.hookFunction(`OnlineProfileRun`,V.OverrideBehaviour,(e,t)=>g?(DrawText(K(`Personal notes (only you can read these):`),910,105,`Black`,`Gray`),v&&b(K(`Last saved: $date`,{$date:new Date(v).toLocaleString()}),60,105,400,`Black`,`Gray`),ElementPositionFix(`bceNoteInput`,36,100,160,1790,750),DrawButton(1720,60,90,90,``,`White`,`Icons/Accept.png`,TextGet(`LeaveSave`)),DrawButton(1820,60,90,90,``,`White`,`Icons/Cancel.png`,TextGet(`LeaveNoSave`)),null):(DrawButton(1620,60,90,90,``,`White`,`Icons/Notifications.png`,K(`[WCE] Notes`)),t(e))),H.hookFunction(`OnlineProfileClick`,V.OverrideBehaviour,(e,t)=>{if(g){MouseIn(1720,60,90,90)?(p().then(()=>{if(!InformationSheetSelection?.MemberNumber)throw Error(`invalid InformationSheetSelection in notes`);return c.put({memberNumber:InformationSheetSelection.MemberNumber,note:o.value,updatedAt:Date.now()})}),w()):MouseIn(1820,60,90,90)&&w();return}else !g&&MouseIn(1620,60,90,90)&&C();t(e)}),navigator.storage?.persisted&&!await navigator.storage.persisted()&&(await navigator.storage.persist()||i(`Profile storage may not be persistent.`))}function At(){function e(e,t,n){return Array.isArray(e)||(e=[]),e.push({Tag:t,Text:n}),e}let t=0;H.hookFunction(`ChatRoomMessage`,V.Observe,(e,t)=>{let n=t(e);if(Z.pendingMessages&&e?.length&&u(e[0])&&Array.isArray(e[0].Dictionary)){let[t]=e,n=t.Dictionary?.find?.(e=>e.Tag===`fbc_nonce`);if(n){let e=document.querySelector(`[data-nonce='${n.Text}']`);e&&e.remove()}}return n}),H.hookFunction(`ServerSend`,V.AddBehaviour,(n,r)=>{if(Z.pendingMessages&&n?.length>=2&&n[0]===`ChatRoomChat`&&u(n[1])&&n[1].Type!==z&&!n[1].Target){t++,t>=2**53-1&&(t=0),n[1].Dictionary=e(n[1].Dictionary,`fbc_nonce`,t);let i=document.createElement(`div`);switch(i.classList.add(`ChatMessage`,`bce-pending`),i.setAttribute(`data-time`,ChatRoomCurrentTime()),i.setAttribute(`data-sender`,Player.MemberNumber?.toString()),i.setAttribute(`data-nonce`,t.toString()),n[1].Type){case`Chat`:{i.classList.add(`ChatMessageChat`);let e=document.createElement(`span`);e.classList.add(`ChatMessageName`),e.style.color=Player.LabelColor||``,e.textContent=CharacterNickname(Player),i.appendChild(e),i.appendChild(document.createTextNode(`: ${n[1].Content}`))}break;case`Emote`:case`Action`:i.classList.add(`ChatMessageEmote`),i.appendChild(document.createTextNode(`*${n[1].Type===`Emote`?`${CharacterNickname(Player)}: `:``}${n[1].Content}*`));break;default:return r(n)}let a=document.createElement(`div`);a.classList.add(`lds-ellipsis`);for(let e=0;e<4;e++){let e=document.createElement(`div`);a.appendChild(e)}i.appendChild(a);let o=ElementIsScrolledToEnd(`TextAreaChatLog`),s=document.getElementById(`TextAreaChatLog`);s&&(s.appendChild(i),o&&ElementScrollToEnd(`TextAreaChatLog`))}return r(n)})}function jt(){H.hookFunction(`DrawCharacter`,V.ModifyBehaviourLow,(e,t)=>{let[n]=e;if(!n||!Z.hideHiddenItemsIcon)return t(e);let r=n.HasHiddenItems;n.HasHiddenItems=!1;let i=t(e);return n.HasHiddenItems=r,i})}function Mt(){let e=`DescriptionInput`,t=`bceRichOnlineProfile`,n=!0;function r(){let t=document.getElementById(e);t&&(n=!1,t.style.display=`none`)}function i(){let t=document.getElementById(e);t&&(n=!0,t.style.display=``)}function a(){r();let e=document.createElement(`div`);e.id=t,e.style.overflowY=`scroll`,e.style.overflowX=`hidden`,e.style.overflowWrap=`break-word`,e.style.whiteSpace=`pre-wrap`,e.style.background=`rgb(244, 236, 216)`,e.style.color=`rgb(45, 35, 27)`,e.style.border=`2px solid black`,e.style.padding=`2px`,e.classList.add(`bce-rich-textarea`),e.textContent=InformationSheetSelection?.Description||``,Ne(e,()=>!1),document.body.append(e),o()}function o(){ElementPositionFix(t,36,100,160,1790,750)}function s(){let e=document.getElementById(t);e&&e.remove(),i()}H.hookFunction(`OnlineProfileLoad`,V.ModifyBehaviourMedium,(t,r)=>{n=!0;let i=r(t),o=document.getElementById(e);return!Z.richOnlineProfile||!o||a(),i}),H.hookFunction(`ChatRoomHideElements`,V.ModifyBehaviourMedium,(e,t)=>(s(),t(e)));let c=[90,60,90,90];H.hookFunction(`OnlineProfileRun`,V.ModifyBehaviourMedium,(e,t)=>{if(!Z.richOnlineProfile)return t(e);DrawButton(...c,``,`White`,`Icons/Crafting.png`,K(`Toggle Editing Mode`));let i=t(e);return n||(r(),o()),i}),H.hookFunction(`OnlineProfileClick`,V.ModifyBehaviourMedium,(e,t)=>Z.richOnlineProfile&&MouseIn(...c)?(n?a():s(),!0):t(e)),H.hookFunction(`OnlineProfileUnload`,V.ModifyBehaviourMedium,(e,t)=>(n||s(),t(e)))}function Nt(){let e=!1,t=!1;H.hookFunction(`DrawArousalMeter`,V.Observe,(n,r)=>{let[i]=n;e=!!i.ArousalZoom;let a=i.ArousalSettings?.ProgressTimer??0,o=a>0,s=i.ArousalSettings?.VibratorLevel??0,c=s>0,l=i.ArousalSettings?.Progress??0,u=(i.IsEdged()||i.HasEffect(`DenialMode`))&&l>=95;t=o||c&&!u;let d=r(n);return e=!1,d}),H.hookFunction(`DrawArousalThermometer`,V.Observe,(n,r)=>{let i=r(n);if(Z.numericArousalMeter&&e){let[e,r,i,a]=n,o=`white`;a>=95?o=t?`red`:`hotpink`:a>=70&&(o=`pink`),DrawTextFit(a.toLocaleString()+(t?`↑`:` `),e+50*i,r-30*i,100*i,o,`black`)}return i})}function Pt(){ServerCharacterNicknameRegex=/^[\p{L}0-9\p{Z}'-]+$/u}function Ft(){s(()=>ServerIsConnected&&ServerPlayerIsInChatRoom()),q(null,!0),J(()=>{let e=bcModSdk.getModsInfo();Z.shareAddons&&JSON.stringify(e)!==JSON.stringify(Player.FBCOtherAddons)&&ServerIsConnected&&ServerPlayerIsInChatRoom()&&(Player.FBCOtherAddons=e,q(null,!0))},5e3)}function It(){window.addEventListener(`beforeunload`,e=>{if(Y.client?.connected)for(let e of Y.client.devices.filter(e=>e.vibrateAttributes.length>0))e.vibrate(0);return Z.confirmLeave?(e.preventDefault(),ServerSocket.io.disconnect(),CommonSetScreen(`Character`,`Relog`),ServerSocket.io.connect(),e.returnValue=`Are you sure you want to leave the club?`):null},{capture:!0})}function Lt(){let e={};H.hookFunction(`ChatRoomMessageDisplay`,V.AddBehaviour,(t,n)=>(Z.whisperTargetFixes&&t[0].Type===`Action`&&t[0].Sender===ChatRoomTargetMemberNumber&&([`ServerLeave`,`ServerBan`,`ServerKick`,`ServerDisconnect`].some(e=>t[0].Content.startsWith(e))?e[t[0].Sender]=window.setTimeout(()=>{ChatRoomSetTarget(-1),ChatRoomSendLocal(`<span style="color: red">[WCE] Your whisper target was cleared, because they left the room for more than a minute!</span>`)},60*1e3):t[0].Content.startsWith(`ServerEnter`)&&e[t[0].Sender]&&(window.clearTimeout(e[t[0].Sender]),delete e[t[0].Sender])),n(t))),U(`ChatRoomSendChat`,{'ChatRoomSendLocal(`<span style="color: red">\${TextGet("WhisperTargetGone")}</span>`);':`ChatRoomSendLocal('<span style="color: red">' + TextGet("WhisperTargetGone") + " Resetting to talk to everyone now!</span>");
        if(fbcSettingValue("whisperTargetFixes")) ChatRoomSetTarget(-1);
        `},`Resetting blush, eyes, and eyebrows after struggling`)}async function Rt(){await s(()=>AssetFemale3DCG?.some(e=>e.Group===`Pronouns`)),AssetFemale3DCG.find(e=>e.Group===`Pronouns`).Asset.forEach(e=>e.AllowEffect=[E.Leash,E.BlurLight]),await s(()=>Player?.Appearance?.some(e=>e.Asset.Group.Name===`Pronouns`)),Player.Appearance.find(e=>e.Asset.Group.Name===`Pronouns`).Asset.AllowEffect=[E.Leash,E.BlurLight]}const zt=[];async function $(e,t){zt.push(t);try{let n=e();n instanceof Promise&&await n,zt.splice(zt.indexOf(t),1)}catch(e){let n=e;a(`Error in ${t}: ${n?.toString()}\n${n?.stack??``}`)}}async function Bt(){let e=`init`;H.hookFunction(`LoginResponse`,V.Top,(t,n)=>(e===`init`&&(e=`disable`),n(t))),H.hookFunction(`LoginStatusReset`,V.Top,(t,n)=>(e===`disable`&&(e=`init`),n(t))),H.hookFunction(`GameRun`,V.Top,(t,n)=>e===`disable`?(GameAnimationFrameId=requestAnimationFrame(GameRun),null):n(t)),H.hookFunction(`GameRunBackground`,V.Top,(t,n)=>e===`disable`?null:n(t)),await $(Je,`functionIntegrityCheck`),$(Xe,`wceStyles`),$($e,`commonPatches`),$(Ce,`extendedWardrobe`),$(Rt,`allowCustomEffect`),$(ct,`automaticReconnect`),$(pe,`hiddenMessageHandler`),await $(Ve,`bceLoadSettings`),$(We,`postSettings`),$(ce,`appendSocketListenersToInit`),n(Z),$(Et,`discreetMode`),$(et,`beepImprovements`),$(ot,`settingsPage`),$(_t,`alternateArousal`),$(Fe,`chatAugments`),$(gt,`automaticExpressions`),$(lt,`layeringMenu`),$(ut,`cacheClearer`),$(st,`lockpickHelp`),$(rt,`commands`),$(dt,`chatRoomOverlay`),$(ft,`privateWardrobe`),$(Le,`antiGarbling`),$(vt,`autoGhostBroadcast`),$(yt,`blindWithoutGlasses`),$(xt,`friendPresenceNotifications`),$(fe,`forcedClubSlave`),$(wt,`instantMessenger`),$(Dt,`autoStruggle`),$(Pt,`nicknames`),$(Ot,`leashAlways`),$(ge,`toySync`),$(kt,`pastProfiles`),$(At,`pendingMessages`),$(jt,`hideHiddenItemsIcon`),$(St,`itemAntiCheat`),$(Ct,`leashFix`),$(le,`hookBCXAPI`),$(we,`customContentDomainCheck`),$(Nt,`numericArousalMeters`),$(Mt,`richOnlineProfile`),$(Ft,`shareAddons`),$(It,`confirmLeave`),$(Lt,`chatRoomWhisperFixes`),e=`enable`}if(await s(()=>typeof FUSAM==`object`&&FUSAM?.present&&typeof bcModSdk==`object`&&!!bcModSdk),globalThis.FBC_VERSION)throw Error(`FBC already loaded. Skipping load.`);if(typeof ChatRoomCharacter>`u`)throw Error(`Bondage Club not detected. Skipping WCE initialization.`);GameVersion=new URLSearchParams(location.hash.slice(1)).get(`version`)??GameVersion,globalThis.FBC_VERSION=A,globalThis.fbcDisplayText=K,globalThis.fbcChatNotify=S,globalThis.fbcSendAction=w,globalThis.fbcSettingValue=Ke,globalThis.bce_initializeDefaultExpression=()=>null,globalThis.fbcDebug=tt,FUSAM.registerDebugMethod(`WCE`,()=>tt(!1)),await Bt(),await C(`Wholesome Club Extensions v${globalThis.FBC_VERSION} loaded!`),Player.FBC=A,window.addEventListener(`error`,e=>{t(`error`,e.message,`${e.filename} (${e.lineno}:${e.colno})`,e.error)});
//# sourceMappingURL=wce.js.map