/**
* @license GPL-3.0-or-later
*     BCE/FBC
*  Copyright (C) 2024  Sid
*
*  This program is free software: you can redistribute it and/or modify
*  it under the terms of the GNU General Public License as published by
*  the Free Software Foundation, either version 3 of the License, or
*  (at your option) any later version.
*
*  This program is distributed in the hope that it will be useful,
*  but WITHOUT ANY WARRANTY; without even the implied warranty of
*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
*  GNU General Public License for more details.
*
*  You should have received a copy of the GNU General Public License
*  along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/const Ve=new Array(100),We=(e,...r)=>{Ve.shift(),Ve.push({level:e,message:r.map(t=>{if(typeof t=="string")return t;try{return JSON.stringify(t)}catch{return t?.toString()}}).join(", ")})},y=(...e)=>{console.debug("WCE",`${window.FBC_VERSION}:`,...e),We("debug",...e)},me=(...e)=>{console.info("WCE",`${window.FBC_VERSION}:`,...e),We("info",...e)},z=(...e)=>{console.warn("WCE",`${window.FBC_VERSION}:`,...e),We("warn",...e)},ie=(...e)=>{console.error("WCE",`${window.FBC_VERSION}:`,...e),We("error",...e)};function Ue(e){return new Promise(r=>setTimeout(r,e))}async function U(e,r=()=>!1){for(;!e();){if(r())return!1;await Ue(10)}return!0}function ce(e){return typeof e=="string"}function se(e){return!!e&&typeof e=="object"&&!Array.isArray(e)}function nt(e){return se(e)&&typeof e.Type=="string"&&typeof e.Content=="string"}function ue(e){return se(e)&&typeof e.IsPlayer=="function"}function at(e){return ce(e)||Array.isArray(e)&&e.every(ce)}function it(e){return Array.isArray(e)&&e.every(r=>Ft(r)||r===null)}function Ft(e){return Array.isArray(e)&&e.every(kt)}function kt(e){return se(e)&&typeof e.Name=="string"&&typeof e.Group=="string"}function ve(e,r=-Number.MAX_SAFE_INTEGER){return e??r}function De(e){return structuredClone(e)}function ye(e){return se(e)?Object.entries(e):[]}function le(e){if(e===null)return null;try{return JSON.parse(e)}catch(r){return ie("parsing JSON",r),null}}function je(e,r,t,o,a,i=void 0){const n=window.MainCanvas.getContext("2d");if(!n)throw new Error("could not get canvas 2d context");const s=n.textAlign;n.textAlign="left",DrawTextFit(e,r,t,o,a,i),n.textAlign=s}function ke(e,r,t,o,a){const i=window.MainCanvas.getContext("2d");if(!i)throw new Error("could not get canvas 2d context");const n=i.textAlign;i.textAlign=a,DrawRect(e,r,t,65,"#FFFF88"),DrawEmptyRect(e,r,t,65,"black",2),DrawTextFit(o,a==="left"?e+3:e+t/2,r+33,t-6,"black"),i.textAlign=n}const H=e=>{const r=document.createElement("div");r.setAttribute("class","ChatMessage bce-notification"),r.setAttribute("data-time",ChatRoomCurrentTime()),r.setAttribute("data-sender",Player.MemberNumber?.toString()),typeof e=="string"?r.appendChild(document.createTextNode(e)):Array.isArray(e)?r.append(...e):r.appendChild(e),ChatRoomAppendChat(r)},Ge=async(e,r=5e3,t={})=>{await U(()=>!!Player&&new Date(ServerBeep?.Timer||0)<new Date),ServerBeep={Timer:Date.now()+r,Message:e,...t}},Pe=e=>{ServerSend("ChatRoomChat",{Content:"Beep",Type:"Action",Dictionary:[{Tag:"Beep",Text:"msg"},{Tag:"\u53D1\u9001\u79C1\u804A",Text:"msg"},{Tag:"Biep",Text:"msg"},{Tag:"Sonner",Text:"msg"},{Tag:"msg",Text:e}]})};function st(e){let r=!1;const t=Player.Appearance.find(o=>o.Asset.Group.Name==="Pronouns");return t?(t.Property?t.Property.Effect?t.Property.Effect.includes(e)||(t.Property.Effect.push(e),r=!0):(t.Property.Effect=[e],r=!0):(t.Property={Effect:[e]},r=!0),r&&ServerPlayerIsInChatRoom()&&ChatRoomCharacterUpdate(Player),r):(z("Could not find pronouns asset."),r)}function _e(e){const r=Player.Appearance.find(o=>o.Asset.Group.Name==="Pronouns");let t=!1;return r?.Property?.Effect?.includes(e)&&(r.Property.Effect=r.Property.Effect.filter(o=>o!==e),t=!0),t&&ServerPlayerIsInChatRoom()&&ChatRoomCharacterUpdate(Player),t}function ut(){st("Leash")}function lt(){_e("Leash")}const Ae="6.2.2b",ct=62.1,dt=["R104"],ze=`WCE v6.2.1
* improved Anti Garble system
* local Wardrobe
* store Saved Logins encrypted
* upgraded Buttplug.io support
* for a full changelog visit: https://github.com/KittenApps/WCE/releases

WCE v6.2
* WCE 6.2 is a fork of the old FBC 5.8 and tries to bring all it's amazing features back
* new Anti Garble system, layering improvements and other fixes and improvements
* please recheck your WCE settings, because many things have changed
`,Pt="https://discord.gg/SHJMjEh9VH",Mt="https://github.com/KittenApps/WCE",be="bce-colors",Tt="https://github.com/KittenApps/WCE/blob/main/LICENSE",Me=99.6,Xe="BCEMsg",pt="bce-dark-input",Te=24,ge=96,Lt=384,Le="Hidden",Be=Object.freeze({Activity:"Activity",ArousalSync:"ArousalSync",Hello:"Hello"}),It="bce-whisper-input",Ke=[],C={Top:11,OverrideBehaviour:10,ModifyBehaviourHigh:6,ModifyBehaviourMedium:5,ModifyBehaviourLow:4,AddBehaviour:3,Observe:0},f=bcModSdk.registerMod({name:"WCE",version:Ae,fullName:"Wholesome Club Extensions",repository:"https://github.com/KittenApps/WCE.git"},{allowReplace:!1}),qe=[],re=(e,r,t)=>{Ke.includes(e)&&dt.includes(GameVersion)&&(z(`Attempted patching of ${e} despite detected deviation. Impact may be: ${t}

See /wcedebug in a chatroom for more information or copy(await fbcDebug()) in console.`),qe.push(t)),f.patchFunction(e,r)},Ie=[];function Ce(e,r){return Ie.push({cb:e,intval:r,lastTime:performance.now()}),()=>{Ie.splice(Ie.findIndex(t=>t.cb===e),1)}}f.hookFunction("GameRun",C.Top,(e,r)=>{if(document.hidden)return r(e);const t=performance.now();return Ie.forEach(o=>{t-o.lastTime>o.intval&&(o.lastTime=t,o.cb())}),r(e)}),f.hookFunction("GameRunBackground",C.Top,(e,r)=>{if(!document.hidden)return r(e);const t=performance.now();return Ie.forEach(o=>{t-o.lastTime>o.intval&&(o.lastTime=t,o.cb())}),r(e)});function Oe(e,r){f.callOriginal("ServerAccountBeep",[{MemberNumber:Player.MemberNumber||-1,BeepType:"",MemberName:"FBC",ChatRoomName:e,Private:!0,Message:r,ChatRoomSpace:""}])}const Nt=["clubslave"];function xe(e=null,r=!1){if(!zt()||!ServerIsConnected||!ServerPlayerIsInChatRoom())return;const t={Type:Le,Content:Xe,Sender:Player.MemberNumber,Dictionary:[]},o={message:{type:Be.Hello,version:Ae,alternateArousal:!!l.alternateArousal,replyRequested:r,capabilities:Nt}};e&&(t.Target=e),l.alternateArousal&&(o.message.progress=Player.BCEArousalProgress||Player.ArousalSettings?.Progress||0,o.message.enjoyment=Player.BCEEnjoyment||1),l.shareAddons&&(o.message.otherAddons=bcModSdk.getModsInfo()),t.Dictionary.push(o),ServerSend("ChatRoomChat",t)}function Rt(){U(()=>ServerIsConnected&&ServerPlayerIsInChatRoom()),xe(null,!0),Ce(()=>{const e=bcModSdk.getModsInfo();l.shareAddons&&JSON.stringify(e)!==JSON.stringify(Player.FBCOtherAddons)&&ServerIsConnected&&ServerPlayerIsInChatRoom()&&(Player.FBCOtherAddons=e,xe(null,!0))},5e3)}function d(e,r={}){const t=Object.freeze({CN:{"Automatic Arousal Expressions (Replaces Vanilla)":"\u81EA\u52A8\u6B32\u671B\u8868\u60C5 (\u66FF\u6362\u539F\u7248)","Activity Expressions":"\u6D3B\u52A8\u8868\u793A","Alternate Arousal (Replaces Vanilla, requires hybrid/locked arousal meter)":"\u53E6\u4E00\u79CD\u6B32\u671B (\u66FF\u6362\u539F\u7248, \u9700\u8981\u6DF7\u5408\u6216\u9501\u5B9A\u6B32\u671B\u6761)","Alternative speech stutter":"\u53E6\u4E00\u79CD\u8A00\u8BED\u4E0D\u6E05","Extended wardrobe slots (96)":"\u6269\u5C55\u8863\u67DC\u4FDD\u5B58\u69FD (96\u4E2A)","Replace wardrobe list with character previews":"\u4F7F\u7528\u89D2\u8272\u9884\u89C8\u66FF\u6362\u8863\u67DC\u4FDD\u5B58\u5217\u8868","Clear Drawing Cache Hourly":"\u6BCF\u5C0F\u65F6\u6E05\u9664\u7ED8\u56FE\u7F13\u5B58","Instant messenger":"\u5373\u65F6\u901A\u8BAF","Chat Links and Embeds":"\u804A\u5929\u94FE\u63A5\u548C\u5D4C\u5165","Use Ctrl+Enter to OOC":"\u4F7F\u7528Ctrl+Enter\u8FDB\u884COOC\u53D1\u8A00","Use italics for input when whispering":"\u6084\u6084\u8BDD\u4F7F\u7528\u659C\u4F53\u5B57","Improve colors for readability":"\u6539\u5584\u989C\u8272\u4EE5\u63D0\u9AD8\u53EF\u8BFB\u6027","Show friend presence notifications":"\u663E\u793A\u597D\u53CB\u5728\u7EBF\u901A\u77E5","Understand All Gagged and when Deafened":"\u5728\u88AB\u5835\u4F4F\u5634\u548C\u88AB\u5835\u4F4F\u8033\u6735\u65F6\u53EF\u4EE5\u542C\u61C2\u6240\u6709\u53D1\u8A00","Reveal Lockpicking Order Based on Skill":"\u6839\u636E\u6280\u80FD\u663E\u793A\u64AC\u9501/\u5F00\u9501\u987A\u5E8F","Allow layering menus while bound":"\u5141\u8BB8\u5728\u6346\u7ED1\u65F6\u7528\u5206\u5C42\u83DC\u5355","Limited gag anti-cheat: cloth-gag equivalent garbling":"\u6709\u9650\u7684\u5835\u5634\u53CD\u4F5C\u5F0A: \u548C\u5E03\u5835\u5634\u76F8\u540C\u7684\u4E71\u7801","Full gag anti-cheat: use equipped gags to determine garbling":"\u5B8C\u6574\u7684\u5835\u5634\u53CD\u4F5C\u5F0A: \u4F7F\u7528\u5F53\u524D\u88C5\u5907\u7684\u5835\u5634\u6765\u786E\u5B9A\u4E71\u7801","Extra gag anti-cheat: even more garbling for the most extreme gags":"\u6269\u5C55\u7684\u5835\u5634\u53CD\u4F5C\u5F0A: \u5BF9\u4E8E\u4F7F\u7528\u6700\u6781\u7AEF\u7684\u5835\u5634\u66F4\u52A0\u6DF7\u4E71","Require glasses to see":"\u9700\u8981\u773C\u955C\u624D\u80FD\u770B\u6E05","Automatic Relogin on Disconnect":"\u65AD\u7EBF\u540E\u81EA\u52A8\u91CD\u8FDE","Show gag cheat and anti-cheat options in chat":"\u5728\u804A\u5929\u5BA4\u91CC\u663E\u793A\u5835\u5634\u4F5C\u5F0A\u548C\u53CD\u4F5C\u5F0A\u9009\u9879","Automatically ghost+blocklist unnaturally new users":"\u81EA\u52A8\u5BF9\u4E0D\u81EA\u7136\u7684\u7528\u6237\u65E0\u89C6\u5E76\u6DFB\u52A0\u9ED1\u540D\u5355","Confirm leaving the game":"\u79BB\u5F00\u6E38\u620F\u524D\u9700\u8981\u786E\u8BA4","Discreet mode (disable drawing)":"\u8C28\u614E\u6A21\u5F0F (\u7981\u7528\u7ED8\u56FE)","Make automatic progress while struggling":"\u5728\u6323\u624E\u65F6\u81EA\u52A8\u589E\u52A0\u8FDB\u5EA6","Allow leashing without wearing a leashable item (requires leasher to have WCE too)":"\u5141\u8BB8\u5728\u4E0D\u4F69\u6234\u7275\u5F15\u7EF3\u7684\u60C5\u51B5\u4E0B\u4E5F\u53EF\u4EE5\u8FDB\u884C\u7275\u5F15\uFF08\u9700\u8981\u7275\u5F15\u8005\u4E5F\u5B89\u88C5\u6709WCE\uFF09","Enable buttplug.io (requires refresh)":"\u542F\u7528buttplug.io\uFF08\u9700\u8981\u5237\u65B0\u7F51\u9875)","This page allows configuration of the synchronization of bluetooth connected toys.":"\u6B64\u9875\u9762\u5141\u8BB8\u914D\u7F6E\u5C06BC\u9707\u52A8\u5668\u72B6\u6001\u540C\u6B65\u5230\u84DD\u7259\u8FDE\u63A5\u7684\u73A9\u5177","Save & browse seen profiles (requires refresh)":"\u4FDD\u5B58\u5E76\u6D4F\u89C8\u5DF2\u77E5\u7684\u4E2A\u4EBA\u8D44\u6599 (\u9700\u8981\u5237\u65B0)","Chat & Social":"\u804A\u5929 & \u793E\u4EA4","Activities & Arousal":"\u6D3B\u52A8 & \u6B32\u671B","Appearance & Wardrobe":"\u5916\u89C2 & \u8863\u67DC","Immersion & Anti-Cheat":"\u6C89\u6D78\u4F53\u9A8C & \u53CD\u4F5C\u5F0A",Performance:"\u8868\u73B0",Misc:"\u6742\u9879",Cheats:"\u4F5C\u5F0A",ah:"\u554A",aah:"\u554A\u2764",mnm:"\u5514\u59C6",nn:"\u55EF\u554A",mnh:"\u55EF\u54C8",mngh:"\u5514\u554A",haa:"\u54C8\u554A",nng:"\u55EF\u55EF\u2764",mnng:"\u5514\u554A\u2764","FBC Developer":"FBC \u5F00\u53D1\u8005","WCE Developer":"WCE \u5F00\u53D1\u8005",Incompatibility:"\u4E0D\u517C\u5BB9","Show recent WCE changelog":"\u663E\u793A\u6700\u8FD1\u7684WCE\u66F4\u65B0\u65E5\u5FD7","Include binds?":"\u5305\u62EC\u675F\u7F1A\uFF1F","Include locks?":"\u5305\u62EC\u9501\uFF1F","Include height, body type, hair, etc?":"\u5305\u62EC\u8EAB\u9AD8\uFF0C\u4F53\u578B\uFF0C\u5934\u53D1\u7B49\uFF1F","Copy the looks string below":"\u590D\u5236\u4E0B\u9762\u7684\u5916\u89C2\u5B57\u7B26\u4E32","Paste your looks here":"\u5728\u8FD9\u91CC\u7C98\u8D34\u4F60\u7684\u5916\u89C2","No looks string provided":"\u6CA1\u6709\u63D0\u4F9B\u5916\u89C2\u5B57\u7B26\u4E32","Applied looks":"\u5E94\u7528\u5916\u89C2","Could not parse looks":"\u65E0\u6CD5\u89E3\u6790\u5916\u89C2","[membernumber] [message]: beep someone":"[\u7528\u6237\u7F16\u53F7] [\u6D88\u606F]: \u53D1\u9001beep","Wholesome Club Extensions (WCE) Settings":"Wholesome Club Extensions (WCE)\u8BBE\u7F6E","Join Discord":"\u52A0\u5165Discord",License:"\u6388\u6743",Information:"\u4FE1\u606F","Still connecting or connection failed...":"\u6B63\u5728\u8FDE\u63A5\u6216\u8FDE\u63A5\u5931\u8D25...",Scan:"\u641C\u7D22","Device Name":"\u8BBE\u5907\u540D\u79F0","Synchronized Slot":"\u540C\u6B65\u680F\u4F4D","Click on a setting to see its description":"\u70B9\u51FB\u8BBE\u7F6E\u4EE5\u67E5\u770B\u5176\u63CF\u8FF0","WCE Settings":"WCE\u8BBE\u7F6E","Saved Logins (WCE)":"\u5DF2\u4FDD\u5B58\u7684\u767B\u5F55 (WCE)","Save (WCE)":"\u4FDD\u5B58 (WCE)","Reconnected!":"\u91CD\u65B0\u8FDE\u63A5\uFF01",ERROR:"\u9519\u8BEF","Reset all expressions":"\u91CD\u7F6E\u6240\u6709\u8868\u60C5","['list' or name of emote]: run an animation":"['list' \u6216 \u8868\u60C5\u540D\u79F0]: \u8FD0\u884C\u4E00\u4E2A\u52A8\u753B","['list' or list of poses]: set your pose":"['list' \u6216 \u59FF\u52BF\u5217\u8868]: \u8BBE\u7F6E\u4F60\u7684\u59FF\u52BF","Load without body parts":"\u52A0\u8F7D\u65F6\u4E0D\u5305\u62EC\u8EAB\u4F53\u90E8\u4F4D","Exclude body parts":"\u6392\u9664\u8EAB\u4F53\u90E8\u4F4D",Gagging:"\u5835\u5634","Antigarble anti-cheat strength":"\u53CD\u5835\u5634\u53CD\u4F5C\u5F0A\u5F3A\u5EA6","Understand: Yes":"\u7406\u89E3: \u662F","Understand gagspeak: No":"\u7406\u89E3\u5835\u5634\u8BF4\u8BDD: \u5426","Understand gagspeak: Yes":"\u7406\u89E3\u5835\u5634\u8BF4\u8BDD: \u662F","Having recovered your glasses you can see again!":"\u627E\u56DE\u4E86\u4F60\u7684\u773C\u955C\uFF0C\u4F60\u53EF\u4EE5\u770B\u89C1\u4E86\uFF01","Having lost your glasses your eyesight is impaired!":"\u5931\u53BB\u4E86\u4F60\u7684\u773C\u955C\uFF0C\u4F60\u7684\u89C6\u529B\u53D7\u635F\u4E86\uFF01","([WCE] Force them to become a Club Slave.)":"([WCE] \u5F3A\u5236\u4ED6\u4EEC\u6210\u4E3A\u4FF1\u4E50\u90E8\u5974\u96B6\u3002)","(She will become a Club Slave for the next hour.)":"(\u5979\u5C06\u6210\u4E3A\u4FF1\u4E50\u90E8\u5974\u96B6\uFF0C\u6301\u7EED\u4E00\u4E2A\u5C0F\u65F6\u3002)","Search for a friend":"\u641C\u7D22\u597D\u53CB","Sending beeps is currently restricted by BCX rules":"\u53D1\u9001beep\u76EE\u524D\u53D7\u5230BCX\u89C4\u5219\u7684\u9650\u5236",Online:"\u5728\u7EBF",Offline:"\u79BB\u7EBF","Instant Messenger (Disabled by BCX)":"\u5373\u65F6\u901A\u8BAF\u5668 (\u88ABBCX\u7981\u7528)","Instant Messenger":"\u5373\u65F6\u901A\u8BAF\u5668","WCE Changelog":"WCE\u66F4\u65B0\u65E5\u5FD7","Trust this session":"\u4FE1\u4EFB\u6B64\u4F1A\u8BDD","(embed)":"(\u5D4C\u5165)","(This origin is trusted by authors of WCE)":"(\u6B64\u6765\u6E90\u5DF2\u88ABWCE\u4F5C\u8005\u4FE1\u4EFB)","Deny for session":"\u62D2\u7EDD\u6B64\u4F1A\u8BDD","Allow for session":"\u5141\u8BB8\u6B64\u4F1A\u8BDD",OnlineChat:"\u5728\u7EBF\u804A\u5929","Scans for connected buttplug.io toys":"\u626B\u63CF\u5DF2\u8FDE\u63A5\u7684buttplug.io\u73A9\u5177","buttplug.io is not connected":"buttplug.io\u672A\u8FDE\u63A5","Scanning stopped":"\u626B\u63CF\u505C\u6B62","Scanning for toys":"\u626B\u63CF\u73A9\u5177","Last seen: ":"\u6700\u540E\u5728\u7EBF: ","No profile found":"\u672A\u627E\u5230\u4E2A\u4EBA\u8D44\u6599",Open:"\u6253\u5F00","Saved Profiles":"\u5DF2\u4FDD\u5B58\u7684\u4E2A\u4EBA\u8D44\u6599","Personal notes (only you can read these):":"\u4E2A\u4EBA\u7B14\u8BB0 (\u53EA\u6709\u4F60\u53EF\u4EE5\u8BFB\u5230):","[WCE] Notes":"[WCE] \u7B14\u8BB0","Toggle Editing Mode":"\u5207\u6362\u7F16\u8F91\u6A21\u5F0F","Paste the craft here":"\u5728\u8FD9\u91CC\u7C98\u8D34\u5236\u4F5C\u7269\u54C1","Copy the craft here":"\u5728\u8FD9\u91CC\u590D\u5236\u5236\u4F5C\u7269\u54C1",Import:"\u5BFC\u5165",Export:"\u5BFC\u51FA","Description:":"\u63CF\u8FF0:","Animation Engine":"\u52A8\u753B\u5F15\u64CE","Show numeric arousal meter":"\u663E\u793A\u6B32\u671B\u6761\u6570\u503C","Show friends going offline too":"\u663E\u793A\u670B\u53CB\u79BB\u7EBF\u901A\u77E5","Show friend presence notifications in chat, when possible":"\u5728\u804A\u5929\u5BA4\u91CC\u663E\u793A\u597D\u53CB\u5728\u7EBF\u901A\u77E5","Show sent messages while waiting for server":"\u5728\u7B49\u5F85\u670D\u52A1\u5668\u65F6\u663E\u793A\u5DF2\u53D1\u9001\u7684\u6D88\u606F","Show whisper button on chat messages (requires refresh)":"\u5728\u804A\u5929\u6D88\u606F\u4E0A\u663E\u793A\u6084\u6084\u8BDD\u6309\u94AE \uFF08\u9700\u8981\u5237\u65B0\u7F51\u9875)","Rich online profile":"\u4E30\u5BCC\u7684\u5728\u7EBF\u4E2A\u4EBA\u8D44\u6599","Allow IMs to bypass BCX beep restrictions":"\u5141\u8BB8\u5373\u65F6\u901A\u8BAF\u7ED5\u8FC7BCX beep\u9650\u5236","Hide the hidden items icon":"\u4E0D\u663E\u793A\u9690\u85CF\u7684\u7269\u54C1\u56FE\u6807","Enable anti-cheat":"\u542F\u7528\u53CD\u4F5C\u5F0A","Blacklist detected cheaters automatically":"\u81EA\u52A8\u5C06\u68C0\u6D4B\u5230\u7684\u4F5C\u5F0A\u8005\u52A0\u5165\u9ED1\u540D\u5355","Enable uwall anti-cheat":"\u542F\u7528uwall\u53CD\u4F5C\u5F0A","Prompt before loading content from a 3rd party domain":"\u5728\u52A0\u8F7D\u7B2C\u4E09\u65B9\u57DF\u540D\u7684\u5185\u5BB9\u524D\u63D0\u793A","Share Addons":"\u5206\u4EAB\u63D2\u4EF6\u8BBE\u7F6E","Buttplug Devices":"Buttplug\u8BBE\u5907"}});let o=TranslationLanguage in t&&e in t[TranslationLanguage]?t[TranslationLanguage][e]:e;for(const[a,i]of ye(r))for(;o.includes(a);)o=o.replace(a,i);return o}const Wt=(e,r={})=>d(e,r),J={deviceSettings:new Map};async function Gt(){if(!l.toySync)return;const{ButtplugClient:e,ButtplugBrowserWebsocketClientConnector:r}=await import("./buttplug.js");me("Loaded Buttplug.io");const t=new e("WCE Toy Sync");t.addListener("deviceadded",i=>{y("Device connected",i),H(d("Vibrator connected: $DeviceName",{$DeviceName:i.name}));const n=J.deviceSettings.get(i.name);n&&delete n.LastIntensity}),t.addListener("deviceremoved",i=>{y("Device disconnected",i),H(d("Vibrator disconnected: $DeviceName",{$DeviceName:i.name}))}),t.addListener("scanningfinished",i=>{y("Scanning finished",i)});const o=new r(l.toySyncAddress||"ws://127.0.0.1:12345");try{await t.connect(o),me("Connected buttplug.io")}catch(i){FUSAM.modals.openAsync({prompt:d("buttplug.io is enabled, but server could not be contacted at $toySyncAddress. Is Intiface Desktop running? Is another client connected to it?",{$toySyncAddress:l.toySyncAddress}),buttons:{submit:"OK"}}),ie("buttplug.io could not connect to server",i);return}J.client=t;const a=Ce(()=>{if(!t.connected){a();return}for(const i of t.devices.filter(n=>n.vibrateAttributes.length>0)){const n=J.deviceSettings?.get(i.name);if(!n)continue;const s=n.SlotName,u=Player.Appearance.find(c=>c.Asset.Group.Name===s)?.Property?.Intensity;if(n.LastIntensity!==u)if(n.LastIntensity=u,typeof u!="number"||u<0)i.vibrate(0);else switch(u){case 0:i.vibrate(.1),y(i.name,s,"intensity 0.1");break;case 1:i.vibrate(.4),y(i.name,s,"intensity 0.4");break;case 2:i.vibrate(.75),y(i.name,s,"intensity 0.75");break;case 3:i.vibrate(1),y(i.name,s,"intensity 1");break;default:z("Invalid intensity in ",s,":",u);break}}},3e3);Commands.push({Tag:"toybatteries",Description:d("Shows the battery status of all connected buttplug.io toys"),Action:()=>{(async()=>{if(!t.connected){H("buttplug.io is not connected");return}const i=t.devices.filter(s=>s.hasBattery);if(i.length===0){H("No battery devices connected");return}const n=await Promise.all(i.map(s=>s.battery()));for(let s=0;s<i.length;s++){const u=n[s]*100;H(`${i[s].name}: ${u}%`)}})()}}),Commands.push({Tag:"toyscan",Description:d("Scans for connected buttplug.io toys"),Action:()=>{if(!t.connected){H(d("buttplug.io is not connected"));return}if(t.isScanning){t.stopScanning(),H(d("Scanning stopped"));return}t.startScanning(),H(d("Scanning for toys"))}}),await t.startScanning()}let Je;async function Ot(e){const{Dexie:r}=await import("./dexie.js"),t=new r("wce-local-wardrobe");t.version(1).stores({wardrobe:"id, appearance"}),Je=t.table("wardrobe");const o=await Je.toArray()||[];await U(()=>e.length===ge),e.push(...o.map(a=>ht(a.appearance)))}async function $t(e){await Je.bulkPut(e.map((r,t)=>({id:t,appearance:r})))}function ht(e){return Array.isArray(e)?e.map(r=>{if(typeof r.Property?.Type=="string"&&!CommonIsObject(r.Property?.TypeRecord)){const t=AssetGet("Female3DCG",r.Group,r.Name);t&&(r.Property.TypeRecord=ExtendedItemTypeToRecord(t,r.Property.Type))}return r}):e}function Ht(e){l.extendedWardrobe&&(WardrobeSize=ge,WardrobeFixLength());const r=Player.ExtensionSettings.FBCWardrobe||Player.OnlineSettings?.BCEWardrobe;if(r){Player.OnlineSettings?.BCEWardrobe&&(Player.ExtensionSettings.FBCWardrobe=r,ServerPlayerExtensionSettingsSync("FBCWardrobe"),me("Migrated wardrobe from OnlineSettings to ExtensionSettings"),delete Player.OnlineSettings.BCEWardrobe);try{const t=le(LZString.decompressFromUTF16(r));if(it(t))for(let o=Te;o<ge;o++){const a=o-Te;if(a>=t.length)break;e[o]=ht(t[a])}}catch(t){ie("Failed to load extended wardrobe",t),Oe("Wardrobe error",`Failed to load extended wardrobe.

Backup: ${r}`),me("Backup wardrobe",r)}}return e}async function Vt(){await U(()=>!!ServerSocket),f.hookFunction("CharacterCompressWardrobe",C.Top,(e,r)=>{const[t]=e;if(it(t)){const o=t.slice(Te,ge);if(o.length>0){Player.ExtensionSettings.FBCWardrobe=LZString.compressToUTF16(JSON.stringify(o)),e[0]=t.slice(0,Te),ServerPlayerExtensionSettingsSync("FBCWardrobe");const a=t.slice(ge);a.length>0&&$t(a)}}return r(e)}),f.hookFunction("WardrobeLoadCharacterNames",C.ModifyBehaviourMedium,(e,r)=>{if(!l.localWardrobe)return r(e);Player.WardrobeCharacterNames||(Player.WardrobeCharacterNames=[]);let t=!1;for(;Player.WardrobeCharacterNames.length<=WardrobeSize;)Player.WardrobeCharacterNames.length<ge?(Player.WardrobeCharacterNames.push(Player.Name),t=!0):Player.WardrobeCharacterNames.push("Local");return t&&ServerAccountUpdate.QueueData({WardrobeCharacterNames:Player.WardrobeCharacterNames.slice(0,ge)}),null})}const pe=new Map;function Ut(){const e=["https://fs.kinkop.eu","https://i.imgur.com"];let r=!1;function t(o,a=null){r||(r=!0,FUSAM.modals.open({prompt:d(`Do you want to allow 3rd party ${a??"content"} to be loaded from $origin? $trusted`,{$origin:o,$trusted:e.includes(o)?d("(This origin is trusted by authors of WCE)"):""}),callback:i=>{r=!1,i==="submit"?pe.set(o,"allowed"):i==="cancel"&&pe.set(o,"denied")},buttons:{cancel:d("Deny for session"),submit:d("Allow for session")}}))}f.hookFunction("ChatAdminRoomCustomizationProcess",C.OverrideBehaviour,(o,a)=>{if(!l.customContentDomainCheck)return a(o);try{const[{ImageURL:i,MusicURL:n}]=o,s=i&&new URL(i).origin,u=n&&new URL(n).origin;if(s&&!pe.has(s)?t(s,"image"):u&&!pe.has(u)&&t(u,"music"),(!i||pe.get(s)==="allowed")&&(!n||pe.get(u)==="allowed"))return a(o)}catch{}return null}),f.hookFunction("ChatAdminRoomCustomizationClick",C.Observe,(o,a)=>{for(const i of[ElementValue("InputImageURL").trim(),ElementValue("InputMusicURL").trim()])try{const n=new URL(i);pe.set(n.origin,"allowed")}catch{}return a(o)})}const mt="\\uf130\\u005d",Ne={Image:"img",None:"",Untrusted:"none-img"};function gt(e){try{const r=new URL(e);return["http:","https:"].includes(r.protocol)?r:!1}catch{return!1}}const ft=["..","--"],yt=["...","~","~..","~~","..~"],bt=["ah","aah","mnn","nn","mnh","mngh","haa","nng","mnng"];function Ct(e,r){if(!e?.length)return{results:[e],stutter:!1};const t=B=>/^\p{L}/u.test(B)?`${B.substring(0,/\uD800-\uDFFF/u.test(B[0])?2:1)}-${B}`:B,o=Math.max(0,...Player.Appearance.filter(B=>(B.Property?.Intensity??-1)>-1).map(B=>B.Property?.Intensity??0)),a=Player.ArousalSettings?.Progress??0,i=o*5,n=Math.max(0,a-10+i)*.5/100,s=Math.max(0,a/2-20+i*2)*.5/100;let u=!1;const c=Math.random();for(let B=Math.min(4,Math.max(1,o));B>=1;B--)(c<n/B||B===1&&r&&n>0)&&(e=t(e),u=!0);const h=[e];if(o>0&&Math.random()<s){const B=ft[Math.floor(Math.random()*ft.length)],x=bt[Math.floor(Math.random()*bt.length)],P=yt[Math.floor(Math.random()*yt.length)];h.push(" ",`${B}${d(x)}${P}`),u=!0}return{results:h,stutter:u}}function jt(e){const r=["cdn.discordapp.com","media.discordapp.com","i.imgur.com","tenor.com","c.tenor.com","media.tenor.com","i.redd.it","puu.sh","fs.kinkop.eu"].includes(e.host)||pe.get(e.origin)==="allowed";return/\/[^/]+\.(png|jpe?g|gif)$/u.test(e.pathname)?r?Ne.Image:Ne.Untrusted:Ne.None}function Re(e,r){const t=[];let o="";for(const a of e.childNodes){if(a.nodeType!==Node.TEXT_NODE){t.push(a);const s=a;(s.classList.contains("ChatMessageName")||s.classList.contains("bce-message-Message"))&&t.push(document.createTextNode(" "));continue}const i=a.textContent?.trim()??"",n=[i];o+=a.textContent;for(let s=0;s<n.length;s++){const u=n[s].search(/[\s\r\n]/u);if(u>=1)n.splice(s+1,0,n[s].substring(u)),n[s]=n[s].substring(0,u);else if(u===0){n.splice(s+1,0,n[s].substring(1)),[n[s]]=n[s],t.push(document.createTextNode(n[s]));continue}const c=gt(n[s].replace(/(^\(+|\)+$)/gu,""));if(c){let h=null;const B=document.createElement("a");t.push(B);const x=jt(c);switch(x){case Ne.Image:{const P=document.createElement("img");P.src=c.href,P.alt=c.href,P.onload=r,P.classList.add("bce-img"),B.classList.add("bce-img-link"),h=P}break;default:if(h=document.createTextNode(c.href),x!==Ne.None){const P=document.createElement("a");P.onclick=O=>{O.preventDefault(),O.stopPropagation();const A=O.target;FUSAM.modals.open({prompt:d("Do you want to add $origin to trusted origins?",{$origin:c.origin}),callback:m=>{if(m==="submit"){pe.set(c.origin,"allowed");const D=A.parentElement;if(!D)throw new Error("clicked promptTrust has no parent");D.removeChild(A);const v=D.querySelector(".ChatMessageName");D.innerHTML="",v&&(D.appendChild(v),D.appendChild(document.createTextNode(" ")));const I=D.getAttribute("bce-original-text");if(!I)throw new Error("clicked promptTrust has no original text");D.appendChild(document.createTextNode(I)),Re(e,r),y("updated trusted origins",pe)}},buttons:{submit:d("Trust this session")}})},P.href="#",P.title=d("Trust this session"),P.textContent=d("(embed)"),t.push(document.createTextNode(" ")),t.push(P)}break}B.href=c.href,B.title=c.href,B.target="_blank",B.appendChild(h)}else if(/^#[0-9a-fA-F]{3}([0-9a-fA-F]{3})?$/u.test(n[s])){const h=document.createElement("span");h.classList.add("bce-color"),h.style.background=n[s],t.push(h),t.push(document.createTextNode(n[s]))}else t.push(document.createTextNode(n[s]))}}for(;e.firstChild;)e.removeChild(e.firstChild);for(const a of t)e.appendChild(a);e.setAttribute("bce-original-text",o)}const Qe=e=>{const r=document.createElement("div");r.setAttribute("class","ChatMessage bce-notification"),r.setAttribute("data-time",ChatRoomCurrentTime()),r.setAttribute("data-sender",Player.MemberNumber?.toString()),typeof e=="string"?r.appendChild(document.createTextNode(e)):Array.isArray(e)?r.append(...e):r.appendChild(e),ChatRoomAppendChat(r),Re(r,()=>{ElementIsScrolledToEnd("TextAreaChatLog")&&ElementScrollToEnd("TextAreaChatLog")})};function _t(){f.hookFunction("ChatRoomKeyDown",C.ModifyBehaviourMedium,([t],o)=>{if(document.activeElement.id==="InputChat"){if(t.key==="Enter"&&!t.shiftKey){if(fbcSettingValue("ctrlEnterOoc")&&t.ctrlKey&&ElementValue("InputChat")?.trim()){let a=ElementValue("InputChat"),i="";if(!a)return fbcChatNotify("Nothing to send!"),!0;if(a.startsWith("/w ")){const n=a.split(" ");a=n.slice(2).join(" "),i=`${n.slice(0,2).join(" ")} `}else if(a.startsWith("/")&&!a.startsWith("//"))return fbcChatNotify("Tried to OOC send a command. Use double // to confirm sending to chat."),!0;ElementValue("InputChat",`${i}(${a.replace(/\)/g,mt)}`)}return ChatRoomSendChat(),!0}if(t.metaKey&&(t.key==="ArrowUp"||t.key==="ArrowDown"))return ChatRoomScrollHistory(t.key==="ArrowUp"),!0}return o([t])}),f.hookFunction("ChatRoomMessageDisplay",C.ModifyBehaviourMedium,([t,o,a,i],n)=>n([t,o.replace(new RegExp(mt,"g"),")"),a,i])),f.hookFunction("SpeechTransformProcess",C.ModifyBehaviourMedium,([t,o,a,i],n)=>{const{msg:s,hasStuttered:u}=e(o||""),c=n([t,s,a.filter(h=>h!=="stutter"||!l.stutters),i]);return u&&c.effects.push("stutter"),c});function e(t){const o=[t];let a=!0,i=!1;const n=[];let s=!1;for(let u=0;u<o.length;u++){const c=o[u].search(/[\s\r\n]/u);if(c>=1)o.splice(u+1,0,o[u].substring(c)),o[u]=o[u].substring(0,c);else if(c===0){o.splice(u+1,0,o[u].substring(1)),[o[u]]=o[u],n.push(o[u]);continue}const h=o[u].search(/[()]/u);if(h>0?(o.splice(u+1,0,o[u].substring(h+1)),o.splice(u+1,0,o[u].substring(h,h+1)),o[u]=o[u].substring(0,h)):h===0&&o[u].length>1&&(o.splice(u+1,0,o[u].substring(1)),[o[u]]=o[u]),o[u]==="("&&(i=!0),gt(o[u])&&!i)n.push("( "),n.push(o[u]),n.push(" )");else if(l.stutters&&!i){const{results:B,stutter:x}=Ct(o[u],a);s||=x,n.push(...B),a=!1}else n.push(o[u]);o[u]===")"&&(i=!1)}return{msg:n.join(""),hasStuttered:s}}function r(){if(CurrentScreen!=="ChatRoom"||!l.augmentChat)return;const t="TextAreaChatLog",o="data-bce-handled",a=document.querySelectorAll(`.ChatMessage:not([${o}=true])`);for(const i of a)if(i.setAttribute(o,"true"),(i.classList.contains("ChatMessageChat")||i.classList.contains("ChatMessageWhisper"))&&!i.classList.contains("bce-pending")){const n=ElementIsScrolledToEnd(t);Re(i,()=>{n&&ElementScrollToEnd(t)}),n&&ElementScrollToEnd(t)}}Ce(r,500)}let l={},Et=!1;const oe={animationEngine:{label:"Animation Engine",type:"checkbox",value:!1,sideEffects:e=>{e&&Player.ArousalSettings&&(Player.ArousalSettings.AffectExpression=!1),e||(l.expressions=!1,l.activityExpressions=!1),y("animationEngine",e)},category:"activities",description:"Enables the animation engine. This will replace the game's expression and pose system."},expressions:{label:"Automatic Arousal Expressions (Replaces Vanilla)",type:"checkbox",value:!1,disabled:()=>!l.animationEngine,sideEffects:e=>{y("expressions",e)},category:"activities",description:"Automatically express arousal when performing an activity (requires Animation Engine)."},activityExpressions:{label:"Activity Expressions",type:"checkbox",value:!1,disabled:()=>!l.animationEngine,sideEffects:e=>{y("activityExpressions",e)},category:"activities",description:"Automatically express reactions to certain activities (requires Animation Engine)."},alternateArousal:{label:"Alternate Arousal (Replaces Vanilla, requires hybrid/locked arousal meter)",type:"checkbox",value:!1,sideEffects:e=>{xe(),Player.BCEArousal=!!e,Player.BCEArousalProgress=Math.min(Me,Player.ArousalSettings?.Progress??0),y("alternateArousal",e)},category:"activities",description:"More intense activities will affect arousal faster."},stutters:{label:"Alternative speech stutter",type:"checkbox",value:!1,sideEffects:e=>{y("stutters",e)},category:"activities",description:"More stuttering at high arousal, moans between words with vibrators."},numericArousalMeter:{label:"Show numeric arousal meter",type:"checkbox",value:!0,sideEffects:e=>{y("numericArousalMeter",e)},category:"activities",description:"Shows the numeric value of arousal meters when expanded."},copyColor:{label:"Enable option to copy color to all item's of the same type",type:"checkbox",value:!1,sideEffects:e=>{y("copyColor",e)},category:"appearance",description:"Enable option to copy color to all item's of the same type."},extendedWardrobe:{label:"Extended wardrobe slots (96)",type:"checkbox",value:!1,sideEffects:e=>{y("extendedWardrobe",e),e?Player.Wardrobe?(WardrobeSize=ge,Ht(Player.Wardrobe),CharacterCompressWardrobe(Player.Wardrobe)):z("Player.Wardrobe not found, skipping wardrobe extension"):(l.localWardrobe=!1,WardrobeSize=Te,WardrobeFixLength(),CharacterAppearanceWardrobeOffset=0)},category:"appearance",description:"Increase the amount of wardrobe slots to save more outfits."},localWardrobe:{label:"Local Wardrobe (+288)",type:"checkbox",value:!1,disabled:()=>!l.extendedWardrobe,sideEffects:e=>{y("localWardrobe",e),e?Player.Wardrobe?(WardrobeSize=Lt,Ot(Player.Wardrobe),CharacterCompressWardrobe(Player.Wardrobe)):z("Player.Wardrobe not found, skipping wardrobe extension"):(WardrobeSize=ge,WardrobeFixLength(),CharacterAppearanceWardrobeOffset=0)},category:"appearance",description:"Enables the Local Wardrobe - save 288 additional outfits on your device (not synced between devices, but shared between alts on the same device)."},privateWardrobe:{label:"Replace wardrobe list with character previews",type:"checkbox",value:!1,sideEffects:e=>{y("privateWardrobe",e)},category:"appearance",description:"Allows you to preview all saved outfits at a glance, no more having to remember names."},confirmWardrobeSave:{label:"Confirm overriding wardrobe outfits",type:"checkbox",value:!1,sideEffects:e=>{y("confirmWardrobeSave",e)},category:"appearance",description:"When saving over an already existing wardrobe outfit you'll ask for confirmation, preventing accidentally overwriting outfits."},automateCacheClear:{label:"Clear Drawing Cache Hourly",type:"checkbox",value:!1,sideEffects:e=>{y("automateCacheClear",e)},category:"performance",description:"Automatically clears the drawing cache every hour, preventing memory usage from growing out of control during long play sessions."},manualCacheClear:{label:"Adds a clear / reload drawing cache button",type:"checkbox",value:!1,sideEffects:e=>{y("manualCacheClear",e)},category:"performance",description:"Adds a button to the chat room menu to clear and reload the drawing cache of all characters, helping to fix buged / non-loaded assets."},instantMessenger:{label:"Instant messenger",type:"checkbox",value:!0,sideEffects:e=>{y("instantMessenger",e)},category:"chat",description:"Allows you to send messages to other players without having to open the friends list, with enhancements."},augmentChat:{label:"Chat Links and Embeds",type:"checkbox",value:!0,sideEffects:e=>{y("augmentChat",e)},category:"chat",description:"Adds clickable links and image embeds from trusted domains only (e.g. imgur) to chat messages."},ctrlEnterOoc:{label:"Use Ctrl+Enter to OOC",type:"checkbox",value:!0,sideEffects:e=>{y("ctrlEnterOoc",e)},category:"chat",description:"Allows you to use Ctrl+Enter to send OOC messages."},whisperInput:{label:"Use italics for input when whispering",type:"checkbox",value:!0,sideEffects:e=>{y("whisperInput",e)},category:"chat",description:"Changes the input field to italics when you're in whisper mode to make it more obvious."},chatColors:{label:"Improve colors for readability",type:"checkbox",value:!0,sideEffects:e=>{e?document.body.classList.add(be):document.body.classList.remove(be),y("chatColors",e)},category:"chat",description:"Improves contrast between the colors used for chat messages to comply with web accessibility standards."},friendPresenceNotifications:{label:"Show friend presence notifications",type:"checkbox",value:!1,sideEffects:e=>{y("friendPresenceNotifications",e)},category:"chat",description:"Enables friend presence tracking and shows a notification when a friend logs in."},friendOfflineNotifications:{label:"Show friends going offline too",type:"checkbox",value:!1,sideEffects:e=>{y("friendOfflineNotifications",e)},category:"chat",description:"Shows a notification when a friend logs out. (Requires friend presence)"},friendNotificationsInChat:{label:"Show friend presence notifications in chat, when possible",type:"checkbox",value:!1,sideEffects:e=>{y("friendNotificationsInChat",e)},category:"chat",description:"Shows friend presence notifications in chat, when possible. (Requires friend presence)"},pastProfiles:{label:"Save & browse seen profiles (requires refresh)",type:"checkbox",value:!1,sideEffects:e=>{y("pastProfiles",e)},category:"chat",description:"Saves the profiles for everyone you've seen and allows you to browse them using /profiles in chatrooms."},pendingMessages:{label:"Show sent messages while waiting for server",type:"checkbox",value:!0,sideEffects:e=>{y("showSentMessages",e)},category:"chat",description:"Shows messages you've sent while waiting for the server to respond, confirming you have sent the message and the server is just being slow."},whisperButton:{label:"Show whisper button on chat messages",type:"checkbox",value:!0,sideEffects:e=>{y("whisperButton",e)},category:"chat",description:"Adds a whisper button to chat messages, allowing you to whisper to the sender more conveniently."},richOnlineProfile:{label:"Rich online profile",type:"checkbox",value:!0,sideEffects:e=>{y("richOnlineProfile",e)},category:"chat",description:"Changes the online profile to support clickable links and embedded images."},whisperTargetFixes:{label:"Improved whisper target handling",type:"checkbox",value:!0,sideEffects:e=>{y("whisperTargetFixes",e)},category:"chat",description:"Automatically reset whisper target if they leave the room for more than one minute and after the first invalid whisper target warning message."},antiGarble:{label:"Anti Garble",type:"checkbox",value:!1,sideEffects:(e,r)=>{e?r||(l.antiGarbleChatOptions=!0,oe.antiGarbleChatOptions.sideEffects(!0),l.antiGarbleChatLevel="none",l.antiGarbleChatBabyTalk="remove",l.antiGarbleChatStutter="ignore",l.antiGarbleWhisperLevel="none",l.antiGarbleWhisperBabyTalk="remove",l.antiGarbleWhisperStutter="ignore"):(l.antiGarbleChatOptions=!1,oe.antiGarbleChatOptions.sideEffects(!1),l.antiGarbleChatLevel="full",l.antiGarbleChatBabyTalk="preserve",l.antiGarbleChatStutter="preserve",l.antiGarbleWhisperLevel="full",l.antiGarbleWhisperBabyTalk="preserve",l.antiGarbleWhisperStutter="preserve"),y("antiGarble",e)},category:"antigarble",description:"Enables the anti-garble system. Allowing you to send less garbled version of your messages together with the garbled one to others, who could read it in brackets."},antiGarbleChatOptions:{label:"Anti Garble chat options",type:"checkbox",value:!1,disabled:()=>!l.antiGarble,sideEffects:e=>{y("antiGarbleChatoptions",e),e?(ChatRoomChatLogRect=[1005,66,988,805],ChatRoomChatInputRect=[1405,938,800,120],ChatRoomChatLengthLabelRect=[1644,970,120,82]):(ChatRoomChatLogRect=[1005,66,988,835],ChatRoomChatInputRect=[1453,953,895,90],ChatRoomChatLengthLabelRect=[1764,970,120,82])},category:"antigarble",description:"Adds quick options for your anti-garble settings to the chat input menu."},antiGarbleChatLevel:{label:"Chat garble level:",type:"select",value:"none",options:["none","low","medium","high","full"],tooltips:["Chat garble level: none (send a fully ungarbled message to the recipient, shown in brackets)","Chat garble level: low (send a partly ungarbled message, which is only garbled up to the low garbel level 1)","Chat garble level: medium (send a partly ungarbled message, which is only garbled up to the medium garbel level 3)","Chat garble level: high (send a partly ungarbled message, which is only garbled up to the high garbel level 5)","Chat garble level: full (always only sends the full garbled message, no ungarbled message in brackets)"],disabled:()=>!l.antiGarble,sideEffects:e=>{y("antiGarbleChatLevel",e)},category:"antigarble",description:"Sends an ungarbled (or lower garbled up to the selected value) chat message together with the garbled messages, which is shown on the recipient side in brackets (defaults to full = no ungarbling)."},antiGarbleChatStutter:{label:"Chat stutters:",type:"select",value:"preserve",options:["remove","ignore","preserve"],tooltips:["Chat stutters: remove (always remove chat stutters, even if it is the only effect)","Chat stutters: ignore (remove chat stutters if ungarbling gag speech, but ignore it if it's the only effect)","Chat stutters: preserve (always preserve chat stutters in the ungarbled text in brackets)"],disabled:()=>!l.antiGarble||l.antiGarbleChatLevel==="full",sideEffects:e=>{typeof e=="boolean"&&(l.antiGarbleChatStutter=e?"preserve":"ignore"),y("antiGarbleChatoptions",e)},category:"antigarble",description:"Controls if stutters in chat messages are always removed, ignored (only removed if other ungarbling applied) or preserved."},antiGarbleChatBabyTalk:{label:"Chat baby talk:",type:"select",value:"preserve",options:["remove","ignore","preserve"],tooltips:["Chat baby talk: remove (always remove chat baby talk, even if it is the only effect)","Chat baby talk: ignore (remove chat baby talk if ungarbling gag speech, but ignore it if it's the only effect)","Chat baby talk: preserve (always preserve chat baby talk in the ungarbled text in brackets)"],disabled:()=>!l.antiGarble||l.antiGarbleChatLevel==="full",sideEffects:e=>{typeof e=="boolean"&&(l.antiGarbleChatBabyTalk=e?"preserve":"remove"),y("antiGarbleChatBabyTalk",e)},category:"antigarble",description:"Controls if baby talk in chat messages is always removed, ignored (only removed if other ungarbling applied) or preserved."},antiGarbleWhisperLevel:{label:"Whisper garble level:",type:"select",value:"none",options:["none","low","medium","high","full","off"],tooltips:["Whisper garble level: none (send a fully ungarbled whisper to the recipient, shown in brackets)","Whisper garble level: low (send a partly ungarbled whisper, which is only garbled up to the low garbel level 1)","Whisper garble level: medium (send a partly ungarbled whisper, which is only garbled up to the medium garbel level 3)","Whisper garble level: high (send a partly ungarbled whisper, which is only garbled up to the high garbel level 5)","Whisper garble level: full (always only sends the full garbled whisper, no ungarbled message in brackets)","Whisper garble level: off (don't garble whisper messages at all, normal message is ungarbled, no message in brackets)"],disabled:()=>!l.antiGarble,sideEffects:e=>{y("antiGarbleWhisperLevel",e)},category:"antigarble",description:"Sends an ungarbled (or lower garbled) whisper message together with the garbled messages, which is shown on the recipient side in brackets. (off = only sending the ungarbled messages as the original)."},antiGarbleWhisperStutter:{label:"Whispers stutters:",type:"select",value:"preserve",options:["remove","ignore","preserve"],tooltips:["Whispers stutters: remove (always remove whispers stutters, even if it is the only effect)","Whispers stutters: ignore (remove whispers stutters if ungarbling gag speech, but ignore it if it's the only effect)","Whispers stutters: preserve (always preserve whispers stutters in the ungarbled text in brackets)"],disabled:()=>!l.antiGarble||["off","full"].includes(l.antiGarbleWhisperLevel),sideEffects:e=>{typeof e=="boolean"&&(l.antiGarbleWhisperStutter=e?"preserve":"ignore"),y("antiGarbleWhisperStutter",e)},category:"antigarble",description:"Controls if stutters in whispers are always removed, ignored (only removed if other ungarbling applied) or preserved."},antiGarbleWhisperBabyTalk:{label:"Whispers baby talk:",type:"select",value:"preserve",options:["remove","ignore","preserve"],tooltips:["Whispers baby talk: remove (always remove whispers baby talk, even if it is the only effect)","Whispers baby talk: ignore (remove whispers baby talk if ungarbling gag speech, but ignore it if it's the only effect)","Whispers baby talk: preserve (always preserve whispers baby talk in the ungarbled text in brackets)"],disabled:()=>!l.antiGarble||["off","full"].includes(l.antiGarbleWhisperLevel),sideEffects:e=>{typeof e=="boolean"&&(l.antiGarbleWhisperBabyTalk=e?"preserve":"remove"),y("antiGarbleWhisperBabyTalk",e)},category:"antigarble",description:"Controls if baby talk in whispers is always removed, ignored (only removed if other ungarbling applied) or preserved."},lockpick:{label:"Reveal Lockpicking Order Based on Skill",type:"checkbox",value:!1,sideEffects:e=>{y("lockpick",e)},category:"cheats",description:"Randomly reveals the order of some of the pins with higher lockpicking skill revealing more pins on average. Picking can still be impossible like other forms of struggling."},allowLayeringWhileBound:{label:"Allow layering menus while bound",type:"checkbox",value:!1,sideEffects:e=>{y("allowLayeringWhileBound",e)},category:"cheats",description:"Allows you to open menus while bound, even if they're disabled in the settings."},autoStruggle:{label:"Make automatic progress while struggling",type:"checkbox",value:!1,sideEffects:e=>{y("autoStruggle",e)},category:"cheats",description:"All three forms of struggling will be completed automatically in a realistic amount of time, if the restraint is possible to struggle out of."},allowIMBypassBCX:{label:"Allow IMs to bypass BCX beep restrictions",type:"checkbox",value:!1,sideEffects:e=>{y("allowIMBypassBCX",e)},category:"cheats",description:"This setting is temporary until BCX supports a focus mode rule."},antiDeaf:{label:"Anti Deafen",type:"checkbox",value:!1,sideEffects:e=>{y("antiDeaf",e)},category:"cheats",description:"Show original messages in brackets while deafened."},toySync:{label:"Enable buttplug.io (requires refresh)",type:"checkbox",value:!1,sideEffects:e=>{y("toySync",e)},category:"buttplug",description:"Allows the game to control your real vibrators. For a list of supported vibrators see https://buttplug.io"},blindWithoutGlasses:{label:"Require glasses to see",type:"checkbox",value:!1,sideEffects:e=>{e||_e("BlurLight"),y("blindWithoutGlasses",e)},category:"immersion",description:"You will be partially blinded while not wearing glasses."},leashAlways:{label:"Allow leashing without wearing a leashable item (requires leasher to have WCE too)",type:"checkbox",value:!1,sideEffects:e=>{y("leashAlways",e),e?ut():lt()},category:"immersion",description:"Allows you to be leashed between rooms even when you are not wearing an item that counts as a leash to allow roleplaying being carried in arms."},hideHiddenItemsIcon:{label:"Hide the hidden items icon",type:"checkbox",value:!1,sideEffects:e=>{y("hideHiddenItemsIcon",e)},category:"immersion",description:"You can choose to hide items (not on extreme difficulty). The game shows an icon on players that have hidden items. This option hides that icon."},itemAntiCheat:{label:"Enable anti-cheat",type:"checkbox",value:!1,sideEffects:e=>{y("itemAntiCheat",e)},category:"immersion",description:"Prevents certain console cheats from impacting your character. Whitelisted actors are exempt from this."},antiCheatBlackList:{label:"Blacklist detected cheaters automatically",type:"checkbox",value:!1,sideEffects:e=>{y("antiCheatBlackList",e)},category:"immersion",description:"Automatically blacklist detected cheaters. Whitelisted actors are exempt from this."},uwall:{label:"Enable uwall anti-cheat",type:"checkbox",value:!0,sideEffects:e=>{y("uwall",e),Player?.OnlineSharedSettings&&typeof e=="boolean"?(Player.OnlineSharedSettings.Uwall=e,ServerAccountUpdate.QueueData({OnlineSharedSettings:Player.OnlineSharedSettings})):z("Player.OnlineSharedSettings not found, skipping uwall")},category:"immersion",description:"Prevents certain other addon cheats from impacting your character."},relogin:{label:"Automatic Relogin on Disconnect",type:"checkbox",value:!0,sideEffects:e=>{y("relogin",e)},category:"misc",description:"Automatically re-enter your password after you disconnect from the game. For convenience or AFK. Requires the password for the current account to have been saved in the login screen. Passwords are saved in your browser's local storage in plain text."},ghostNewUsers:{label:"Automatically ghost+blocklist unnaturally new users",type:"checkbox",value:!1,sideEffects:e=>{y("ghostNewUsers",e)},category:"misc",description:"Automatically ghost+blocklist unnaturally new users. This is useful for preventing malicious bots, but is not recommended to be enabled normally."},confirmLeave:{label:"Confirm leaving the game",type:"checkbox",value:!0,sideEffects:e=>{y("confirmLeave",e)},category:"misc",description:"When you leave the game, you will be prompted to confirm your decision. This is useful for preventing accidentally closing the tab, but will cause you to reconnect."},discreetMode:{label:"Discreet mode (disable drawing)",type:"checkbox",value:!1,sideEffects:e=>{y("discreetMode",e),e&&(document.getElementById("favicon").href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9oFFAADATTAuQQAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAEklEQVQ4y2NgGAWjYBSMAggAAAQQAAGFP6pyAAAAAElFTkSuQmCC",document.title="OnlineChat")},category:"misc",description:"Disables drawing on the screen. This is useful for preventing accidental drawing."},customContentDomainCheck:{label:"Prompt before loading content from a 3rd party domain",type:"checkbox",value:!0,sideEffects:e=>{y("customContentDomainCheck",e)},category:"misc",description:"Show a confirmation prompt before allowing content from a 3rd party domain to be loaded."},shareAddons:{label:"Share Addons",type:"checkbox",value:!0,sideEffects:e=>{y("shareAddons",e)},category:"misc",description:"Share a list of your installed addons with other WCE users in the room, visible via /versions chat command."},buttplugDevices:{label:"Buttplug Devices",type:"input",value:"",sideEffects:e=>{if(y("buttplugDevices",e),e!=="")try{if(!ce(e))throw new Error("expected string for buttplugDevices");const r=le(e);if(!Array.isArray(r))throw new Error("expected array for devices");for(const t of r)J.deviceSettings.set(t.Name,t)}catch(r){ie(r)}},category:"hidden",description:""},toySyncAddress:{label:"Intiface Address",type:"input",value:"ws://127.0.0.1:12345",sideEffects:e=>{y("toySyncAddress",e)},category:"hidden",description:""}};function zt(){return Et}const vt=()=>`bce.settings.${Player?.AccountName}`;async function Xt(){await U(()=>!!Player?.AccountName);const e=vt();if(y("loading settings"),Object.keys(l).length===0){let r=le(localStorage.getItem(e));const t=le(LZString.decompressFromBase64(Player.ExtensionSettings.FBC||(Player.OnlineSettings?.BCE??""))||null);t||(z("No online settings found"),y("onlineSettings",Player.OnlineSettings),y("extensionSettings",Player.ExtensionSettings)),Player.OnlineSettings?.BCE&&(Player.ExtensionSettings.FBC=Player.OnlineSettings.BCE,ServerPlayerExtensionSettingsSync("FBC"),me("Migrated online settings to extension settings"),delete Player.OnlineSettings.BCE);const o=r?.version||0;if(t&&t.version>=o&&(me("using online settings"),r=t),se(r)||(y("no settings",e),Oe("Welcome to WCE",`Welcome to Wholesome Club Extensions v${window.FBC_VERSION}! As this is your first time using WCE on this account, you may want to check out the settings page for some options to customize your experience. You can find it in the game preferences. Enjoy!`),r={}),!se(r))throw new Error("failed to initialize settings");for(const[a]of Object.entries(oe))if(!(a in r)){if(a==="activityExpressions"&&"expressions"in r){r[a]=r.expressions;continue}r[a]=oe[a].value}return(typeof r.version>"u"||r.version<ct)&&qt(),r.version=ct,l=r,r}return l}function At(){y("saving settings"),J.deviceSettings.size>0&&(l.buttplugDevices=JSON.stringify(Array.from(J.deviceSettings.values()))),localStorage.setItem(vt(),JSON.stringify(l)),Player.ExtensionSettings.FBC=LZString.compressToBase64(JSON.stringify(l)),ServerPlayerExtensionSettingsSync("FBC"),y("saved settings",l)}function Ye(e){return e in oe}function Kt(){y("handling settings side effects");for(const[e,r]of Object.entries(l))if(e!=="version"){if(!Ye(e)){z("Deleting unknown setting",e),delete l[e];continue}oe[e].sideEffects(r,!0)}At(),Et=!0}async function qt(){await U(()=>!!Player?.AccountName),await Ue(5e3),Oe(d("WCE Changelog"),d("WCE has received significant updates since you last used it. See /wcechangelog in a chatroom.")),await U(()=>!!document.getElementById("TextAreaChatLog")),Qe(`Wholesome Club Extensions (WCE) changelog:
${ze}`)}function Jt(e){return Ye(e)?l[e]:!1}const Qt=e=>{switch(e.toLowerCase()){default:return{ActivityChatRoomArousalSync:"BFF3DED7",ActivitySetArousal:"3AE28123",ActivitySetArousalTimer:"1342AFE2",ActivityTimerProgress:"6CD388A7",AppearanceClick:"4E3937AA",AppearanceLoad:"4360C485",AppearanceRun:"EAF1055D",CharacterAppearanceBuildCanvas:"C05FE035",CharacterAppearanceWardrobeLoad:"A5B63A03",CharacterBuildDialog:"85F79C6E",CharacterCompressWardrobe:"2A05ECD1",CharacterDelete:"57AA5D48",CharacterGetCurrent:"69F45A41",CharacterLoadCanvas:"EAB81BC4",CharacterLoadOnline:"B1BCD3B1",CharacterNickname:"A794EFF5",CharacterRefresh:"301DA9CF",CharacterReleaseTotal:"BB9C6989",CharacterSetCurrent:"F46573D8",CharacterSetFacialExpression:"EC032BEE",CharacterSetActivePose:"566A14D7",ChatAdminRoomCustomizationClick:"9D859B28",ChatAdminRoomCustomizationProcess:"AF01C65A",ChatRoomAppendChat:"998F2F98",ChatRoomCharacterUpdate:"DE2DC592",ChatRoomCharacterViewDraw:"CA108410",ChatRoomCharacterViewIsActive:"CD8066FA",ChatRoomClearAllElements:"D67A7839",ChatRoomClick:"747C51C4",ChatRoomCurrentTime:"A462DD3A",ChatRoomDrawCharacterStatusIcons:"198C8657",ChatRoomGenerateChatRoomChatMessage:"6BFAC520",ChatRoomHideElements:"E1435FF3",ChatRoomHTMLEntities:"0A7ADB1D",ChatRoomKeyDown:"CBE6830E",ChatRoomListManipulation:"75D28A8B",ChatRoomMapViewCharacterIsVisible:"286C447D",ChatRoomMapViewCharacterOnWhisperRange:"B0D08E96",ChatRoomMapViewIsActive:"D181020D",ChatRoomMenuBuild:"F76AEFC3",ChatRoomMenuClick:"B1F7EBFB",ChatRoomMenuDraw:"83275135",ChatRoomMessage:"EA9F35DE",ChatRoomRegisterMessageHandler:"C432923A",ChatRoomRun:"975B8ABD",ChatRoomSendChat:"21606D2F",ChatRoomStart:"9B822A9A",CommandExecute:"C5477FA1",CommonClick:"1F6DF7CB",CommonColorIsValid:"390A2CE4",CommonSetScreen:"E10E2148",CraftingClick:"9169F897",CraftingConvertSelectedToItem:"48270B42",CraftingRun:"51577F65",DialogDrawItemMenu:"FCE556C2",DialogLeave:"C37553DC",DialogMenuButtonBuild:"AC1C6466",DialogMenuButtonClick:"C1F5E0AF",DrawArousalMeter:"BB0755AF",DrawArousalThermometer:"7ED6D822",DrawBackNextButton:"7263249E",DrawButton:"B747DF6E",DrawCharacter:"B175AF5E",DrawCheckbox:"00FD87EB",DrawImageEx:"E01BE7E7",DrawImageResize:"D205975A",DrawItemPreview:"6A7A1E2A",DrawProcess:"9776CBC2",DrawText:"C1BF0F50",DrawTextFit:"F9A1B11E",ElementCreateTextArea:"AA4AEDE7",ElementIsScrolledToEnd:"1CC4FE11",ElementPosition:"3D9F7B72",ElementScrollToEnd:"1AC45575",ElementValue:"4F26C62F",FriendListShowBeep:"6C0449BB",GameRun:"337CB358",GLDrawResetCanvas:"81214642",InformationSheetRun:"060A6DBA",InterfaceTextGet:"66603471",InventoryGet:"E666F671","Layering.Init":"C0D32894",LoginClick:"ADA7E2B7",LoginDoLogin:"D4000B03",LoginRun:"D1DB7A8A",LoginSetSubmitted:"C88F4A8E",LoginStatusReset:"18619F02",MouseIn:"CA8B839E",NotificationDrawFavicon:"AB88656B",NotificationRaise:"E8F29646",NotificationTitleUpdate:"0E92F3ED",OnlineGameAllowChange:"3779F42C",OnlineProfileClick:"521146DF",OnlineProfileExit:"1C673DC8",OnlineProfileLoad:"BE8B009B",OnlineProfileRun:"7F57EF9A",PoseSetActive:"22C02050",PreferenceInitPlayer:"F6DF1324",PreferenceSubscreenArousalClick:"D8DCBBB5",PreferenceSubscreenArousalRun:"96A6157B",PreferenceSubscreenRestrictionClick:"EDC419A0",PreferenceSubscreenRestrictionRun:"54908E55",RelogRun:"10AF5A60",RelogExit:"2DFB2DAD",ServerAccountBeep:"37ED13F6",ServerAppearanceBundle:"4D069622",ServerAppearanceLoadFromBundle:"946537FD",ServerClickBeep:"3E6277BE",ServerConnect:"845E50A6",ServerDisconnect:"198FF7E7",ServerInit:"B6CEF7F1",ServerOpenFriendList:"FA8D3CDE",ServerPlayerExtensionSettingsSync:"1776666B",ServerSend:"ABE74E75",ServerSendQueueProcess:"BD4277AC",SkillGetWithRatio:"3EB4BC45",SpeechTransformBabyTalk:"C812EE0E",SpeechTransformGagGarble:"C056FE08",SpeechTransformGagGarbleIntensity:"F61ECBDA",SpeechTransformProcess:"666DDA2F",SpeechTransformShouldBabyTalk:"634BCD64",SpeechTransformStutter:"A930F55E",SpeechTransformStutterIntensity:"4754768A",StruggleDexterityProcess:"D185D348",StruggleFlexibilityCheck:"727CE05B",StruggleFlexibilityProcess:"1A0B96EF",StruggleLockPickDraw:"C04E2FBB",StruggleMinigameHandleExpression:"1B3ABF55",StruggleMinigameStop:"FB05E8A9",StruggleStrengthProcess:"B1A1457D",TextGet:"4DDE5794",TextLoad:"0D535190",TimerInventoryRemove:"1FA771FB",TimerProcess:"BFB7FFE2",TitleExit:"F13F533C",ValidationSanitizeProperties:"659F5965",WardrobeClick:"33405B1D",WardrobeExit:"12D14AE4",WardrobeFastLoad:"AAB9F25B",WardrobeFastSave:"D1E906FD",WardrobeFixLength:"CA3334C6",WardrobeLoad:"C343A4C7",WardrobeLoadCharacterNames:"F39DF5E3",WardrobeRun:"633B3570"}}};async function Yt(){await U(()=>GameVersion!=="R0"&&typeof ServerIsConnected=="boolean"&&ServerIsConnected),me("Checking function integrity with GameVersion",GameVersion);function e(t,o){return o!=="SKIP"}function r(t){return!!t&&typeof t=="object"&&!Array.isArray(t)}for(const[t,o]of ye(Qt(GameVersion))){if(!e(t,o))continue;let a=window;const i=t.split(".");for(let s=0;s<i.length-1;s++)a=a[i[s]],r(a)||z(`Expected Function ${t} not found; ${i.slice(0,s+1).join(".")} is not object`);if(a=a[i.pop()],typeof a!="function"){z(`Expected function ${t} is not a function.`);continue}const n=f.getOriginalHash(t);n!==o&&(z(`Function ${t} has been modified before WCE, potential incompatibility: ${n}`),Ke.push(t))}}const wt="bce-input-warn";function Zt(){const e=`
  .bce-beep-link {
    text-decoration: none;
  }
  #TextAreaChatLog .bce-notification,
  #TextAreaChatLog .bce-notification {
    background-color: #D696FF;
    color: black;
  }
  #TextAreaChatLog[data-colortheme="dark"] .bce-notification,
  #TextAreaChatLog[data-colortheme="dark2"] .bce-notification {
    background-color: #481D64;
    color: white;
  }
  .bce-img-link {
    vertical-align: top;
  }
  .bce-img {
    max-height: 25rem;
    max-width: 90%;
    display: inline;
    border:1px solid red;
    padding: 0.1rem;
  }
  .bce-color {
    width: 0.8em;
    height: 0.8em;
    display: inline-block;
    vertical-align: middle;
    border: 0.1em solid black;
    margin-right: 0.1em;
  }
  .${be} .${pt}.${wt} {
    background-color: #400000 !important;
  }
  .${wt} {
    background-color: yellow !important;
  }
  #TextAreaChatLog a,
  .bce-message a {
    color: #003f91;
    cursor: pointer;
  }
  #TextAreaChatLog a:visited,
  .bce-message a {
    color: #380091;
  }
  .${be} div.ChatMessageWhisper,
  .${be} div.ChatMessageWhisper {
    color: #646464;
  }
  .${be} #TextAreaChatLog[data-colortheme="dark"] div.ChatMessageWhisper,
  .${be} #TextAreaChatLog[data-colortheme="dark2"] div.ChatMessageWhisper {
    color: #828282;
  }
  #TextAreaChatLog[data-colortheme="dark"] a,
  #TextAreaChatLog[data-colortheme="dark2"] a,
  .bce-message a {
    color: #a9ceff;
  }
  #TextAreaChatLog[data-colortheme="dark"] a:visited,
  #TextAreaChatLog[data-colortheme="dark2"] a:visited,
  .bce-message a {
    color: #3d91ff;
  }
  .${It} {
    font-style: italic;
  }
  .${be} .${pt} {
    background-color: #111;
    color: #eee;
    border-color: #333;
  }
  a.bce-button {
    text-decoration: none;
  }
  .bce-hidden {
    display: none !important;
  }
  .bce-false-hidden {
    position: absolute;
    border: 0;
    margin: 0;
    padding: 0;
    top: 0;
    left: 0;
    width: 0.1px;
    height: 0.1px;
    opacity: 0.01;
  }
  .bce-line-icon-wrapper {
    display: none;
    position: absolute;
    right: 1em;
  }
  .ChatMessage:hover .bce-line-icon-wrapper,
  .ChatMessage:focus .bce-line-icon-wrapper,
  .ChatMessage:focus-within .bce-line-icon-wrapper {
    display: inline;
  }
  .bce-line-icon {
    height: 1em;
    vertical-align: middle;
  }
  #bce-instant-messenger {
    display: flex;
    z-index: 100;
    position: fixed;
    width: 80%;
    height: 70%;
    top: 5%;
    left: 10%;
    padding: 0;
    margin: 0;
    flex-direction: row;
    background-color: #111;
    color: #eee;
    border: 0.2em solid white;
    resize: both;
    overflow: auto;
    max-width: 80%;
    max-height: 75%;
    min-width: 38%;
    min-height: 30%;
    overflow-wrap: break-word;
  }
  #bce-friend-list {
    width: 100%;
    overflow-x: hidden;
    overflow-y: scroll;
  }
  .bce-friend-list-entry {
    padding: 1em;
  }
  .bce-friend-list-entry-name {
    font-weight: bold;
    display: flex;
    flex-direction: column;
  }
  .bce-friend-list-selected {
    font-style: italic;
    border-top: 0.1em solid white;
    border-bottom: 0.1em solid white;
    background-color: #222;
  }
  #bce-message-container {
    width: 100%;
    height: 90%;
    font-size: 1.5rem;
    font-family: Arial, sans-serif;
  }
  #bce-message-right-container {
    width: 80%;
    display: flex;
    flex-direction: column;
    border-left: 0.1em solid white;
  }
  #bce-message-input {
    width: 100%;
    height: 10%;
    border: 0;
    padding: 0;
    margin: 0;
    background-color: #222;
    color: #eee;
    font-size: 1.5rem;
    font-family: system-ui;
  }
  .bce-friend-list-unread {
    background-color: #a22;
  }
  .bce-message-divider {
    margin: 0.5em 2em;
    border-bottom: 0.2em solid white;
  }
  .bce-message {
    padding: 0.2em 0.4em;
    position: relative;
    white-space: pre-wrap;
  }
  .bce-message::before {
    content: attr(data-time);
    float: right;
    color: gray;
    font-size: 0.5em;
    margin-right: 0.2em;
    font-style: italic;
  }
  .bce-message-sender {
    text-shadow: 0.05em 0.05em #eee;
    font-weight: bold;
  }
  .bce-message-Emote, .bce-message-Action {
    font-style: italic;
    color: gray;
  }
  .bce-message-Message .bce-message-sender {
    text-shadow: 0.05em 0.05em #eee;
  }
  .bce-friend-history {
    overflow-y: scroll;
    overflow-x: hidden;
    height: 100%;
  }
  .bce-friend-list-handshake-false,
  .bce-friend-list-handshake-pending {
    text-decoration: line-through;
    color: gray;
  }
  #bce-message-left-container {
    display: flex;
    flex-direction: column;
    width: 20%;
    height: 100%;
  }
  #bce-friend-search {
    border: 0;
    border-bottom: 0.1em solid white;
    padding: 0.5em;
    height: 1em;
    background-color: #222;
    color: #eee;
  }
  .bce-profile-open {
    margin-right: 0.5em;
  }
  .bce-pending {
    opacity: 0.4;
  }

  .lds-ellipsis {
    display: inline-block;
    position: relative;
    width: 80px;
    height: 1em;
  }
  .lds-ellipsis div {
    position: absolute;
    top: 44%;
    width: 13px;
    height: 13px;
    border-radius: 50%;
    background: #fff;
    animation-timing-function: cubic-bezier(0, 1, 1, 0);
  }
  .lds-ellipsis div:nth-child(1) {
    left: 8px;
    animation: lds-ellipsis1 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(2) {
    left: 8px;
    animation: lds-ellipsis2 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(3) {
    left: 32px;
    animation: lds-ellipsis2 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(4) {
    left: 56px;
    animation: lds-ellipsis3 0.6s infinite;
  }
  @keyframes lds-ellipsis1 {
    0% {
      transform: scale(0);
    }
    100% {
      transform: scale(1);
    }
  }
  @keyframes lds-ellipsis3 {
    0% {
      transform: scale(1);
    }
    100% {
      transform: scale(0);
    }
  }
  @keyframes lds-ellipsis2 {
    0% {
      transform: translate(0, 0);
    }
    100% {
      transform: translate(24px, 0);
    }
  }

  #bceNoteInput {
    z-index: 100 !important;
  }

  `,r=document.head||document.getElementsByTagName("head")[0],t=document.createElement("style");t.appendChild(document.createTextNode(e)),r.appendChild(t)}const er=[23476,27006,24890],tr=[129178];function rr(){re("DrawBackNextButton",{"Disabled, ArrowWidth":"Disabled, ArrowWidth, tooltipPosition","DrawButtonHover(Left, Top, Width, Height,":"DrawButtonHover(tooltipPosition?.X || Left, tooltipPosition?.Y || Top, tooltipPosition?.Width || Width, tooltipPosition?.Height || Height,"},"DrawBackNextButton tooltip positions may be incorrect."),re("DrawButton",{"HoveringText, Disabled":"HoveringText, Disabled, tooltipPosition","DrawButtonHover(Left, Top, Width, Height,":"DrawButtonHover(tooltipPosition?.X || Left, tooltipPosition?.Y || Top, tooltipPosition?.Width || Width, tooltipPosition?.Height || Height,"},"DrawButton tooltip positions may be incorrect."),re("CommandExecute",{"key.indexOf(CommandsKey + cmd.Tag) == 0)":"key.substring(1) === cmd.Tag)"},"Whitelist commands will not work."),f.hookFunction("InformationSheetRun",C.AddBehaviour,(e,r)=>{if(!InformationSheetSelection||!InformationSheetSelection.MemberNumber)return r(e);const t=r(e),o=er.includes(InformationSheetSelection.MemberNumber),a=tr.includes(InformationSheetSelection.MemberNumber);if(o||a){const i=window.MainCanvas.getContext("2d");if(!i)throw new Error("could not get canvas 2d context");i.textAlign="left",DrawText(d(a?"WCE Developer":"FBC Developer"),550,75,a?"fuchsia":"hotpink","black"),i.textAlign="center"}return t}),f.hookFunction("ServerSend",C.Top,(e,r)=>{const[t,o]=e;if(t!=="AccountUpdate"||!se(o))return r(e);if("ExtensionSettings"in o)throw new Error("misuse of ExtensionSettings detected; write prevented");return r(e)}),f.hookFunction("FriendListLoadFriendList",C.OverrideBehaviour,(e,r)=>{if(document.getElementById("FriendList"))return r(e)}),f.hookFunction("ServerSendQueueProcess",C.OverrideBehaviour,(e,r)=>ServerIsConnected?r(e):null)}function or(){if(typeof StartBcUtil=="function"){Oe(d("Incompatibility"),d("WCE is incompatible with BCUtil. Some functionality from WCE may not work. BCUtil's wardrobe, appearance, and instant messaging functionality are all available within WCE. Go to WCE settings and enable the relevant options, then disable BCUtil to migrate fully to WCE. This beep will appear every time WCE detects BCUtil as having loaded before WCE."));return}re("ServerAccountBeep",{'ChatRoomSendLocal(`<a onclick="ServerOpenFriendList()">(${ServerBeep.Message})</a>`);':'{\n        const beepId = FriendListBeepLog.length - 1;\n        ChatRoomSendLocal(`<a id="bce-beep-reply-${beepId}">\u21A9\uFE0F</a><a class="bce-beep-link" id="bce-beep-${beepId}">(${ServerBeep.Message}${ChatRoomHTMLEntities(data.Message ? `: ${bceStripBeepMetadata(data.Message.length > 150 ? data.Message.substring(0, 150) + "..." : data.Message)}` : "")})</a>`);\n        if (document.getElementById("bce-beep-reply-" + beepId)) {\n          document.getElementById(`bce-beep-reply-${beepId}`).onclick = (e) => {\n            e.preventDefault();\n            ElementValue("InputChat", `/beep ${data.MemberNumber} ${ElementValue("InputChat").replace(/^\\/(beep|w) \\S+ ?/u, \'\')}`);\n            document.getElementById(\'InputChat\').focus();\n          };\n        }\n        if (document.getElementById("bce-beep-" + beepId)) {\n          document.getElementById(`bce-beep-${beepId}`).onclick = (e) => {\n            e.preventDefault();\n            ServerOpenFriendList();\n            FriendListModeIndex = 1;\n            FriendListShowBeep(`${beepId}`);\n          };\n        }\n      }'},"Beeps are not enhanced by WCE.")}let we=null;async function nr(){await U(()=>!!window.bcx),we=window.bcx?.getModApi("WCE")??null}const ar=async()=>{const e="Management";if(we?.getRuleState("block_club_slave_work")?.isEnforced){Pe(d("BCX rules forbid $PlayerName from becoming a Club Slave.",{$PlayerName:CharacterNickname(Player)}));return}if(Pe(d("$PlayerName gets grabbed by two maids and escorted to management to serve as a Club Slave.",{$PlayerName:CharacterNickname(Player)})),!ChatRoomData){ie("ChatRoomData is null in bceStartClubSlave. Was it called outside a chat room?");return}const r=ChatRoomData.Name;if(ChatRoomClearAllElements(),ServerSend("ChatRoomLeave",""),ChatRoomLeashPlayer=null,CommonSetScreen("Room",e),await U(()=>!!ManagementMistress),!ManagementMistress)throw new Error("ManagementMistress is missing");PoseSetActive(Player,"Kneel",!1),ManagementMistress.Stage="320",ManagementMistress.CurrentDialog=d("(You get grabbed by a pair of maids and brought to management.) Your owner wants you to be a Club Slave. Now strip."),CharacterSetCurrent(ManagementMistress),await U(()=>CurrentScreen!==e||!CurrentCharacter),window.bceGotoRoom(r)};function St(e){ChatRoomJoinLeash=e,ChatRoomCharacter=[],DialogLeave(),ChatRoomClearAllElements(),CurrentScreen==="ChatRoom"&&ServerSend("ChatRoomLeave",""),e?ChatRoomStart("X","",null,null,"Introduction",BackgroundsTagList):(ChatRoomSetLastChatRoom(null),CommonSetScreen("Room","MainHall"))}async function ir(){const e=async function(){await U(()=>!!CommonCSVCache["Screens/Online/ChatRoom/Dialog_Online.csv"]&&CommonCSVCache["Screens/Online/ChatRoom/Dialog_Online.csv"].length>150);const o=[["160","100",d("([WCE] Force them to become a Club Slave.)"),d("(She will become a Club Slave for the next hour.)"),"bceSendToClubSlavery()","bceCanSendToClubSlavery()"],["160","160",d("([WCE] Force them to become a Club Slave.)"),d("(Requires both to use compatible versions of WCE and the target to not already be a club slave.)"),"","!bceCanSendToClubSlavery()"]],a=CommonCSVCache["Screens/Online/ChatRoom/Dialog_Online.csv"].findIndex(n=>n[0]==="160")+1;CommonCSVCache["Screens/Online/ChatRoom/Dialog_Online.csv"].splice(a,0,...o);const i=n=>{!n.Dialog||n.Dialog.some(s=>s.FBC)||n.Dialog.splice(a,0,...o.map(s=>({Stage:s[0],NextStage:s[1],Option:s[2],Result:s[3],Function:s[4]===""?null:`ChatRoom${s[4]}`,Prerequisite:s[5],FBC:!0})))};for(const n of ChatRoomCharacter.filter(s=>!s.IsPlayer()&&s.IsOnline()))i(n);f.hookFunction("CharacterBuildDialog",C.AddBehaviour,(n,s)=>{const u=s(n),[c]=n;return ue(c)&&c.IsOnline()&&i(c),u})}();function r(){const o={Type:Le,Content:Xe,Sender:Player.MemberNumber,Dictionary:[{message:{type:Be.Activity,version:Ae,activity:"ClubSlavery"}}]};ServerSend("ChatRoomChat",o),DialogLeave()}function t(){const o=CurrentCharacter;return o?o.BCECapabilities?.includes("clubslave")&&!o.Appearance.some(a=>a.Asset.Name==="ClubSlaveCollar"):!1}window.bceGotoRoom=St,window.ChatRoombceSendToClubSlavery=r,window.ChatRoombceCanSendToClubSlavery=t,await e}async function $e(e){const r=new Map;r.set("Browser",navigator.userAgent),r.set("Game Version",`${GameVersion}${dt.includes(GameVersion)?"":" (unsupported)"}`),r.set("WebGL Version",GLVersion),r.set("WCE Version",Ae),r.set("Loaded via FUSAM",typeof FUSAM=="object"&&FUSAM?.addons?.FBC?"Yes":"No"),r.set("WCE Enabled Settings",`
- ${ye(l).filter(([o,a])=>a||o==="version").map(([o,a])=>`${o}: ${a.toString()}`).join(`
- `)}`),J.client?.connected&&r.set("Buttplug.io Devices",J.client.devices.map(o=>`${o.name} (${o.vibrateAttributes.join(",")})`).join(", ")),r.set("SDK Mods",`
- ${bcModSdk.getModsInfo().map(o=>`${o.name} @ ${o.version}`).join(`
- `)}`),r.set("Incomplete Functions",He.join(", ")),r.set("Modified Functions (non-SDK)",Ke.join(", ")),r.set("Skipped Functionality for Compatibility",`
- ${qe.join(`
- `)}`),r.set("Log",Ve.filter(o=>o).map(o=>`[${o.level.toUpperCase()}] ${o.message}`).join(`
`));const t=Array.from(r).map(([o,a])=>`${o}: ${a}`).join(`
`);return e&&(H(`${t}

**The report has been copied to your clipboard.**`),console.debug(`${t}

**The report has been copied to your clipboard.**`),await navigator.clipboard.writeText(t)),qe.length>0&&H("If you are running another addon that modifies the game, but is not listed above, please tell its developer to use https://github.com/Jomshir98/bondage-club-mod-sdk to hook into the game instead. This is a very cheap and easy way for addon developers to almost guarantee compatibility with other addons."),t}function Ze(e,r=!1){let t=r?ChatRoomCharacterDrawlist:ChatRoomCharacter;if(ChatRoomMapViewIsActive()&&(t=t.filter(ChatRoomMapViewCharacterIsVisible)),e===null)return t;let o=[];return/^\d+$/u.test(e)?o=[t.find(a=>a.MemberNumber===parseInt(e))]:o=t.filter(a=>CharacterNickname(a).split(" ")[0]?.toLowerCase()===e?.toLowerCase()||a.Name.split(" ")[0].toLowerCase()===e?.toLowerCase()),o.filter(Boolean)}async function sr(){await U(()=>!!Commands),y("registering additional commands"),f.hookFunction("ChatRoomAppendChat",C.AddBehaviour,(r,t)=>{if(!l.whisperButton)return t(r);const[o]=r;o.querySelector(".ReplyButton")?.remove();const a=o.getAttribute("data-sender"),i=a?Ze(a):[];if(a&&a!==Player.MemberNumber?.toString()&&i.length>0&&(ChatRoomCharacterViewIsActive()||i.some(ChatRoomMapViewCharacterOnWhisperRange))){const n=document.createElement("a");n.href="#",n.onclick=u=>{u.preventDefault(),ElementValue("InputChat",`/w ${a} ${ElementValue("InputChat").replace(/^\/(beep|w(hisper)?) \S+ ?/u,"")}`),window.InputChat?.focus()},n.title="Whisper",n.classList.add("bce-line-icon-wrapper");const s=document.createElement("img");s.src="https://fielr.github.io/scripts/wce/whisper.png",s.alt="Whisper",s.classList.add("bce-line-icon"),n.appendChild(s),o.prepend(n)}return t(r)});const e=[{Tag:"fbcdebug",Description:d("Get debug information to share with developers."),Action:()=>$e(!0)},{Tag:"fbcchangelog",Description:d("Show recent WCE changelog"),Action:()=>{Qe(ze)}},{Tag:"wcedebug",Description:d("Get debug information to share with developers."),Action:()=>$e(!0)},{Tag:"wcechangelog",Description:d("Show recent WCE changelog"),Action:()=>{Qe(ze)}},{Tag:"wcegotoroom",Description:d("[room name or empty] switches to the room or leaves room if empty (ignoring all restrictions)"),Action:(r,t)=>{St(t.substring(13).trim())}},{Tag:"exportlooks",Description:d("[target member number]: Copy your or another player's appearance in a format that can be imported with WCE or BCX"),Action:async(r,t,o)=>{const[a]=o;let i=null;if(a?i=Character.find(v=>v.MemberNumber===parseInt(a))??null:i=Player,!i){me("Could not find member",a);return}const[n]=await FUSAM.modals.openAsync({prompt:d("Include binds?"),buttons:{cancel:"No",submit:"Yes"}}),s=n==="submit";let u=!1;if(s){const[v]=await FUSAM.modals.openAsync({prompt:d("Include locks?"),buttons:{cancel:"No",submit:"Yes"}});u=v==="submit"}const[c]=await FUSAM.modals.openAsync({prompt:d("Include height, body type, hair, etc?"),buttons:{cancel:"No",submit:"Yes"}}),h=c==="submit",B=i.Appearance.filter(v=>v.Asset.Group.IsDefault&&!v.Asset.Group.Clothing),x=i.Appearance.filter(v=>v.Asset.Group.Category==="Appearance"&&v.Asset.Group.Clothing),P=i.Appearance.filter(v=>v.Asset.Group.Category==="Item"&&!v.Asset.Group.BodyCosplay),O=[...x];s&&O.push(...P),h&&O.push(...B);const A=O.map(v=>{const I=v.Property?{...v.Property}:{};return!u&&I.LockedBy&&(delete I.LockedBy,delete I.LockMemberNumber),I?.LockMemberNumber&&(I.LockMemberNumber=Player.MemberNumber),{Group:v.Asset.Group.Name,Name:v.Asset.Name,Color:v.Color,Difficulty:v.Difficulty,Property:I,Craft:v.Craft}}),m=i.IsPlayer()?"yourself":CharacterNickname(i),D=LZString.compressToBase64(JSON.stringify(A));FUSAM.modals.openAsync({prompt:d(d("Copy the looks string below")),input:{initial:D,readonly:!0,type:"textarea"},buttons:{submit:"Done"}}),await navigator.clipboard.writeText(D),H(d("Exported looks for $TargetName copied to clipboard",{$TargetName:m}))}},{Tag:"importlooks",Description:d("Import looks from a string (BCX or WCE export)"),Action:()=>{if(!Player.CanChangeOwnClothes()||!OnlineGameAllowChange()){H(d("You cannot change your appearance while bound or during online games, such as LARP."));return}FUSAM.modals.open({prompt:d("Paste your looks here"),input:{initial:"",readonly:!1,type:"textarea"},callback:(r,t)=>{if(r==="submit"){if(!t){H(d("No looks string provided"));return}try{const o=t.startsWith("[")?le(t):le(LZString.decompressFromBase64(t));if(!Array.isArray(o)||o.length===0||!o[0].Group)throw new Error("Invalid bundle");for(const a of Player.Appearance)if(a.Property?.LockedBy&&!DialogCanUnlock(Player,a)){const i={Group:a.Asset.Group.Name,Name:a.Asset.Name,Color:a.Color,Difficulty:a.Difficulty,Property:a.Property},n=o.findIndex(s=>s.Group===a.Asset.Group.Name);n<0?o.push(i):o[n]=i}ServerAppearanceLoadFromBundle(Player,"Female3DCG",o,Player.MemberNumber),ChatRoomCharacterUpdate(Player),H(d("Applied looks"))}catch(o){console.error(o),H(d("Could not parse looks"))}}}})}},{Tag:"beep",Description:d("[membernumber] [message]: beep someone"),Action:(r,t,o)=>{we?.getRuleState("speech_restrict_beep_send")?.isEnforced&&H(d("Sending beeps is restricted by BCX rule."));const[a]=o,[,,...i]=t.split(" "),n=i?.join(" ");if(!a||!n||!/^\d+$/u.test(a)){H(d("beep target or message not provided"));return}const s=parseInt(a);if(!Player.FriendList?.includes(s)){H(d("$Target is not in your friend list",{$Target:a}));return}const u=Player.FriendNames?.get(s)??`unknown (${s})`;ServerSend("AccountBeep",{BeepType:"",MemberNumber:s,Message:n,IsSecret:!0}),FriendListBeepLog.push({MemberNumber:s,MemberName:u,Sent:!0,Private:!1,Time:new Date,Message:n});const c=FriendListBeepLog.length-1,h=document.createElement("a");h.href=`#beep-${c}`,h.onclick=B=>{B.preventDefault(),ServerOpenFriendList(),FriendListModeIndex=1,FriendListShowBeep(c)},h.textContent=d("(Beep to $Name ($Number): $Message)",{$Name:u,$Number:s.toString(),$Message:n.length>150?`${n.substring(0,150)}...`:n}),h.classList.add("bce-beep-link"),H(h)}},{Tag:"w",Description:d("[target name] [message]: whisper the target player. Use first name only. Finds the first person in the room with a matching name, left-to-right, top-to-bottom."),Action:(r,t,o)=>{o.length<2&&H(d("Whisper target or message not provided"));const[a]=o,[,,...i]=t.split(" "),n=i?.join(" "),s=Ze(a);if(!a||!s||s.length===0)H(`Whisper target not found: ${a}`);else if(s.length>1)H(d("Multiple whisper targets found: $Targets. You can still whisper the player by clicking their name or by using their member number.",{$Targets:s.map(u=>`${CharacterNickname(u)} (${u.MemberNumber??""})`).join(", ")}));else if(!n)H(d("No message provided"));else{const u=s[0].MemberNumber,c=ChatRoomTargetMemberNumber;ChatRoomTargetMemberNumber=u??null,ElementValue("InputChat",`${n.length>0&&[".","/"].includes(n[0])?"\u200B":""}${n}`),ChatRoomSendChat(),ChatRoomLastMessage.pop(),ChatRoomTargetMemberNumber=c}}},{Tag:"versions",Description:d("show versions of the club, WCE, BCX and other mods in use by players"),Action:(r,t,o)=>{const a=n=>`${CharacterNickname(n)} (${n.MemberNumber??""}) club ${n.OnlineSharedSettings?.GameVersion??"R0"}${window.bcx?.getCharacterVersion(n.MemberNumber)?` BCX ${window.bcx.getCharacterVersion(n.MemberNumber)??"?"}`:""}${n.FBC?`
WCE v${n.FBC} Alt Arousal: ${n.BCEArousal?.toString()}`:""}${n.FBCOtherAddons&&n.FBCOtherAddons.some(s=>!["BCX","FBC","WCE"].includes(s.name))?`
Other Addons:
- ${n.FBCOtherAddons.filter(s=>!["BCX","FBC","WCE"].includes(s.name)).map(s=>`${s.name} v${s.version} ${s.repository??""}`).join(`
- `)}`:""}`,i=Ze(o.length>0?o[0]:null,!0).map(a).filter(n=>n).join(`

`);H(i),y(i)}}];for(const r of e){if(Commands.some(t=>t.Tag===r.Tag)){y("already registered",r);continue}Commands.push(r)}}const et=900,Dt=200;async function ur(){await U(()=>!!PreferenceSubscreenList),y("initializing");const e=8,r=70,t=225,o=k=>Math.ceil(Object.values(oe).filter(T=>T.category===k).length/e),a=[1500,60,250,50],i=[1500,60,250,50],n=[1240,60,250,50];let s=0,u=null,c="";const h=["chat","activities","appearance","immersion","antigarble","performance","misc","cheats","buttplug"],B={chat:"Chat & Social",activities:"Activities & Arousal",appearance:"Appearance & Wardrobe",immersion:"Immersion & Anti-Cheat",antigarble:"Gagspeak & Anti-Garble",performance:"Performance",misc:"Misc",cheats:"Cheats",buttplug:"Buttplug.io Toys",hidden:""},x=["None",...new Set(Asset.filter(k=>k.AllowEffect?.includes("Vibrating")||k.AllowEffect?.includes("Egged")).map(k=>k.Group.Name))],P=[1650,225,150,50],O=k=>Object.entries(oe).filter(([T,L])=>L.category===k&&T!=="buttplugDevices");function A(){ElementCreateInput("WceIntifaceAddress","text",l.toySyncAddress),ElementPosition("WceIntifaceAddress",-999,-999,550),s=0}function m(){l.toySyncAddress=ElementValue("WceIntifaceAddress"),ElementRemove("WceIntifaceAddress"),At(),PreferenceSubscreenExtensionsClear()}function D(){const k=window.MainCanvas.getContext("2d");if(!k){ie("Could not get canvas context");return}if(k.textAlign="left",DrawText(d(u?`WCE Settings - ${B[u]}`:"Wholesome Club Extensions (WCE) Settings"),300,125,"Black","Gray"),DrawButton(...i,"","White",""),DrawText(d("License"),i[0]+20,i[1]+i[3]/2,"Black",""),DrawButton(...n,"","White",""),DrawText(d("Information"),n[0]+20,n[1]+n[3]/2,"Black",""),DrawButton(1815,75,90,90,"","White","Icons/Exit.png"),u){let T=t;for(const[L,p]of O(u).slice(s*e,s*e+e)){if(p.type==="select"&&Array.isArray(p.options)){const g=p.options.indexOf(l[L]),b=p.options.length,G=p.disabled?.()||!1;DrawText(d(p.label),400,T+33,c===L?"Red":"Black","Gray"),DrawBackNextButton(et,T,Dt,64,d(p.options[g]),G?"#ebebe4":"White","",()=>d(`${p.label} ${p.options[(g-1+b)%b]}`),()=>d(`${p.label} ${p.options[(g+1+b)%b]}`),G)}else DrawCheckbox(300,T,64,64,d(p.label),!!l[L],p.disabled?.()||!1,c===L?"Red":"Black");T+=r}if(u==="buttplug"){if(DrawText(d("This page allows configuration of the synchronization of bluetooth connected toys."),300,350,"Black","Gray"),ElementPosition("WceIntifaceAddress",1300,t+32,550),l.toySync)if(!J.client?.connected)DrawText(d("Still connecting or connection failed..."),300,450,"Black","Gray");else{k.textAlign="center",DrawButton(...P,d("Scan"),J.client.isScanning?"Grey":"White","",J.client.isScanning?"Already scanning":void 0,J.client.isScanning),k.textAlign="left",DrawText(d("Device Name"),300,420,"Black","Gray"),DrawText(d("Synchronized Slot"),800,420,"Black","Gray"),T=500;for(const L of J.client.devices.filter(p=>p.vibrateAttributes.length>0)){let p=J.deviceSettings.get(L.name);p||(p={Name:L.name,SlotName:"None"},J.deviceSettings.set(L.name,p));const g=x.indexOf(p.SlotName);let b=0,G=0;if(g<=0?G=x.length-1:G=g-1,g===x.length-1?b=0:b=g+1,DrawText(L.name,300,T,"Black","Gray"),k.textAlign="center",DrawBackNextButton(800,T-32,450,64,d(p.SlotName),"white","",()=>d(x[G]),()=>d(x[b])),k.textAlign="left",T+=r,T>950)break}}}else{if(DrawText(d("Click on a setting to see its description"),300,160,"Gray","Silver"),Ye(c))if(oe[c].tooltips){const L=oe[c].options.indexOf(l[c]);ke(300,800,1600,d(oe[c].description),"left"),ke(330,870,1570,d(oe[c].tooltips[L]),"left")}else ke(300,830,1600,d(oe[c].description),"left");o(u)>1&&(DrawText(`${s+1} / ${o(u)}`,1700,230,"Black","Gray"),DrawButton(1815,180,90,90,"","White","Icons/Next.png"))}}else{let T=t;for(const L of h)DrawButton(300,T,400,64,"","White"),DrawTextFit(d(B[L]),310,T+32,380,"Black"),T+=r}k.textAlign="center"}function v(){let k=t;if(MouseIn(1815,75,90,90))u===null?m():(ElementPosition("WceIntifaceAddress",-999,-999,550),u=null);else if(MouseIn(...i))open(Tt,"_blank");else if(MouseIn(...a))open(Pt,"_blank");else if(MouseIn(...n))open(Mt,"_blank");else if(u!==null){if(MouseIn(1815,180,90,90)&&u!=="buttplug")s+=1,s%=o(u);else for(const[T,L]of O(u).slice(s*e,s*e+e)){if(L.type==="select"&&Array.isArray(L.options)){const p=Dt/2,g=L.options.indexOf(l[T]),b=L.options.length;MouseIn(et+p,k,p,64)&&(!L.disabled||!L.disabled())?l[T]=L.options[(g+1+b)%b]:MouseIn(et,k,p,64)&&(!L.disabled||!L.disabled())&&(l[T]=L.options[(g-1+b)%b])}else MouseIn(300,k,64,64)&&(!L.disabled||!L.disabled())&&(l[T]=!l[T],L.sideEffects(l[T],!1));MouseIn(364,k,1e3,64)&&(c=T,y("currentSetting",c)),k+=r}if(u==="buttplug"&&J.client?.connected){if(MouseIn(...P)){J.client.isScanning||J.client.startScanning();return}k=500;for(const T of J.client.devices.filter(L=>L.vibrateAttributes.length>0)){if(!MouseIn(800,k-32,450,64)){k+=r;continue}const L=J.deviceSettings.get(T.name);if(!L){z("Could not find device settings for",T.name,J.deviceSettings),k+=r;continue}const p=x.indexOf(L.SlotName);let g=0,b=0;if(p<=0?b=x.length-1:b=p-1,p===x.length-1?g=0:g=p+1,MouseX<800+450/2?L.SlotName=x[b]:L.SlotName=x[g],k+=r,k>950)break}}}else for(const T of h){if(MouseIn(300,k,400,64)){u=T,s=0;break}k+=r}}PreferenceRegisterExtensionSetting({Identifier:"WCE",ButtonText:d("WCE Settings"),Image:"https://fielr.github.io/scripts/wce/icon.png",click:v,run:D,exit:m,load:A,unload:()=>{}});function I(k){k.key==="Escape"&&u!==null&&(u=null,k.stopPropagation(),k.preventDefault())}document.addEventListener("keydown",I,!0),document.addEventListener("keypress",I,!0)}async function lr(){await U(()=>!!StruggleMinigames);const e=100,r=200,t=1575,o=300;f.hookFunction("StruggleLockPickDraw",C.AddBehaviour,(a,i)=>{if(l.lockpick&&StruggleLockPickOrder){const n=StruggleLockPickOrder.map(s=>s);for(let s=0;s<n.length;s++){const u=t-r/2+(.5-n.length/2+s)*e;DrawText(`${StruggleLockPickOrder.indexOf(s)+1}`,u,o,"White")}}return i(a)}),y("hooking struggle for lockpick cheat draw",StruggleMinigames),StruggleMinigames.LockPick.Draw=StruggleLockPickDraw}const tt=[];function de(e,r){return tt.some(t=>t[1]===r)?null:(tt.push([e,r]),ServerSocket.on(e,r))}function cr(){f.hookFunction("ServerInit",C.AddBehaviour,(e,r)=>{const t=r(e);for(const[o,a]of tt)ServerSocket.on(o,a);return t})}async function dr(){const{Dexie:e}=await import("./dexie.js"),r=new e("wce-saved-accounts");r.version(2).stores({key:"id, key",accounts:"id, data, iv, auth"});const t=r.table("key"),o=r.table("accounts");let a,i;try{i=await t.get({id:1})}catch(A){z(A),localStorage.removeItem("bce.passwords.authTag"),localStorage.removeItem("bce.passwords.iv"),localStorage.removeItem("bce.passwords"),await r.delete(),window.location.reload()}i?a=i.key:(a=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),await t.put({id:1,key:a}));async function n(){const A=localStorage.getItem("bce.passwords"),m=localStorage.getItem("bce.passwords.iv"),D=localStorage.getItem("bce.passwords.authTag");if(A&&(!D||!m)){const p=le(localStorage.getItem("bce.passwords"))||{};return window.crypto?.subtle&&setTimeout(()=>{localStorage.removeItem("bce.passwords"),c(p)},1),p}if(A&&D&&m)return localStorage.removeItem("bce.passwords.authTag"),localStorage.removeItem("bce.passwords.iv"),localStorage.removeItem("bce.passwords"),t.clear(),{};const v=await o.get({id:1});if(!v)return{};const{auth:I,iv:k,data:T}=v,L=new TextDecoder("utf8");try{const p=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:k,additionalData:I,tagLength:128},a,T);return le(L.decode(new Uint8Array(p)))||{}}catch(p){return z(p),localStorage.removeItem("bce.passwords.authTag"),localStorage.removeItem("bce.passwords.iv"),localStorage.removeItem("bce.passwords"),t.clear(),o.clear(),{}}}let s=await n();function u(){return s||{}}function c(A){if(window.crypto?.subtle){const m=window.crypto.getRandomValues(new Uint8Array(16)),D=window.crypto.getRandomValues(new Uint8Array(16)),v=new TextEncoder;s=A,window.crypto.subtle.encrypt({name:"AES-GCM",iv:m,additionalData:D,tagLength:128},a,v.encode(JSON.stringify(A))).then(I=>o.put({id:1,iv:m,auth:D,data:new Uint8Array(I)},[1]))}else localStorage.removeItem("bce.passwords")}window.bceUpdatePasswordForReconnect=()=>{let A="";CurrentScreen==="Login"?A=ElementValue("InputName").toUpperCase():CurrentScreen==="Relog"&&(A=Player.AccountName);const m=u();m[A]=ElementValue("InputPassword"),c(m)},window.bceClearPassword=A=>{const m=u();Object.hasOwn(m,A)&&(delete m[A],c(m))};let h=Date.now();async function B(){await U(()=>CurrentScreen==="Login");const A={passwords:u(),posMaps:{}};f.hookFunction("LoginRun",C.Top,(m,D)=>{const v=D(m);Object.keys(A.passwords).length>0&&DrawText(d("Saved Logins (WCE)"),170,35,"White","Black"),DrawButton(1250,387,180,50,d("Save (WCE)"),"White");let I=60;for(const k in A.passwords)Object.hasOwn(A.passwords,k)&&(A.posMaps[I]=k,DrawButton(10,I,350,60,k,"White"),DrawButton(355,I,60,60,"X","White"),I+=70);return v}),f.hookFunction("LoginClick",C.Top,(m,D)=>{const v=D(m);MouseIn(1250,385,180,60)&&(bceUpdatePasswordForReconnect(),A.posMaps={},A.passwords=u());const I=Date.now();if(I-h<150)return v;h=I;for(const k in A.posMaps){if(!Object.hasOwn(A.posMaps,k))continue;const T=parseInt(k);MouseIn(10,T,350,60)?(ElementValue("InputName",A.posMaps[T]),ElementValue("InputPassword",A.passwords[A.posMaps[T]]),LoginDoLogin()):MouseIn(355,T,60,60)&&(bceClearPassword(A.posMaps[T]),A.posMaps={},A.passwords=u())}return v}),CurrentScreenFunctions.Run=LoginRun,CurrentScreenFunctions.Click=LoginClick}B();let x=!1,P=!1;async function O(){if(!Player?.AccountName||!ServerIsConnected||LoginSubmitted||!ServerSocket.connected||x||P||!l.relogin)return;x=!0;const A=u();if(y("Attempting to log in again as",Player.AccountName),!A[Player.AccountName]){z("No saved credentials for account",Player.AccountName);return}LoginSetSubmitted(),ServerSend("AccountLogin",{AccountName:Player.AccountName,Password:A[Player.AccountName]}),await U(()=>CurrentScreen!=="Relog",()=>!x)||z("Relogin failed, circuit was restored"),await Ue(500),f.callOriginal("ServerAccountBeep",[{MemberNumber:Player.MemberNumber||-1,BeepType:"",MemberName:"VOID",ChatRoomName:"VOID",Private:!0,Message:d("Reconnected!"),ChatRoomSpace:""}])}f.hookFunction("RelogRun",C.Top,(A,m)=>(["ErrorDuplicatedLogin"].includes(LoginErrorMessage)?x||(f.callOriginal("ServerAccountBeep",[{MemberNumber:Player.MemberNumber||-1,BeepType:"",MemberName:Player.Name,ChatRoomName:d("ERROR"),Private:!0,Message:d("Signed in from a different location! Refresh the page to re-enable relogin in this tab."),ChatRoomSpace:""}]),x=!0,P=!0):O(),m(A))),f.hookFunction("RelogExit",C.Top,(A,m)=>(x=!1,P=!1,m(A))),de("connect",()=>{x=!1}),f.hookFunction("ServerDisconnect",C.ModifyBehaviourHigh,(A,m)=>{const[,D]=A;A[1]=!1;const v=m(A);return D&&(z("Forcefully disconnected",A),ServerSocket.disconnect(),ce(A[0])&&["ErrorRateLimited","ErrorDuplicatedLogin"].includes(A[0])?(z("Reconnecting..."),setTimeout(()=>{z("Connecting..."),ServerInit()},3e3+Math.round(Math.random()*3e3))):z("Disconnected.")),v})}async function pr(){await U(()=>!!Player?.AppearanceLayers),GameVersion==="R104"?re("DialogMenuButtonBuild",{"if (Item != null && !C.IsNpc() && Player.CanInteract()) {":"if (Item != null && !C.IsNpc() && (Player.CanInteract() || fbcSettingValue('allowLayeringWhileBound'))) {"},"Built-in layering menus options for allow on others and allow while bound"):f.hookFunction("Layering.Init",C.AddBehaviour,(a,i)=>{const n=i(a);return Layering.Readonly=a[4]&&!l.allowLayeringWhileBound,n});const e=["LeatherCrop","LeatherWhip","ShockCollarRemote","SpankingToys","VibratorRemote"],r=Asset.filter(a=>AssetGroup.filter(i=>i.Name.startsWith("Item")&&!/\d$/u.test(i.Name)&&i.Asset.find(n=>n.Name===a.Name)).length>1).filter((a,i,n)=>n.findIndex(s=>s.Name===a.Name)===i).map(a=>a.Name).filter(a=>!e.includes(a));function t(a,i){return!!i&&!!a.Appearance.find(n=>n===i)}f.hookFunction("DialogMenuButtonBuild",C.AddBehaviour,(a,i)=>{const n=CharacterGetCurrent(),s=i(a);if(ue(n)&&l.copyColor&&Player.CanInteract()&&n?.FocusGroup?.Name&&!InventoryGroupIsBlocked(n,n.FocusGroup.Name)&&DialogMenuMode==="items"){const u=InventoryGet(n,n.FocusGroup.Name);t(n,u)&&r.includes(u.Asset.Name)&&DialogMenuButton.push("Paint")}return s}),f.hookFunction("InterfaceTextGet",C.AddBehaviour,(a,i)=>a[0]==="DialogMenuPaint"?d("[WCE] Copy colors to other items of same type"):i(a)),f.hookFunction("DialogMenuButtonClick",C.AddBehaviour,(a,i)=>{const n=i(a);if(!n&&!["colorExpression","colorItem","extended","layering","tighten"].includes(DialogMenuMode)){const s=CharacterGetCurrent(),u=s.FocusGroup?InventoryGet(s,s.FocusGroup.Name):null;for(let c=0;c<DialogMenuButton.length;c++)if(MouseIn(1885-c*110,15,90,90)){const h=DialogMenuButton[c];if(u&&h==="Paint")return o(s,u),!1}}return n});function o(a,i){if(!l.copyColor||!Player.CanInteract()||InventoryGroupIsBlocked(a,a.FocusGroup.Name)||!t(a,i)||!r.includes(i.Asset.Name))return;console.log("copying color to all: ",i);for(const s of a.Appearance)n(s);CurrentScreen==="ChatRoom"?(ChatRoomCharacterUpdate(a),Pe(d("$TargetName's $ItemName colors spread from their $ItemGroup",{$TargetName:CharacterNickname(a),$ItemName:i.Asset.Description.toLowerCase(),$ItemGroup:i.Asset.Group.Description.toLowerCase()}))):CharacterRefresh(a);function n(s){if(s.Asset.Name===i.Asset.Name)if(Array.isArray(i.Color))if(Array.isArray(s.Color))for(let u=s.Color.length-1;u>=0;u--)s.Color[u]=i.Color[u%i.Color.length];else s.Color=i.Color[i.Color.length-1];else if(Array.isArray(s.Color))for(let u=0;u<s.Color.length;u++)s.Color[u]=i.Color??"Default";else s.Color=De(i.Color)}}}function hr(){f.hookFunction("ChatRoomMenuBuild",C.AddBehaviour,(t,o)=>{const a=o(t);return l.manualCacheClear&&ChatRoomMenuButtons.splice(ChatRoomMenuButtons.indexOf("Cut"),0,"clearCache"),a}),f.hookFunction("ChatRoomMenuClick",C.AddBehaviour,(t,o)=>{const a=o(t);if(l.manualCacheClear){const i=992/ChatRoomMenuButtons.length;for(let n=0;n<ChatRoomMenuButtons.length;n++)MouseXIn(1005+i*n,i-2)&&ChatRoomMenuButtons[n]==="clearCache"&&r()}return a}),re("ChatRoomMenuDraw",{'let suffix = "";':`let suffix = "";
        if (name === "clearCache") {
          DrawButton(1005 + Space * Number(idx), 2, Space - 2, 60, "", color, null, "[WCE] clear and reload the drawing cache of all characters");
          DrawImage("Icons/Small/Reset.png", 976 + Space * Number(idx) + Space / 2, 4);
          continue;
        }`},"manual clearing and reloading of drawing cache");async function e(){const t=Date.now();await U(()=>CurrentScreen==="ChatRoom"&&!CurrentCharacter,()=>Date.now()-t>36e5)&&l.automateCacheClear&&r()}window.bceClearCaches=e;function r(){y("Clearing caches"),GLDrawCanvas.GL?.textureCache&&GLDrawCanvas.GL.textureCache.clear(),GLDrawResetCanvas(),y("Clearing old characters from cache"),Character.filter(t=>t.IsOnline?.()&&!ChatRoomCharacter.some(o=>o.MemberNumber===t.MemberNumber)).forEach(t=>CharacterDelete(t)),Character.filter(t=>t.IsOnline?.()).forEach(t=>CharacterRefresh(t,!1,!1))}Ce(()=>{l.automateCacheClear&&e()},36e5)}function mr(){f.hookFunction("ChatRoomDrawCharacterStatusIcons",C.AddBehaviour,(e,r)=>{const t=r(e),[o,a,i,n]=e;if(ue(o)&&typeof a=="number"&&typeof i=="number"&&typeof n=="number"&&o.FBC&&ChatRoomHideIconState===0){const s=["1","2","3","4","5"].includes(o.FBC.split(".")[0])?"FBC":"WCE";DrawTextFit(s,a+290*n,i+12*n,50*n,o.FBCNoteExists?"Cyan":"White","Black"),DrawTextFit(/^\d+\.\d+(\.\d+)?b?$/u.test(o.FBC)?o.FBC.replace("b",""):"",a+290*n,i+32*n,50*n,o.FBC.endsWith("b")?"Lightpink":"White","Black")}return t})}async function gr(){await U(()=>ServerSocket&&ServerIsConnected);function e(o){let a={};return Array.isArray(o.Dictionary)?a=o.Dictionary?.find(i=>i.message)?.message||a:a=o.Dictionary?.message||a,a}function r(o,a,i=!1){if(y("Processing BCE message",o,a,i?"(deferred)":""),!o?.ArousalSettings&&!i){z("No arousal settings found for",o,"; deferring execution to microtask."),queueMicrotask(()=>{r(o,a,!0)});return}switch(o?.ArousalSettings||z("No arousal settings found for",o),a.type){case Be.Hello:t(o,a);break;case Be.ArousalSync:o.BCEArousal=a.alternateArousal||!1,o.BCEArousalProgress=a.progress||0,o.BCEEnjoyment=a.enjoyment||1;break;case Be.Activity:o.MemberNumber===Player.Ownership?.MemberNumber&&!Player.Appearance.some(n=>n.Asset.Name==="ClubSlaveCollar")&&ar();break}}function t(o,a){o.FBC=a.version??"0.0",o.BCEArousal=a.alternateArousal||!1,o.BCEArousalProgress=a.progress||o.ArousalSettings?.Progress||0,o.BCEEnjoyment=a.enjoyment||1,o.BCECapabilities=a.capabilities??[],a.replyRequested&&xe(o.MemberNumber),o.FBCOtherAddons=a.otherAddons}de("ChatRoomMessage",o=>{if(o.Type===Le&&o.Content==="BCEMsg"){const a=Character.find(n=>n.MemberNumber===o.Sender);if(!a)return;const i=e(o);r(a,i)}}),de("ChatRoomSyncMemberJoin",o=>{o.SourceMemberNumber!==Player.MemberNumber&&xe(o.SourceMemberNumber)}),de("ChatRoomSync",()=>{xe()})}async function fr(){await U(()=>!!Player);let e=!1,r=null,t=null,o=!1;function a(){return e&&r?.IsPlayer()||CharacterAppearanceSelection?.IsPlayer()}re("DrawProcess",{'CurrentScreen !== "Crafting"':'CurrentScreen !== "Crafting" && CurrentScreen !== "Wardrobe"'},"Full wardrobe may display blur and blindness effects of the background"),re("DrawCharacter",{'|| CurrentScreen === "Crafting"':'|| CurrentScreen === "Crafting" || CurrentScreen === "Wardrobe"'},"Full wardrobe may display blur and blindness effects of the outfits"),f.hookFunction("CharacterAppearanceWardrobeLoad",C.OverrideBehaviour,(n,s)=>{const[u]=n;return l.privateWardrobe&&CurrentScreen==="Appearance"?(e=!0,r=ue(u)?u:CharacterGetCurrent(),CommonSetScreen("Character","Wardrobe"),null):s(n)}),f.hookFunction("AppearanceLoad",C.AddBehaviour,(n,s)=>{const u=s(n);return e&&(CharacterAppearanceBackup=t),u}),f.hookFunction("AppearanceRun",C.AddBehaviour,(n,s)=>(CharacterAppearanceMode==="Wardrobe"&&a()&&(DrawCheckbox(1300,350,64,64,"",o,!1,"white"),je(d("Load without body parts"),1374,380,630,"white")),s(n))),f.hookFunction("AppearanceClick",C.ModifyBehaviourMedium,(n,s)=>CharacterAppearanceMode==="Wardrobe"&&MouseIn(1300,350,64,64)&&a()?(o=!o,null):s(n)),f.hookFunction("WardrobeLoad",C.AddBehaviour,(n,s)=>(t=CharacterAppearanceBackup,s(n))),f.hookFunction("WardrobeRun",C.AddBehaviour,(n,s)=>{const u=Player;e&&(Player=r);const c=s(n);return e&&(Player=u),DrawText(`Page: ${(WardrobeOffset/12|0)+1}/${WardrobeSize/12}`,300,35,"White"),DrawCheckbox(10,74,64,64,"",o,!1,"white"),je(d("Exclude body parts"),84,106,300,"white"),c}),f.hookFunction("WardrobeClick",C.ModifyBehaviourMedium,(n,s)=>MouseIn(10,74,64,64)?(o=!o,null):s(n)),f.hookFunction("WardrobeExit",C.OverrideBehaviour,(n,s)=>e?(CommonSetScreen("Character","Appearance"),e=!1,null):s(n)),f.hookFunction("WardrobeFastLoad",C.OverrideBehaviour,(n,s)=>{let[u]=n;const c=u.Appearance.filter(B=>B.Asset.Group.IsDefault&&!B.Asset.Group.Clothing);if(e&&ue(u)&&u.IsPlayer()){if(!r)throw new Error("targetCharacter is not defined in WardrobeFastLoad");n[0]=r,u=r,n[2]=!1}const h=s(n);return o&&(u.Appearance=[...c,...u.Appearance.filter(B=>!B.Asset.Group.IsDefault||B.Asset.Group.Clothing)],CharacterLoadCanvas(u)),h}),f.hookFunction("WardrobeFastSave",C.OverrideBehaviour,(n,s)=>{const[u]=n;if(e&&ue(u)&&u.IsPlayer()){if(!r)throw new Error("targetCharacter is not defined in WardrobeFastSave");n[0]=r}return l.confirmWardrobeSave&&Player.Wardrobe?.length>n[1]&&Player.Wardrobe[n[1]]?.some(c=>c.Group==="Pronouns")&&!window.confirm("Do you really want to override this wardrobe outfit?")?null:s(n)}),f.hookFunction("ServerPlayerIsInChatRoom",C.AddBehaviour,(n,s)=>e&&CharacterAppearanceReturnRoom==="ChatRoom"||s(n));function i(n){l.privateWardrobe&&n.key==="Escape"&&e&&(WardrobeExit(),n.stopPropagation(),n.preventDefault())}document.addEventListener("keydown",i,!0),document.addEventListener("keypress",i,!0)}function yr(){f.hookFunction("ChatRoomGenerateChatRoomChatMessage",C.Top,(o,a)=>{if(!l.antiGarble)return a(o);const[i,n]=o;let s={effects:[],text:n},u;if(i!=="Whisper"||l.antiGarbleWhisperLevel!=="off"){s=SpeechTransformProcess(Player,n,SpeechTransformSenderEffects);const h=SpeechTransformShouldBabyTalk(Player),B=SpeechTransformGagGarbleIntensity(Player),x=SpeechTransformStutterIntensity(Player);if(B>0||l[`antiGarble${i}BabyTalk`]==="remove"&&h||l[`antiGarble${i}Stutter`]==="remove"&&x>0){if(Player.RestrictionSettings.NoSpeechGarble)u=n;else if(l[`antiGarble${i}Level`]!=="full"){if(u=n,l[`antiGarble${i}BabyTalk`]==="preserve"&&h&&(u=SpeechTransformBabyTalk(u)),["low","medium","high"].includes(l[`antiGarble${i}Level`])){const P=Math.min(B,{low:1,medium:3,high:5}[l[`antiGarble${i}Level`]]);u=SpeechTransformGagGarble(u,P)}l[`antiGarble${i}Stutter`]==="preserve"&&x>0&&(u=l.stutters?Ct(u,!0).results.join(""):SpeechTransformStutter(u,x))}}s.text===u&&(u=void 0)}const c=[{Effects:s.effects,Original:u}];return{Content:s.text,Type:i,Dictionary:c}});const e=oe.antiGarbleChatLevel.options,r=oe.antiGarbleWhisperLevel.options,t=oe.antiGarbleChatBabyTalk.options;f.hookFunction("ChatRoomRun",C.ModifyBehaviourMedium,(o,a)=>{const i=a(o);if(l.antiGarbleChatOptions){const n=ChatRoomTargetMemberNumber!==-1||window.InputChat?.value.startsWith("/w ")||window.InputChat?.value.startsWith("/whisper "),s=n?r:e,u=n?"antiGarbleWhisperLevel":"antiGarbleChatLevel",c=s.indexOf(l[u]),h=s.length;DrawRect(1810,878,185,120,"Black"),DrawBackNextButton(1810,878,185,50,d((n?"whis: ":"chat: ")+s[c]),c===5?"Lightgreen":`#${(15-c*2).toString(16).repeat(6)}`,"",()=>d((n?"Whisper garble level: ":"Chat garble level: ")+s[(c-1+h)%h]),()=>d((n?"Whisper garble level: ":"Chat garble level: ")+s[(c+1+h)%h]),!1,null,{X:1e3,Y:910,Width:200,Height:90});const B=t.indexOf(l[n?"antiGarbleWhisperStutter":"antiGarbleChatStutter"]),x=t.indexOf(l[n?"antiGarbleWhisperBabyTalk":"antiGarbleChatBabyTalk"]);DrawButton(1810,928,35,35,"",c>3?"#555555":`#${(15-B*3).toString(16).repeat(6)}`,"https://fielr.github.io/scripts/wce/stutter.png",`${n?"Whisper":"Chat"} stutters: ${l[n?"antiGarbleWhisperStutter":"antiGarbleChatStutter"]}`,c>3,{X:1e3,Y:910,Width:200,Height:90}),DrawButton(1810,963,35,35,"",c>3?"#555555":`#${(15-x*3).toString(16).repeat(6)}`,"https://fielr.github.io/scripts/wce/baby.png",`${n?"Whisper":"Chat"} baby talk: ${l[n?"antiGarbleWhisperBabyTalk":"antiGarbleChatBabyTalk"]}`,c>3,{X:1e3,Y:910,Width:200,Height:90}),DrawButton(1845,928,150,70,"","White"),DrawImage("Icons/Small/Chat.png",1895,935)}return i}),f.hookFunction("ChatRoomClick",C.ModifyBehaviourHigh,(o,a)=>{if(l.antiGarbleChatOptions&&MouseIn(1810,878,185,120)){if(MouseIn(1845,928,150,70))return ChatRoomSendChat();const i=ChatRoomTargetMemberNumber!==-1||window.InputChat?.value.startsWith("/w ")||window.InputChat?.value.startsWith("/whisper "),n=i?r:e,s=i?"antiGarbleWhisperLevel":"antiGarbleChatLevel",u=n.indexOf(l[s]),c=n.length;if(MouseIn(1810,878,92,50))return l[s]=n[(u-1+c)%c],null;if(MouseIn(1902,878,93,50))return l[s]=n[(u+1)%c],null;if(u<=3){const h=t.indexOf(l[i?"antiGarbleWhisperStutter":"antiGarbleChatStutter"]),B=t.indexOf(l[i?"antiGarbleWhisperBabyTalk":"antiGarbleChatBabyTalk"]);if(MouseIn(1810,928,35,35))return l[i?"antiGarbleWhisperStutter":"antiGarbleChatStutter"]=t[(h+1)%3],null;if(MouseIn(1810,963,35,35))return l[i?"antiGarbleWhisperBabyTalk":"antiGarbleChatBabyTalk"]=t[(B+1)%3],null}}return a(o)}),re("ElementPosition",{"const Font = MainCanvas.canvas.clientWidth <= MainCanvas.canvas.clientHeight * 2 ? MainCanvas.canvas.clientWidth / 50 : MainCanvas.canvas.clientHeight / 25;":`let Font;
        if (fbcSettingValue("antiGarbleChatOptions") && ElementID === "InputChat") {
          Font = MainCanvas.canvas.clientWidth <= MainCanvas.canvas.clientHeight * 2 ? MainCanvas.canvas.clientWidth / 60 : MainCanvas.canvas.clientHeight / 30;
        } else {
          Font = MainCanvas.canvas.clientWidth <= MainCanvas.canvas.clientHeight * 2 ? MainCanvas.canvas.clientWidth / 50 : MainCanvas.canvas.clientHeight / 25;
        }`},"better ChatInput won't have smaller fontsize"),ChatRoomRegisterMessageHandler({Description:"show OriginalMsg while deafened",Priority:90,Callback:(o,a,i,n)=>(o.Type==="Chat"&&l.antiDeaf&&Player.GetDeafLevel()>0&&(n.OriginalMsg=i),!1)}),CurrentScreen==="ChatRoom"&&ChatRoomResize(!1)}async function br(){if(await U(()=>CurrentScreen==="ChatRoom"&&!!Player.ArousalSettings),!Player.ArousalSettings)throw new Error("Player.ArousalSettings is not defined");re("PreferenceSubscreenArousalRun",{'DrawCheckbox(1250, 276, 64, 64, TextGet("ArousalAffectExpression"), Player.ArousalSettings.AffectExpression);':'DrawCheckbox(1250, 276, 64, 64, TextGet("ArousalAffectExpression"), Player.ArousalSettings.AffectExpression, fbcSettingValue("animationEngine"));'},"disabling conflicting Player.ArousalSettings.AffectExpression when Animation Engine is active"),f.hookFunction("PreferenceSubscreenArousalClick",C.ModifyBehaviourMedium,(w,M)=>l.animationEngine&&PreferenceArousalIsActive()&&MouseIn(1250,276,64,64)?null:M(w)),re("StruggleMinigameHandleExpression",{'");':'", 3);'},"Resetting blush, eyes, and eyebrows after struggling"),window.bceAnimationEngineEnabled=()=>!!l.animationEngine,f.hookFunction("StruggleMinigameStop",C.ModifyBehaviourMedium,(w,M)=>(l.animationEngine&&(StruggleExpressionStore=void 0,p([o],[a])),M(w))),window.bce_ArousalExpressionStages||(window.bce_ArousalExpressionStages={Blush:[{Expression:"High",Limit:100},{Expression:"Medium",Limit:60},{Expression:"Low",Limit:10},{Expression:null,Limit:0}],Eyebrows:[{Expression:"Soft",Limit:80},{Expression:"Lowered",Limit:50},{Expression:"Raised",Limit:20},{Expression:null,Limit:0}],Fluids:[{Expression:"DroolMedium",Limit:100},{Expression:"DroolLow",Limit:40},{Expression:null,Limit:0}],Eyes:[{Expression:"Closed",Limit:100},{Expression:"Surprised",Limit:90},{Expression:"Horny",Limit:70},{Expression:"Dazed",Limit:20},{Expression:null,Limit:0}],Eyes2:[{Expression:"Closed",Limit:100},{Expression:"Surprised",Limit:90},{Expression:"Horny",Limit:70},{Expression:"Dazed",Limit:20},{Expression:null,Limit:0}],Pussy:[{Expression:"Hard",Limit:50},{Expression:null,Limit:0}]});const e=Object.freeze({Blush:[null,"Low","Medium","High","VeryHigh","Extreme"]}),r="AutomatedByArousal",t="DEFAULT",o="GameTimer",a="ManualOverride",i="PostOrgasm",n=[];let s=0;function u(){return s=(s+1)%(Number.MAX_SAFE_INTEGER-1),s}const c={};function h(w){if(!w)return;switch(w.Type){case r:case i:if(!l.expressions)return;break;case a:break;default:if(!l.activityExpressions)return}const M=Date.now(),S=De(w);if(S.At=M,S.Until=M+S.Duration,S.Id=u(),typeof S.Priority!="number"&&(S.Priority=1),S.Expression)for(const R of Object.values(S.Expression))for(const W of R)W.Id=u(),typeof W.Priority!="number"&&(W.Priority=1),typeof W.Duration!="number"&&(W.Duration=S.Duration);if(S.Poses)for(const R of S.Poses)R.Id=u(),typeof R.Priority!="number"&&(R.Priority=1);n.push(S)}window.fbcPushEvent=h,window.bce_EventExpressions||(window.bce_EventExpressions={PostOrgasm:{Type:i,Duration:2e4,Priority:1e4,Expression:{Blush:[{Expression:"Extreme",Duration:5e3},{ExpressionModifier:-1,Duration:5e3},{ExpressionModifier:-1,Duration:5e3,Priority:1e3},{ExpressionModifier:-1,Duration:5e3,Priority:200}],Eyes:[{Expression:"Closed",Duration:8500},{Expression:"Heart",Duration:7500},{Expression:"Sad",Duration:4e3,Priority:200}],Eyes2:[{Expression:"Closed",Duration:8e3},{Expression:"Heart",Duration:8e3},{Expression:"Sad",Duration:4e3,Priority:200}],Mouth:[{Expression:"Ahegao",Duration:5e3},{Expression:"Moan",Duration:5e3},{Expression:"HalfOpen",Duration:1e4,Priority:200}],Fluids:[{Expression:"DroolMessy",Duration:5e3},{Expression:"DroolSides",Duration:9e3,Priority:400},{Expression:"DroolLow",Duration:6e3,Priority:200}],Eyebrows:[{Expression:"Soft",Duration:1e4},{Expression:"Lowered",Duration:5e3,Priority:200},{Expression:null,Duration:5e3,Priority:1}]}},Pout:{Type:"Pout",Duration:-1,Expression:{Mouth:[{Expression:"Pout",Duration:-1}],Eyes:[{Expression:"Dazed",Duration:-1}],Eyes2:[{Expression:"Dazed",Duration:-1}],Eyebrows:[{Expression:"Harsh",Duration:-1}]}},ResetBrows:{Type:"ResetBrows",Duration:-1,Expression:{Eyebrows:[{Expression:null,Duration:-1}]}},RaiseBrows:{Type:"RaiseBrows",Duration:-1,Expression:{Eyebrows:[{Expression:"Raised",Duration:-1}]}},Confused:{Type:"Confused",Duration:-1,Expression:{Eyebrows:[{Expression:"OneRaised",Duration:-1}]}},Smirk:{Type:"Smirk",Duration:-1,Expression:{Mouth:[{Expression:"Smirk",Duration:-1}]}},Wink:{Type:"Wink",Duration:1500,Expression:{Eyes:[{Expression:"Closed",Duration:1500}]}},Laugh:{Type:"Laugh",Duration:8e3,Expression:{Mouth:[{Expression:"Laughing",Duration:1e3},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:1e3},{Expression:"Happy",Duration:200},{Expression:"Laughing",Duration:800},{Expression:"Grin",Duration:400},{Expression:"Laughing",Duration:800},{Expression:"Happy",Duration:400},{Expression:"Laughing",Duration:600},{Expression:"Grin",Duration:600},{Expression:"Laughing",Duration:600},{Expression:"Happy",Duration:600},{Expression:"Laughing",Duration:200},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:200},{Expression:"Happy",Duration:200}]}},Giggle:{Type:"Giggle",Duration:4e3,Expression:{Mouth:[{Expression:"Laughing",Duration:800},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:700},{Expression:"Happy",Duration:200},{Expression:"Laughing",Duration:600},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:500},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:400},{Expression:"Happy",Duration:200}]}},Chuckle:{Type:"Chuckle",Duration:4e3,Expression:{Mouth:[{Expression:"Grin",Duration:4e3}]}},Smile:{Type:"Smile",Duration:-1,Expression:{Mouth:[{Expression:"Grin",Duration:-1}]}},Blink:{Type:"Blink",Duration:200,Expression:{Eyes:[{Expression:"Closed",Duration:200}],Eyes2:[{Expression:"Closed",Duration:200}]}},Grin:{Type:"Grin",Duration:-1,Expression:{Eyes:[{Expression:"Horny",Duration:-1}],Eyes2:[{Expression:"Horny",Duration:-1}],Mouth:[{Expression:"Grin",Duration:-1}]}},Cuddle:{Type:"Cuddle",Duration:1e4,Priority:150,Expression:{Mouth:[{Expression:"Happy",Duration:1e4}],Eyes:[{Expression:"ShylyHappy",Duration:1e4}],Eyes2:[{Expression:"ShylyHappy",Duration:1e4}],Eyebrows:[{Expression:"Raised",Duration:1e4}]}},Blush:{Type:"Blush",Duration:1e4,Expression:{Blush:[{ExpressionModifier:1,Duration:1e4}]}},Choke:{Type:"Choke",Duration:4e3,Priority:150,Expression:{Blush:[{ExpressionModifier:3,Duration:4e3}],Eyes:[{Expression:"VeryLewd",Duration:3e3},{Expression:"Sad",Duration:1e3}],Eyes2:[{Expression:"VeryLewd",Duration:3e3},{Expression:"Sad",Duration:1e3}],Eyebrows:[{Expression:"Harsh",Duration:4e3}]}},Stimulated:{Type:"Stimulated",Duration:5e3,Priority:400,Expression:{Blush:[{ExpressionModifier:2,Duration:5e3}],Eyes:[{Expression:"VeryLewd",Duration:4e3},{Expression:"Sad",Duration:1e3}],Eyes2:[{Expression:"VeryLewd",Duration:4e3},{Expression:"Sad",Duration:1e3}],Eyebrows:[{Expression:"Soft",Duration:5e3}]}},StimulatedLong:{Type:"StimulatedLong",Duration:2e4,Priority:400,Expression:{Blush:[{ExpressionModifier:1,Duration:2e4}]}},Shock:{Type:"Shock",Duration:15e3,Priority:1e3,Expression:{Blush:[{ExpressionModifier:5,Duration:1e4},{ExpressionModifier:-1,Duration:2e3},{ExpressionModifier:-1,Duration:2e3},{ExpressionModifier:-1,Duration:1e3}],Eyes:[{Expression:"Dizzy",Duration:1e3},{Expression:"Scared",Duration:8e3},{Expression:"Surprised",Duration:7e3}],Eyes2:[{Expression:"Dizzy",Duration:1e3},{Expression:"Scared",Duration:8e3},{Expression:"Surprised",Duration:7e3}],Eyebrows:[{Expression:"Soft",Duration:15e3}],Mouth:[{Expression:"Pained",Duration:1e4},{Expression:"Angry",Duration:5e3}]}},ShockLight:{Type:"ShockLight",Duration:5e3,Priority:900,Expression:{Blush:[{ExpressionModifier:2,Duration:5e3}],Eyes:[{Expression:"Dizzy",Duration:2e3},{Expression:"Surprised",Duration:3e3}],Eyes2:[{Expression:"Dizzy",Duration:2e3},{Expression:"Surprised",Duration:3e3}],Eyebrows:[{Expression:"Soft",Duration:5e3}],Mouth:[{Expression:"Angry",Duration:5e3}]}},Hit:{Type:"Hit",Duration:7e3,Priority:500,Expression:{Blush:[{Expression:"VeryHigh",Duration:7e3}],Eyes:[{Expression:"Daydream",Duration:1e3},{Expression:"Closed",Duration:3e3},{Expression:"Daydream",Duration:3e3}],Eyes2:[{Expression:"Daydream",Duration:1e3},{Expression:"Closed",Duration:3e3},{Expression:"Daydream",Duration:3e3}],Eyebrows:[{Expression:"Soft",Duration:7e3}]}},Spank:{Type:"Spank",Duration:3e3,Priority:300,Expression:{Eyes:[{Expression:"Lewd",Duration:3e3}],Eyes2:[{Expression:"Lewd",Duration:3e3}],Eyebrows:[{Expression:"Soft",Duration:3e3}]}},Kiss:{Type:"Kiss",Duration:2e3,Priority:200,Expression:{Mouth:[{Expression:"HalfOpen",Duration:2e3}]}},KissOnLips:{Type:"KissOnLips",Duration:2e3,Priority:200,Expression:{Eyes:[{Expression:"Closed",Duration:2e3}],Eyes2:[{Expression:"Closed",Duration:2e3}],Mouth:[{Expression:"HalfOpen",Duration:2e3}],Blush:[{Skip:!0,Duration:1e3},{ExpressionModifier:1,Duration:1e3}]}},LongKiss:{Type:"LongKiss",Duration:4e3,Priority:200,Expression:{Eyes:[{Expression:"Closed",Duration:4e3}],Eyes2:[{Expression:"Closed",Duration:4e3}],Mouth:[{Expression:"Open",Duration:4e3}],Blush:[{Skip:!0,Duration:1e3},{ExpressionModifier:1,Duration:1e3},{ExpressionModifier:1,Duration:2e3}]}},Disoriented:{Type:"Disoriented",Duration:8e3,Priority:250,Expression:{Eyes:[{Expression:"Dizzy",Duration:8e3}],Eyes2:[{Expression:"Dizzy",Duration:8e3}],Eyebrows:[{Expression:"Raised",Duration:8e3}],Blush:[{ExpressionModifier:2,Duration:8e3}]}},Angry:{Type:"Angry",Duration:-1,Expression:{Mouth:[{Expression:"Angry",Duration:-1}],Eyes:[{Expression:"Angry",Duration:-1}],Eyes2:[{Expression:"Angry",Duration:-1}],Eyebrows:[{Expression:"Angry",Duration:-1}]}},Sad:{Type:"Sad",Duration:-1,Expression:{Mouth:[{Expression:"Frown",Duration:-1}],Eyes:[{Expression:"Shy",Duration:-1}],Eyes2:[{Expression:"Shy",Duration:-1}],Eyebrows:[{Expression:"Soft",Duration:-1}]}},Worried:{Type:"Worried",Duration:-1,Expression:{Eyes:[{Expression:"Surprised",Duration:-1}],Eyes2:[{Expression:"Surprised",Duration:-1}],Eyebrows:[{Expression:"Soft",Duration:-1}]}},Distressed:{Type:"Distressed",Duration:-1,Expression:{Eyes:[{Expression:"Scared",Duration:-1}],Eyes2:[{Expression:"Scared",Duration:-1}],Eyebrows:[{Expression:"Soft",Duration:-1}],Mouth:[{Expression:"Angry",Duration:-1}]}},Reset:{Type:"Reset",Duration:-1,Expression:{Mouth:[{Expression:null,Duration:-1}],Eyes:[{Expression:null,Duration:-1}],Eyes2:[{Expression:null,Duration:-1}],Eyebrows:[{Expression:null,Duration:-1}],Blush:[{Expression:null,Duration:-1}],Fluids:[{Expression:null,Duration:-1}]}},Cry:{Type:"Cry",Duration:-1,Expression:{Fluids:[{Expression:"TearsMedium",Duration:-1}]}},DroolReset:{Type:"DroolReset",Duration:-1,Expression:{Fluids:[{Expression:null,Duration:-1}]}},DroolSides:{Type:"DroolSides",Duration:-1,Expression:{Fluids:[{Expression:"DroolSides",Duration:-1}]}},BareTeeth:{Type:"BareTeeth",Duration:-1,Expression:{Mouth:[{Expression:"Angry",Duration:-1}]}},Happy:{Type:"Happy",Duration:-1,Expression:{Mouth:[{Expression:"Happy",Duration:-1}]}},Frown:{Type:"Frown",Duration:-1,Expression:{Mouth:[{Expression:"Frown",Duration:-1}]}},Glare:{Type:"Glare",Duration:-1,Expression:{Eyes:[{Expression:"Angry",Duration:-1}],Eyes2:[{Expression:"Angry",Duration:-1}],Eyebrows:[{Expression:"Harsh",Duration:-1}]}},NarrowEyes:{Type:"NarrowEyes",Duration:-1,Expression:{Eyes:[{Expression:"Horny",Duration:-1}],Eyes2:[{Expression:"Horny",Duration:-1}]}},OpenEyes:{Type:"OpenEyes",Duration:-1,Expression:{Eyes:[{Expression:null,Duration:-1}],Eyes2:[{Expression:null,Duration:-1}]}},CloseEyes:{Type:"CloseEyes",Duration:-1,Expression:{Eyes:[{Expression:"Closed",Duration:-1}],Eyes2:[{Expression:"Closed",Duration:-1}]}},CloseMouth:{Type:"CloseMouth",Duration:-1,Expression:{Mouth:[{Expression:null,Duration:-1}]}},OpenMouth:{Type:"OpenMouth",Duration:-1,Expression:{Mouth:[{Expression:"Moan",Duration:-1}]}},LipBite:{Type:"LipBite",Duration:-1,Expression:{Mouth:[{Expression:"LipBite",Duration:-1}]}},Lick:{Type:"Lick",Duration:4e3,Priority:200,Expression:{Mouth:[{Expression:"Ahegao",Duration:4e3}],Blush:[{ExpressionModifier:1,Duration:4e3}]}},GagInflate:{Type:"GagInflate",Duration:4e3,Priority:400,Expression:{Eyes:[{Expression:"Lewd",Duration:4e3}],Eyes2:[{Expression:"Lewd",Duration:4e3}],Blush:[{ExpressionModifier:2,Duration:2e3},{ExpressionModifier:-1,Duration:2e3}]}},Iced:{Type:"Iced",Duration:4e3,Priority:500,Expression:{Eyes:[{Expression:"Surprised",Duration:3e3},{Expression:null,Duration:1e3}],Eyes2:[{Expression:"Surprised",Duration:3e3},{Expression:null,Duration:1e3}],Mouth:[{Expression:"Angry",Duration:4e3}]}},AllFours:{Type:"AllFours",Duration:-1,Poses:[{Pose:["AllFours"],Duration:-1}]},SpreadKnees:{Type:"SpreadKnees",Duration:-1,Poses:[{Pose:["KneelingSpread"],Duration:-1}]},Hogtied:{Type:"Hogtied",Duration:-1,Poses:[{Pose:["Hogtied"],Duration:-1}]},Handstand:{Type:"Handstand",Duration:-1,Poses:[{Pose:["Suspension","OverTheHead"],Duration:-1}]},Stretch:{Type:"Stretch",Priority:100,Duration:6e3,Poses:[{Pose:["OverTheHead"],Duration:1e3},{Pose:["Yoked"],Duration:1e3},{Pose:["BaseUpper"],Duration:1e3},{Pose:["Spread"],Duration:1e3},{Pose:["LegsClosed"],Duration:1e3},{Pose:["BaseLower"],Duration:1e3}]},SpreadLegs:{Type:"SpreadLegs",Duration:-1,Poses:[{Pose:["Spread"],Duration:-1}]},JumpingJacks:{Type:"JumpingJacks",Priority:100,Duration:8e3,Poses:[{Pose:["OverTheHead","Spread"],Duration:1e3},{Pose:["BaseUpper","LegsClosed"],Duration:1e3},{Pose:["OverTheHead","Spread"],Duration:1e3},{Pose:["BaseUpper","LegsClosed"],Duration:1e3},{Pose:["OverTheHead","Spread"],Duration:1e3},{Pose:["BaseUpper","LegsClosed"],Duration:1e3},{Pose:["OverTheHead","Spread"],Duration:1e3},{Pose:["BaseUpper","LegsClosed"],Duration:1e3}]}}),window.bce_ActivityTriggers||(window.bce_ActivityTriggers=[{Event:"Blush",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemMouth-PoliteKiss$/u}]},{Event:"Stretch",Type:"Emote",Matchers:[{Tester:/^stretches (her|his|their) whole body/u}]},{Event:"JumpingJacks",Type:"Emote",Matchers:[{Tester:/^does jumping[ -]?jacks/u}]},{Event:"AllFours",Type:"Emote",Matchers:[{Tester:/^(gets on all fours|starts crawling)/u}]},{Event:"SpreadKnees",Type:"Emote",Matchers:[{Tester:/^spreads(( (her|his|their) legs)? on)? (her|his|their) knees/u}]},{Event:"SpreadLegs",Type:"Emote",Matchers:[{Tester:/^spreads (her|his|their) legs apart/u}]},{Event:"Handstand",Type:"Emote",Matchers:[{Tester:/^(does a handstand|stands on (her|his|their) hands)/u}]},{Event:"Hogtied",Type:"Emote",Matchers:[{Tester:/^lies( down)? on (the floor|(her|his|their) (tummy|stomach))/u}]},{Event:"Blush",Type:"Emote",Matchers:[{Tester:/^blushes/u}]},{Event:"Chuckle",Type:"Emote",Matchers:[{Tester:/^chuckles/u}]},{Event:"Laugh",Type:"Emote",Matchers:[{Tester:/^laughs/u}]},{Event:"Giggle",Type:"Emote",Matchers:[{Tester:/^giggles/u}]},{Event:"Smirk",Type:"Emote",Matchers:[{Tester:/^(smirk(s|ing)|.*with a smirk)/u}]},{Event:"Wink",Type:"Emote",Matchers:[{Tester:/^winks/u}]},{Event:"Pout",Type:"Emote",Matchers:[{Tester:/^pouts/u}]},{Event:"Blink",Type:"Emote",Matchers:[{Tester:/^blinks/u}]},{Event:"Frown",Type:"Emote",Matchers:[{Tester:/^frowns/u}]},{Event:"Grin",Type:"Emote",Matchers:[{Tester:/^(grins|is grinning)/u}]},{Event:"Confused",Type:"Emote",Matchers:[{Tester:/^((seems|looks) (confused|curious|suspicious)|raises an eyebrow)/u}]},{Event:"CloseMouth",Type:"Emote",Matchers:[{Tester:/^closes (her|his|their) mouth/u}]},{Event:"OpenMouth",Type:"Emote",Matchers:[{Tester:/^opens (her|his|their) mouth/u}]},{Event:"Happy",Type:"Emote",Matchers:[{Tester:/^(looks|seems|is|gets|smiles) happ(il)?y/u}]},{Event:"Smile",Type:"Emote",Matchers:[{Tester:/^smiles/u}]},{Event:"Distressed",Type:"Emote",Matchers:[{Tester:/^(looks|seems|is|gets) distressed/u}]},{Event:"Sad",Type:"Emote",Matchers:[{Tester:/^(looks|seems|is|gets) sad/u}]},{Event:"Worried",Type:"Emote",Matchers:[{Tester:/^(looks|seems|is|gets) (worried|surprised)/u}]},{Event:"BareTeeth",Type:"Emote",Matchers:[{Tester:/^(bares (her|his|their) teeth|snarls)/u}]},{Event:"Angry",Type:"Emote",Matchers:[{Tester:/^(looks angr(il)?y|(gets|is|seems) angry)/u}]},{Event:"Glare",Type:"Emote",Matchers:[{Tester:/^(glares|looks harshly|gives a (glare|harsh look))/u}]},{Event:"OpenEyes",Type:"Emote",Matchers:[{Tester:/^opens (her|his|their) eyes/u}]},{Event:"NarrowEyes",Type:"Emote",Matchers:[{Tester:/^((squints|narrows) (her|his|their) eyes|narrowly opens (her|his|their) eyes)/u}]},{Event:"CloseEyes",Type:"Emote",Matchers:[{Tester:/^closes (her|his|their) eyes/u}]},{Event:"ResetBrows",Type:"Emote",Matchers:[{Tester:/^lowers (her|his|their) eyebrows/u}]},{Event:"RaiseBrows",Type:"Emote",Matchers:[{Tester:/^raises (her|his|their) eyebrows/u}]},{Event:"DroolSides",Type:"Emote",Matchers:[{Tester:/^drools/u}]},{Event:"Cry",Type:"Emote",Matchers:[{Tester:/^(starts to cry|sheds .* tears?|eyes( start( to)?)? leak)/u}]},{Event:"Reset",Type:"Emote",Matchers:[{Tester:/^'s (expression|face) returns to normal/u}]},{Event:"Shock",Type:"Action",Matchers:[{Tester:/^(ActionActivityShockItem|FuturisticVibratorShockTrigger|FuturisticChastityBeltShock\w+|(TriggerShock|(ShockCollar|Collar(Auto)?ShockUnit|(LoveChastityBelt|SciFiPleasurePanties)Shock)Trigger)(1|2))$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:"ShockLight",Type:"Action",Matchers:[{Tester:/^(TriggerShock|(ShockCollar|Collar(Auto)?ShockUnit|(LoveChastityBelt|SciFiPleasurePanties)Shock)Trigger)0$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:"Hit",Type:"Action",Matchers:[{Tester:/^ActionActivitySpankItem$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:"Spank",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemButt-Spank$/u,Criteria:{TargetIsPlayer:!0}},{Tester:/^ChatSelf-ItemButt-Spank$/u}]},{Event:"Cuddle",Type:"Activity",Matchers:[{Tester:/^ChatOther-.*-Cuddle$/u},{Tester:/^ChatSelf-.*-Cuddle$/u}]},{Event:"Stimulated",Type:"Action",Matchers:[{Tester:/^ActionActivityMasturbateItem$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:"StimulatedLong",Type:"Activity",Matchers:[{Tester:/^ChatOther-.*-(Masturbate|Penetrate).*$/u,Criteria:{TargetIsPlayer:!0}},{Tester:/^ChatSelf-.*-(Masturbate|Penetrate).*$/u}]},{Event:"KissOnLips",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemMouth-Kiss$/u}]},{Event:"Kiss",Type:"Activity",Matchers:[{Tester:/^ChatOther-.*-Kiss$/u,Criteria:{SenderIsPlayer:!0}}]},{Event:"Disoriented",Type:"Action",Matchers:[{Tester:/^(KneelDown|StandUp)Fail$/u}]},{Event:"LipBite",Type:"Activity",Matchers:[{Tester:/^ChatSelf-ItemMouth-Bite$/u}]},{Event:"Lick",Type:"Activity",Matchers:[{Tester:/^ChatOther-.*-(Lick|MasturbateTongue)$/u,Criteria:{SenderIsPlayer:!0}}]},{Event:"DroolReset",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemMouth-Caress$/u,Criteria:{TargetIsPlayer:!0}},{Tester:/^ChatSelf-ItemMouth-Caress$/u}]},{Event:"LongKiss",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemMouth-FrenchKiss$/u}]}]);function B(w){return w?.some(M=>M&&"TargetCharacter"in M&&M.TargetCharacter===Player.MemberNumber)||!1}de("ChatRoomMessage",w=>{e:for(const M of window.bce_ActivityTriggers.filter(S=>S.Type===w.Type))for(const S of M.Matchers)if(S.Tester.test(w.Content)){if(S.Criteria){if(S.Criteria.SenderIsPlayer&&w.Sender!==Player.MemberNumber||S.Criteria.TargetIsPlayer&&!B(w.Dictionary)||S.Criteria.DictionaryMatchers&&!S.Criteria.DictionaryMatchers.some(R=>w.Dictionary?.find(W=>Object.keys(R).every(Q=>R[Q]===W[Q]))))continue;h(window.bce_EventExpressions[M.Event])}else if(w.Sender===Player.MemberNumber||B(w.Dictionary)){h(window.bce_EventExpressions[M.Event]);break e}}});function x(w){const M=Player.Appearance.filter(S=>S.Asset.Group.Name===w)[0]?.Property??null;return[M?.Expression||null,!M?.RemoveTimer]}function P(w,M,S){M||(M=null);for(let R=0;R<Player.Appearance.length;R++){const W=Player.Appearance[R];if(W.Asset.Group.Name===w){W.Property||(W.Property={}),W.Property.Expression=M,S&&(Player.Appearance[R].Color=S);break}}}const O={BodyFull:{Conflicts:["BodyUpper","BodyLower"]},BodyUpper:{Conflicts:["BodyFull"]},BodyLower:{Conflicts:["BodyFull"]}};function A(w){return ce(w)&&w in O}const m=["Eyes","Eyes2","Eyebrows","Mouth","Fluids","Emoticon","Blush","Pussy"];h({Type:a,Duration:-1,Expression:m.map(w=>{const[M]=x(w);return[w,M]}).filter(w=>w[1]!==null).map(w=>[w[0],[{Expression:w[1]}]]).reduce((w,M)=>({...w,[M[0]]:M[1]}),{})});let D=0,v=0,I=!1,k=Player.ArousalSettings;const T={None:0,Down:1,Up:2};let L=T.Up;function p(w,M=[]){if(delete Player.ExpressionQueue,n.push(...n.splice(0,n.length).map(S=>((w.includes(S.Type)||S.Duration<=0&&S.Type!==r&&!M.includes(S.Type))&&delete S.Expression,S))),!w.includes(a))h({Type:a,Duration:-1,Expression:ye(c).reduce((S,[R,W])=>({...S,[R]:[{Expression:W}]}),{})});else for(const[S]of ye(c))delete c[S]}Commands.push({Tag:"r",Description:d("[part of face or 'all']: resets expression overrides on part of or all of face"),Action:w=>{if(w.length===0||w==="all")p([a]),H(d("Reset all expressions"));else{const M=`${w[0].toUpperCase()}${w.substring(1).toLowerCase()}`;for(const S of n.map(R=>R.Expression).filter(Boolean))M==="Eyes"&&"Eyes2"in S&&delete S.Eyes2,M in S&&delete S[M];H(d("Reset expression on $component",{$component:M}))}}}),Commands.push({Tag:"anim",Description:d("['list' or name of emote]: run an animation"),Action:(w,M,S)=>{if(!l.activityExpressions){H(d("Activity expressions are not enabled in WCE settings. Unable to run animations."));return}S[0]==="list"&&H(d("Available animations: $anims",{$anims:Object.keys(window.bce_EventExpressions).join(", ")}));const R=Object.keys(window.bce_EventExpressions).find(W=>W.toLowerCase()===S[0]?.toLowerCase());R&&h(window.bce_EventExpressions[R])}});function g(w){return PoseFemale3DCG.find(M=>M.Name===w)?.Category}function b(w){w=w.filter(S=>S).map(S=>S.toLowerCase()),n.forEach(S=>{S.Type===a?S.Poses=[]:S.Poses&&S.Poses.length>0&&S.Poses.forEach(R=>{if(R.Pose.length===0||typeof R.Pose[0]=="string")return;const W=R.Pose;R.Pose=W.filter(Q=>!!g(Q))})});const M=PoseFemale3DCG.filter(S=>w.includes(S.Name.toLowerCase())).map(S=>S.Name);for(const S of M)PoseSetActive(Player,S,!1)}Commands.push({Tag:"pose",Description:d("['list' or list of poses]: set your pose"),Action:(w,M,S)=>{if(S[0]==="list"){const R=[...new Set(PoseFemale3DCG.map(W=>W.Category))];for(const W of R){const Q=PoseFemale3DCG.filter(V=>V.Category===W)?.map(V=>V.Name);Q.sort(),H(`=> ${W}:
${Q.join(`
`)}

`)}return}l.animationEngine||H(d("Warning: animation engine in WCE is disabled. Pose may not be synchronized or set. Enable animation engine in WCE settings.")),b(S)}}),re("TimerInventoryRemove",{"CharacterSetFacialExpression(C, C.ExpressionQueue[0].Group, C.ExpressionQueue[0].Expression, undefined, undefined, true);":`if (bceAnimationEngineEnabled()) {
        fbcPushEvent({
          Type: "${o}",
          Duration: -1,
          Expression: {
            [C.ExpressionQueue[0].Group]: [{ Expression: C.ExpressionQueue[0].Expression, Duration: -1 }]
          }
        })
      } else {
        CharacterSetFacialExpression(C, C.ExpressionQueue[0].Group, C.ExpressionQueue[0].Expression, undefined, undefined, true);
      }`},"Game's timed expressions are not hooked to WCE's animation engine"),re("ValidationSanitizeProperties",{"delete property.Expression;":`delete property.Expression;
      if (bceAnimationEngineEnabled()) {
        if (item?.Asset?.Group?.Name) {
          CharacterSetFacialExpression(C, item.Asset.Group.Name, null);
          console.warn("(WCE) Animation engine acknowledged validation-based expression removal for face component", item)
        } else {
          console.warn("Unable to determine asset group name for item", item);
        }
      }`},"Prevent animation engine from getting into an endless loop when another addon includes an invalid expression"),f.hookFunction("CharacterSetFacialExpression",C.OverrideBehaviour,(w,M)=>{let[S,R,W,Q,V]=w;if(!ue(S)||!ce(R)||!ce(W)&&W!==null||!S.IsPlayer()||!l.animationEngine)return M(w);const Y=typeof Q=="number"&&Q>0?Q*1e3:-1,ne={};let Z=[];R==="Eyes"?Z=["Eyes","Eyes2"]:R==="Eyes1"?Z=["Eyes"]:Z=[R],(!V||!at(V)||!CommonColorIsValid(V))&&(V=void 0);for(const Ee of Z)ne[Ee]=[{Expression:W,Duration:Y,Color:V}],Y<0&&(c[Ee]=W);return h({Type:a,Duration:Y,Expression:ne}),j()});const G=["CharacterSetActivePose","PoseSetActive"];for(const w of G)f.hookFunction(w,C.OverrideBehaviour,(M,S)=>{const[R,W]=M;if(!ue(R)||!at(W)&&W!==null||!R.IsPlayer()||!l.animationEngine)return S(M);const Q={};return!W||Array.isArray(W)&&W.every(V=>!V)?Q.Pose=["BaseUpper","BaseLower"]:Q.Pose=[W],Q.Duration=-1,h({Type:a,Duration:-1,Poses:[Q]}),j()});de("ChatRoomSyncPose",w=>{if(!(w===null||!se(w))){if(!Array.isArray(w.Pose)){z(`data.Pose in ChatRoomSyncPose for ${w.MemberNumber?.toString()} is not an array`);return}l.animationEngine&&w.MemberNumber===Player.MemberNumber&&b(w.Pose)}}),de("ChatRoomSyncSingle",w=>{w===null||!se(w)||l.animationEngine&&w.Character?.MemberNumber===Player.MemberNumber&&b(w.Character.ActivePose??[])}),p([a,o]);function j(){if(!l.animationEngine||!Player?.AppearanceLayers)return;if(Player.Appearance.filter(F=>m.includes(F.Asset.Group.Name)&&F.Property?.RemoveTimer).forEach(F=>{delete F.Property.RemoveTimer}),!Player.ArousalSettings){z("Player.ArousalSettings is not defined");return}Player.ArousalSettings.AffectExpression=!1;const w=Player.ArousalSettings.OrgasmCount??0;v<w?v=w:v>w&&(Player.ArousalSettings.OrgasmCount=v,ActivityChatRoomArousalSync(Player));let M=!0;for(const F of m)x(F)[0]&&(M=!1);if(M){if(k.Progress=0,L=T.Up,!I)for(let F=0;F<n.length;F++)n[F].Type!==r&&(n[F].Expression={});I=!0}else I=!1;const S=Player.ArousalSettings.Progress;let R=L;S<k.Progress?R=T.Down:S>k.Progress&&(R=T.Up),L=R;const W=()=>{const F=Player.ArousalSettings?.OrgasmCount||0,$=Math.min(300,60+F*5),X=(Date.now()-D)/1e4|0;return X>$?0:Math.min(Math.max(0,90-S),30*($-X)/$)},Q=2;k.OrgasmStage!==Q&&Player.ArousalSettings.OrgasmStage===Q&&n.filter(F=>F.Type===i).length===0&&(h(window.bce_EventExpressions.PostOrgasm),D=Date.now());const V={};let Y={};const ne={},Z=(F,$,X,_)=>{const K=$.Priority||X.Priority||0;(!ne[_]||(ne[_].Priority??0)<=K)&&(ne[_]={Id:$.Id,Expression:F,Duration:$.Duration,Priority:K,Color:$.Color})};for(let F=0;F<n.length;F++){const $=n[F],X=$.Until??0,_=$.At??0;let K=!1;if(X>Date.now()||X-_<0){const ee=$.Expression??{};if(Object.keys(ee).length>0)for(const q of Object.keys(ee)){let te=Date.now()-_;for(let he=0;he<ee[q].length;he++){const ae=ee[q][he];if(te-=ae.Duration,te<0||ae.Duration<0){if(K=!0,!ae.Skip)if(ae.ExpressionModifier&&q in e){const[fe]=x(q);if(ae.Applied)Z(fe,ae,$,q);else{let Fe=e[q].indexOf(fe)+ae.ExpressionModifier;Fe>=e[q].length?Fe=e[q].length-1:Fe<0&&(Fe=0),Z(e[q][Fe],ae,$,q),n[F].Expression[q][he].Applied=!0}}else Z(ae.Expression??null,ae,$,q);break}}}if($.Poses?.length){let q=Date.now()-_;for(const te of $.Poses)if(q-=te.Duration,q<0||te.Duration<0){K=!0;for(const he of te.Pose){const ae=te.Priority||$.Priority||0,fe=g(he);if(!fe){z(`Pose ${he} has no category`);continue}te.Id||(z(`Pose ${he} has no ID`),te.Id=u()),(!Y[fe]||Y[fe].Priority<=ae)&&(Y[fe]={Id:te.Id,Pose:he,Category:fe,Duration:te.Duration,Priority:ae,Type:$.Type})}break}}}if(!K){const ee=n.splice(F,1);if(F--,!l.expressions&&ee.length>0&&ee[0].Expression)for(const q of Object.keys(ee[0].Expression))Z(null,{Duration:-1},{Priority:0,Type:t,Duration:500},q)}}for(let F=0;F<n.length;F++){const $=n[F].Expression,X=n[F].Poses;if($)for(const _ of Object.keys($)){if(!ne[_]||ne[_].Duration>0)continue;const K=ve(ne[_].Id),ee=ve(ne[_].Priority,0);for(let q=0;q<$[_].length;q++){const te=$[_][q];te.Duration<0&&(ve(te.Id)<K||ve(te.Priority,0)<ee)&&($[_].splice(q,1),q--)}$[_].length===0&&delete $[_]}if(X)for(let _=0;_<X.length;_++){const K=X[_],ee=K.Pose.every(q=>{const te=g(q);return!!te&&Y[te]?.Duration<0&&Y[te]?.Id>ve(K.Id)&&(Y[te]?.Type===a||n[F].Type!==a)});K.Duration<0&&ee&&(X.splice(_,1),_--)}Object.keys(n[F].Expression||{}).length===0&&n[F].Poses?.length===0&&(n.splice(F,1),F--)}let Ee=!1,Se=!1;if(Player.ActivePose)for(let F=0;F<Player.ActivePose.length;F++){const $=Player.ActivePose[F];!PoseFemale3DCG.find(X=>X.Name===$)?.Category&&Object.values(Y).every(X=>X.Pose!==$)&&(Se=[...Player.ActivePose],Se.splice(F,1),F--,Ee=!0)}e:for(const F of Object.keys(window.bce_ArousalExpressionStages)){const[$]=x(F);let X=null,_=!1;for(const K of window.bce_ArousalExpressionStages[F]){const ee=K.Limit-(R===T.Up?0:1);if(S+W()>=ee)if(K.Expression!==$){X=K.Expression,_=!0;break}else continue e}if(_){const K={};K[F]=[{Expression:X,Duration:-1,Priority:0}],h({Type:r,Duration:-1,Priority:0,Expression:K})}}for(const F of m){const[$]=x(F),X=ne[F]||{Duration:-1,Expression:null};X.Expression!==$&&typeof X.Expression<"u"&&(V[F]={...X})}if(Object.keys(V).length>0){for(const F of Object.keys(V))we?.getRuleState("block_changing_emoticon")?.isEnforced&&F==="Emoticon"||(P(F,V[F].Expression??null,V[F].Color),ServerSend("ChatRoomCharacterExpressionUpdate",{Name:V[F].Expression??null,Group:F,Appearance:ServerAppearanceBundle(Player.Appearance)}));Ee=!0}function Bt(){const F=Math.max(...Object.values(Y).map(K=>K.Priority)),$=ye(Y).filter(K=>K[1].Priority===F);let X="";if($.length>1){const K=Math.max(...$.map(ee=>ee[1].Id));[[X]]=$.filter(ee=>ee[1].Id===K)}else{if($.length===0)return 0;[[X]]=$}let _=0;if(A(X)){const K=O[X].Conflicts||[];for(const ee of Array.from(K).filter(q=>q in Y))delete Y[ee],_++}return _}for(;Bt()>0;);Object.keys(Y).length===0&&(Y={BodyUpper:{Pose:"BaseUpper",Duration:-1,Id:u(),Priority:0,Type:t},BodyLower:{Pose:"BaseLower",Duration:-1,Id:u(),Priority:0,Type:t}});const xt=/^Base(Lower|Upper)$/u,ot=Object.values(Y).map(F=>F.Pose).filter(F=>!xt.test(F));JSON.stringify(Player.ActivePose)!==JSON.stringify(ot)&&(Se=ot,Ee=!0),Se&&(Player.ActivePose=Se,ServerSend("ChatRoomCharacterPoseUpdate",{Pose:Se})),Ee&&CharacterRefresh(Player,!1,!1),k={...Player.ArousalSettings}}Ce(j,250)}async function Cr(){await U(()=>!!ServerSocket&&ServerIsConnected),Player.BCEArousalProgress=Math.min(Me,Player.ArousalSettings?.Progress??0),Player.BCEEnjoyment=1;const e=.2;de("ChatRoomSyncArousal",r=>{if(r.MemberNumber===Player.MemberNumber)return;const t=ChatRoomCharacter.find(o=>o.MemberNumber===r.MemberNumber);t&&queueMicrotask(()=>{if(t.BCEArousalProgress=Math.min(Me,r.Progress||0),!t?.ArousalSettings){z("No arousal settings found for",t);return}t.ArousalSettings.Progress=Math.round(t.BCEArousalProgress)})}),re("ActivitySetArousalTimer",{"if (Progress > 0 && (C.ArousalSettings.Progress + Progress) > Max)\n		Progress = (Max - C.ArousalSettings.Progress >= 0) ? Max - C.ArousalSettings.Progress : 0;":`
      if (!C.BCEArousal) {
        if ((Progress > 0) && (C.ArousalSettings.Progress + Progress > Max)) Progress = (Max - C.ArousalSettings.Progress >= 0) ? Max - C.ArousalSettings.Progress : 0;
      } else {
        if (Max === 100) Max = 105;
        const fromMax = Max - (C.BCEArousal ? C.BCEArousalProgress : C.ArousalSettings.Progress);
        if (Progress > 0 && fromMax < Progress) {
          if (fromMax <= 0) {
            Progress = 0;
          } else if (C.BCEArousal) {
            Progress = Math.floor(fromMax / ${e} / (C.BCEEnjoyment || 1));
          } else {
            Progress = fromMax;
          }
        }
      }
    `,"if (Progress < -25) Progress = -25;":`
      if (!C.BCEArousal) {
        if (Progress < -25) Progress = -25;
      } else {
        if (Progress < -20) Progress = -20;
      }
      `,"if (Progress > 25) Progress = 25;":`
      if (!C.BCEArousal) {
        if (Progress > 25) Progress = 25;
      } else {
        if (Progress > 20) Progress = 20;
      }
      `},"Alternate arousal algorithm will be incorrect."),f.hookFunction("ActivityChatRoomArousalSync",C.Observe,(r,t)=>{const[o]=r;if(ue(o)&&o.IsPlayer()&&CurrentScreen==="ChatRoom"){const a={Type:Le,Content:Xe,Dictionary:[{message:{type:Be.ArousalSync,version:Ae,alternateArousal:l.alternateArousal,progress:o.BCEArousalProgress,enjoyment:o.BCEEnjoyment}}]};ServerSend("ChatRoomChat",a)}return t(r)}),f.hookFunction("ActivitySetArousal",C.AddBehaviour,(r,t)=>{const[o,a]=r,i=t(r);return ue(o)&&typeof a=="number"&&Math.abs(o.BCEArousalProgress-a)>3&&(o.BCEArousalProgress=Math.min(Me,a)),i}),f.hookFunction("ActivitySetArousalTimer",C.AddBehaviour,(r,t)=>{const[o,,,a]=r;return ue(o)&&typeof a=="number"&&(o.BCEEnjoyment=1+(a>1?Math.round(Math.log2(a)):0)),t(r)}),f.hookFunction("ActivityTimerProgress",C.AddBehaviour,(r,t)=>{const[o,a]=r;if(ue(o)&&typeof a=="number"&&(o.BCEArousalProgress||(o.BCEArousalProgress=0),o.BCEEnjoyment||(o.BCEEnjoyment=1),o.BCEArousalProgress+=a*(a>0?o.BCEEnjoyment*e:1),o.BCEArousalProgress=Math.min(Me,o.BCEArousalProgress),o.BCEArousal)){if(!o.ArousalSettings)throw new Error(`No arousal settings found for ${o.Name}`);return o.ArousalSettings.Progress=Math.round(o.BCEArousalProgress),r[1]=0,t(r)}return t(r)}),re("TimerProcess",{"// If the character is egged, we find the highest intensity factor and affect the progress, low and medium vibrations have a cap\n							let Factor = -1;":`
      let Factor = -1;
      if (Character[C].BCEArousal) {
        let maxIntensity = 0;
        let vibes = 0;
        let noOrgasmVibes = 0;
        for (let A = 0; A < Character[C].Appearance.length; A++) {
          let Item = Character[C].Appearance[A];
          let ZoneFactor = PreferenceGetZoneFactor(Character[C], Item.Asset.ArousalZone) - 2;
          if (InventoryItemHasEffect(Item, "Egged", true) && typeof Item.Property?.Intensity === "number" && !isNaN(Item.Property.Intensity) && Item.Property.Intensity >= 0 && ZoneFactor >= 0) {
            if (Item.Property.Intensity >= 0) {
              vibes++;
              if (!PreferenceGetZoneOrgasm(Character[C], Item.Asset.ArousalZone)) {
                noOrgasmVibes++;
              }
              maxIntensity = Math.max(Item.Property.Intensity, maxIntensity);
              Factor += Item.Property.Intensity + ZoneFactor + 1;
            }
          }
        }
        // Adds the fetish value to the factor
        if (Factor >= 0) {
          var Fetish = ActivityFetishFactor(Character[C]);
          if (Fetish > 0) Factor = Factor + Math.ceil(Fetish / 3);
          if (Fetish < 0) Factor = Factor + Math.floor(Fetish / 3);
        }

        let maxProgress = 100;
        switch (maxIntensity) {
          case 0:
            maxProgress = 40 + vibes * 5;
            break;
          case 1:
            maxProgress = 70 + vibes * 5;
            break;
          default:
            maxProgress = vibes === 0 || vibes > noOrgasmVibes ? 100 : 95;
            break;
        }
        const topStepInterval = 2;
        let stepInterval = topStepInterval;
        if (Factor < 0) {
          ActivityVibratorLevel(Character[C], 0);
        } else {
          if (Factor < 1) {
            ActivityVibratorLevel(Character[C], 1);
            maxProgress = Math.min(maxProgress, 35);
            stepInterval = 5;
          } else if (Factor < 2) {
            ActivityVibratorLevel(Character[C], 1);
            maxProgress = Math.min(maxProgress, 65);
            stepInterval = 4;
          } else if (Factor < 3) {
            maxProgress = Math.min(maxProgress, 95);
            stepInterval = 3;
            ActivityVibratorLevel(Character[C], 2);
          } else {
            ActivityVibratorLevel(Character[C], Math.min(4, Math.floor(Factor)));
          }
          if (maxProgress === 100) {
            maxProgress = 105;
          }
          let maxIncrease = maxProgress - Character[C].ArousalSettings.Progress;
          if (TimerLastArousalProgressCount % stepInterval === 0 && maxIncrease > 0) {
            Character[C].BCEEnjoyment = 1 + (Factor > 1 ? Math.round(1.5*Math.log2(Factor)) : 0);
            ActivityTimerProgress(Character[C], 1);
          }
        }
      } else {
      `,"if ((Factor == -1)) {ActivityVibratorLevel(Character[C], 0);}\n\n						}":`if (Factor == -1) {
          ActivityVibratorLevel(Character[C], 0);
        }
      }
    } else {
      ActivityVibratorLevel(Character[C], 0);
    }
    `,"// No decay if there's a vibrating item running":`// No decay if there's a vibrating item running
    Character[C].BCEEnjoyment = 1;`},"Alternative arousal algorithm will be incorrect.")}async function Er(){await U(()=>!!ServerSocket&&ServerIsConnected),de("ChatRoomSyncMemberJoin",e=>{l.ghostNewUsers&&Date.now()-e.Character.Creation<3e4&&(ChatRoomListManipulation(Player.BlackList,!0,e.Character.MemberNumber.toString()),Player.GhostList||(Player.GhostList=[]),ChatRoomListManipulation(Player.GhostList,!0,e.Character.MemberNumber.toString()),y("Blacklisted",e.Character.Name,CharacterNickname(e.Character),e.Character.MemberNumber,"registered",(Date.now()-e.Character.Creation)/1e3,"seconds ago"))})}async function vr(){await U(()=>!!Player&&!!Player.Appearance);function e(){const r=["Glasses1","Glasses2","Glasses3","Glasses4","Glasses5","Glasses6","SunGlasses1","SunGlasses2","SunGlassesClear","CatGlasses","VGlasses","GradientSunglasses","FuturisticVisor","InteractiveVisor","InteractiveVRHeadset","FuturisticMask","Goggles"];Player.Appearance.find(t=>r.includes(t.Asset.Name))?_e("BlurLight")&&H(d("Having recovered your glasses you can see again!")):st("BlurLight")&&H(d("Having lost your glasses your eyesight is impaired!"))}f.hookFunction("CharacterAppearanceBuildCanvas",C.Observe,(r,t)=>(l.blindWithoutGlasses&&r[0].IsPlayer()&&e(),t(r)))}const rt=Object.freeze({FriendList:"FriendList"});async function Ar(){await U(()=>!!Player&&ServerSocket&&ServerIsConnected);function e(){!l.friendPresenceNotifications&&!l.instantMessenger||CurrentScreen==="FriendList"||CurrentScreen==="Relog"||CurrentScreen==="Login"||ServerSend("AccountQuery",{Query:"OnlineFriends"})}Ce(e,2e4);let r=[];de("AccountQueryResult",t=>{if(CurrentScreen==="FriendList"||CurrentScreen==="Relog"||CurrentScreen==="Login"||!l.friendPresenceNotifications||t.Query!=="OnlineFriends")return;const o=t.Result.map(n=>n.MemberNumber),a=r.map(n=>n.MemberNumber).filter(n=>!o.includes(n)),i=o.filter(n=>!r.some(s=>s.MemberNumber===n));if(i.length){const n=i.map(s=>{const{MemberNumber:u,MemberName:c}=t.Result.find(h=>h.MemberNumber===s)??{MemberName:"",MemberNumber:-1};return`${c} (${u})`}).join(", ");l.friendNotificationsInChat&&CurrentScreen==="ChatRoom"?H(d("Now online: $list",{$list:n})):Ge(d("Now online: $list",{$list:n}),5e3,{ClickAction:rt.FriendList})}if(l.friendOfflineNotifications&&a.length){const n=a.map(s=>{const{MemberNumber:u,MemberName:c}=r.find(h=>h.MemberNumber===s)??{MemberName:"",MemberNumber:-1};return`${c} (${u})`}).join(", ");l.friendNotificationsInChat&&CurrentScreen==="ChatRoom"?H(d("Now offline: $list",{$list:n})):Ge(d("Now offline: $list",{$list:n}),5e3,{ClickAction:rt.FriendList})}r=t.Result}),f.hookFunction("ServerClickBeep",C.OverrideBehaviour,(t,o)=>{if(ServerBeep.Timer>Date.now()&&MouseIn(CurrentScreen==="ChatRoom"?0:500,0,1e3,50)&&CurrentScreen!=="FriendList")switch(ServerBeep.ClickAction){case rt.FriendList:return ServerOpenFriendList(),null}return o(t)})}function wr(){const e=new Map;function r(a,i){return!i.Name||!i.Property?.LockedBy?!0:i.Property?.LockMemberNumber!==a.MemberNumber?(y("Bad lock member number",i.Property?.LockMemberNumber,"from",a.MemberNumber),!1):!0}function t(a,i,n,s,u){const c={changed:0,prohibited:!1};if(a.IsPlayer())return c;const h=`${CharacterNickname(a)} (${a.MemberNumber??"-1"})`;function B(P){if(!P)return P;const O=De(P);return O&&(O.Property&&(s&&(delete O.Property.LockMemberNumber,delete O.Property.LockedBy,delete O.Property.RemoveTimer,delete O.Property.Effect),delete O.Property.BlinkState),u&&delete O.Color,O)}function x(){(a?.Reputation?.find(P=>P.Type==="Dominant")?.Value??0)>=50||a.Title==="Mistress"||a.MemberNumber===Player.Ownership?.MemberNumber||Player.Lovership?.some(P=>P.MemberNumber===a.MemberNumber)||((i?.Property?.LockedBy==="MistressPadlock"&&n?.Property?.LockedBy!=="MistressPadlock"||i?.Property?.LockedBy==="MistressTimerPadlock"&&n?.Property?.LockedBy!=="MistressTimerPadlock")&&(y("Not a mistress attempting to remove mistress lock",h),c.prohibited=!0),(i?.Property?.LockedBy!=="MistressPadlock"&&n?.Property?.LockedBy==="MistressPadlock"||i?.Property?.LockedBy!=="MistressTimerPadlock"&&n?.Property?.LockedBy==="MistressTimerPadlock")&&(y("Not a mistress attempting to add mistress lock",h),c.prohibited=!0),i?.Property?.LockedBy==="MistressTimerPadlock"&&Math.abs(ve(i.Property?.RemoveTimer,Number.MAX_SAFE_INTEGER)-ve(n?.Property?.RemoveTimer))>31*60*1e3&&(c.prohibited=!0,y("Not a mistress attempting to change mistress lock timer more than allowed by public entry",h)))}return n&&n.Property?.LockMemberNumber!==i?.Property?.LockMemberNumber&&(r(a,n)||(c.prohibited=!0)),x(),n=B(n),i=B(i),JSON.stringify(n)!==JSON.stringify(i)&&(y(h,"changed",JSON.stringify(i),"to",JSON.stringify(n),"changes:",c),c.changed++),c}function o(a){if(typeof a.MemberNumber!="number")throw new Error("change from invalid source character with no member number");const i=`${CharacterNickname(a)} (${a.MemberNumber??"-1"})`;y("Rejected changes from",i),H(d(`[Anti-Cheat] ${i} tried to make suspicious changes! Appearance changes rejected. Consider telling the user to stop, whitelisting the user (if trusted friend), or blacklisting the user (if the behaviour continues, chat command: "/blacklistadd ${a.MemberNumber}").`));const n=e.get(a.MemberNumber)||0;Date.now()-n>1e3*60*10&&(e.set(a.MemberNumber,Date.now()),Pe(d(`A magical shield on ${CharacterNickname(Player)} repelled the suspiciously magical changes attempted by ${i}! [WCE Anti-Cheat]`))),l.antiCheatBlackList&&!Player.WhiteList.includes(a.MemberNumber)&&!Player.BlackList.includes(a.MemberNumber)&&(ChatRoomListManipulation(Player.BlackList,!0,a.MemberNumber.toString()),H(d(`[AntiCheat] ${i} blacklisted.`))),ChatRoomCharacterUpdate(Player)}f.hookFunction("ChatRoomSyncItem",C.OverrideBehaviour,(a,i)=>{const[n]=a;if(!l.itemAntiCheat)return i(a);const s=n?.Item;if(s?.Target!==Player.MemberNumber||Player.WhiteList.includes(n.Source))return i(a);const u=ChatRoomCharacter.find(P=>P.MemberNumber===n.Source)||(n.Source===Player.MemberNumber?Player:null);if(!u)throw new Error("change from invalid source character not in the current room");const c=Player.Appearance.some(P=>P.Asset.Name==="FuturisticCollar"),h=Player.Appearance.some(P=>P.Asset.Name==="FuturisticHarness")||c,B=Player.Appearance.find(P=>P.Asset.Group.Name===s.Group),x=B?ServerAppearanceBundle([B])[0]:null;return t(u,x,s,c,h).prohibited?(o(u),null):i(a)}),f.hookFunction("ChatRoomSyncSingle",C.OverrideBehaviour,(a,i)=>{const[n]=a;if(!l.itemAntiCheat||!n?.Character||n.Character.MemberNumber!==Player.MemberNumber||Player.WhiteList.includes(n.SourceMemberNumber))return i(a);const s=ChatRoomCharacter.find(A=>A.MemberNumber===n.SourceMemberNumber)||(n.SourceMemberNumber===Player.MemberNumber?Player:null);if(!s)throw new Error("change from invalid source character not in the current room");if(s.IsPlayer())return i(a);function u(A){const m=new Map;return A.reduce((D,v)=>(v=De(v),delete v.Color,D.set(`${v.Group}/${v.Name}`,v),D),m)}const c=u(ServerAppearanceBundle(Player.Appearance.filter(A=>A.Asset.Group.Category==="Item")));if(!n.Character.Appearance)throw new Error("no appearance data in sync single");const h=u(n.Character.Appearance.filter(A=>ServerBundledItemToAppearanceItem("Female3DCG",A)?.Asset.Group.Category==="Item")),B=Array.from(c.values()).some(A=>A.Name==="FuturisticCollar")&&Array.from(h.values()).some(A=>A.Name==="FuturisticCollar"),x=Array.from(c.values()).some(A=>A.Name==="FuturisticHarness")&&Array.from(h.values()).some(A=>A.Name==="FuturisticHarness")||B;y("Anti-Cheat validating bulk change from",s.MemberNumber);const P=Array.from(h.keys()).reduce((A,m)=>{const D=h.get(m);if(!D)throw new Error("this should never happen: newItem is null inside map loop");if(!c.has(m))return r(s,D)||(A.prohibited=!0),A.new++,A;const v=c.get(m)??null,I=t(s,v,D,B,x);return A.prohibited=A.prohibited||I.prohibited,A.changed+=I.changed,A},{new:0,changed:0,prohibited:!1}),O=Array.from(c.keys()).reduce((A,m)=>h.has(m)?A:A+1,0);return P.new+P.changed+O>2||P.prohibited?(y("Anti-Cheat tripped on bulk change from",s.MemberNumber,P,O),o(s),null):i(a)})}function Sr(){re("ChatSearchQuery",{"// Prevent spam searching the same thing.":`if (ChatRoomJoinLeash) { SearchData.Language = ""; }
	// Prevent spam searching the same thing.`},"Leashing between language filters")}function Dr(){window.bceStripBeepMetadata=p=>p.split("\uF124")[0].trimEnd();const e=document.createElement("div");e.classList.add("bce-hidden"),e.id="bce-instant-messenger";const r=document.createElement("div");r.id="bce-message-left-container";const t=document.createElement("div");t.id="bce-friend-list";const o=document.createElement("div");o.id="bce-message-right-container";const a=document.createElement("div");a.id="bce-message-container";const i=document.createElement("textarea");i.id="bce-message-input",i.setAttribute("maxlength","2000"),i.addEventListener("keydown",p=>{p.stopPropagation()});const n=document.createElement("input");n.id="bce-friend-search",n.setAttribute("placeholder",d("Search for a friend")),n.autocomplete="off",n.addEventListener("keydown",p=>{p.stopPropagation()});const s="bce-friend-list-handshake-completed",u="bce-friend-list-handshake-false";e.appendChild(r),e.appendChild(o),r.appendChild(n),r.appendChild(t),o.appendChild(a),o.appendChild(i),document.body.appendChild(e);const c=()=>`bce-instant-messenger-state-${Player.AccountName.toLowerCase()}`;let h=-1,B=0;const x=new Map,P=()=>{const p=x.get(h);p&&(p.history.scrollTop=p.history.scrollHeight)},O=()=>{const p={};x.forEach((g,b)=>{if(g.historyRaw.length===0)return;const G=Math.min(g.historyRaw.length,100);p[b]={historyRaw:g.historyRaw.slice(-G)}}),localStorage.setItem(c(),JSON.stringify(p))},A=p=>{const g=x.get(p);i.disabled=!g?.online,a.innerHTML="";for(const G of x.values())G.listElement.classList.remove("bce-friend-list-selected");g&&(g.listElement.classList.add("bce-friend-list-selected"),g.listElement.classList.remove("bce-friend-list-unread"),a.appendChild(g.history),g.unread=0);const b=x.get(h);if(b){const G=b.history.querySelector(".bce-message-divider");G&&b.history.removeChild(G)}I(),h=p,P()},m=(p,g,b,G,j)=>{const w=x.get(p);if(!w||b.BeepType)return;const M=le(b.Message?.split(`
`).find(Z=>Z.startsWith("\uF124"))?.substring(1)??"{}")??{messageType:"Message"};M.messageType||(M.messageType="Message");const S=["Message","Emote","Action"].includes(M.messageType)?M.messageType:"Message",R=M?.messageColor??"#ffffff",W=b.Message?.split(`
`).filter(Z=>!Z.startsWith("\uF124")).join(`
`).trimEnd();if(!W){y("skipped empty beep",p,b,g,G);return}const Q=w.history.scrollHeight-w.history.scrollTop-w.history.clientHeight<1,V=document.createElement("div");V.classList.add("bce-message"),V.classList.add(g?"bce-message-sent":"bce-message-received"),V.classList.add(`bce-message-${S}`),V.setAttribute("data-time",j.toLocaleString());const Y=g?CharacterNickname(Player):b.MemberName??"<Unknown>";switch(S){case"Emote":V.textContent=`*${Y}${W}*`;break;case"Action":V.textContent=`*${W}*`;break;case"Message":{const Z=document.createElement("span");Z.classList.add("bce-message-sender"),R&&(Z.style.color=R),Z.textContent=`${Y}: `,V.appendChild(Z),V.appendChild(document.createTextNode(W))}break;default:V.textContent=W;break}if(!Player.MemberNumber)throw new Error("Player.MemberNumber is invalid");let ne=Player.MemberNumber;if(!g){if(!b.MemberNumber)throw new Error("beep.MemberNumber is invalid");ne=b.MemberNumber}if(!G){if(w.historyRaw.push({author:Y,authorId:ne,message:W,type:S,color:R,createdAt:Date.now()}),w.listElement.setAttribute("data-last-updated",Date.now().toString()),p!==h&&(w.listElement.classList.add("bce-friend-list-unread"),w.unread++),w.unread===1&&(e.classList.contains("bce-hidden")||p!==h)){const Z=document.createElement("div");Z.classList.add("bce-message-divider"),w.history.appendChild(Z)}e.classList.contains("bce-hidden")&&B++}Re(V,Q?P:()=>null),w.history.appendChild(V),Q&&P(),O()},D=p=>{let g=x.get(p);if(!g){const b={statusText:document.createElement("span"),listElement:document.createElement("div"),historyRaw:[],history:document.createElement("div"),unread:0,online:!1};b.listElement.id=`bce-friend-list-entry-${p}`,b.listElement.classList.add("bce-friend-list-entry"),b.listElement.onclick=()=>{A(p)},b.history.classList.add("bce-friend-history");const G=document.createElement("div");G.classList.add("bce-friend-list-entry-name"),G.textContent=Player.FriendNames?.get(p)||"",b.listElement.appendChild(G);const j=document.createElement("div");j.classList.add("bce-friend-list-entry-member-number"),j.textContent=p.toString(),b.listElement.appendChild(j),b.listElement.appendChild(b.statusText),t.appendChild(b.listElement),x.set(p,b),g=b}return g},v=le(localStorage.getItem(c())||"{}");for(const[p,g]of ye(v)){const b=parseInt(p),G=D(b);G.historyRaw=g.historyRaw;for(const j of g.historyRaw)m(b,j.authorId===Player.MemberNumber,{Message:`${j.message}

\uF124${JSON.stringify({messageType:j.type,messageColor:j.color})}`,MemberNumber:j.authorId,MemberName:j.author},!0,j.createdAt?new Date(j.createdAt):new Date(0)),j.createdAt&&G.listElement.setAttribute("data-last-updated",j.createdAt.toString())}i.addEventListener("keydown",p=>{if(p.key==="Enter"&&!p.shiftKey){if(p.preventDefault(),we?.getRuleState("speech_restrict_beep_send")?.isEnforced&&!l.allowIMBypassBCX){Ge(d("Sending beeps is currently restricted by BCX rules"));return}let g=i.value;if(g.trim()==="")return;i.value="";let b="Message";g.startsWith("/me ")?(g=g.substring(4),/^[', ]/u.test(g)||(g=` ${g}`),b="Emote"):g.startsWith("/action ")?(g=g.substring(8),b="Action"):/^\*[^*]/u.test(g)?(g=g.substring(1),/^[', ]/u.test(g)||(g=` ${g}`),b="Emote"):/^\*\*/u.test(g)&&(g=g.substring(2),b="Action");const G={BeepType:"",MemberNumber:h,IsSecret:!0,Message:`${g}

\uF124${JSON.stringify({messageType:b,messageColor:Player.LabelColor})}`};m(h,!0,G,!1,new Date),FriendListBeepLog.push({...G,MemberName:Player.FriendNames?.get(h)||"aname",Sent:!0,Private:!1,Time:new Date}),ServerSend("AccountBeep",G)}}),n.onkeyup=()=>{const p=n.value.toLowerCase();for(const g of x.keys()){const b=x.get(g);if(!b)throw new Error("this should never happen, friend is null in map loop");const G=Player.FriendNames?.get(g)?.toLowerCase();p===""?b.listElement.classList.remove("bce-hidden"):!g.toString().includes(p)&&!G?.includes(p)?b.listElement.classList.add("bce-hidden"):b.listElement.classList.remove("bce-hidden")}I()},de("AccountQueryResult",p=>{if(p.Query==="OnlineFriends"&&p.Result&&l.instantMessenger){for(const g of p.Result){const b=D(g.MemberNumber);b.online=!0,b.statusText.textContent=d("Online"),b.listElement.classList.remove(u),b.listElement.classList.add(s)}for(const g of Array.from(x.keys()).filter(b=>!p.Result.some(G=>G.MemberNumber===b))){const b=x.get(g);if(!b)throw new Error("this should never happen, f is null in map loop");b.online=!1,b.statusText.textContent=d("Offline"),b.listElement.classList.remove(s),b.listElement.classList.add(u)}p.Result.some(g=>g.MemberNumber===h)?i.disabled=!1:i.disabled=!0}});function I(){[...t.children].sort((p,g)=>{const b=!p.classList.contains(s),G=!g.classList.contains(s);if(b&&G||!b&&!G){const j=p.getAttribute("data-last-updated")??"",w=g.getAttribute("data-last-updated")??"",M=/^\d+$/u.test(j)?parseInt(j):0;return(/^\d+$/u.test(w)?parseInt(w):0)-M}return b?1:-1}).forEach(p=>{t.removeChild(p),t.appendChild(p)})}f.hookFunction("ServerAccountBeep",C.OverrideBehaviour,(p,g)=>{const[b]=p;b&&se(b)&&!b.BeepType&&l.instantMessenger&&m(b.MemberNumber,!1,b,!1,new Date),g(p)}),f.hookFunction("ServerSend",C.Observe,(p,g)=>{const[b,G]=p;if(b!=="AccountBeep")return g(p);const j=G;return!j?.BeepType&&ce(j?.Message)&&!j.Message.includes("\uF124")&&m(j.MemberNumber,!0,j,!1,new Date),g(p)});function k(){return CurrentScreen==="ChatRoom"&&document.getElementById("TextAreaChatLog")?.offsetParent!==null?[5,865,60,60]:[126,905,60,60]}f.hookFunction("DrawProcess",C.AddBehaviour,(p,g)=>{g(p),l.instantMessenger&&(!l.allowIMBypassBCX&&(we?.getRuleState("speech_restrict_beep_receive")?.isEnforced||we?.getRuleState("alt_hide_friends")?.isEnforced&&Player.GetBlindLevel()>=3)?(e.classList.contains("bce-hidden")||L(),DrawButton(...k(),"","Gray","Icons/Small/Chat.png",d("Instant Messenger (Disabled by BCX)"),!1)):DrawButton(...k(),"",B?"Red":"White","Icons/Small/Chat.png",d("Instant Messenger"),!1))}),f.hookFunction("CommonClick",C.OverrideBehaviour,(p,g)=>{if(l.instantMessenger&&MouseIn(...k())){if(!e.classList.contains("bce-hidden")){L();return}I(),e.classList.toggle("bce-hidden"),ServerSend("AccountQuery",{Query:"OnlineFriends"}),B=0,P(),NotificationReset("Beep");return}g(p)}),f.hookFunction("NotificationRaise",C.ModifyBehaviourHigh,(p,g)=>(p[0]==="Beep"&&p[1]?.body&&(p[1].body=bceStripBeepMetadata(p[1].body)),g(p)));function T(p){l.instantMessenger&&p.key==="Escape"&&!e.classList.contains("bce-hidden")&&(L(),p.stopPropagation(),p.preventDefault())}function L(){e.classList.add("bce-hidden"),i.blur(),n.blur()}document.addEventListener("keydown",T,!0),document.addEventListener("keypress",T,!0)}function Br(){const e=(r,t)=>{if(!l.discreetMode)return t(r)};f.hookFunction("DrawCharacter",C.Top,e),f.hookFunction("NotificationDrawFavicon",C.Top,e),f.hookFunction("DrawImageEx",C.Top,(r,t)=>{if(l.discreetMode){if(!r)return!1;const o=ce(r[0])&&r[0].startsWith("Backgrounds/"),a=/(^Backgrounds\/(?!Sheet(White)?|grey|White\.|BrickWall\.)|\b(Kneel|Arousal|Activity|Asylum|Cage|Cell|ChangeLayersMouth|Diaper|Kidnap|Logo|Player|Remote|Restriction|SpitOutPacifier|Struggle|Therapy|Orgasm\d|Poses|HouseVincula|Seducer\w+)\b|^data:|^Assets\/(?!Female3DCG\/Emoticon\/(Afk|Sleep|Read|Gaming|Hearing|Thumbs(Up|Down))\/))/u;if(ce(r[0])&&a.test(r[0]))return o?(r[0]="Backgrounds/BrickWall.jpg",t(r)):!1;if(r[0]?.src&&a.test(r[0].src))return!1}return t(r)}),f.hookFunction("ChatRoomCharacterViewDraw",C.Top,(r,t)=>{if(l.discreetMode){let o;const a=DrawGetCustomBackground(Player);if(a)o=`Backgrounds/${a}.jpg`;else{if(ChatRoomCustomized&&ChatRoomCustomBackground)return!1;o=`Backgrounds/${ChatRoomData.Background}.jpg`}if(/(^Backgrounds\/(?!Sheet(White)?|grey|White\.|BrickWall\.)|\b(Kneel|Arousal|Activity|Asylum|Cage|Cell|ChangeLayersMouth|Diaper|Kidnap|Logo|Player|Remote|Restriction|SpitOutPacifier|Struggle|Therapy|Orgasm\d|Poses|HouseVincula|Seducer\w+)\b|^data:|^Assets\/(?!Female3DCG\/Emoticon\/(Afk|Sleep|Read|Gaming|Hearing|Thumbs(Up|Down))\/))/u.test(o)){const i=ChatRoomCharacterViewCharacterCount,n=ChatRoomCharacterViewCharactersPerRow,s=ChatRoomCharacterViewWidth,u=ChatRoomCharacterViewHeight,c={inverted:Player.GraphicsSettings.InvertRoom&&Player.IsInverted(),blur:Player.GetBlurLevel(),darken:DrawGetDarkFactor(),tints:Player.GetTints(),sizeMode:ChatRoomCustomSizeMode};ChatRoomCharacterViewLoopCharacters((h,B,x,P,O)=>{if(h%n===0){const A=i<=n?u*(1-O)/2:0,m=RectMakeRect(0,A+h*100,s,u*O);DrawRoomBackground("Backgrounds/BrickWall.jpg",m,c)}DrawCharacter(ChatRoomCharacterDrawlist[h],B,x,O),DrawStatus(ChatRoomCharacterDrawlist[h],B,x,O),ChatRoomCharacterDrawlist[h].MemberNumber!=null&&ChatRoomCharacterViewDrawOverlay(ChatRoomCharacterDrawlist[h],B,x,O,h)})}}return t(r)}),f.hookFunction("NotificationTitleUpdate",C.Top,(r,t)=>{if(l.discreetMode){const o=NotificationGetTotalCount(1);document.title=`${o>0?`(${o}) `:""}${d("OnlineChat")}`;return}return t(r)})}function xr(){f.hookFunction("StruggleFlexibilityCheck",C.OverrideBehaviour,(e,r)=>l.autoStruggle&&StruggleProgressFlexCircles&&StruggleProgressFlexCircles.length>0?(StruggleProgressFlexCircles.splice(0,1),!0):r(e)),Ce(()=>{l.autoStruggle&&(typeof StruggleProgress!="number"||StruggleProgress<0||(StruggleProgressCurrentMinigame==="Strength"?StruggleStrengthProcess(!1):StruggleProgressCurrentMinigame==="Flexibility"&&StruggleProgressFlexCircles&&StruggleProgressFlexCircles.length>0&&StruggleFlexibilityProcess(!1)))},60),Ce(()=>{l.autoStruggle&&(typeof StruggleProgress!="number"||StruggleProgress<0||StruggleProgressCurrentMinigame==="Dexterity"&&Math.max(-.5,Math.min(1,(85-Math.abs(StruggleProgressDexTarget-StruggleProgressDexCurrent))/75))>.5&&StruggleDexterityProcess())},0)}function Fr(){l.leashAlways?ut():lt()}function kr(){const e=["InputChat","TextAreaChatLog"];for(const r of e){const t=document.getElementById(r);t&&(t.style.display="none")}ChatRoomChatHidden=!0}async function Pr(){if(!l.pastProfiles)return;const{Dexie:e}=await import("./dexie.js"),r=new e("bce-past-profiles");r.version(3).stores({profiles:"memberNumber, name, lastNick, seen, characterBundle",notes:"memberNumber, note, updatedAt"}),ElementCreateTextArea("bceNoteInput");const t=document.getElementById("bceNoteInput");t.maxLength=1e4,t.classList.add("bce-hidden");const o=r.table("profiles"),a=r.table("notes");async function i(){try{const{quota:m,usage:D}=await navigator.storage.estimate();return y(`current quota usage ${D?.toLocaleString()??"?"} out of maximum ${m?.toLocaleString()??"?"}`),{quota:m??-1,usage:D??0}}catch(m){return ie("reading storage quota information",m),{quota:-1,usage:-1}}}async function n(m){let D=await o.toArray();D.sort((v,I)=>v.seen-I.seen),D=D.slice(0,m),y("deleting",D),await o.bulkDelete(D.map(v=>v.memberNumber))}async function s(){const{quota:m,usage:D}=await i();D/m>.9&&(me(`storage quota above 90% utilization (${D}/${m}), cleaning some of the least recently seen profiles before saving new one`),await n(10))}async function u(m){await s();const D=m.Name,v=m.Nickname,I=["ActivePose","Inventory","BlockItems","LimitedItems","FavoriteItems","ArousalSettings","OnlineSharedSettings","WhiteList","BlackList","Crafting"];for(const k of I)delete m[k];y(`saving profile of ${v??D} (${D})`);try{await o.put({memberNumber:m.MemberNumber,name:D,lastNick:v,seen:Date.now(),characterBundle:JSON.stringify(m)})}catch(k){const{quota:T,usage:L}=await i();ie(`unable to save profile (${L}/${T}):`,k)}}f.hookFunction("ChatRoomSync",C.Top,(m,D)=>{const[v]=m;if(v?.Character?.length)for(const I of v.Character)u(De(I));D(m)}),f.hookFunction("ChatRoomSyncSingle",C.Top,(m,D)=>{const[v]=m;v?.Character?.MemberNumber&&u(De(v.Character)),D(m)}),f.hookFunction("InformationSheetRun",C.AddBehaviour,(m,D)=>{if(!InformationSheetSelection)throw new Error("InformationSheetSelection is null in InformationSheetRun");if(InformationSheetSelection.BCESeen){const v=window.MainCanvas.getContext("2d");if(!v)throw new Error("could not get canvas 2d context");v.textAlign="left",DrawText(d("Last seen: ")+new Date(InformationSheetSelection.BCESeen).toLocaleString(),1200,75,"grey","black"),v.textAlign="center"}return D(m)});async function c(m){try{const D=await o.get(m),v=CharacterLoadOnline(le(D.characterBundle),m);v.BCESeen=D.seen,CurrentScreen==="ChatRoom"&&(kr(),ChatRoomData&&(ChatRoomBackground=ChatRoomData.Background)),InformationSheetLoadCharacter(v)}catch(D){H(d("No profile found")),ie("reading profile",D)}}Commands.push({Tag:"profiles",Description:d("<filter> - List seen profiles, optionally searching by member number or name"),Action:m=>{(async D=>{let v=await o.toArray();v=v.filter(p=>!D||p.name.toLowerCase().includes(D)||p.memberNumber.toString().includes(D)||p.lastNick?.toLowerCase().includes(D)),v.sort((p,g)=>g.seen-p.seen);const I=v.length;v=v.slice(0,100),v.sort((p,g)=>-(g.lastNick??g.name).localeCompare(p.lastNick??p.name));const k=v.map(p=>{const g=document.createElement("div");g.textContent=d("$nickAndName ($memberNumber) - Seen: $seen",{$nickAndName:p.lastNick?`${p.lastNick} / ${p.name}`:p.name,$memberNumber:p.memberNumber.toString(),$seen:new Date(p.seen).toLocaleDateString()});const b=document.createElement("a");return b.textContent=d("Open"),b.href="#",b.classList.add("bce-profile-open"),b.addEventListener("click",G=>{G.preventDefault(),G.stopPropagation(),c(p.memberNumber)}),g.prepend(b),g}),T=document.createElement("h3");T.textContent=d("Saved Profiles"),T.style.marginTop="0";const L=document.createElement("div");L.textContent=d("showing $num most recent of $total total profiles matching search",{$num:v.length.toLocaleString(),$total:I.toLocaleString()}),H([T,...k,L])})(m)}});let h=!1,B=0;function x(m){return se(m)&&typeof m.note=="string"}function P(){if(!InformationSheetSelection||!InformationSheetSelection.MemberNumber)throw new Error("invalid InformationSheetSelection in notes");h=!0,t.classList.remove("bce-hidden"),t.value="Loading...",a.get(InformationSheetSelection.MemberNumber).then(m=>{if(x(m))t.value=m?.note||"",B=m?.updatedAt||0;else throw new Error("invalid note")}).catch(m=>{t.value="",ie("getting note",m)})}f.hookFunction("CharacterLoadOnline",C.Top,(m,D)=>{const v=D(m);return ue(v)&&v.MemberNumber&&a.get(v.MemberNumber).then(I=>{v.FBCNoteExists=!!(x(I)&&I.note)}),v});function O(){t.classList.add("bce-hidden"),h=!1}function A(m){m.key==="Escape"&&h&&(O(),m.stopPropagation(),m.preventDefault())}document.addEventListener("keydown",A,!0),document.addEventListener("keypress",A,!0),f.hookFunction("OnlineProfileRun",C.OverrideBehaviour,(m,D)=>h?(DrawText(d("Personal notes (only you can read these):"),910,105,"Black","Gray"),B&&je(d("Last saved: $date",{$date:new Date(B).toLocaleString()}),60,105,400,"Black","Gray"),ElementPositionFix("bceNoteInput",36,100,160,1790,750),DrawButton(1720,60,90,90,"","White","Icons/Accept.png",TextGet("LeaveSave")),DrawButton(1820,60,90,90,"","White","Icons/Cancel.png",TextGet("LeaveNoSave")),null):(DrawButton(1620,60,90,90,"","White","Icons/Notifications.png",d("[WCE] Notes")),D(m))),f.hookFunction("OnlineProfileClick",C.OverrideBehaviour,(m,D)=>{if(h){MouseIn(1720,60,90,90)?(s().then(()=>{if(!InformationSheetSelection||!InformationSheetSelection.MemberNumber)throw new Error("invalid InformationSheetSelection in notes");return a.put({memberNumber:InformationSheetSelection.MemberNumber,note:t.value,updatedAt:Date.now()})}),O()):MouseIn(1820,60,90,90)&&O();return}else!h&&MouseIn(1620,60,90,90)&&P();D(m)}),navigator.storage?.persisted&&!await navigator.storage.persisted()&&(await navigator.storage.persist()||z("Profile storage may not be persistent."))}function Mr(){function e(t,o,a){return Array.isArray(t)||(t=[]),t.push({Tag:o,Text:a}),t}let r=0;f.hookFunction("ChatRoomMessage",C.Observe,(t,o)=>{const a=o(t);if(l.pendingMessages&&t?.length&&nt(t[0])&&Array.isArray(t[0].Dictionary)){const[i]=t,n=i.Dictionary?.find?.(s=>s.Tag==="fbc_nonce");if(n){const s=document.querySelector(`[data-nonce='${n.Text}']`);s&&s.remove()}}return a}),f.hookFunction("ServerSend",C.AddBehaviour,(t,o)=>{if(l.pendingMessages&&t?.length>=2&&t[0]==="ChatRoomChat"&&nt(t[1])&&t[1].Type!==Le&&!t[1].Target){r++,r>=Number.MAX_SAFE_INTEGER&&(r=0),t[1].Dictionary=e(t[1].Dictionary,"fbc_nonce",r);const a=document.createElement("div");switch(a.classList.add("ChatMessage","bce-pending"),a.setAttribute("data-time",ChatRoomCurrentTime()),a.setAttribute("data-sender",Player.MemberNumber?.toString()),a.setAttribute("data-nonce",r.toString()),t[1].Type){case"Chat":{a.classList.add("ChatMessageChat");const u=document.createElement("span");u.classList.add("ChatMessageName"),u.style.color=Player.LabelColor||"",u.textContent=CharacterNickname(Player),a.appendChild(u),a.appendChild(document.createTextNode(`: ${t[1].Content}`))}break;case"Emote":case"Action":a.classList.add("ChatMessageEmote"),a.appendChild(document.createTextNode(`*${t[1].Type==="Emote"?`${CharacterNickname(Player)}: `:""}${t[1].Content}*`));break;default:return o(t)}const i=document.createElement("div");i.classList.add("lds-ellipsis");for(let u=0;u<4;u++){const c=document.createElement("div");i.appendChild(c)}a.appendChild(i);const n=ElementIsScrolledToEnd("TextAreaChatLog"),s=document.getElementById("TextAreaChatLog");s&&(s.appendChild(a),n&&ElementScrollToEnd("TextAreaChatLog"))}return o(t)})}function Tr(){f.hookFunction("DrawCharacter",C.ModifyBehaviourLow,(e,r)=>{const[t]=e;if(!t||!l.hideHiddenItemsIcon)return r(e);const o=t.HasHiddenItems;t.HasHiddenItems=!1;const a=r(e);return t.HasHiddenItems=o,a})}function Lr(){const e="DescriptionInput",r="bceRichOnlineProfile";let t=!0;function o(){const c=document.getElementById(e);c&&(t=!1,c.style.display="none")}function a(){const c=document.getElementById(e);c&&(t=!0,c.style.display="")}function i(){o();const c=document.createElement("div");c.id=r,c.style.overflowY="scroll",c.style.overflowX="hidden",c.style.overflowWrap="break-word",c.style.whiteSpace="pre-wrap",c.style.background="rgb(244, 236, 216)",c.style.color="rgb(45, 35, 27)",c.style.border="2px solid black",c.style.padding="2px",c.classList.add("bce-rich-textarea"),c.textContent=InformationSheetSelection?.Description||"",Re(c,()=>!1),document.body.append(c),n()}function n(){ElementPositionFix(r,36,100,160,1790,750)}function s(){const c=document.getElementById(r);c&&c.remove(),a()}f.hookFunction("OnlineProfileLoad",C.ModifyBehaviourMedium,(c,h)=>{t=!0;const B=h(c),x=document.getElementById(e);return!l.richOnlineProfile||!x||i(),B}),f.hookFunction("ChatRoomHideElements",C.ModifyBehaviourMedium,(c,h)=>(s(),h(c)));const u=[90,60,90,90];f.hookFunction("OnlineProfileRun",C.ModifyBehaviourMedium,(c,h)=>{if(!l.richOnlineProfile)return h(c);DrawButton(...u,"","White","Icons/Crafting.png",d("Toggle Editing Mode"));const B=h(c);return t||(o(),n()),B}),f.hookFunction("OnlineProfileClick",C.ModifyBehaviourMedium,(c,h)=>l.richOnlineProfile&&MouseIn(...u)?(t?i():s(),!0):h(c)),f.hookFunction("OnlineProfileExit",C.ModifyBehaviourMedium,(c,h)=>(t||s(),h(c)))}async function Ir(){await U(()=>Array.isArray(Commands)&&Commands.length>0);const e=[1485,15,90,90],r=[1585,15,90,90];function t(){FUSAM.modals.open({prompt:d("Paste the craft here"),callback:(o,a)=>{if(!(o!=="submit"||!a))try{const i=le(LZString.decompressFromBase64(a));if(!se(i))throw ie(i),new Error(`invalid craft type ${typeof i} ${a}`);for(const[n,s]of ye(i))!ce(s)&&!Number.isInteger(s)&&s!==!1&&s!==!0&&s!==null&&!se(s)&&z("potentially invalid craft bundle:",n,"was",s);CraftingSelectedItem=CraftingConvertItemToSelected(i),CraftingModeSet("Name")}catch(i){ie("importing craft",i)}},input:{initial:"",readonly:!1,type:"textarea"}})}f.hookFunction("CraftingClick",C.AddBehaviour,(o,a)=>{switch(CraftingMode){case"Name":MouseIn(...r)?FUSAM.modals.open({prompt:d("Copy the craft here"),input:{initial:LZString.compressToBase64(JSON.stringify(CraftingConvertSelectedToItem())),readonly:!0,type:"textarea"},callback:()=>{y("exported craft")}}):MouseIn(...e)&&t();break}return a(o)}),f.hookFunction("CraftingRun",C.ModifyBehaviourMedium,(o,a)=>{const i=a(o);return CraftingMode==="Name"&&(DrawButton(...e,d("Import"),"white"),DrawButton(...r,d("Export"),"white")),i}),f.hookFunction("DrawItemPreview",C.AddBehaviour,(o,a)=>{const i=a(o),[n,,s,u]=o;if(n){const{Craft:c}=n;MouseIn(s,u,DialogInventoryGrid.itemWidth,DialogInventoryGrid.itemHeight)&&c&&(ke(s,u,DialogInventoryGrid.itemWidth,d(c.Property),"center"),ke(1e3,u-70,975,`${d("Description:")} ${c.Description||"<no description>"}`,"left"))}return i})}function Nr(){let e=!1,r=!1;f.hookFunction("DrawArousalMeter",C.Observe,(t,o)=>{const[a]=t;e=!!a.ArousalZoom;const i=(a.ArousalSettings?.ProgressTimer??0)>0,n=(a.ArousalSettings?.VibratorLevel??0)>0,s=a.ArousalSettings?.Progress??0,u=(a.IsEdged()||a.HasEffect("DenialMode"))&&s>=95;r=i||n&&!u;const c=o(t);return e=!1,c}),f.hookFunction("DrawArousalThermometer",C.Observe,(t,o)=>{const a=o(t);if(l.numericArousalMeter&&e){const[i,n,s,u]=t;let c="white";u>=95?r?c="red":c="hotpink":u>=70&&(c="pink"),DrawTextFit(u.toLocaleString()+(r?"\u2191":" "),i+50*s,n-30*s,100*s,c,"black")}return a})}function Rr(){ServerCharacterNicknameRegex=/^[\p{L}0-9\p{Z}'-]+$/u}function Wr(){window.addEventListener("beforeunload",e=>{if(J.client?.connected)for(const r of J.client.devices.filter(t=>t.vibrateAttributes.length>0))r.vibrate(0);return l.confirmLeave?(e.preventDefault(),ServerSocket.io.disconnect(),CommonSetScreen("Character","Relog"),ServerSocket.io.connect(),e.returnValue="Are you sure you want to leave the club?"):null},{capture:!0})}function Gr(){const e={};f.hookFunction("ChatRoomMessageDisplay",C.AddBehaviour,(r,t)=>(l.whisperTargetFixes&&r[0].Type==="Action"&&r[0].Sender===ChatRoomTargetMemberNumber&&(["ServerLeave","ServerBan","ServerKick","ServerDisconnect"].some(o=>r[0].Content.startsWith(o))?e[r[0].Sender]=window.setTimeout(()=>{ChatRoomSetTarget(-1),ChatRoomSendLocal('<span style="color: red">[WCE] Your whisper target was cleared, because they left the room for more than a minute!</span>')},60*1e3):r[0].Content.startsWith("ServerEnter")&&e[r[0].Sender]&&(window.clearTimeout(e[r[0].Sender]),delete e[r[0].Sender])),t(r))),re("ChatRoomSendChat",{'ChatRoomSendLocal(`<span style="color: red">${TextGet("WhisperTargetGone")}</span>`);':`ChatRoomSendLocal('<span style="color: red">' + TextGet("WhisperTargetGone") + " Resetting to talk to everyone now!</span>");
        if(fbcSettingValue("whisperTargetFixes")) ChatRoomSetTarget(-1);
        `},"Resetting blush, eyes, and eyebrows after struggling")}async function Or(){await U(()=>AssetFemale3DCG?.some(e=>e.Group==="Pronouns")),AssetFemale3DCG.find(e=>e.Group==="Pronouns").Asset.forEach(e=>e.AllowEffect=[E.Leash,E.BlurLight]),await U(()=>Player?.Appearance?.some(e=>e.Asset.Group.Name==="Pronouns")),Player.Appearance.find(e=>e.Asset.Group.Name==="Pronouns").Asset.AllowEffect=[E.Leash,E.BlurLight]}const He=[],N=async(e,r)=>{He.push(r);try{const t=e();t instanceof Promise&&await t,He.splice(He.indexOf(r),1)}catch(t){const o=t;ie(`Error in ${r}: ${o?.toString()}
${o?.stack??""}`)}};async function $r(){let e="init";f.hookFunction("LoginResponse",C.Top,(r,t)=>(e==="init"&&(e="disable"),t(r))),f.hookFunction("LoginStatusReset",C.Top,(r,t)=>(e==="disable"&&(e="init"),t(r))),f.hookFunction("GameRun",C.Top,(r,t)=>e==="disable"?(GameAnimationFrameId=requestAnimationFrame(GameRun),null):t(r)),f.hookFunction("GameRunBackground",C.Top,(r,t)=>e==="disable"?null:t(r)),await N(Yt,"functionIntegrityCheck"),N(Zt,"bceStyles"),N(rr,"commonPatches"),N(Vt,"extendedWardrobe"),N(Or,"allowCustomEffect"),N(dr,"automaticReconnect"),N(gr,"hiddenMessageHandler"),await N(Xt,"bceLoadSettings"),N(Kt,"postSettings"),N(cr,"appendSocketListenersToInit"),y(l),N(Br,"discreetMode"),N(or,"beepImprovements"),N(ur,"settingsPage"),N(Cr,"alternateArousal"),N(_t,"chatAugments"),N(br,"automaticExpressions"),N(pr,"layeringMenu"),N(hr,"cacheClearer"),N(lr,"lockpickHelp"),N(sr,"commands"),N(mr,"chatRoomOverlay"),N(fr,"privateWardrobe"),N(yr,"antiGarbling"),N(Er,"autoGhostBroadcast"),N(vr,"blindWithoutGlasses"),N(Ar,"friendPresenceNotifications"),N(ir,"forcedClubSlave"),N(Dr,"instantMessenger"),N(xr,"autoStruggle"),N(Rr,"nicknames"),N(Fr,"leashAlways"),N(Gt,"toySync"),N(Pr,"pastProfiles"),N(Mr,"pendingMessages"),N(Tr,"hideHiddenItemsIcon"),N(Ir,"crafting"),N(wr,"itemAntiCheat"),N(Sr,"leashFix"),N(nr,"hookBCXAPI"),N(Ut,"customContentDomainCheck"),N(Nr,"numericArousalMeters"),N(Lr,"richOnlineProfile"),N(Rt,"shareAddons"),N(Wr,"confirmLeave"),N(Gr,"chatRoomWhisperFixes"),e="enable"}if(await U(()=>typeof FUSAM=="object"&&FUSAM?.present&&typeof bcModSdk=="object"&&!!bcModSdk),window.FBC_VERSION)throw new Error("FBC already loaded. Skipping load.");if(typeof ChatRoomCharacter>"u")throw new Error("Bondage Club not detected. Skipping WCE initialization.");window.FBC_VERSION=Ae,window.fbcDisplayText=Wt,window.fbcChatNotify=H,window.fbcSendAction=Pe,window.fbcSettingValue=Jt,window.bce_initializeDefaultExpression=()=>{},window.fbcDebug=$e,FUSAM.registerDebugMethod("WCE",$e),await $r(),await Ge(`Wholesome Club Extensions v${window.FBC_VERSION} loaded!`),Player.FBC=Ae;
//# sourceMappingURL=wce.js.map
