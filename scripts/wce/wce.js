/**
* @license GPL-3.0-or-later
*     BCE/FBC
*  Copyright (C) 2024  Sid
*
*  This program is free software: you can redistribute it and/or modify
*  it under the terms of the GNU General Public License as published by
*  the Free Software Foundation, either version 3 of the License, or
*  (at your option) any later version.
*
*  This program is distributed in the hope that it will be useful,
*  but WITHOUT ANY WARRANTY; without even the implied warranty of
*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
*  GNU General Public License for more details.
*
*  You should have received a copy of the GNU General Public License
*  along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/const Ve=Array.from({length:100});function Fe(e,...t){Ve.shift(),Ve.push({level:e,message:t.map(r=>{if(typeof r=="string")return r;if(r instanceof Error)return r.stack;try{return JSON.stringify(r)}catch{return r?.toString()}}).join(", ")})}function f(...e){console.debug("WCE",`${globalThis.FBC_VERSION}:`,...e),Fe("debug",...e)}function ye(...e){console.info("WCE",`${globalThis.FBC_VERSION}:`,...e),Fe("info",...e)}function K(...e){console.warn("WCE",`${globalThis.FBC_VERSION}:`,...e),Fe("warn",...e)}function se(...e){console.error("WCE",`${globalThis.FBC_VERSION}:`,...e),Fe("error",...e)}function je(e){return new Promise(t=>window.setTimeout(t,e))}async function _(e,t=()=>!1){for(;!e();){if(t())return!1;await je(10)}return!0}function he(e){return typeof e=="string"}function le(e){return!!e&&typeof e=="object"&&!Array.isArray(e)}function at(e){return le(e)&&typeof e.Type=="string"&&typeof e.Content=="string"}function ue(e){return le(e)&&typeof e.IsPlayer=="function"}function it(e){return he(e)||Array.isArray(e)&&e.every(he)}function st(e){return Array.isArray(e)&&e.every(t=>Tt(t)||t===null)}function Mt(e){return le(e)&&typeof e.Name=="string"&&typeof e.Group=="string"}function Tt(e){return Array.isArray(e)&&e.every(Mt)}function Ae(e,t=-Number.MAX_SAFE_INTEGER){return e??t}function xe(e){return structuredClone(e)}function Be(e){return le(e)?Object.entries(e):[]}function ce(e){if(e===null)return null;try{return JSON.parse(e)}catch(t){return se("parsing JSON",t),null}}function _e(e,t,r,n,a,s){const l=window.MainCanvas.getContext("2d");if(!l)throw new Error("could not get canvas 2d context");const o=l.textAlign;l.textAlign="left",DrawTextFit(e,t,r,n,a,s),l.textAlign=o}function Me(e,t,r,n,a){const s=window.MainCanvas.getContext("2d");if(!s)throw new Error("could not get canvas 2d context");const l=s.textAlign;s.textAlign=a,DrawRect(e,t,r,65,"#FFFF88"),DrawEmptyRect(e,t,r,65,"black",2),DrawTextFit(n,a==="left"?e+3:e+r/2,t+33,r-6,"black"),s.textAlign=l}function W(e){const t=document.createElement("div");t.setAttribute("class","ChatMessage bce-notification"),t.setAttribute("data-time",ChatRoomCurrentTime()),t.setAttribute("data-sender",Player.MemberNumber?.toString()),typeof e=="string"?t.appendChild(document.createTextNode(e)):Array.isArray(e)?t.append(...e):t.appendChild(e),ChatRoomAppendChat(t)}async function $e(e,t=5e3,r={}){await _(()=>!!Player&&new Date(ServerBeep?.Timer||0)<new Date),ServerBeep={Timer:Date.now()+t,Message:e,...r}}function Te(e){ServerSend("ChatRoomChat",{Content:"Beep",Type:"Action",Dictionary:[{Tag:"Beep",Text:"msg"},{Tag:"\u53D1\u9001\u79C1\u804A",Text:"msg"},{Tag:"Biep",Text:"msg"},{Tag:"Sonner",Text:"msg"},{Tag:"msg",Text:e}]})}function lt(e){let t=!1;const r=Player.Appearance.find(n=>n.Asset.Group.Name==="Pronouns");return r?(r.Property?r.Property.Effect?r.Property.Effect.includes(e)||(r.Property.Effect.push(e),t=!0):(r.Property.Effect=[e],t=!0):(r.Property={Effect:[e]},t=!0),t&&ServerPlayerIsInChatRoom()&&ChatRoomCharacterUpdate(Player),t):(K("Could not find pronouns asset."),t)}function ze(e){const t=Player.Appearance.find(n=>n.Asset.Group.Name==="Pronouns");let r=!1;return t?.Property?.Effect?.includes(e)&&(t.Property.Effect=t.Property.Effect.filter(n=>n!==e),r=!0),r&&ServerPlayerIsInChatRoom()&&ChatRoomCharacterUpdate(Player),r}function ut(){lt("Leash")}function ct(){ze("Leash")}const ve="6.3.4",dt=63.2,ht=["R109"],Ke=`WCE v6.3.4
* BC R109 compatibility and other fixes
* for a full changelog visit our new website: https://wce-docs.vercel.app/blog

WCE v6.3
* configure layer hiding in layering menus

WCE v6.2
* WCE 6.2 is a fork of the old FBC 5.8 and tries to bring all it's amazing features back
* new Anti Garble system, layering improvements, local wardrobe and other fixes and improvements
* please recheck your WCE settings, because many things have changed
`,Lt="https://wce-docs.vercel.app",Ce="bce-colors",It="https://github.com/KittenApps/WCE/blob/main/LICENSE",Le=99.6,qe="BCEMsg",pt="bce-dark-input",Ie=24,fe=96,Nt=384,Ne="Hidden",Pe=Object.freeze({Activity:"Activity",ArousalSync:"ArousalSync",Hello:"Hello"}),Rt="bce-whisper-input",Xe=[],Je=[],b={Top:11,OverrideBehaviour:10,ModifyBehaviourHigh:6,ModifyBehaviourMedium:5,ModifyBehaviourLow:4,AddBehaviour:3,Observe:0},g=bcModSdk.registerMod({name:"WCE",version:ve,fullName:"Wholesome Club Extensions",repository:"https://github.com/KittenApps/WCE.git"},{allowReplace:!1});function ne(e,t,r){Xe.includes(e)&&ht.includes(GameVersion)&&(K(`Attempted patching of ${e} despite detected deviation. Impact may be: ${r}

See /wcedebug in a chatroom for more information or copy(await fbcDebug()) in console.`),Je.push(r)),g.patchFunction(e,t)}const Qe=[];function pe(e,t){return Qe.some(r=>r[1]===t)?null:(Qe.push([e,t]),ServerSocket.on(e,t))}function Wt(){g.hookFunction("ServerInit",b.AddBehaviour,(e,t)=>{const r=t(e);for(const[n,a]of Qe)ServerSocket.on(n,a);return r})}let Se=null;async function Ot(){await _(()=>!!window.bcx),Se=window.bcx?.getModApi("WCE")??null}function h(e,t={}){let r=Object.freeze({CN:{"Automatic Arousal Expressions (Replaces Vanilla)":"\u81EA\u52A8\u6B32\u671B\u8868\u60C5 (\u66FF\u6362\u539F\u7248)","Activity Expressions":"\u6D3B\u52A8\u8868\u793A","Alternate Arousal (Replaces Vanilla, requires hybrid/locked arousal meter)":"\u53E6\u4E00\u79CD\u6B32\u671B (\u66FF\u6362\u539F\u7248, \u9700\u8981\u6DF7\u5408\u6216\u9501\u5B9A\u6B32\u671B\u6761)","Alternative speech stutter":"\u53E6\u4E00\u79CD\u8A00\u8BED\u4E0D\u6E05","Extended wardrobe slots (96)":"\u6269\u5C55\u8863\u67DC\u4FDD\u5B58\u69FD (96\u4E2A)","Replace wardrobe list with character previews":"\u4F7F\u7528\u89D2\u8272\u9884\u89C8\u66FF\u6362\u8863\u67DC\u4FDD\u5B58\u5217\u8868","Clear Drawing Cache Hourly":"\u6BCF\u5C0F\u65F6\u6E05\u9664\u7ED8\u56FE\u7F13\u5B58","Instant messenger":"\u5373\u65F6\u901A\u8BAF","Chat Links and Embeds":"\u804A\u5929\u94FE\u63A5\u548C\u5D4C\u5165","Use Ctrl+Enter to OOC":"\u4F7F\u7528Ctrl+Enter\u8FDB\u884COOC\u53D1\u8A00","Use italics for input when whispering":"\u6084\u6084\u8BDD\u4F7F\u7528\u659C\u4F53\u5B57","Improve colors for readability":"\u6539\u5584\u989C\u8272\u4EE5\u63D0\u9AD8\u53EF\u8BFB\u6027","Show friend presence notifications":"\u663E\u793A\u597D\u53CB\u5728\u7EBF\u901A\u77E5","Understand All Gagged and when Deafened":"\u5728\u88AB\u5835\u4F4F\u5634\u548C\u88AB\u5835\u4F4F\u8033\u6735\u65F6\u53EF\u4EE5\u542C\u61C2\u6240\u6709\u53D1\u8A00","Reveal Lockpicking Order Based on Skill":"\u6839\u636E\u6280\u80FD\u663E\u793A\u64AC\u9501/\u5F00\u9501\u987A\u5E8F","Allow layering menus while bound":"\u5141\u8BB8\u5728\u6346\u7ED1\u65F6\u7528\u5206\u5C42\u83DC\u5355","Limited gag anti-cheat: cloth-gag equivalent garbling":"\u6709\u9650\u7684\u5835\u5634\u53CD\u4F5C\u5F0A: \u548C\u5E03\u5835\u5634\u76F8\u540C\u7684\u4E71\u7801","Full gag anti-cheat: use equipped gags to determine garbling":"\u5B8C\u6574\u7684\u5835\u5634\u53CD\u4F5C\u5F0A: \u4F7F\u7528\u5F53\u524D\u88C5\u5907\u7684\u5835\u5634\u6765\u786E\u5B9A\u4E71\u7801","Extra gag anti-cheat: even more garbling for the most extreme gags":"\u6269\u5C55\u7684\u5835\u5634\u53CD\u4F5C\u5F0A: \u5BF9\u4E8E\u4F7F\u7528\u6700\u6781\u7AEF\u7684\u5835\u5634\u66F4\u52A0\u6DF7\u4E71","Require glasses to see":"\u9700\u8981\u773C\u955C\u624D\u80FD\u770B\u6E05","Automatic Relogin on Disconnect":"\u65AD\u7EBF\u540E\u81EA\u52A8\u91CD\u8FDE","Show gag cheat and anti-cheat options in chat":"\u5728\u804A\u5929\u5BA4\u91CC\u663E\u793A\u5835\u5634\u4F5C\u5F0A\u548C\u53CD\u4F5C\u5F0A\u9009\u9879","Automatically ghost+blocklist unnaturally new users":"\u81EA\u52A8\u5BF9\u4E0D\u81EA\u7136\u7684\u7528\u6237\u65E0\u89C6\u5E76\u6DFB\u52A0\u9ED1\u540D\u5355","Confirm leaving the game":"\u79BB\u5F00\u6E38\u620F\u524D\u9700\u8981\u786E\u8BA4","Discreet mode (disable drawing)":"\u8C28\u614E\u6A21\u5F0F (\u7981\u7528\u7ED8\u56FE)","Make automatic progress while struggling":"\u5728\u6323\u624E\u65F6\u81EA\u52A8\u589E\u52A0\u8FDB\u5EA6","Allow leashing without wearing a leashable item (requires leasher to have WCE too)":"\u5141\u8BB8\u5728\u4E0D\u4F69\u6234\u7275\u5F15\u7EF3\u7684\u60C5\u51B5\u4E0B\u4E5F\u53EF\u4EE5\u8FDB\u884C\u7275\u5F15\uFF08\u9700\u8981\u7275\u5F15\u8005\u4E5F\u5B89\u88C5\u6709WCE\uFF09","Enable buttplug.io (requires refresh)":"\u542F\u7528buttplug.io\uFF08\u9700\u8981\u5237\u65B0\u7F51\u9875)","This page allows configuration of the synchronization of bluetooth connected toys.":"\u6B64\u9875\u9762\u5141\u8BB8\u914D\u7F6E\u5C06BC\u9707\u52A8\u5668\u72B6\u6001\u540C\u6B65\u5230\u84DD\u7259\u8FDE\u63A5\u7684\u73A9\u5177","Save & browse seen profiles (requires refresh)":"\u4FDD\u5B58\u5E76\u6D4F\u89C8\u5DF2\u77E5\u7684\u4E2A\u4EBA\u8D44\u6599 (\u9700\u8981\u5237\u65B0)","Chat & Social":"\u804A\u5929 & \u793E\u4EA4","Activities & Arousal":"\u6D3B\u52A8 & \u6B32\u671B","Appearance & Wardrobe":"\u5916\u89C2 & \u8863\u67DC","Immersion & Anti-Cheat":"\u6C89\u6D78\u4F53\u9A8C & \u53CD\u4F5C\u5F0A",Performance:"\u8868\u73B0",Misc:"\u6742\u9879",Cheats:"\u4F5C\u5F0A",ah:"\u554A",aah:"\u554A\u2764",mnm:"\u5514\u59C6",nn:"\u55EF\u554A",mnh:"\u55EF\u54C8",mngh:"\u5514\u554A",haa:"\u54C8\u554A",nng:"\u55EF\u55EF\u2764",mnng:"\u5514\u554A\u2764","FBC Developer":"FBC \u5F00\u53D1\u8005","WCE Developer":"WCE \u5F00\u53D1\u8005",Incompatibility:"\u4E0D\u517C\u5BB9","Show recent WCE changelog":"\u663E\u793A\u6700\u8FD1\u7684WCE\u66F4\u65B0\u65E5\u5FD7","Include binds?":"\u5305\u62EC\u675F\u7F1A\uFF1F","Include locks?":"\u5305\u62EC\u9501\uFF1F","Include height, body type, hair, etc?":"\u5305\u62EC\u8EAB\u9AD8\uFF0C\u4F53\u578B\uFF0C\u5934\u53D1\u7B49\uFF1F","Copy the looks string below":"\u590D\u5236\u4E0B\u9762\u7684\u5916\u89C2\u5B57\u7B26\u4E32","Paste your looks here":"\u5728\u8FD9\u91CC\u7C98\u8D34\u4F60\u7684\u5916\u89C2","No looks string provided":"\u6CA1\u6709\u63D0\u4F9B\u5916\u89C2\u5B57\u7B26\u4E32","Applied looks":"\u5E94\u7528\u5916\u89C2","Could not parse looks":"\u65E0\u6CD5\u89E3\u6790\u5916\u89C2","[membernumber] [message]: beep someone":"[\u7528\u6237\u7F16\u53F7] [\u6D88\u606F]: \u53D1\u9001beep","Wholesome Club Extensions (WCE) Settings":"Wholesome Club Extensions (WCE)\u8BBE\u7F6E","Join Discord":"\u52A0\u5165Discord",License:"\u6388\u6743",Information:"\u4FE1\u606F","Still connecting or connection failed...":"\u6B63\u5728\u8FDE\u63A5\u6216\u8FDE\u63A5\u5931\u8D25...",Scan:"\u641C\u7D22","Device Name":"\u8BBE\u5907\u540D\u79F0","Synchronized Slot":"\u540C\u6B65\u680F\u4F4D","Click on a setting to see its description":"\u70B9\u51FB\u8BBE\u7F6E\u4EE5\u67E5\u770B\u5176\u63CF\u8FF0","WCE Settings":"WCE\u8BBE\u7F6E","Saved Logins (WCE)":"\u5DF2\u4FDD\u5B58\u7684\u767B\u5F55 (WCE)","Save (WCE)":"\u4FDD\u5B58 (WCE)","Reconnected!":"\u91CD\u65B0\u8FDE\u63A5\uFF01",ERROR:"\u9519\u8BEF","Reset all expressions":"\u91CD\u7F6E\u6240\u6709\u8868\u60C5","['list' or name of emote]: run an animation":"['list' \u6216 \u8868\u60C5\u540D\u79F0]: \u8FD0\u884C\u4E00\u4E2A\u52A8\u753B","['list' or list of poses]: set your pose":"['list' \u6216 \u59FF\u52BF\u5217\u8868]: \u8BBE\u7F6E\u4F60\u7684\u59FF\u52BF","Load without body parts":"\u52A0\u8F7D\u65F6\u4E0D\u5305\u62EC\u8EAB\u4F53\u90E8\u4F4D","Exclude body parts":"\u6392\u9664\u8EAB\u4F53\u90E8\u4F4D",Gagging:"\u5835\u5634","Antigarble anti-cheat strength":"\u53CD\u5835\u5634\u53CD\u4F5C\u5F0A\u5F3A\u5EA6","Understand: Yes":"\u7406\u89E3: \u662F","Understand gagspeak: No":"\u7406\u89E3\u5835\u5634\u8BF4\u8BDD: \u5426","Understand gagspeak: Yes":"\u7406\u89E3\u5835\u5634\u8BF4\u8BDD: \u662F","Having recovered your glasses you can see again!":"\u627E\u56DE\u4E86\u4F60\u7684\u773C\u955C\uFF0C\u4F60\u53EF\u4EE5\u770B\u89C1\u4E86\uFF01","Having lost your glasses your eyesight is impaired!":"\u5931\u53BB\u4E86\u4F60\u7684\u773C\u955C\uFF0C\u4F60\u7684\u89C6\u529B\u53D7\u635F\u4E86\uFF01","([WCE] Force them to become a Club Slave.)":"([WCE] \u5F3A\u5236\u4ED6\u4EEC\u6210\u4E3A\u4FF1\u4E50\u90E8\u5974\u96B6\u3002)","(She will become a Club Slave for the next hour.)":"(\u5979\u5C06\u6210\u4E3A\u4FF1\u4E50\u90E8\u5974\u96B6\uFF0C\u6301\u7EED\u4E00\u4E2A\u5C0F\u65F6\u3002)","Search for a friend":"\u641C\u7D22\u597D\u53CB","Sending beeps is currently restricted by BCX rules":"\u53D1\u9001beep\u76EE\u524D\u53D7\u5230BCX\u89C4\u5219\u7684\u9650\u5236",Online:"\u5728\u7EBF",Offline:"\u79BB\u7EBF","Instant Messenger (Disabled by BCX)":"\u5373\u65F6\u901A\u8BAF\u5668 (\u88ABBCX\u7981\u7528)","Instant Messenger":"\u5373\u65F6\u901A\u8BAF\u5668","WCE Changelog":"WCE\u66F4\u65B0\u65E5\u5FD7","Trust this session":"\u4FE1\u4EFB\u6B64\u4F1A\u8BDD","(embed)":"(\u5D4C\u5165)","(This origin is trusted by authors of WCE)":"(\u6B64\u6765\u6E90\u5DF2\u88ABWCE\u4F5C\u8005\u4FE1\u4EFB)","Deny for session":"\u62D2\u7EDD\u6B64\u4F1A\u8BDD","Allow for session":"\u5141\u8BB8\u6B64\u4F1A\u8BDD",OnlineChat:"\u5728\u7EBF\u804A\u5929","Scans for connected buttplug.io toys":"\u626B\u63CF\u5DF2\u8FDE\u63A5\u7684buttplug.io\u73A9\u5177","buttplug.io is not connected":"buttplug.io\u672A\u8FDE\u63A5","Scanning stopped":"\u626B\u63CF\u505C\u6B62","Scanning for toys":"\u626B\u63CF\u73A9\u5177","Last seen: ":"\u6700\u540E\u5728\u7EBF: ","No profile found":"\u672A\u627E\u5230\u4E2A\u4EBA\u8D44\u6599",Open:"\u6253\u5F00","Saved Profiles":"\u5DF2\u4FDD\u5B58\u7684\u4E2A\u4EBA\u8D44\u6599","Personal notes (only you can read these):":"\u4E2A\u4EBA\u7B14\u8BB0 (\u53EA\u6709\u4F60\u53EF\u4EE5\u8BFB\u5230):","[WCE] Notes":"[WCE] \u7B14\u8BB0","Toggle Editing Mode":"\u5207\u6362\u7F16\u8F91\u6A21\u5F0F","Paste the craft here":"\u5728\u8FD9\u91CC\u7C98\u8D34\u5236\u4F5C\u7269\u54C1","Copy the craft here":"\u5728\u8FD9\u91CC\u590D\u5236\u5236\u4F5C\u7269\u54C1",Import:"\u5BFC\u5165",Export:"\u5BFC\u51FA","Description:":"\u63CF\u8FF0:","Animation Engine":"\u52A8\u753B\u5F15\u64CE","Show numeric arousal meter":"\u663E\u793A\u6B32\u671B\u6761\u6570\u503C","Show friends going offline too":"\u663E\u793A\u670B\u53CB\u79BB\u7EBF\u901A\u77E5","Show friend presence notifications in chat, when possible":"\u5728\u804A\u5929\u5BA4\u91CC\u663E\u793A\u597D\u53CB\u5728\u7EBF\u901A\u77E5","Show sent messages while waiting for server":"\u5728\u7B49\u5F85\u670D\u52A1\u5668\u65F6\u663E\u793A\u5DF2\u53D1\u9001\u7684\u6D88\u606F","Show whisper button on chat messages (requires refresh)":"\u5728\u804A\u5929\u6D88\u606F\u4E0A\u663E\u793A\u6084\u6084\u8BDD\u6309\u94AE \uFF08\u9700\u8981\u5237\u65B0\u7F51\u9875)","Rich online profile":"\u4E30\u5BCC\u7684\u5728\u7EBF\u4E2A\u4EBA\u8D44\u6599","Allow IMs to bypass BCX beep restrictions":"\u5141\u8BB8\u5373\u65F6\u901A\u8BAF\u7ED5\u8FC7BCX beep\u9650\u5236","Hide the hidden items icon":"\u4E0D\u663E\u793A\u9690\u85CF\u7684\u7269\u54C1\u56FE\u6807","Enable anti-cheat":"\u542F\u7528\u53CD\u4F5C\u5F0A","Blacklist detected cheaters automatically":"\u81EA\u52A8\u5C06\u68C0\u6D4B\u5230\u7684\u4F5C\u5F0A\u8005\u52A0\u5165\u9ED1\u540D\u5355","Enable uwall anti-cheat":"\u542F\u7528uwall\u53CD\u4F5C\u5F0A","Prompt before loading content from a 3rd party domain":"\u5728\u52A0\u8F7D\u7B2C\u4E09\u65B9\u57DF\u540D\u7684\u5185\u5BB9\u524D\u63D0\u793A","Share Addons":"\u5206\u4EAB\u63D2\u4EF6\u8BBE\u7F6E","Buttplug Devices":"Buttplug\u8BBE\u5907"}})[TranslationLanguage]?.[e]??e;for(const[n,a]of Object.entries(t))for(;r.includes(n);)r=r.replace(n,a);return r}async function $t(){if(Se?.getRuleState("block_club_slave_work")?.isEnforced){Te(h("BCX rules forbid $PlayerName from becoming a Club Slave.",{$PlayerName:CharacterNickname(Player)}));return}if(Te(h("$PlayerName gets grabbed by two maids and escorted to management to serve as a Club Slave.",{$PlayerName:CharacterNickname(Player)})),!ChatRoomData){se("ChatRoomData is null in bceStartClubSlave. Was it called outside a chat room?");return}const e=ChatRoomData.Name;if(ChatRoomClearAllElements(),ServerSend("ChatRoomLeave",""),ChatRoomLeashPlayer=null,CommonSetScreen("Room","Management"),await _(()=>!!ManagementMistress),!ManagementMistress)throw new Error("ManagementMistress is missing");PoseSetActive(Player,"Kneel",!1),ManagementMistress.Stage="320",ManagementMistress.CurrentDialog=h("(You get grabbed by a pair of maids and brought to management.) Your owner wants you to be a Club Slave. Now strip."),CharacterSetCurrent(ManagementMistress),await _(()=>CurrentScreen!=="Management"||!CurrentCharacter),Ze(e)}function Ze(e){ChatRoomJoinLeash=e,ChatRoomCharacter=[],DialogLeave(),ChatRoomClearAllElements(),CurrentScreen==="ChatRoom"&&ServerSend("ChatRoomLeave",""),e?ChatRoomStart("X","",null,null,"Introduction",BackgroundsTagList):(ChatRoomSetLastChatRoom(null),CommonSetScreen("Room","MainHall"))}async function Gt(){async function e(){await _(()=>!!CommonCSVCache["Screens/Online/ChatRoom/Dialog_Online.csv"]&&CommonCSVCache["Screens/Online/ChatRoom/Dialog_Online.csv"].length>150);const a=[["160","100",h("([WCE] Force them to become a Club Slave.)"),h("(She will become a Club Slave for the next hour.)"),"bceSendToClubSlavery()","bceCanSendToClubSlavery()"],["160","160",h("([WCE] Force them to become a Club Slave.)"),h("(Requires both to use compatible versions of WCE and the target to not already be a club slave.)"),"","!bceCanSendToClubSlavery()"]],s=CommonCSVCache["Screens/Online/ChatRoom/Dialog_Online.csv"].findIndex(o=>o[0]==="160")+1;CommonCSVCache["Screens/Online/ChatRoom/Dialog_Online.csv"].splice(s,0,...a);function l(o){!o.Dialog||o.Dialog.some(i=>i.FBC)||o.Dialog.splice(s,0,...a.map(i=>({Stage:i[0],NextStage:i[1],Option:i[2],Result:i[3],Function:i[4]===""?null:`ChatRoom${i[4]}`,Prerequisite:i[5],Group:null,Trait:null,FBC:!0})))}for(const o of ChatRoomCharacter.filter(i=>!i.IsPlayer()&&i.IsOnline()))l(o);g.hookFunction("CharacterBuildDialog",b.AddBehaviour,(o,i)=>{const u=i(o),[d]=o;return ue(d)&&d.IsOnline()&&l(d),u})}const t=e();function r(){const a={Type:Ne,Content:qe,Sender:Player.MemberNumber,Dictionary:[{message:{type:Pe.Activity,version:ve,activity:"ClubSlavery"}}]};ServerSend("ChatRoomChat",a),DialogLeave()}function n(){const a=CurrentCharacter;return a?a.BCECapabilities?.includes("clubslave")&&!a.Appearance.some(s=>s.Asset.Name==="ClubSlaveCollar"):!1}globalThis.bceGotoRoom=Ze,globalThis.ChatRoombceSendToClubSlavery=r,globalThis.ChatRoombceCanSendToClubSlavery=n,await t}function we(e=null,t=!1){if(!Qt()||!ServerIsConnected||!ServerPlayerIsInChatRoom())return;const r=["clubslave","layeringHide"];c.preventLayeringByOthers&&r.push("preventLayeringByOthers");const n={Type:Ne,Content:qe,Sender:Player.MemberNumber,Dictionary:[]},a={message:{type:Pe.Hello,version:ve,alternateArousal:!!c.alternateArousal,replyRequested:t,capabilities:r}};e&&(n.Target=e),c.alternateArousal&&(a.message.progress=Player.BCEArousalProgress||Player.ArousalSettings?.Progress||0,a.message.enjoyment=Player.BCEEnjoyment||1),c.shareAddons&&(a.message.otherAddons=bcModSdk.getModsInfo()),n.Dictionary.push(a),ServerSend("ChatRoomChat",n)}async function Ht(){await _(()=>ServerSocket&&ServerIsConnected);function e(n){let a={};return Array.isArray(n.Dictionary)?a=n.Dictionary?.find(s=>s.message)?.message||a:a=n.Dictionary?.message||a,a}function t(n,a,s=!1){if(f("Processing BCE message",n,a,s?"(deferred)":""),!n?.ArousalSettings&&!s){K("No arousal settings found for",n,"; deferring execution to microtask."),queueMicrotask(()=>t(n,a,!0));return}switch(n?.ArousalSettings||K("No arousal settings found for",n),a.type){case Pe.Hello:r(n,a);break;case Pe.ArousalSync:n.BCEArousal=a.alternateArousal||!1,n.BCEArousalProgress=a.progress||0,n.BCEEnjoyment=a.enjoyment||1;break;case Pe.Activity:n.MemberNumber===Player.Ownership?.MemberNumber&&!Player.Appearance.some(l=>l.Asset.Name==="ClubSlaveCollar")&&$t();break}}function r(n,a){n.FBC=a.version??"0.0",n.BCEArousal=a.alternateArousal||!1,n.BCEArousalProgress=a.progress||n.ArousalSettings?.Progress||0,n.BCEEnjoyment=a.enjoyment||1,n.BCECapabilities=a.capabilities??[],a.replyRequested&&we(n.MemberNumber),n.FBCOtherAddons=a.otherAddons}pe("ChatRoomMessage",n=>{if(n.Type===Ne&&n.Content==="BCEMsg"){const a=Character.find(l=>l.MemberNumber===n.Sender);if(!a)return;const s=e(n);t(a,s)}}),pe("ChatRoomSyncMemberJoin",n=>{n.SourceMemberNumber!==Player.MemberNumber&&we(n.SourceMemberNumber)}),pe("ChatRoomSync",()=>{we()})}const Re=[];function Ee(e,t){return Re.push({cb:e,intval:t,lastTime:performance.now()}),()=>{Re.splice(Re.findIndex(r=>r.cb===e),1)}}g.hookFunction("GameRun",b.Top,(e,t)=>{if(document.hidden)return t(e);const r=performance.now();return Re.forEach(n=>{r-n.lastTime>n.intval&&(n.lastTime=r,n.cb())}),t(e)}),g.hookFunction("GameRunBackground",b.Top,(e,t)=>{if(!document.hidden)return t(e);const r=performance.now();return Re.forEach(n=>{r-n.lastTime>n.intval&&(n.lastTime=r,n.cb())}),t(e)});function Ge(e,t){g.callOriginal("ServerAccountBeep",[{MemberNumber:Player.MemberNumber||-1,BeepType:"",MemberName:"WCE",ChatRoomName:e,Private:!0,Message:t,ChatRoomSpace:""}])}const Z={deviceSettings:new Map};async function Ut(){if(!c.toySync)return;const{ButtplugClient:e,ButtplugBrowserWebsocketClientConnector:t}=await import("./buttplug.js");ye("Loaded Buttplug.io");const r=new e("WCE Toy Sync");r.addListener("deviceadded",s=>{f("Device connected",s),W(h("Vibrator connected: $DeviceName",{$DeviceName:s.name}));const l=Z.deviceSettings.get(s.name);l&&delete l.LastIntensity}),r.addListener("deviceremoved",s=>{f("Device disconnected",s),W(h("Vibrator disconnected: $DeviceName",{$DeviceName:s.name}))}),r.addListener("scanningfinished",s=>{f("Scanning finished",s)});const n=new t(c.toySyncAddress||"ws://127.0.0.1:12345");try{await r.connect(n),ye("Connected buttplug.io")}catch(s){FUSAM.modals.openAsync({prompt:h("buttplug.io is enabled, but server could not be contacted at $toySyncAddress. Is Intiface Desktop running? Is another client connected to it?",{$toySyncAddress:c.toySyncAddress}),buttons:{submit:"OK"}}),se("buttplug.io could not connect to server",s);return}Z.client=r;const a=Ee(()=>{if(!r.connected){a();return}for(const s of r.devices.filter(l=>l.vibrateAttributes.length>0)){const l=Z.deviceSettings?.get(s.name);if(!l)continue;const o=l.SlotName,i=Player.Appearance.find(u=>u.Asset.Group.Name===o)?.Property?.Intensity;if(l.LastIntensity!==i)if(l.LastIntensity=i,typeof i!="number"||i<0)s.vibrate(0);else switch(i){case 0:s.vibrate(.1),f(s.name,o,"intensity 0.1");break;case 1:s.vibrate(.4),f(s.name,o,"intensity 0.4");break;case 2:s.vibrate(.75),f(s.name,o,"intensity 0.75");break;case 3:s.vibrate(1),f(s.name,o,"intensity 1");break;default:K("Invalid intensity in ",o,":",i);break}}},3e3);CommandCombine([{Tag:"toybatteries",Description:h("Shows the battery status of all connected buttplug.io toys"),Action:()=>{if(!r.connected){W("buttplug.io is not connected");return}const s=r.devices.filter(l=>l.hasBattery);if(s.length===0){W("No battery devices connected");return}Promise.all(s.map(l=>l.battery())).then(l=>{for(let o=0;o<s.length;o++){const i=l[o]*100;W(`${s[o].name}: ${i}%`)}})}},{Tag:"toyscan",Description:h("Scans for connected buttplug.io toys"),Action:()=>{if(!r.connected){W(h("buttplug.io is not connected"));return}if(r.isScanning){r.stopScanning(),W(h("Scanning stopped"));return}r.startScanning(),W(h("Scanning for toys"))}}]),await r.startScanning()}let Ye,mt=!1;async function Vt(e){const{Dexie:t}=await import("./dexie.js"),r=new t("wce-local-wardrobe");r.version(1).stores({wardrobe:"id, appearance"}),Ye=r.table("wardrobe");const n=await Ye.toArray()||[];await _(()=>e.length===fe),e.push(...n.map(a=>gt(a.appearance)))}async function jt(e){await Ye.bulkPut(e.map((t,r)=>({id:r,appearance:t})))}function gt(e){return Array.isArray(e)?e.map(t=>{if(typeof t.Property?.Type=="string"&&!CommonIsObject(t.Property?.TypeRecord)){const r=AssetGet("Female3DCG",t.Group,t.Name);r&&(t.Property.TypeRecord=ExtendedItemTypeToRecord(r,t.Property.Type))}return t}):e}function _t(e){c.extendedWardrobe&&(WardrobeSize=fe,WardrobeFixLength());const t=Player.ExtensionSettings.FBCWardrobe||Player.OnlineSettings?.BCEWardrobe;if(t){Player.OnlineSettings?.BCEWardrobe&&(Player.ExtensionSettings.FBCWardrobe=t,ServerPlayerExtensionSettingsSync("FBCWardrobe"),ye("Migrated wardrobe from OnlineSettings to ExtensionSettings"),delete Player.OnlineSettings.BCEWardrobe);try{const r=ce(LZString.decompressFromUTF16(t));if(st(r)){for(let n=Ie;n<fe;n++){const a=n-Ie;if(a>=r.length)break;e[n]=gt(r[a])}mt=!0}}catch(r){se("Failed to load extended wardrobe",r),Ge("Wardrobe error",`Failed to load extended wardrobe.

Backup: ${t}`),ye("Backup wardrobe",t)}}return e}async function zt(){await _(()=>!!ServerSocket),g.hookFunction("CharacterCompressWardrobe",b.Top,([e],t)=>{if(st(e)){const r=e.slice(Ie,fe);if(r.length>0&&mt){Player.ExtensionSettings.FBCWardrobe=LZString.compressToUTF16(JSON.stringify(r));const n=e.slice(fe);n.length>0&&jt(n),e=e.slice(0,Ie),ServerPlayerExtensionSettingsSync("FBCWardrobe")}}return t([e])}),g.hookFunction("WardrobeLoadCharacterNames",b.ModifyBehaviourMedium,(e,t)=>{if(!c.localWardrobe)return t(e);Player.WardrobeCharacterNames||(Player.WardrobeCharacterNames=[]);let r=!1;for(;Player.WardrobeCharacterNames.length<=WardrobeSize;)Player.WardrobeCharacterNames.length<fe?(Player.WardrobeCharacterNames.push(Player.Name),r=!0):Player.WardrobeCharacterNames.push("Local");return r&&ServerAccountUpdate.QueueData({WardrobeCharacterNames:Player.WardrobeCharacterNames.slice(0,fe)}),null})}const me=new Map;function Kt(){const e=["https://fs.kinkop.eu","https://i.imgur.com"];let t=!1;function r(n,a=null){t||(t=!0,FUSAM.modals.open({prompt:h(`Do you want to allow 3rd party ${a??"content"} to be loaded from $origin? $trusted`,{$origin:n,$trusted:e.includes(n)?h("(This origin is trusted by authors of WCE)"):""}),callback:s=>{t=!1,s==="submit"?me.set(n,"allowed"):s==="cancel"&&me.set(n,"denied")},buttons:{cancel:h("Deny for session"),submit:h("Allow for session")}}))}g.hookFunction("ChatAdminRoomCustomizationProcess",b.OverrideBehaviour,(n,a)=>{if(!c.customContentDomainCheck)return a(n);try{const[{ImageURL:s,MusicURL:l}]=n,o=s&&new URL(s).origin,i=l&&new URL(l).origin;if(o&&!me.has(o)?r(o,"image"):i&&!me.has(i)&&r(i,"music"),(!s||me.get(o)==="allowed")&&(!l||me.get(i)==="allowed"))return a(n)}catch{}return null}),g.hookFunction("ChatAdminRoomCustomizationClick",b.Observe,(n,a)=>{for(const s of[ElementValue("InputImageURL").trim(),ElementValue("InputMusicURL").trim()])try{const l=new URL(s);me.set(l.origin,"allowed")}catch{}return a(n)})}const yt="\\uf130\\u005d",We={Image:"img",None:"",Untrusted:"none-img"};function ft(e){try{const t=new URL(e);return["http:","https:"].includes(t.protocol)?t:!1}catch{return!1}}const bt=["..","--"],Ct=["...","~","~..","~~","..~"],Et=["ah","aah","mnn","nn","mnh","mngh","haa","nng","mnng"];function At(e,t){if(!e?.length)return{results:[e],stutter:!1};function r(p){return/^\p{L}/u.test(p)?`${p.substring(0,/[\uD800-\uDFFF]/u.test(p[0])?2:1)}-${p}`:p}const n=Math.max(0,...Player.Appearance.filter(p=>(p.Property?.Intensity??-1)>-1).map(p=>p.Property?.Intensity??0)),a=Player.ArousalSettings?.Progress??0,s=n*5,l=Math.max(0,a-10+s)*.5/100,o=Math.max(0,a/2-20+s*2)*.5/100;let i=!1;const u=Math.random();for(let p=Math.min(4,Math.max(1,n));p>=1;p--)(u<l/p||p===1&&t&&l>0)&&(e=r(e),i=!0);const d=[e];if(n>0&&Math.random()<o){const p=bt[Math.floor(Math.random()*bt.length)],k=Et[Math.floor(Math.random()*Et.length)],P=Ct[Math.floor(Math.random()*Ct.length)];d.push(" ",`${p}${h(k)}${P}`),i=!0}return{results:d,stutter:i}}function qt(e){const t=["cdn.discordapp.com","media.discordapp.com","i.imgur.com","tenor.com","c.tenor.com","media.tenor.com","i.redd.it","puu.sh","fs.kinkop.eu"].includes(e.host)||me.get(e.origin)==="allowed";return/\/[^/]+\.(png|jpe?g|webp|gif)$/ui.test(e.pathname)?t?We.Image:We.Untrusted:We.None}function Oe(e,t){const r=[];let n="";for(const a of e.childNodes){if(a.nodeType!==Node.TEXT_NODE){r.push(a);continue}const s=a.textContent??"",l=[s];n+=s;for(let o=0;o<l.length;o++){const i=l[o].search(/[\s\r\n]/u);if(i>=1)l.splice(o+1,0,l[o].substring(i)),l[o]=l[o].substring(0,i);else if(i===0){l.splice(o+1,0,l[o].substring(1)),[l[o]]=l[o],r.push(document.createTextNode(l[o]));continue}const u=ft(l[o].replace(/(^\(+|\)+$)/gu,""));if(u){let d=null;const p=document.createElement("a");r.push(p);const k=qt(u);switch(k){case We.Image:{const P=document.createElement("img");P.src=u.href,P.alt=u.href,P.onload=t,P.classList.add("bce-img"),p.classList.add("bce-img-link"),d=P}break;default:if(d=document.createTextNode(u.href),k!==We.None){const P=document.createElement("a");P.onclick=M=>{M.preventDefault(),M.stopPropagation();const w=M.target;FUSAM.modals.open({prompt:h("Do you want to add $origin to trusted origins?",{$origin:u.origin}),callback:v=>{if(v==="submit"){me.set(u.origin,"allowed");const m=w.parentElement;if(!m)throw new Error("clicked promptTrust has no parent");m.removeChild(w);const A=m.querySelector(".ChatMessageName");m.innerHTML="",A&&(m.appendChild(A),m.appendChild(document.createTextNode(" ")));const B=m.getAttribute("bce-original-text");if(!B)throw new Error("clicked promptTrust has no original text");m.appendChild(document.createTextNode(B)),Oe(e,t),f("updated trusted origins",me)}},buttons:{submit:h("Trust this session")}})},P.href="#",P.title=h("Trust this session"),P.textContent=h("(embed)"),r.push(document.createTextNode(" ")),r.push(P)}break}p.href=u.href,p.title=u.href,p.target="_blank",p.appendChild(d)}else if(/^#[0-9a-fA-F]{3}([0-9a-fA-F]{3})?$/u.test(l[o])){const d=document.createElement("span");d.classList.add("bce-color"),d.style.background=l[o],r.push(d),r.push(document.createTextNode(l[o]))}else r.push(document.createTextNode(l[o]))}}for(;e.firstChild;)e.removeChild(e.firstChild);for(const a of r)e.appendChild(a);e.setAttribute("bce-original-text",n)}function et(e){const t=document.createElement("div");t.setAttribute("class","ChatMessage bce-notification"),t.setAttribute("data-time",ChatRoomCurrentTime()),t.setAttribute("data-sender",Player.MemberNumber?.toString()),typeof e=="string"?t.appendChild(document.createTextNode(e)):Array.isArray(e)?t.append(...e):t.appendChild(e),ChatRoomAppendChat(t),Oe(t,()=>{ElementIsScrolledToEnd("TextAreaChatLog")&&ElementScrollToEnd("TextAreaChatLog")})}function Xt(){g.hookFunction("ChatRoomKeyDown",b.ModifyBehaviourMedium,([r],n)=>{const a=document.getElementById("InputChat");if(a&&document.activeElement===a){if(r.key==="Enter"&&!r.shiftKey){if(c.ctrlEnterOoc&&r.ctrlKey&&a.value.trim().length!==0){let s=a.value,l="";if(!s)return W("Nothing to send!"),!0;if(s.startsWith("/w ")){const o=s.split(" ");s=o.slice(2).join(" "),l=`${o.slice(0,2).join(" ")} `}else if(s.startsWith("/")&&!s.startsWith("//"))return W("Tried to OOC send a command. Use double // to confirm sending to chat."),!0;a.value=`${l}(${s.replace(/\)/g,yt)}`}return ChatRoomSendChat(),!0}if(r.metaKey&&(r.key==="ArrowUp"||r.key==="ArrowDown"))return ChatRoomScrollHistory(r.key==="ArrowUp"),!0}return n([r])}),g.hookFunction("ChatRoomMessageDisplay",b.ModifyBehaviourMedium,([r,n,a,s],l)=>l([r,n.replace(new RegExp(yt,"g"),")"),a,s])),g.hookFunction("SpeechTransformProcess",b.ModifyBehaviourMedium,([r,n,a,s],l)=>{const{msg:o,hasStuttered:i}=e(n||""),u=l([r,o,a.filter(d=>d!=="stutter"||!c.stutters),s]);return i&&u.effects.push("stutter"),u});function e(r){const n=[r];let a=!0,s=!1;const l=[];let o=!1;for(let i=0;i<n.length;i++){const u=n[i].search(/[\s\r\n]/u);if(u>=1)n.splice(i+1,0,n[i].substring(u)),n[i]=n[i].substring(0,u);else if(u===0){n.splice(i+1,0,n[i].substring(1)),[n[i]]=n[i],l.push(n[i]);continue}const d=n[i].search(/[()]/u);if(d>0?(n.splice(i+1,0,n[i].substring(d+1)),n.splice(i+1,0,n[i].substring(d,d+1)),n[i]=n[i].substring(0,d)):d===0&&n[i].length>1&&(n.splice(i+1,0,n[i].substring(1)),[n[i]]=n[i]),n[i]==="("&&(s=!0),ft(n[i])&&!s)l.push("( "),l.push(n[i]),l.push(" )");else if(c.stutters&&!s){const{results:p,stutter:k}=At(n[i],a);o||=k,l.push(...p),a=!1}else l.push(n[i]);n[i]===")"&&(s=!1)}return{msg:l.join(""),hasStuttered:o}}function t(){if(CurrentScreen!=="ChatRoom"||!c.augmentChat)return;const r="TextAreaChatLog",n="data-bce-handled",a=document.querySelectorAll(`.ChatMessage:not([${n}=true])`);for(const s of a)if(s.setAttribute(n,"true"),(s.classList.contains("ChatMessageChat")||s.classList.contains("ChatMessageWhisper"))&&!s.classList.contains("bce-pending")){const l=ElementIsScrolledToEnd(r);Oe(s,()=>{l&&ElementScrollToEnd(r)}),l&&ElementScrollToEnd(r)}}Ee(t,500)}let tt;function Jt(){g.hookFunction("ChatRoomGenerateChatRoomChatMessage",b.Top,([o,i],u)=>{if(!c.antiGarble)return u([o,i]);const d=SpeechGetOOCRanges(i).pop();Player.ChatSettings.OOCAutoClose&&typeof d=="object"&&i.charAt(d.start+d.length-1)!==")"&&d.start+d.length===i.length&&d.length!==1&&(i+=")");let p={effects:[],text:i},k;if(o!=="Whisper"||c.antiGarbleWhisperLevel!=="off"){p=SpeechTransformProcess(Player,i,SpeechTransformSenderEffects);const M=SpeechTransformShouldBabyTalk(Player),w=SpeechTransformGagGarbleIntensity(Player),v=SpeechTransformStutterIntensity(Player);if(w>0||c[`antiGarble${o}BabyTalk`]==="remove"&&M||c[`antiGarble${o}Stutter`]==="remove"&&v>0){if(Player.RestrictionSettings?.NoSpeechGarble)k=i;else if(c[`antiGarble${o}Level`]!=="full"){if(k=i,c[`antiGarble${o}BabyTalk`]==="preserve"&&M&&(k=SpeechTransformBabyTalk(k)),["low","medium","high"].includes(c[`antiGarble${o}Level`])){const m=Math.min(w,{low:1,medium:3,high:5}[c[`antiGarble${o}Level`]]);k=SpeechTransformGagGarble(k,m)}c[`antiGarble${o}Stutter`]==="preserve"&&v>0&&(k=c.stutters?At(k,!0).results.join(""):SpeechTransformStutter(k,v))}}p.text===k&&(k=void 0)}const P=[{Effects:p.effects,Original:k}];return{Content:p.text,Type:o,Dictionary:P}});const e=ae.antiGarbleChatBabyTalk.options;function t(){if(this.disabled||this.getAttribute("aria-disabled")==="true")return;const o=this.parentElement.classList.contains("wce-whisper")?"antiGarbleWhisperBabyTalk":"antiGarbleChatBabyTalk",i=e.indexOf(c[o]);c[o]=e[(i+1)%e.length],a(this.id)}function r(){if(this.disabled||this.getAttribute("aria-disabled")==="true")return;const o=this.parentElement.classList.contains("wce-whisper")?"antiGarbleWhisperStutter":"antiGarbleChatStutter",i=e.indexOf(c[o]);c[o]=e[(i+1)%e.length],a(this.id)}function n(){const o=this.parentElement.parentElement.classList.contains("wce-whisper")?"antiGarbleWhisperLevel":"antiGarbleChatLevel";c[o]=this.value,a()}function a(o){const i={"wce-chat-baby-talk":{state:"antiGarbleChatBabyTalk",whisperState:"antiGarbleWhisperBabyTalk"},"wce-chat-stutters":{state:"antiGarbleChatStutter",whisperState:"antiGarbleWhisperStutter"}},u=document.getElementById("chat-room-buttons").classList.contains("wce-whisper"),d=document.getElementById("wce-chat-garble");if(!o){const P=document.getElementById(d?.getAttribute("aria-describedby"));if(d&&P){const M=u?"antiGarbleWhisperLevel":"antiGarbleChatLevel";d.value=c[M],d.dataset.state=c[M],P.innerText=`${u?"Whisper":"Chat"} garble level: ${c[M]}`}}const p=["full","off"].includes(d?.value),k=o?[[o,i[o]]]:Object.entries(i);for(const[P,{state:M,whisperState:w}]of k){const v=document.getElementById(P),m=document.getElementById(v?.getAttribute("aria-describedby"));if(v&&m){const A=u?w:M;v.dataset.state=c[A],m.innerText=`${u?"Whisper":"Chat"} ${P==="wce-chat-stutters"?"stutters":"baby talk"}: ${c[A]}`,v.setAttribute("aria-disabled",p)}}}function s(o){const i=document.getElementById("chat-room-buttons");i&&(o&&!i.classList.contains("wce-whisper")?(i.classList.add("wce-whisper"),a()):!o&&i.classList.contains("wce-whisper")&&(i.classList.remove("wce-whisper"),a()))}tt=function(o){const i=o?.querySelector("#chat-room-buttons");i&&!i.querySelector(".wce-chat-room-button")&&(ElementMenu.PrependItem(i,ElementCreate({tag:"div",style:{display:"none"},classList:["wce-chat-room-select-div","wce-chat-room-button"],children:[{tag:"label",attributes:{id:"wce-chat-garble-label",for:"wce-chat-garble"}},{tag:"select",attributes:{id:"wce-chat-garble","aria-describedby":"wce-chat-garble-tooltip"},classList:["wce-chat-room-select"],eventListeners:{change:n},children:ae.antiGarbleWhisperLevel.options.map(u=>({tag:"option",attributes:{value:u},children:[u]}))},{tag:"div",attributes:{id:"wce-chat-garble-tooltip",role:"tooltip"},classList:["button-tooltip","button-tooltip-left"],children:[]}]})),ElementMenu.AppendButton(i,ElementButton.Create("wce-chat-baby-talk",t,{noStyling:!0},{button:{classList:["chat-room-button","wce-chat-room-button"],style:{display:"none"}}})),ElementMenu.AppendButton(i,ElementButton.Create("wce-chat-stutters",r,{noStyling:!0},{button:{classList:["chat-room-button","wce-chat-room-button"],style:{display:"none"}}})),a())};let l=!1;g.hookFunction("ChatRoomCreateElement",b.ModifyBehaviourHigh,(o,i)=>{if(!c.antiGarbleChatOptions)return i(o);if(!l){const d=document.getElementById("InputChat"),p=document.getElementById("chat-room-buttons-collapse");d&&p&&(d.addEventListener("input",function(){const k=this.value.startsWith("/w ")||this.value.startsWith("/whisper ");s(k)}),p.addEventListener("click",k=>{ChatRoomChatInputChangeHandler.call(d,k)}),l=!0)}const u=i(o);return tt(u),u}),g.hookFunction("ChatRoomSetTarget",b.ModifyBehaviourHigh,([o,...i],u)=>{const d=Number.isInteger(o)&&o!==-1;return s(d),u([o,...i])}),ChatRoomRegisterMessageHandler({Description:"show OriginalMsg while deafened",Priority:90,Callback:(o,i,u,d)=>(o.Type==="Chat"&&c.antiDeaf&&Player.GetDeafLevel()>0&&!d.OriginalMsg&&(d.OriginalMsg=u),!1)}),CurrentScreen==="ChatRoom"&&ChatRoomResize(!1)}let c={},vt=!1;const ae={animationEngine:{label:"Animation Engine",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{e&&Player.ArousalSettings&&(Player.ArousalSettings.AffectExpression=!1),e||(c.expressions=!1,c.activityExpressions=!1),f("animationEngine",e)},category:"activities",description:"Enables the animation engine. This will replace the game's expression and pose system."},expressions:{label:"Automatic Arousal Expressions (Replaces Vanilla)",type:"checkbox",value:!1,disabled:()=>!c.animationEngine,sideEffects:e=>{f("expressions",e)},category:"activities",description:"Automatically express arousal when performing an activity (requires Animation Engine)."},activityExpressions:{label:"Activity Expressions",type:"checkbox",value:!1,disabled:()=>!c.animationEngine,sideEffects:e=>{f("activityExpressions",e)},category:"activities",description:"Automatically express reactions to certain activities (requires Animation Engine)."},alternateArousal:{label:"Alternate Arousal (Replaces Vanilla, requires hybrid/locked arousal meter)",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{we(),Player.BCEArousal=!!e,Player.BCEArousalProgress=Math.min(Le,Player.ArousalSettings?.Progress??0),f("alternateArousal",e)},category:"activities",description:"More intense activities will affect arousal faster."},stutters:{label:"Alternative speech stutter",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("stutters",e)},category:"activities",description:"More stuttering at high arousal, moans between words with vibrators."},numericArousalMeter:{label:"Show numeric arousal meter",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("numericArousalMeter",e)},category:"activities",description:"Shows the numeric value of arousal meters when expanded."},layeringHide:{label:"[Beta] Allow configuring layer hiding in layering menu",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("layeringHide",e)},category:"appearance",description:"Allows you to configure which lower layers an item should hide or not (changes only visible to other WCE players)."},copyColor:{label:"Enable option to copy color to all item's of the same type",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("copyColor",e)},category:"appearance",description:"Enable option to copy color to all item's of the same type."},extendedWardrobe:{label:"Extended wardrobe slots (96)",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("extendedWardrobe",e),e?Player.Wardrobe?(WardrobeSize=fe,_t(Player.Wardrobe),CharacterCompressWardrobe(Player.Wardrobe)):K("Player.Wardrobe not found, skipping wardrobe extension"):(c.localWardrobe=!1,WardrobeSize=Ie,WardrobeFixLength(),CharacterAppearanceWardrobeOffset=0)},category:"appearance",description:"Increase the amount of wardrobe slots to save more outfits."},localWardrobe:{label:"Local Wardrobe (+288)",type:"checkbox",value:!1,disabled:()=>!c.extendedWardrobe,sideEffects:e=>{f("localWardrobe",e),e?Player.Wardrobe?(WardrobeSize=Nt,Vt(Player.Wardrobe),CharacterCompressWardrobe(Player.Wardrobe)):K("Player.Wardrobe not found, skipping wardrobe extension"):c.extendedWardrobe&&(WardrobeSize=fe,WardrobeFixLength(),CharacterAppearanceWardrobeOffset=0)},category:"appearance",description:"Enables the Local Wardrobe - save 288 additional outfits on your device (not synced between devices, but shared between alts on the same device)."},privateWardrobe:{label:"Replace wardrobe list with character previews",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("privateWardrobe",e)},category:"appearance",description:"Allows you to preview all saved outfits at a glance, no more having to remember names."},confirmWardrobeSave:{label:"Confirm overriding wardrobe outfits",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("confirmWardrobeSave",e)},category:"appearance",description:"When saving over an already existing wardrobe outfit you'll ask for confirmation, preventing accidentally overwriting outfits."},automateCacheClear:{label:"Clear Drawing Cache Hourly",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("automateCacheClear",e)},category:"performance",description:"Automatically clears the drawing cache every hour, preventing memory usage from growing out of control during long play sessions."},manualCacheClear:{label:"Adds a clear / reload drawing cache button",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("manualCacheClear",e)},category:"performance",description:"Adds a button to the chat room menu to clear and reload the drawing cache of all characters, helping to fix buged / non-loaded assets."},instantMessenger:{label:"Instant messenger",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("instantMessenger",e)},category:"chat",description:"Allows you to send messages to other players without having to open the friends list, with enhancements."},augmentChat:{label:"Chat Links and Embeds",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("augmentChat",e)},category:"chat",description:"Adds clickable links and image embeds from trusted domains only (e.g. imgur) to chat messages."},ctrlEnterOoc:{label:"Use Ctrl+Enter to OOC",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("ctrlEnterOoc",e)},category:"chat",description:"Allows you to use Ctrl+Enter to send OOC messages."},whisperInput:{label:"Use italics for input when whispering",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("whisperInput",e)},category:"chat",description:"Changes the input field to italics when you're in whisper mode to make it more obvious."},chatColors:{label:"Improve colors for readability",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{e?document.body.classList.add(Ce):document.body.classList.remove(Ce),f("chatColors",e)},category:"chat",description:"Improves contrast between the colors used for chat messages to comply with web accessibility standards."},friendPresenceNotifications:{label:"Show friend presence notifications",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("friendPresenceNotifications",e)},category:"chat",description:"Enables friend presence tracking and shows a notification when a friend logs in."},friendOfflineNotifications:{label:"Show friends going offline too",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("friendOfflineNotifications",e)},category:"chat",description:"Shows a notification when a friend logs out. (Requires friend presence)"},friendNotificationsInChat:{label:"Show friend presence notifications in chat, when possible",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("friendNotificationsInChat",e)},category:"chat",description:"Shows friend presence notifications in chat, when possible. (Requires friend presence)"},pastProfiles:{label:"Save & browse seen profiles (requires refresh)",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("pastProfiles",e)},category:"chat",description:"Saves the profiles for everyone you've seen and allows you to browse them using /profiles in chatrooms."},pendingMessages:{label:"Show sent messages while waiting for server",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("showSentMessages",e)},category:"chat",description:"Shows messages you've sent while waiting for the server to respond, confirming you have sent the message and the server is just being slow."},richOnlineProfile:{label:"Rich online profile",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("richOnlineProfile",e)},category:"chat",description:"Changes the online profile to support clickable links and embedded images."},whisperTargetFixes:{label:"Improved whisper target handling",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("whisperTargetFixes",e)},category:"chat",description:"Automatically reset whisper target if they leave the room for more than one minute and after the first invalid whisper target warning message."},antiGarble:{label:"Anti Garble",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:(e,t)=>{e?t||(c.antiGarbleChatOptions=!0,ae.antiGarbleChatOptions.sideEffects(!0,t),c.antiGarbleChatLevel="none",c.antiGarbleChatBabyTalk="remove",c.antiGarbleChatStutter="ignore",c.antiGarbleWhisperLevel="none",c.antiGarbleWhisperBabyTalk="remove",c.antiGarbleWhisperStutter="ignore"):(c.antiGarbleChatOptions=!1,ae.antiGarbleChatOptions.sideEffects(!1,t),c.antiGarbleChatLevel="full",c.antiGarbleChatBabyTalk="preserve",c.antiGarbleChatStutter="preserve",c.antiGarbleWhisperLevel="full",c.antiGarbleWhisperBabyTalk="preserve",c.antiGarbleWhisperStutter="preserve"),f("antiGarble",e)},category:"antigarble",description:"Enables the anti-garble system. Allowing you to send less garbled version of your messages together with the garbled one to others, who could read it in brackets."},antiGarbleChatOptions:{label:"Anti Garble chat options",type:"checkbox",value:!1,disabled:()=>!c.antiGarble,sideEffects:(e,t)=>{f("antiGarbleChatoptions",e),!t&&e?tt(document.getElementById("chat-room-div")):t||document.querySelectorAll(".wce-chat-room-button").forEach(r=>r.remove())},category:"antigarble",description:"Adds quick options for your anti-garble settings to the chat input menu."},antiGarbleChatLevel:{label:"Chat garble level:",type:"select",value:"none",options:["none","low","medium","high","full"],tooltips:["Chat garble level: none (send a fully ungarbled message to the recipient, shown in brackets)","Chat garble level: low (send a partly ungarbled message, which is only garbled up to the low garbel level 1)","Chat garble level: medium (send a partly ungarbled message, which is only garbled up to the medium garbel level 3)","Chat garble level: high (send a partly ungarbled message, which is only garbled up to the high garbel level 5)","Chat garble level: full (always only sends the full garbled message, no ungarbled message in brackets)"],disabled:()=>!c.antiGarble,sideEffects:e=>{f("antiGarbleChatLevel",e)},category:"antigarble",description:"Sends an ungarbled (or lower garbled up to the selected value) chat message together with the garbled messages, which is shown on the recipient side in brackets (defaults to full = no ungarbling)."},antiGarbleChatStutter:{label:"Chat stutters:",type:"select",value:"preserve",options:["remove","ignore","preserve"],tooltips:["Chat stutters: remove (always remove chat stutters, even if it is the only effect)","Chat stutters: ignore (remove chat stutters if ungarbling gag speech, but ignore it if it's the only effect)","Chat stutters: preserve (always preserve chat stutters in the ungarbled text in brackets)"],disabled:()=>!c.antiGarble||c.antiGarbleChatLevel==="full",sideEffects:e=>{f("antiGarbleChatoptions",e)},category:"antigarble",description:"Controls if stutters in chat messages are always removed, ignored (only removed if other ungarbling applied) or preserved."},antiGarbleChatBabyTalk:{label:"Chat baby talk:",type:"select",value:"preserve",options:["remove","ignore","preserve"],tooltips:["Chat baby talk: remove (always remove chat baby talk, even if it is the only effect)","Chat baby talk: ignore (remove chat baby talk if ungarbling gag speech, but ignore it if it's the only effect)","Chat baby talk: preserve (always preserve chat baby talk in the ungarbled text in brackets)"],disabled:()=>!c.antiGarble||c.antiGarbleChatLevel==="full",sideEffects:e=>{f("antiGarbleChatBabyTalk",e)},category:"antigarble",description:"Controls if baby talk in chat messages is always removed, ignored (only removed if other ungarbling applied) or preserved."},antiGarbleWhisperLevel:{label:"Whisper garble level:",type:"select",value:"none",options:["none","low","medium","high","full","off"],tooltips:["Whisper garble level: none (send a fully ungarbled whisper to the recipient, shown in brackets)","Whisper garble level: low (send a partly ungarbled whisper, which is only garbled up to the low garbel level 1)","Whisper garble level: medium (send a partly ungarbled whisper, which is only garbled up to the medium garbel level 3)","Whisper garble level: high (send a partly ungarbled whisper, which is only garbled up to the high garbel level 5)","Whisper garble level: full (always only sends the full garbled whisper, no ungarbled message in brackets)","Whisper garble level: off (don't garble whisper messages at all, normal message is ungarbled, no message in brackets)"],disabled:()=>!c.antiGarble,sideEffects:e=>{f("antiGarbleWhisperLevel",e)},category:"antigarble",description:"Sends an ungarbled (or lower garbled) whisper message together with the garbled messages, which is shown on the recipient side in brackets. (off = only sending the ungarbled messages as the original)."},antiGarbleWhisperStutter:{label:"Whispers stutters:",type:"select",value:"preserve",options:["remove","ignore","preserve"],tooltips:["Whispers stutters: remove (always remove whispers stutters, even if it is the only effect)","Whispers stutters: ignore (remove whispers stutters if ungarbling gag speech, but ignore it if it's the only effect)","Whispers stutters: preserve (always preserve whispers stutters in the ungarbled text in brackets)"],disabled:()=>!c.antiGarble||["off","full"].includes(c.antiGarbleWhisperLevel),sideEffects:e=>{f("antiGarbleWhisperStutter",e)},category:"antigarble",description:"Controls if stutters in whispers are always removed, ignored (only removed if other ungarbling applied) or preserved."},antiGarbleWhisperBabyTalk:{label:"Whispers baby talk:",type:"select",value:"preserve",options:["remove","ignore","preserve"],tooltips:["Whispers baby talk: remove (always remove whispers baby talk, even if it is the only effect)","Whispers baby talk: ignore (remove whispers baby talk if ungarbling gag speech, but ignore it if it's the only effect)","Whispers baby talk: preserve (always preserve whispers baby talk in the ungarbled text in brackets)"],disabled:()=>!c.antiGarble||["off","full"].includes(c.antiGarbleWhisperLevel),sideEffects:e=>{f("antiGarbleWhisperBabyTalk",e)},category:"antigarble",description:"Controls if baby talk in whispers is always removed, ignored (only removed if other ungarbling applied) or preserved."},lockpick:{label:"Reveal Lockpicking Order Based on Skill",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("lockpick",e)},category:"cheats",description:"Randomly reveals the order of some of the pins with higher lockpicking skill revealing more pins on average. Picking can still be impossible like other forms of struggling."},allowLayeringWhileBound:{label:"Allow layering menus while bound",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("allowLayeringWhileBound",e)},category:"cheats",description:"Allows you to open menus while bound, even if they're disabled in the settings."},autoStruggle:{label:"Make automatic progress while struggling",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("autoStruggle",e)},category:"cheats",description:"All three forms of struggling will be completed automatically in a realistic amount of time, if the restraint is possible to struggle out of."},allowIMBypassBCX:{label:"Allow IMs to bypass BCX beep restrictions",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("allowIMBypassBCX",e)},category:"cheats",description:"This setting is temporary until BCX supports a focus mode rule."},antiDeaf:{label:"Anti Deafen",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("antiDeaf",e)},category:"cheats",description:"Show original messages in brackets while deafened."},toySync:{label:"Enable buttplug.io (requires refresh)",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("toySync",e)},category:"buttplug",description:"Allows the game to control your real vibrators. For a list of supported vibrators see https://buttplug.io"},blindWithoutGlasses:{label:"Require glasses to see",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{e||ze("BlurLight"),f("blindWithoutGlasses",e)},category:"immersion",description:"You will be partially blinded while not wearing glasses."},leashAlways:{label:"Allow leashing without wearing a leashable item (requires leasher to have WCE too)",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("leashAlways",e),e?ut():ct()},category:"immersion",description:"Allows you to be leashed between rooms even when you are not wearing an item that counts as a leash to allow roleplaying being carried in arms."},hideHiddenItemsIcon:{label:"Hide the hidden items icon",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("hideHiddenItemsIcon",e)},category:"immersion",description:"You can choose to hide items (not on extreme difficulty). The game shows an icon on players that have hidden items. This option hides that icon."},itemAntiCheat:{label:"Enable anti-cheat",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("itemAntiCheat",e)},category:"immersion",description:"Prevents certain console cheats from impacting your character. Whitelisted actors are exempt from this."},antiCheatBlackList:{label:"Blacklist detected cheaters automatically",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("antiCheatBlackList",e)},category:"immersion",description:"Automatically blacklist detected cheaters. Whitelisted actors are exempt from this."},uwall:{label:"Enable uwall anti-cheat",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("uwall",e),Player?.OnlineSharedSettings&&typeof e=="boolean"?(Player.OnlineSharedSettings.Uwall=e,ServerAccountUpdate.QueueData({OnlineSharedSettings:Player.OnlineSharedSettings})):K("Player.OnlineSharedSettings not found, skipping uwall")},category:"immersion",description:"Prevents certain other addon cheats from impacting your character."},preventLayeringByOthers:{label:"Prevents other players from using layering on you",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:(e,t)=>{f("preventLayeringByOthers",e),t||we()},category:"immersion",description:"Prevents other WCE players to make Layering based changes to your character."},relogin:{label:"Automatic Relogin on Disconnect",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("relogin",e)},category:"misc",description:"Automatically re-enter your password after you disconnect from the game. For convenience or AFK. Requires the password for the current account to have been saved in the login screen. Passwords are saved in your browser's local storage in plain text."},ghostNewUsers:{label:"Automatically ghost+blocklist unnaturally new users",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("ghostNewUsers",e)},category:"misc",description:"Automatically ghost+blocklist unnaturally new users. This is useful for preventing malicious bots, but is not recommended to be enabled normally."},confirmLeave:{label:"Confirm leaving the game",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("confirmLeave",e)},category:"misc",description:"When you leave the game, you will be prompted to confirm your decision. This is useful for preventing accidentally closing the tab, but will cause you to reconnect."},discreetMode:{label:"Discreet mode (disable drawing)",type:"checkbox",value:!1,disabled:()=>!1,sideEffects:e=>{f("discreetMode",e),e&&(document.getElementById("favicon").href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9oFFAADATTAuQQAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAEklEQVQ4y2NgGAWjYBSMAggAAAQQAAGFP6pyAAAAAElFTkSuQmCC",document.title="OnlineChat")},category:"misc",description:"Disables drawing on the screen. This is useful for preventing accidental drawing."},customContentDomainCheck:{label:"Prompt before loading content from a 3rd party domain",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("customContentDomainCheck",e)},category:"misc",description:"Show a confirmation prompt before allowing content from a 3rd party domain to be loaded."},shareAddons:{label:"Share Addons",type:"checkbox",value:!0,disabled:()=>!1,sideEffects:e=>{f("shareAddons",e)},category:"misc",description:"Share a list of your installed addons with other WCE users in the room, visible via /versions chat command."},buttplugDevices:{label:"Buttplug Devices",type:"input",value:"",disabled:()=>!1,sideEffects:e=>{if(f("buttplugDevices",e),e!=="")try{if(!he(e))throw new Error("expected string for buttplugDevices");const t=ce(e);if(!Array.isArray(t))throw new Error("expected array for devices");for(const r of t)Z.deviceSettings.set(r.Name,r)}catch(t){se(t)}},category:"hidden",description:""},toySyncAddress:{label:"Intiface Address",type:"input",value:"ws://127.0.0.1:12345",disabled:()=>!1,sideEffects:e=>{f("toySyncAddress",e)},category:"hidden",description:""}};function Qt(){return vt}function St(){return`bce.settings.${Player?.AccountName}`}async function Zt(){await _(()=>!!Player?.AccountName);const e=St();if(f("loading settings"),Object.keys(c).length===0){let t=ce(localStorage.getItem(e));const r=ce(LZString.decompressFromBase64(Player.ExtensionSettings.FBC||(Player.OnlineSettings?.BCE??""))||null);r||(K("No online settings found"),f("onlineSettings",Player.OnlineSettings),f("extensionSettings",Player.ExtensionSettings)),Player.OnlineSettings?.BCE&&(Player.ExtensionSettings.FBC=Player.OnlineSettings.BCE,ServerPlayerExtensionSettingsSync("FBC"),ye("Migrated online settings to extension settings"),delete Player.OnlineSettings.BCE);const n=t?.version||0;if(r&&r.version>=n&&(ye("using online settings"),t=r),le(t)||(f("no settings",e),Ge("Welcome to WCE",`Welcome to Wholesome Club Extensions v${globalThis.FBC_VERSION}! As this is your first time using WCE on this account, you may want to check out the settings page for some options to customize your experience. You can find it in the game preferences. Enjoy!`),t={}),!le(t))throw new Error("failed to initialize settings");for(const[a]of Object.entries(ae))if(!(a in t)){if(a==="activityExpressions"&&"expressions"in t){t[a]=t.expressions;continue}t[a]=ae[a].value}(typeof t.version>"u"||t.version<dt)&&er(),t.version=dt,c=t}}function wt(){f("saving settings"),Z.deviceSettings.size>0&&(c.buttplugDevices=JSON.stringify(Array.from(Z.deviceSettings.values()))),localStorage.setItem(St(),JSON.stringify(c)),Player.ExtensionSettings.FBC=LZString.compressToBase64(JSON.stringify(c)),ServerPlayerExtensionSettingsSync("FBC"),f("saved settings",c)}function rt(e){return e in ae}function Yt(){f("handling settings side effects");for(const[e,t]of Object.entries(c))if(e!=="version"){if(!rt(e)){K("Deleting unknown setting",e),delete c[e];continue}ae[e].sideEffects(t,!0)}wt(),vt=!0}async function er(){await _(()=>!!Player?.AccountName),await je(5e3),Ge(h("WCE Changelog"),h("WCE has received significant updates since you last used it. See /wcechangelog in a chatroom.")),await _(()=>!!document.getElementById("TextAreaChatLog")),et(`Wholesome Club Extensions (WCE) changelog:
${Ke}`)}function tr(e){return rt(e)?c[e]:!1}function rr(e){switch(e.toLowerCase()){default:return{ActivityChatRoomArousalSync:"BFF3DED7",ActivitySetArousal:"3AE28123",ActivitySetArousalTimer:"1342AFE2",ActivityTimerProgress:"6CD388A7",AppearanceClick:"48B83523",AppearanceLoad:"4360C485",AppearanceRun:"8B7558CB",CharacterAppearanceBuildCanvas:"C05FE035",CharacterAppearanceMustHide:"9C34DF21",CharacterAppearanceVisible:"0740043C",CharacterAppearanceWardrobeLoad:"A5B63A03",CharacterBuildDialog:"85F79C6E",CharacterCompressWardrobe:"2A05ECD1",CharacterDelete:"57AA5D48",CharacterGetCurrent:"69F45A41",CharacterLoadCanvas:"EAB81BC4",CharacterLoadOnline:"407FEDDE",CharacterNickname:"A794EFF5",CharacterRefresh:"301DA9CF",CharacterSetCurrent:"F46573D8",CharacterSetFacialExpression:"EC032BEE",CharacterSetActivePose:"566A14D7",ChatAdminRoomCustomizationClick:"9D859B28",ChatAdminRoomCustomizationProcess:"AF01C65A",ChatRoomAppendChat:"12890378",ChatRoomCharacterUpdate:"DE2DC592",ChatRoomCharacterViewDraw:"732C91C9",ChatRoomCharacterViewIsActive:"CD8066FA",ChatRoomClearAllElements:"ECF65628",ChatRoomCurrentTime:"A462DD3A",ChatRoomDrawCharacterStatusIcons:"B5209E11",ChatRoomGenerateChatRoomChatMessage:"3BDE0884",ChatRoomHideElements:"D58ECB5C",ChatRoomHTMLEntities:"0A7ADB1D",ChatRoomKeyDown:"9F45A713",ChatRoomListManipulation:"75D28A8B",ChatRoomMapViewCharacterIsVisible:"286C447D",ChatRoomMapViewCharacterOnWhisperRange:"B0D08E96",ChatRoomMapViewIsActive:"D181020D",ChatRoomMenuBuild:"F76AEFC3",ChatRoomMenuClick:"3BC3C582",ChatRoomMenuDraw:"83275135",ChatRoomMessage:"E75ED29B",ChatRoomRegisterMessageHandler:"C432923A",ChatRoomSendChat:"ACB10CE5",ChatRoomStart:"9B822A9A",ChatRoomSyncMemberJoin:"2A9CB40B",CommandCombine:"80F9D4AF",CommandExecute:"D1DEB2AD",CommonClick:"1F6DF7CB",CommonColorIsValid:"390A2CE4",CommonSetScreen:"B674BE4D",CraftingClick:"083CC3CA",CraftingConvertSelectedToItem:"03E97498",CraftingRun:"CA7B4FE0",DialogCanUnlock:"A86B2558",DialogDrawItemMenu:"FCE556C2",DialogLeave:"C37553DC",DialogMenuButtonBuild:"3FDE2F94",DialogMenuButtonClick:"C1F5E0AF",DrawArousalMeter:"BB0755AF",DrawArousalThermometer:"7ED6D822",DrawBackNextButton:"7263249E",DrawButton:"B747DF6E",DrawCharacter:"B175AF5E",DrawCheckbox:"00FD87EB",DrawImageEx:"E01BE7E7",DrawImageResize:"D205975A",DrawItemPreview:"6A7A1E2A",DrawProcess:"9776CBC2",DrawText:"C1BF0F50",DrawTextFit:"F9A1B11E",ElementCreate:"A3E07B07",ElementCreateInput:"0755ED07",ElementCreateTextArea:"4E040819",ElementIsScrolledToEnd:"1CC4FE11",ElementPosition:"81836C4E",ElementScrollToEnd:"1AC45575",ElementValue:"4F26C62F",FriendListShowBeep:"5B91D5DA",GameRun:"337CB358",GLDrawResetCanvas:"81214642",InformationSheetRun:"5B5C7751",InterfaceTextGet:"66603471",InventoryGet:"E666F671","Layering.Load":"589C88CD","Layering._ResetClickListener":"5EDCC26F",LoginClick:"ADA7E2B7",LoginDoLogin:"D4000B03",LoginRun:"D1DB7A8A",LoginSetSubmitted:"C88F4A8E",LoginStatusReset:"18619F02",MouseIn:"CA8B839E",NotificationDrawFavicon:"AB88656B",NotificationRaise:"E8F29646",NotificationTitleUpdate:"0E92F3ED",OnlineGameAllowChange:"3779F42C",OnlineProfileClick:"521146DF",OnlineProfileUnload:"A8651F30",OnlineProfileLoad:"BE8B009B",OnlineProfileRun:"7F57EF9A",PoseSetActive:"22C02050",PreferenceExit:"27E40748",PreferenceInitPlayer:"B12FA731",PreferenceSubscreenArousalClick:"84F49886",PreferenceSubscreenArousalRun:"96A6157B",PreferenceSubscreenImmersionClick:"0EF82344",PreferenceSubscreenImmersionRun:"276FA30B",RelogRun:"10AF5A60",RelogExit:"2DFB2DAD",ServerAccountBeep:"37ED13F6",ServerAppearanceBundle:"4D069622",ServerAppearanceLoadFromBundle:"946537FD",ServerConnect:"845E50A6",ServerDisconnect:"198FF7E7",ServerInit:"B6CEF7F1",ServerOpenFriendList:"FA8D3CDE",ServerPlayerAppearanceSync:"A014E0B7",ServerPlayerExtensionSettingsSync:"1776666B",ServerSend:"ABE74E75",ServerSendQueueProcess:"BD4277AC",SkillGetWithRatio:"3EB4BC45",SpeechTransformBabyTalk:"C812EE0E",SpeechTransformGagGarble:"691A05BF",SpeechTransformGagGarbleIntensity:"F61ECBDA",SpeechTransformProcess:"666DDA2F",SpeechTransformShouldBabyTalk:"634BCD64",SpeechTransformStutter:"A930F55E",SpeechTransformStutterIntensity:"4754768A",StruggleDexterityProcess:"D185D348",StruggleFlexibilityCheck:"727CE05B",StruggleFlexibilityProcess:"1A0B96EF",StruggleLockPickDraw:"CCCCA4BE",StruggleMinigameHandleExpression:"1B3ABF55",StruggleMinigameStop:"FB05E8A9",StruggleStrengthProcess:"B1A1457D",TextGet:"4DDE5794",TextLoad:"0D535190",TimerInventoryRemove:"2588CA11",TimerProcess:"BFB7FFE2",TitleExit:"F13F533C",ValidationSanitizeProperties:"659F5965",WardrobeClick:"33405B1D",WardrobeExit:"12D14AE4",WardrobeFastLoad:"AAB9F25B",WardrobeFastSave:"D1E906FD",WardrobeFixLength:"CA3334C6",WardrobeLoad:"C343A4C7",WardrobeLoadCharacterNames:"F39DF5E3",WardrobeRun:"633B3570"}}}async function nr(){await _(()=>GameVersion!=="R0"&&typeof ServerIsConnected=="boolean"&&ServerIsConnected),ye("Checking function integrity with GameVersion",GameVersion);function e(t){return!!t&&typeof t=="object"&&!Array.isArray(t)}for(const[t,r]of Object.entries(rr(GameVersion)||{})){if(r==="SKIP")continue;let n=window;const a=t.split(".");for(let l=0;l<a.length-1;l++)n=n[a[l]],e(n)||K(`Expected Function ${t} not found; ${a.slice(0,l+1).join(".")} is not object`);if(n=n[a.pop()],typeof n!="function"){K(`Expected function ${t} is not a function.`);continue}const s=g.getOriginalHash(t);s!==r&&(K(`Function ${t} has been modified before WCE, potential incompatibility: ${s}`),Xe.push(t))}}const Dt="bce-input-warn";function or(){const e=`
  .bce-beep-link {
    text-decoration: none;
  }
  #TextAreaChatLog .bce-notification,
  #TextAreaChatLog .bce-notification {
    background-color: #D696FF;
    color: black;
  }
  #TextAreaChatLog[data-colortheme="dark"] .bce-notification,
  #TextAreaChatLog[data-colortheme="dark2"] .bce-notification {
    background-color: #481D64;
    color: white;
  }
  .bce-img-link {
    vertical-align: top;
  }
  .bce-img {
    max-height: 25rem;
    max-width: 90%;
    display: inline;
    border:1px solid red;
    padding: 0.1rem;
  }
  .bce-color {
    width: 0.8em;
    height: 0.8em;
    display: inline-block;
    vertical-align: middle;
    border: 0.1em solid black;
    margin-right: 0.1em;
  }
  .${Ce} .${pt}.${Dt} {
    background-color: #400000 !important;
  }
  .${Dt} {
    background-color: yellow !important;
  }
  #TextAreaChatLog a,
  .bce-message a {
    color: #003f91;
    cursor: pointer;
  }
  #TextAreaChatLog a:visited,
  .bce-message a {
    color: #380091;
  }
  .${Ce} div.ChatMessageWhisper,
  .${Ce} div.ChatMessageWhisper {
    color: #646464;
  }
  .${Ce} #TextAreaChatLog[data-colortheme="dark"] div.ChatMessageWhisper,
  .${Ce} #TextAreaChatLog[data-colortheme="dark2"] div.ChatMessageWhisper {
    color: #828282;
  }
  #TextAreaChatLog[data-colortheme="dark"] a,
  #TextAreaChatLog[data-colortheme="dark2"] a,
  .bce-message a {
    color: #a9ceff;
  }
  #TextAreaChatLog[data-colortheme="dark"] a:visited,
  #TextAreaChatLog[data-colortheme="dark2"] a:visited,
  .bce-message a {
    color: #3d91ff;
  }
  .${Rt} {
    font-style: italic;
  }
  .${Ce} .${pt} {
    background-color: #111;
    color: #eee;
    border-color: #333;
  }
  a.bce-button {
    text-decoration: none;
  }
  .bce-hidden {
    display: none !important;
  }
  .bce-false-hidden {
    position: absolute;
    border: 0;
    margin: 0;
    padding: 0;
    top: 0;
    left: 0;
    width: 0.1px;
    height: 0.1px;
    opacity: 0.01;
  }
  .bce-line-icon-wrapper {
    display: none;
    position: absolute;
    right: 1em;
  }
  .ChatMessage:hover .bce-line-icon-wrapper,
  .ChatMessage:focus .bce-line-icon-wrapper,
  .ChatMessage:focus-within .bce-line-icon-wrapper {
    display: inline;
  }
  .bce-line-icon {
    height: 1em;
    vertical-align: middle;
  }
  #bce-instant-messenger {
    display: flex;
    z-index: 100;
    position: fixed;
    width: 80%;
    height: 70%;
    top: 5%;
    left: 10%;
    padding: 0;
    margin: 0;
    flex-direction: row;
    background-color: #111;
    color: #eee;
    border: 0.2em solid white;
    resize: both;
    overflow: auto;
    max-width: 80%;
    max-height: 75%;
    min-width: 38%;
    min-height: 30%;
    overflow-wrap: break-word;
  }
  #bce-friend-list {
    width: 100%;
    overflow-x: hidden;
    overflow-y: scroll;
  }
  .bce-friend-list-entry {
    padding: 1em;
  }
  .bce-friend-list-entry-name {
    font-weight: bold;
    display: flex;
    flex-direction: column;
  }
  .bce-friend-list-selected {
    font-style: italic;
    border-top: 0.1em solid white;
    border-bottom: 0.1em solid white;
    background-color: #222;
  }
  #bce-message-container {
    width: 100%;
    height: 90%;
    font-size: 1.5rem;
    font-family: Arial, sans-serif;
  }
  #bce-message-right-container {
    width: 80%;
    display: flex;
    flex-direction: column;
    border-left: 0.1em solid white;
  }
  #bce-message-input {
    width: 100%;
    height: 10%;
    border: 0;
    padding: 0;
    margin: 0;
    background-color: #222;
    color: #eee;
    font-size: 1.5rem;
    font-family: system-ui;
  }
  .bce-friend-list-unread {
    background-color: #a22;
  }
  .bce-message-divider {
    margin: 0.5em 2em;
    border-bottom: 0.2em solid white;
  }
  .bce-message {
    padding: 0.2em 0.4em;
    position: relative;
    white-space: pre-wrap;
  }
  .bce-message::before {
    content: attr(data-time);
    float: right;
    color: gray;
    font-size: 0.5em;
    margin-right: 0.2em;
    font-style: italic;
  }
  .bce-message-sender {
    text-shadow: 0.05em 0.05em #eee;
    font-weight: bold;
  }
  .bce-message-Emote, .bce-message-Action {
    font-style: italic;
    color: gray;
  }
  .bce-message-Message .bce-message-sender {
    text-shadow: 0.05em 0.05em #eee;
  }
  .bce-friend-history {
    overflow-y: scroll;
    overflow-x: hidden;
    height: 100%;
  }
  .bce-friend-list-handshake-false,
  .bce-friend-list-handshake-pending {
    text-decoration: line-through;
    color: gray;
  }
  #bce-message-left-container {
    display: flex;
    flex-direction: column;
    width: 20%;
    height: 100%;
  }
  #bce-friend-search {
    border: 0;
    border-bottom: 0.1em solid white;
    padding: 0.5em;
    height: 1em;
    background-color: #222;
    color: #eee;
  }
  .bce-profile-open {
    margin-right: 0.5em;
  }
  .bce-pending {
    opacity: 0.4;
  }

  .lds-ellipsis {
    display: inline-block;
    position: relative;
    width: 80px;
    height: 1em;
  }
  .lds-ellipsis div {
    position: absolute;
    top: 44%;
    width: 13px;
    height: 13px;
    border-radius: 50%;
    background: #fff;
    animation-timing-function: cubic-bezier(0, 1, 1, 0);
  }
  .lds-ellipsis div:nth-child(1) {
    left: 8px;
    animation: lds-ellipsis1 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(2) {
    left: 8px;
    animation: lds-ellipsis2 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(3) {
    left: 32px;
    animation: lds-ellipsis2 0.6s infinite;
  }
  .lds-ellipsis div:nth-child(4) {
    left: 56px;
    animation: lds-ellipsis3 0.6s infinite;
  }
  @keyframes lds-ellipsis1 {
    0% {
      transform: scale(0);
    }
    100% {
      transform: scale(1);
    }
  }
  @keyframes lds-ellipsis3 {
    0% {
      transform: scale(1);
    }
    100% {
      transform: scale(0);
    }
  }
  @keyframes lds-ellipsis2 {
    0% {
      transform: translate(0, 0);
    }
    100% {
      transform: translate(24px, 0);
    }
  }

  #bceNoteInput {
    z-index: 100 !important;
  }

  #layering {
    overflow-y: auto;
    grid-template:
      "asset-header button-grid" min-content
      "asset-grid asset-grid" min-content
      "layer-header layer-header" min-content
      "layer-grid layer-grid" auto
      "layer-hide-header layer-hide-header" min-content
      "layer-hide-grid layer-hide-grid" auto
      / auto min-content
    ;
  }
  #layering-layer-div {
    overflow-y: visible;
  }
  #layering-button-grid {
    top: 0;
    position: sticky;
  }
  .layering-button-container {
    position: relative;
  }
  #layering-hide-header {
    grid-area: layer-hide-header;
  }
  #layering-hide-div {
    grid-area: layer-hide-grid;
  }

  .wce-chat-room-select,
  #wce-chat-garble-label {
    font-size: 80%;
  }
  #TextAreaChatLog[data-colortheme="dark"] + #chat-room-bot .wce-chat-room-select,
  #TextAreaChatLog[data-colortheme="dark2"] + #chat-room-bot .wce-chat-room-select {
    color: #fff;
    background-color: #111;
    border-color: #555;
  }
  .wce-chat-room-select option[value="off"] {
    display: none;
  }
  .wce-whisper .wce-chat-room-select option[value="off"] {
    display: block;
  }
  #wce-chat-garble-label:after {
    content: "chat: ";
  }
  .wce-whisper #wce-chat-garble-label:after {
    content: "whis: ";
  }
  .wce-chat-room-select-div {
    grid-column: 1 / 4;
    direction: ltr;
    position: relative;
    display: grid;
    grid-template-columns: 28% 72%;
    justify-items: stretch;
    align-items: baseline;
  }
  @media (hover: hover) {
    .wce-chat-room-select-div:hover > .button-tooltip {
      visibility: visible;
    }
  }
  #wce-chat-baby-talk::before {
    background-image: url("https://fielr.github.io/scripts/wce/baby.png");
    mask-image: url("https://fielr.github.io/scripts/wce/baby.png");
  }
  #wce-chat-stutters::before {
    background-image: url("https://fielr.github.io/scripts/wce/stutter.png");
    mask-image: url("https://fielr.github.io/scripts/wce/stutter.png");
  }
  #wce-chat-baby-talk[data-state="ignore"]::before,
  #wce-chat-stutters[data-state="ignore"]::before {
    ${GameVersion==="R106"?"background-color":"--button-color"}: #bbb;
  }
  #wce-chat-baby-talk[data-state="preserve"]::before,
  #wce-chat-stutters[data-state="preserve"]::before {
    ${GameVersion==="R106"?"background-color":"--button-color"}: #666;
  }
  `,t=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.appendChild(document.createTextNode(e)),t.appendChild(r)}const ar=[23476,27006,24890],ir=[129178];function sr(){ne("DrawBackNextButton",{"Disabled, ArrowWidth":"Disabled, ArrowWidth, tooltipPosition","DrawButtonHover(Left, Top, Width, Height,":"DrawButtonHover(tooltipPosition?.X || Left, tooltipPosition?.Y || Top, tooltipPosition?.Width || Width, tooltipPosition?.Height || Height,"},"DrawBackNextButton tooltip positions may be incorrect."),ne("DrawButton",{"HoveringText, Disabled":"HoveringText, Disabled, tooltipPosition","DrawButtonHover(Left, Top, Width, Height,":"DrawButtonHover(tooltipPosition?.X || Left, tooltipPosition?.Y || Top, tooltipPosition?.Width || Width, tooltipPosition?.Height || Height,"},"DrawButton tooltip positions may be incorrect."),ne("CommandExecute",{"key.indexOf(CommandsKey + cmd.Tag) == 0)":"key.substring(1) === cmd.Tag)"},"Whitelist commands will not work."),ne("PreferenceSubscreenArousalRun",{'DrawCheckbox(1250, 276, 64, 64, TextGet("ArousalAffectExpression"), Player.ArousalSettings.AffectExpression);':'DrawCheckbox(1250, 276, 64, 64, TextGet("ArousalAffectExpression"), Player.ArousalSettings.AffectExpression, fbcSettingValue("animationEngine"));'},"disabling conflicting Player.ArousalSettings.AffectExpression when Animation Engine is active"),g.hookFunction("PreferenceSubscreenArousalClick",b.ModifyBehaviourMedium,(e,t)=>c.animationEngine&&PreferenceArousalIsActive()&&MouseIn(1250,276,64,64)?null:t(e)),ne("PreferenceSubscreenImmersionRun",{'TextGet("ShowUngarbledMessages"), Player.ImmersionSettings.ShowUngarbledMessages, disableButtons);':'TextGet("ShowUngarbledMessages"), Player.ImmersionSettings.ShowUngarbledMessages, false);'},"Can't control show ungarbled messages while in Extreme mode."),g.hookFunction("PreferenceSubscreenImmersionClick",b.ModifyBehaviourMedium,(e,t)=>PreferencePageCurrent===2&&MouseIn(500,592,64,64)&&(Player.GetDifficulty()>2||Player.GameplaySettings.ImmersionLockSetting&&Player.IsRestrained())?(Player.ImmersionSettings.ShowUngarbledMessages=!Player.ImmersionSettings.ShowUngarbledMessages,null):t(e)),PreferenceSubscreens.find(e=>e.name==="Arousal").run=PreferenceSubscreenArousalRun,PreferenceSubscreens.find(e=>e.name==="Arousal").click=PreferenceSubscreenArousalClick,PreferenceSubscreens.find(e=>e.name==="Immersion").run=PreferenceSubscreenImmersionRun,PreferenceSubscreens.find(e=>e.name==="Immersion").click=PreferenceSubscreenImmersionClick,g.hookFunction("PreferenceLoad",b.AddBehaviour,(e,t)=>{PreferenceDidAddOldStyleScreens=!1;const r=t(e);return PreferenceSubscreenList=[],r}),g.hookFunction("InformationSheetRun",b.AddBehaviour,(e,t)=>{if(!InformationSheetSelection?.MemberNumber)return t(e);const r=t(e),n=ar.includes(InformationSheetSelection.MemberNumber),a=ir.includes(InformationSheetSelection.MemberNumber);if(n||a){const s=window.MainCanvas.getContext("2d");if(!s)throw new Error("could not get canvas 2d context");s.textAlign="left",DrawText(h(a?"WCE Developer":"FBC Developer"),550,75,a?"fuchsia":"hotpink","black"),s.textAlign="center"}return r}),g.hookFunction("ServerSend",b.Top,(e,t)=>{const[r,n]=e;if(r!=="AccountUpdate"||!le(n))return t(e);if("ExtensionSettings"in n)throw new Error("misuse of ExtensionSettings detected; write prevented");return t(e)}),g.hookFunction("ServerSendQueueProcess",b.OverrideBehaviour,(e,t)=>ServerIsConnected?t(e):null)}function lr(){if(typeof window.StartBcUtil=="function"){Ge(h("Incompatibility"),h("WCE is incompatible with BCUtil. Some functionality from WCE may not work. BCUtil's wardrobe, appearance, and instant messaging functionality are all available within WCE. Go to WCE settings and enable the relevant options, then disable BCUtil to migrate fully to WCE. This beep will appear every time WCE detects BCUtil as having loaded before WCE."));return}ne("ServerAccountBeep",{'ChatRoomSendLocal(`<a onclick="ServerOpenFriendList()">(${ServerBeep.Message})</a>`);':'{\n        const beepId = FriendListBeepLog.length - 1;\n        ChatRoomSendLocal(`<a id="bce-beep-reply-${beepId}">\u21A9\uFE0F</a><a class="bce-beep-link" id="bce-beep-${beepId}">(${ServerBeep.Message}${ChatRoomHTMLEntities(data.Message ? `: ${bceStripBeepMetadata(data.Message.length > 150 ? data.Message.substring(0, 150) + "..." : data.Message)}` : "")})</a>`);\n        if (document.getElementById("bce-beep-reply-" + beepId)) {\n          document.getElementById(`bce-beep-reply-${beepId}`).onclick = (e) => {\n            e.preventDefault();\n            ElementValue("InputChat", `/beep ${data.MemberNumber} ${ElementValue("InputChat").replace(/^\\/(beep|w) \\S+ ?/u, \'\')}`);\n            document.getElementById(\'InputChat\').focus();\n          };\n        }\n        if (document.getElementById("bce-beep-" + beepId)) {\n          document.getElementById(`bce-beep-${beepId}`).onclick = (e) => {\n            e.preventDefault();\n            ServerOpenFriendList();\n            FriendListModeIndex = 1;\n            FriendListShowBeep(`${beepId}`);\n          };\n        }\n      }'},"Beeps are not enhanced by WCE.")}async function He(e){const t=new Map;t.set("Browser",navigator.userAgent),t.set("Game Version",`${GameVersion}${ht.includes(GameVersion)?"":" (unsupported)"}`),t.set("WebGL Version",GLVersion),t.set("WCE Version",ve),t.set("Loaded via FUSAM",typeof FUSAM=="object"&&FUSAM?.addons?.WCE?"Yes":"No"),t.set("WCE Enabled Settings",`
- ${Be(c).filter(([n,a])=>a||n==="version").map(([n,a])=>`${n}: ${a.toString()}`).join(`
- `)}`),Z.client?.connected&&t.set("Buttplug.io Devices",Z.client.devices.map(n=>`${n.name} (${n.vibrateAttributes.join(",")})`).join(", ")),t.set("SDK Mods",`
- ${bcModSdk.getModsInfo().map(n=>`${n.name} @ ${n.version}`).join(`
- `)}`),t.set("Incomplete Functions",Ue.join(", ")),t.set("Modified Functions (non-SDK)",Xe.join(", ")),t.set("Skipped Functionality for Compatibility",`
- ${Je.join(`
- `)}`),t.set("Log",Ve.filter(n=>n).map(n=>`[${n.level.toUpperCase()}] ${n.message}`).join(`
`));const r=Array.from(t).map(([n,a])=>`${n}: ${a}`).join(`
`);return e&&(W(`${r}

**The report has been copied to your clipboard.**`),console.debug(`${r}

**The report has been copied to your clipboard.**`),await navigator.clipboard.writeText(r)),Je.length>0&&W("If you are running another addon that modifies the game, but is not listed above, please tell its developer to use https://github.com/Jomshir98/bondage-club-mod-sdk to hook into the game instead. This is a very cheap and easy way for addon developers to almost guarantee compatibility with other addons."),r}function xt(e,t=!1){let r=t?ChatRoomCharacterDrawlist:ChatRoomCharacter;if(ChatRoomMapViewIsActive()&&(r=r.filter(ChatRoomMapViewCharacterIsVisible)),e===null)return r;let n=[];return/^\d+$/u.test(e)?n=[r.find(a=>a.MemberNumber===parseInt(e))]:n=r.filter(a=>CharacterNickname(a).split(" ")[0]?.toLowerCase()===e?.toLowerCase()||a.Name.split(" ")[0].toLowerCase()===e?.toLowerCase()),n.filter(Boolean)}async function ur(){await _(()=>!!Commands),f("registering additional commands"),CommandCombine([{Tag:"fbcdebug",Description:h("Get debug information to share with developers."),Action:()=>{W("Warning: /fbcdebug is deprecated, use /wcedebug instead!"),He(!0)}},{Tag:"fbcchangelog",Description:h("Show recent WCE changelog"),Action:()=>{et(Ke),W("Warning: /fbcchangelog is deprecated, use /wcechangelog instead!")}},{Tag:"wcedebug",Description:h("Get debug information to share with developers."),Action:()=>{He(!0)}},{Tag:"wcechangelog",Description:h("Show recent WCE changelog"),Action:()=>{et(Ke)}},{Tag:"wcegotoroom",Description:h("[room name or empty] switches to the room or leaves room if empty (ignoring all restrictions)"),Action:(e,t)=>{Ze(t.substring(13).trim())}},{Tag:"exportlooks",Description:h("[target member number]: Copy your or another player's appearance in a format that can be imported with WCE or BCX"),Action:(e,t,[r])=>{let n=null;if(r?n=Character.find(o=>o.MemberNumber===parseInt(r))??null:n=Player,!n){ye("Could not find member",r);return}let a=!1,s=!1,l=!1;FUSAM.modals.openAsync({prompt:h("Include binds?"),buttons:{cancel:"No",submit:"Yes"}}).then(([o])=>(s=o==="submit",s?FUSAM.modals.openAsync({prompt:h("Include locks?"),buttons:{cancel:"No",submit:"Yes"}}).then(([i])=>{l=i==="submit"}):null)).then(()=>FUSAM.modals.openAsync({prompt:h("Include height, body type, hair, etc?"),buttons:{cancel:"No",submit:"Yes"}})).then(([o])=>{a=o==="submit";const i=n.Appearance.filter(w=>w.Asset.Group.IsDefault&&!w.Asset.Group.Clothing),u=n.Appearance.filter(w=>w.Asset.Group.Category==="Appearance"&&w.Asset.Group.Clothing),d=n.Appearance.filter(w=>w.Asset.Group.Category==="Item"&&!w.Asset.Group.BodyCosplay),p=[...u];s&&p.push(...d),a&&p.push(...i);const k=p.map(w=>{const v=w.Property?{...w.Property}:{};return!l&&v.LockedBy&&(delete v.LockedBy,delete v.LockMemberNumber),v?.LockMemberNumber&&(v.LockMemberNumber=Player.MemberNumber),{Group:w.Asset.Group.Name,Name:w.Asset.Name,Color:w.Color,Difficulty:w.Difficulty,Property:v,Craft:w.Craft}}),P=n.IsPlayer()?"yourself":CharacterNickname(n),M=LZString.compressToBase64(JSON.stringify(k));return FUSAM.modals.openAsync({prompt:h(h("Copy the looks string below")),input:{initial:M,readonly:!0,type:"textarea"},buttons:{submit:"Done"}}),navigator.clipboard.writeText(M).then(()=>{W(h("Exported looks for $TargetName copied to clipboard",{$TargetName:P}))})})}},{Tag:"importlooks",Description:h("Import looks from a string (BCX or WCE export)"),Action:()=>{if(!Player.CanChangeOwnClothes()||!OnlineGameAllowChange()){W(h("You cannot change your appearance while bound or during online games, such as LARP."));return}FUSAM.modals.open({prompt:h("Paste your looks here"),input:{initial:"",readonly:!1,type:"textarea"},callback:(e,t)=>{if(e==="submit"){if(!t){W(h("No looks string provided"));return}try{const r=t.startsWith("[")?ce(t):ce(LZString.decompressFromBase64(t));if(!Array.isArray(r)||r.length===0||!r[0].Group)throw new Error("Invalid bundle");for(const n of Player.Appearance)if(n.Property?.LockedBy&&!DialogCanUnlock(Player,n)){const a={Group:n.Asset.Group.Name,Name:n.Asset.Name,Color:n.Color,Difficulty:n.Difficulty,Property:n.Property},s=r.findIndex(l=>l.Group===n.Asset.Group.Name);s<0?r.push(a):r[s]=a}ServerAppearanceLoadFromBundle(Player,"Female3DCG",r,Player.MemberNumber),ChatRoomCharacterUpdate(Player),W(h("Applied looks"))}catch(r){console.error(r),W(h("Could not parse looks"))}}}})}},{Tag:"beep",Description:h("[membernumber] [message]: beep someone"),Action:(e,t,[r])=>{if(Se?.getRuleState("speech_restrict_beep_send")?.isEnforced){W(h("Sending beeps is restricted by BCX rule."));return}const[,,...n]=t.split(" "),a=n?.join(" ");if(!r||!a||!/^\d+$/u.test(r)){W(h("beep target or message not provided"));return}const s=parseInt(r);if(!Player.FriendList?.includes(s)){W(h("$Target is not in your friend list",{$Target:r}));return}const l=Player.FriendNames?.get(s);ServerSend("AccountBeep",{BeepType:"",MemberNumber:s,Message:a,IsSecret:!0}),FriendListBeepLog.push({MemberNumber:s,MemberName:l??`unknown (${s})`,Sent:!0,Private:!1,Time:new Date,Message:a});const o=FriendListBeepLog.length-1,i=document.createElement("a");i.href=`#beep-${o}`,i.onclick=u=>{u.preventDefault(),ServerOpenFriendList(),FriendListModeIndex=1,FriendListShowBeep(o)},i.textContent=h("(Beep to $Name ($Number): $Message)",{$Name:l??"unknown",$Number:s.toString(),$Message:a.length>150?`${a.substring(0,150)}...`:a}),i.classList.add("bce-beep-link"),W(i)}},{Tag:"w",Description:h("[target name] [message]: whisper the target player. Use first name only. Finds the first person in the room with a matching name, left-to-right, top-to-bottom."),Action:(e,t,r)=>{if(r.length<2){W(h("Whisper target or message not provided"));return}const[n]=r,[,,...a]=t.split(" "),s=a?.join(" "),l=xt(n);if(!n||!l||l.length===0)W(`Whisper target not found: ${n}`);else if(l.length>1)W(h("Multiple whisper targets found: $Targets. You can still whisper the player by clicking their name or by using their member number.",{$Targets:l.map(o=>`${CharacterNickname(o)} (${o.MemberNumber??""})`).join(", ")}));else if(l[0].IsPlayer())W("You can't whisper yourself!");else if(!s)W(h("No message provided"));else{const o=l[0].MemberNumber,i=ChatRoomTargetMemberNumber;ChatRoomTargetMemberNumber=o??-1,ElementValue("InputChat",`${s.length>0&&[".","/"].includes(s[0])?"\u200B":""}${s}`),ChatRoomSendChat(),ChatRoomLastMessage.pop(),ChatRoomTargetMemberNumber=i}}},{Tag:"versions",Description:h("show versions of the club, WCE, BCX and other mods in use by players"),Action:(e,t,r)=>{function n(s){const l=s.OnlineSharedSettings?.GameVersion??"R0",o=window.bcx?.getCharacterVersion(s.MemberNumber)?` BCX ${window.bcx.getCharacterVersion(s.MemberNumber)??"?"}`:"",i=s.FBC?`
WCE v${s.FBC} Alt Arousal: ${s.BCEArousal?.toString()}`:"",u=s.FBCOtherAddons?.some(d=>!["BCX","FBC","WCE"].includes(d.name))?`
Other Addons:
- ${s.FBCOtherAddons.filter(d=>!["BCX","FBC","WCE"].includes(d.name)).map(d=>`${d.name} v${d.version} ${d.repository??""}`).join(`
- `)}`:"";return`${CharacterNickname(s)} (${s.MemberNumber??""}) club ${l}${o}${i}${u}`}const a=xt(r.length>0?r[0]:null,!0).map(n).filter(s=>s).join(`

`);W(a),f(a)}},{Tag:"ulistadd",Description:h("[membernumber]: adds a player to the list allowing to bypass Uwall."),Action:(e,t,r)=>{if(r.length<1)W("The ulistadd command must be followed by the member number of the player that you allow to bypass Uwall.");else{const n=parseInt(r[0]),a=Player.OnlineSharedSettings.Ulist??[];!isNaN(n)&&n>0&&n!==Player.MemberNumber&&!a.includes(n)&&(Player.OnlineSharedSettings.Ulist=[...a,n],ServerAccountUpdate.QueueData({OnlineSharedSettings:Player.OnlineSharedSettings})),c.uwall||W("Warning: Uwall is not activated in WCE's settings.")}}},{Tag:"ulistremove",Description:h("[membernumber]: removes a player from the list allowing to bypass Uwall."),Action:(e,t,r)=>{if(r.length<1)W("The ulistremove command must be followed by the member number of the player who is no more allowed to bypass Uwall.");else{const n=parseInt(r[0]),{Ulist:a}=Player.OnlineSharedSettings;Array.isArray(a)&&!isNaN(n)&&n>0&&n!==Player.MemberNumber&&(Player.OnlineSharedSettings.Ulist=a.filter(s=>s!==n),ServerAccountUpdate.QueueData({OnlineSharedSettings:Player.OnlineSharedSettings})),c.uwall||W("Warning: Uwall is not activated in WCE's settings.")}}},{Tag:"ulistshow",Description:h("displays the list of players allowed to bypass Uwall."),Action:()=>{W(`Ulist: ${JSON.stringify(Player.OnlineSharedSettings.Ulist??[])}`),c.uwall||W("Warning: Uwall is not activated in WCE's settings.")}}])}const nt=900,Bt=200;async function cr(){await _(()=>!!PreferenceRegisterExtensionSetting),f("initializing");const e=8,t=70,r=225;function n(B){return Math.ceil(Object.values(ae).filter(N=>N.category===B).length/e)}const a=[1500,60,250,50],s=[1240,60,250,50];let l=0,o=null,i="";const u=["chat","activities","appearance","immersion","antigarble","performance","misc","cheats","buttplug"],d={chat:"Chat & Social",activities:"Activities & Arousal",appearance:"Appearance & Wardrobe",immersion:"Immersion & Anti-Cheat",antigarble:"Gagspeak & Anti-Garble",performance:"Performance",misc:"Misc",cheats:"Cheats",buttplug:"Buttplug.io Toys",hidden:""},p=["None",...new Set(Asset.filter(B=>B.AllowEffect?.includes("Vibrating")||B.AllowEffect?.includes("Egged")).map(B=>B.Group.Name))],k=[1650,225,150,50];function P(B){return Object.entries(ae).filter(([N,L])=>L.category===B&&N!=="buttplugDevices")}function M(){ElementCreateInput("WceIntifaceAddress","text",c.toySyncAddress),ElementPosition("WceIntifaceAddress",-999,-999,550),l=0}function w(){c.toySyncAddress=ElementValue("WceIntifaceAddress"),ElementRemove("WceIntifaceAddress"),wt(),PreferenceSubscreenExtensionsClear()}function v(){const B=window.MainCanvas.getContext("2d");if(!B){se("Could not get canvas context");return}if(B.textAlign="left",DrawText(h(o?`WCE Settings - ${d[o]}`:"Wholesome Club Extensions (WCE) Settings"),300,125,"Black","Gray"),DrawButton(...a,"","White",""),DrawText(h("License"),a[0]+20,a[1]+a[3]/2,"Black",""),DrawButton(...s,"","White",""),DrawText(h("Information"),s[0]+20,s[1]+s[3]/2,"Black",""),DrawButton(1815,75,90,90,"","White","Icons/Exit.png"),o){let N=r;for(const[L,R]of P(o).slice(l*e,l*e+e)){if(R.type==="select"&&Array.isArray(R.options)){const I=R,V=I.options.indexOf(c[L]),y=I.options.length,D=I.disabled?.()||!1;DrawText(h(R.label),400,N+33,i===L?"Red":"Black","Gray"),DrawBackNextButton(nt,N,Bt,64,h(I.options[V]),D?"#ebebe4":"White","",()=>h(`${R.label} ${I.options[(V-1+y)%y]}`),()=>h(`${R.label} ${I.options[(V+1+y)%y]}`),D)}else DrawCheckbox(300,N,64,64,h(R.label),!!c[L],R.disabled(),i===L?"Red":"Black");N+=t}if(o==="buttplug"){if(DrawText(h("This page allows configuration of the synchronization of bluetooth connected toys."),300,350,"Black","Gray"),ElementPosition("WceIntifaceAddress",1300,r+32,550),c.toySync)if(!Z.client?.connected)DrawText(h("Still connecting or connection failed..."),300,450,"Black","Gray");else{B.textAlign="center",DrawButton(...k,h("Scan"),Z.client.isScanning?"Grey":"White","",Z.client.isScanning?"Already scanning":void 0,Z.client.isScanning),B.textAlign="left",DrawText(h("Device Name"),300,420,"Black","Gray"),DrawText(h("Synchronized Slot"),800,420,"Black","Gray"),N=500;for(const L of Z.client.devices.filter(R=>R.vibrateAttributes.length>0)){let R=Z.deviceSettings.get(L.name);R||(R={Name:L.name,SlotName:"None"},Z.deviceSettings.set(L.name,R));const I=p.indexOf(R.SlotName);let V=0,y=0;if(I<=0?y=p.length-1:y=I-1,I===p.length-1?V=0:V=I+1,DrawText(L.name,300,N,"Black","Gray"),B.textAlign="center",DrawBackNextButton(800,N-32,450,64,h(R.SlotName),"white","",()=>h(p[y]),()=>h(p[V])),B.textAlign="left",N+=t,N>950)break}}}else{if(DrawText(h("Click on a setting to see its description"),300,160,"Gray","Silver"),rt(i))if(ae[i].type==="select"&&Array.isArray(ae[i].tooltips)){const L=ae[i],R=L.options.indexOf(c[i]);Me(300,800,1600,h(L.description),"left"),Me(330,870,1570,h(L.tooltips[R]),"left")}else Me(300,830,1600,h(ae[i].description),"left");n(o)>1&&(DrawText(`${l+1} / ${n(o)}`,1700,230,"Black","Gray"),DrawButton(1815,180,90,90,"","White","Icons/Next.png"))}}else{let N=r;for(const L of u)DrawButton(300,N,400,64,"","White"),DrawTextFit(h(d[L]),310,N+32,380,"Black"),N+=t}B.textAlign="center"}function m(){let B=r;if(MouseIn(1815,75,90,90))o===null?w():(ElementPosition("WceIntifaceAddress",-999,-999,550),o=null);else if(MouseIn(...a))open(It,"_blank");else if(MouseIn(...s))open(Lt,"_blank");else if(o!==null){if(MouseIn(1815,180,90,90)&&o!=="buttplug")l+=1,l%=n(o);else for(const[N,L]of P(o).slice(l*e,l*e+e)){if(L.type==="select"&&Array.isArray(L.options)){const R=L,I=Bt/2,V=R.options.indexOf(c[N]),y=R.options.length;MouseIn(nt+I,B,I,64)&&!R.disabled?.()?c[N]=R.options[(V+1+y)%y]:MouseIn(nt,B,I,64)&&!R.disabled?.()&&(c[N]=R.options[(V-1+y)%y])}else MouseIn(300,B,64,64)&&!L.disabled?.()&&(c[N]=!c[N],L.sideEffects(c[N],!1));MouseIn(364,B,1e3,64)&&(i=N,f("currentSetting",i)),B+=t}if(o==="buttplug"&&Z.client?.connected){if(MouseIn(...k)){Z.client.isScanning||Z.client.startScanning();return}B=500;for(const N of Z.client.devices.filter(L=>L.vibrateAttributes.length>0)){if(!MouseIn(800,B-32,450,64)){B+=t;continue}const L=Z.deviceSettings.get(N.name);if(!L){K("Could not find device settings for",N.name,Z.deviceSettings),B+=t;continue}const R=p.indexOf(L.SlotName);let I=0,V=0;if(R<=0?V=p.length-1:V=R-1,R===p.length-1?I=0:I=R+1,MouseX<800+450/2?L.SlotName=p[V]:L.SlotName=p[I],B+=t,B>950)break}}}else for(const N of u){if(MouseIn(300,B,400,64)){o=N,l=0;break}B+=t}}PreferenceRegisterExtensionSetting({Identifier:"WCE",ButtonText:h("WCE Settings"),Image:"https://fielr.github.io/scripts/wce/icon.png",click:m,run:v,exit:w,load:M});function A(B){B.key==="Escape"&&o!==null&&(o=null,ElementPosition("WceIntifaceAddress",-999,-999,550),B.stopPropagation(),B.preventDefault())}document.addEventListener("keydown",A,!0),document.addEventListener("keypress",A,!0)}async function dr(){await _(()=>!!StruggleMinigames);const e=100,t=200,r=1575,n=300;g.hookFunction("StruggleLockPickDraw",b.AddBehaviour,(a,s)=>{if(c.lockpick&&StruggleLockPickOrder){const l=StruggleLockPickOrder.map(o=>o);for(let o=0;o<l.length;o++){const i=r-t/2+(.5-l.length/2+o)*e;DrawText(`${StruggleLockPickOrder.indexOf(o)+1}`,i,n,"white")}}return s(a)}),f("hooking struggle for lockpick cheat draw",StruggleMinigames),StruggleMinigames.LockPick.Draw=StruggleLockPickDraw}async function hr(){const{Dexie:e}=await import("./dexie.js"),t=new e("wce-saved-accounts");t.version(2).stores({key:"id, key",accounts:"id, data, iv, auth"});const r=t.table("key"),n=t.table("accounts");let a,s;try{s=await r.get({id:1})}catch(m){K(m),localStorage.removeItem("bce.passwords"),await t.delete(),window.location.reload()}s?a=s.key:(a=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),await r.put({id:1,key:a}));async function l(){const m=localStorage.getItem("bce.passwords");if(m){const I=ce(m)||{};return window.crypto?.subtle&&setTimeout(()=>{localStorage.removeItem("bce.passwords"),u(I)},1),I}const A=await n.get({id:1});if(!A)return{};const{auth:B,iv:N,data:L}=A,R=new TextDecoder("utf8");try{const I=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:N,additionalData:B,tagLength:128},a,L);return ce(R.decode(new Uint8Array(I)))||{}}catch(I){return K(I),localStorage.removeItem("bce.passwords"),r.clear(),n.clear(),{}}}let o=await l();function i(){return o||{}}function u(m){if(window.crypto?.subtle){const A=window.crypto.getRandomValues(new Uint8Array(16)),B=window.crypto.getRandomValues(new Uint8Array(16)),N=new TextEncoder;o=m,window.crypto.subtle.encrypt({name:"AES-GCM",iv:A,additionalData:B,tagLength:128},a,N.encode(JSON.stringify(m))).then(L=>n.put({id:1,iv:A,auth:B,data:new Uint8Array(L)},[1]))}else localStorage.removeItem("bce.passwords")}function d(){let m="";CurrentScreen==="Login"?m=ElementValue("InputName").toUpperCase():CurrentScreen==="Relog"&&(m=Player.AccountName);const A=i();A[m]=ElementValue("InputPassword"),u(A)}globalThis.bceUpdatePasswordForReconnect=d;function p(m){const A=i();Object.hasOwn(A,m)&&(delete A[m],u(A))}globalThis.bceClearPassword=p;let k=Date.now();async function P(){await _(()=>CurrentScreen==="Login");const m={passwords:i(),posMaps:{}};g.hookFunction("LoginRun",b.Top,(A,B)=>{const N=B(A);Object.keys(m.passwords).length>0&&DrawText(h("Saved Logins (WCE)"),170,35,"White","Black"),DrawButton(1250,387,180,50,h("Save (WCE)"),"White");let L=60;for(const R in m.passwords)Object.hasOwn(m.passwords,R)&&(m.posMaps[L]=R,DrawButton(10,L,350,60,R,"White"),DrawButton(355,L,60,60,"X","White"),L+=70);return N}),g.hookFunction("LoginClick",b.Top,(A,B)=>{const N=B(A);MouseIn(1250,385,180,60)&&(d(),m.posMaps={},m.passwords=i());const L=Date.now();if(L-k<150)return N;k=L;for(const R in m.posMaps){if(!Object.hasOwn(m.posMaps,R))continue;const I=parseInt(R);MouseIn(10,I,350,60)?(ElementValue("InputName",m.posMaps[I]),ElementValue("InputPassword",m.passwords[m.posMaps[I]]),LoginDoLogin()):MouseIn(355,I,60,60)&&(p(m.posMaps[I]),m.posMaps={},m.passwords=i())}return N}),CurrentScreenFunctions.Run=LoginRun,CurrentScreenFunctions.Click=LoginClick}P();let M=!1,w=!1;async function v(){if(!Player?.AccountName||!ServerIsConnected||LoginSubmitted||!ServerSocket.connected||M||w||!c.relogin)return;M=!0;const m=i();if(f("Attempting to log in again as",Player.AccountName),!m[Player.AccountName]){K("No saved credentials for account",Player.AccountName);return}LoginSetSubmitted(),ServerSend("AccountLogin",{AccountName:Player.AccountName,Password:m[Player.AccountName]}),await _(()=>CurrentScreen!=="Relog",()=>!M)||K("Relogin failed, circuit was restored"),await je(500),g.callOriginal("ServerAccountBeep",[{MemberNumber:Player.MemberNumber||-1,BeepType:"",MemberName:"VOID",ChatRoomName:"VOID",Private:!0,Message:h("Reconnected!"),ChatRoomSpace:""}])}g.hookFunction("RelogRun",b.Top,(m,A)=>(["ErrorDuplicatedLogin"].includes(LoginErrorMessage)?M||(g.callOriginal("ServerAccountBeep",[{MemberNumber:Player.MemberNumber||-1,BeepType:"",MemberName:Player.Name,ChatRoomName:h("ERROR"),Private:!0,Message:h("Signed in from a different location! Refresh the page to re-enable relogin in this tab."),ChatRoomSpace:""}]),M=!0,w=!0):v(),A(m))),g.hookFunction("RelogExit",b.Top,(m,A)=>(M=!1,w=!1,A(m))),pe("connect",()=>{M=!1}),g.hookFunction("ServerDisconnect",b.ModifyBehaviourHigh,(m,A)=>{const[,B]=m;m[1]=!1;const N=A(m);return B&&(K("Forcefully disconnected",m),ServerSocket.disconnect(),he(m[0])&&["ErrorRateLimited","ErrorDuplicatedLogin"].includes(m[0])?(K("Reconnecting..."),setTimeout(()=>{K("Connecting..."),ServerInit()},3e3+Math.round(Math.random()*3e3))):K("Disconnected.")),N})}async function pr(){await _(()=>!!Player?.AppearanceLayers);function e(o,i){return i?.Property?.LockedBy==="ExclusivePadlock"?!o.IsPlayer():LogQuery("KeyDeposit","Cell")?!1:i?.Asset?.OwnerOnly?i.Asset.Enable&&o.IsOwnedByPlayer():i?.Asset?.LoverOnly?i.Asset.Enable&&o.IsLoverOfPlayer():i?.Asset?.FamilyOnly?i.Asset.Enable&&o.IsFamilyOfPlayer():DialogHasKey(o,i)}g.hookFunction("Layering.Load",b.AddBehaviour,(o,i)=>{if(c.allowLayeringWhileBound&&(!InventoryItemHasEffect(Layering.Item,"Lock")||e(Layering.Character,Layering.Item))&&(Layering.Readonly=!1),!Layering.Character.IsPlayer()&&Layering.Character.BCECapabilities?.includes("preventLayeringByOthers")&&(Layering.Readonly=!0),!c.layeringHide||CurrentScreen==="Crafting"||!Layering.Character.BCECapabilities?.includes("layeringHide"))return i(o);const u=i(o),d=Layering.Asset.Hide||[];if(d.length===0)return u;const p=Layering.Item.Property.wceOverrideHide||d;return ElementCreate({tag:"h1",attributes:{id:"layering-hide-header"},parent:document.getElementById("layering"),children:[h("[WCE] Configure layer hiding")]}),ElementCreate({tag:"form",attributes:{id:"layering-hide-div"},classList:["layering-layer-inner-grid"],parent:document.getElementById("layering"),children:d.map(k=>({tag:"div",classList:["layering-pair"],children:[{tag:"input",attributes:{type:"checkbox",name:"checkbox-hide",value:k,disabled:Layering.Readonly?!0:void 0,checked:p.includes(k)?!0:void 0},classList:[],eventListeners:{click:()=>{const P=document.getElementById("layering-hide-div");Layering.Item.Property.wceOverrideHide=new FormData(P).getAll("checkbox-hide"),d.length===Layering.Item.Property.wceOverrideHide.length&&delete Layering.Item.Property.wceOverrideHide,Layering._CharacterRefresh(Layering.Character,!1,!1)}}},{tag:"span",classList:["layering-pair-text"],children:[k]}]}))}),u}),g.hookFunction("Layering._ResetClickListener",b.AddBehaviour,(o,i)=>(!c.layeringHide||CurrentScreen==="Crafting"||(delete Layering.Item.Property.wceOverrideHide,document.querySelectorAll("input[name=checkbox-hide]").forEach(u=>{u.checked=!0})),i(o))),ne("CharacterAppearanceVisible",{"if ((item.Asset.Hide != null) && (item.Asset.Hide.indexOf(GroupName) >= 0) && !Excluded) HidingItem = true;":`
        const hide = item.Property?.wceOverrideHide != null ? item.Property.wceOverrideHide : item.Asset.Hide;
        if ((hide != null) && (hide.indexOf(GroupName) >= 0) && !Excluded) HidingItem = true;`},"Override C.Appeareance.Asset.Hide won't work");function t(o){const i={Hide:{}};for(const u of o)if(Array.isArray(u.Property?.wceOverrideHide)){const{wceOverrideHide:d,...p}=u.Property;i.Hide[u.Group]=d,u.Property=p}return Player.ExtensionSettings.WCEOverrides=LZString.compressToUTF16(JSON.stringify(i)),ServerPlayerExtensionSettingsSync("WCEOverrides"),o}globalThis.wceServerAppearance=t,ne("ServerPlayerAppearanceSync",{"D.Appearance = ServerAppearanceBundle(Player.Appearance);":"D.Appearance = wceServerAppearance(ServerAppearanceBundle(Player.Appearance));"},"wceOverrideHide would be stored in the BC database"),g.hookFunction("ServerAppearanceLoadFromBundle",b.ModifyBehaviourMedium,(o,i)=>{const u=i(o),[d]=o;if(d.IsPlayer()&&Array.isArray(d.Appearance)){let p=!1;const k=ce(LZString.decompressFromUTF16(Player.ExtensionSettings.WCEOverrides));for(const[P,M]of Object.entries(k?.Hide||{})){const w=InventoryGet(d,P);w&&!Array.isArray(w.Property?.wceOverrideHide)&&(w.Property??={},w.Property.wceOverrideHide=M,p=!0)}p&&ChatRoomCharacterUpdate(d)}return u}),g.hookFunction("ChatRoomSyncMemberJoin",b.AddBehaviour,(o,i)=>{const u=i(o);return Player.Appearance.some(d=>Array.isArray(d.Property?.wceOverrideHide))&&ChatRoomCharacterUpdate(Player),u}),g.hookFunction("PreferenceExit",b.AddBehaviour,(o,i)=>{const u=PreferenceSubscreen.name==="Main",d=i(o);return u&&Player.Appearance.some(p=>Array.isArray(p.Property?.wceOverrideHide))&&ChatRoomCharacterUpdate(Player),d});const r=["LeatherCrop","LeatherWhip","ShockCollarRemote","SpankingToys","VibratorRemote"],n=Asset.filter(o=>AssetGroup.filter(i=>i.Name.startsWith("Item")&&!/\d$/u.test(i.Name)&&i.Asset.find(u=>u.Name===o.Name)).length>1).filter((o,i,u)=>u.findIndex(d=>d.Name===o.Name)===i).map(o=>o.Name).filter(o=>!r.includes(o));function a(o,i){return!!i&&!!o.Appearance.find(u=>u===i)}g.hookFunction("DialogMenuButtonBuild",b.AddBehaviour,([o],i)=>{const u=i([o]);if(ue(o)&&c.copyColor&&Player.CanInteract()&&o?.FocusGroup?.Name&&!InventoryGroupIsBlocked(o,o.FocusGroup.Name)&&DialogMenuMode==="items"){const d=InventoryGet(o,o.FocusGroup.Name);a(o,d)&&n.includes(d.Asset.Name)&&DialogMenuButton.push("Paint")}return u}),g.hookFunction("InterfaceTextGet",b.AddBehaviour,(o,i)=>o[0]==="DialogMenuPaint"?h("[WCE] Copy colors to other items of same type"):i(o)),g.hookFunction("DialogMenuButtonClick",b.AddBehaviour,(o,i)=>{const u=i(o);if(!u&&!["colorExpression","colorItem","extended","layering","tighten"].includes(DialogMenuMode)){const d=CharacterGetCurrent(),p=d.FocusGroup?InventoryGet(d,d.FocusGroup.Name):null;for(let k=0;k<DialogMenuButton.length;k++)if(MouseIn(1885-k*110,15,90,90)){const P=DialogMenuButton[k];if(p&&P==="Paint")return l(d,p),!1}}return u});function s(o,i){if(o.Asset.Name===i.Asset.Name)if(Array.isArray(i.Color))if(Array.isArray(o.Color))for(let u=o.Color.length-1;u>=0;u--)o.Color[u]=i.Color[u%i.Color.length];else o.Color=i.Color[i.Color.length-1];else if(Array.isArray(o.Color))for(let u=0;u<o.Color.length;u++)o.Color[u]=i.Color??"Default";else o.Color=xe(i.Color)}function l(o,i){if(!(!c.copyColor||!Player.CanInteract()||InventoryGroupIsBlocked(o,o.FocusGroup.Name)||!a(o,i)||!n.includes(i.Asset.Name))){for(const u of o.Appearance)s(u,i);CurrentScreen==="ChatRoom"?(ChatRoomCharacterUpdate(o),Te(h("$TargetName's $ItemName colors spread from their $ItemGroup",{$TargetName:CharacterNickname(o),$ItemName:i.Asset.Description.toLowerCase(),$ItemGroup:i.Asset.Group.Description.toLowerCase()}))):CharacterRefresh(o)}}}function mr(){g.hookFunction("ChatRoomMenuBuild",b.AddBehaviour,(r,n)=>{const a=n(r);return c.manualCacheClear&&ChatRoomMenuButtons.splice(ChatRoomMenuButtons.indexOf("Cut"),0,"clearCache"),a}),g.hookFunction("ChatRoomMenuClick",b.AddBehaviour,(r,n)=>{const a=n(r);if(c.manualCacheClear){const s=992/ChatRoomMenuButtons.length;for(let l=0;l<ChatRoomMenuButtons.length;l++)MouseXIn(1005+s*l,s-2)&&ChatRoomMenuButtons[l]==="clearCache"&&t()}return a}),ne("ChatRoomMenuDraw",{'let suffix = "";':`let suffix = "";
        if (name === "clearCache") {
          DrawButton(1005 + Space * Number(idx), 2, Space - 2, 60, "", color, null, "[WCE] clear and reload the drawing cache of all characters");
          DrawImage("Icons/Small/Reset.png", 976 + Space * Number(idx) + Space / 2, 4);
          continue;
        }`},"manual clearing and reloading of drawing cache");async function e(){const r=Date.now();await _(()=>CurrentScreen==="ChatRoom"&&!CurrentCharacter&&document.hasFocus(),()=>Date.now()-r>36e5)&&c.automateCacheClear&&t()}globalThis.bceClearCaches=e;function t(){f("Clearing caches"),GLDrawCanvas.GL?.textureCache&&GLDrawCanvas.GL.textureCache.clear(),GLDrawResetCanvas(),f("Clearing old characters from cache"),Character.filter(r=>r.IsOnline?.()&&!ChatRoomCharacter.some(n=>n.MemberNumber===r.MemberNumber)).forEach(r=>CharacterDelete(r)),Character.filter(r=>r.IsOnline?.()).forEach(r=>CharacterRefresh(r,!1,!1))}Ee(()=>{c.automateCacheClear&&e()},36e5)}function gr(){g.hookFunction("ChatRoomDrawCharacterStatusIcons",b.AddBehaviour,([e,t,r,n],a)=>{const s=a([e,t,r,n]);if(ue(e)&&typeof t=="number"&&typeof r=="number"&&typeof n=="number"&&e.FBC&&ChatRoomHideIconState===0){const l=["1","2","3","4","5"].includes(e.FBC.split(".")[0])?"FBC":"WCE";DrawTextFit(l,t+290*n,r+14*n,60*n,e.FBCNoteExists?"Cyan":"White","Black"),DrawTextFit(/^\d+\.\d+(\.\d+)?b?$/u.test(e.FBC)?e.FBC.replace("b",""):"",t+290*n,r+36*n,e.FBC.split(".").length===3?60*n:40*n,e.FBC.endsWith("b")?"Lightpink":"White","Black")}return s})}async function yr(){await _(()=>!!Player);let e=!1,t=null,r=null,n=!1;function a(){return e&&t?.IsPlayer()||CharacterAppearanceSelection?.IsPlayer()}ne("DrawProcess",{'CurrentScreen !== "Crafting"':'CurrentScreen !== "Crafting" && CurrentScreen !== "Wardrobe"'},"Full wardrobe may display blur and blindness effects of the background"),ne("DrawCharacter",{'|| CurrentScreen === "Crafting"':'|| CurrentScreen === "Crafting" || CurrentScreen === "Wardrobe"'},"Full wardrobe may display blur and blindness effects of the outfits"),g.hookFunction("CharacterAppearanceWardrobeLoad",b.OverrideBehaviour,(l,o)=>{const[i]=l;return c.privateWardrobe&&CurrentScreen==="Appearance"?(e=!0,t=ue(i)?i:CharacterGetCurrent(),CommonSetScreen("Character","Wardrobe"),null):o(l)}),g.hookFunction("AppearanceLoad",b.AddBehaviour,(l,o)=>{const i=o(l);return e&&(CharacterAppearanceBackup=r),i}),g.hookFunction("AppearanceRun",b.AddBehaviour,(l,o)=>(CharacterAppearanceMode==="Wardrobe"&&a()&&(DrawCheckbox(1300,350,64,64,"",n,!1,"white"),_e(h("Load without body parts"),1374,380,630,"white")),o(l))),g.hookFunction("AppearanceClick",b.ModifyBehaviourMedium,(l,o)=>CharacterAppearanceMode==="Wardrobe"&&MouseIn(1300,350,64,64)&&a()?(n=!n,null):o(l)),g.hookFunction("WardrobeLoad",b.AddBehaviour,(l,o)=>(r=CharacterAppearanceBackup,o(l))),g.hookFunction("WardrobeRun",b.AddBehaviour,(l,o)=>{const i=Player;e&&(Player=t);const u=o(l);return e&&(Player=i),DrawText(`Page: ${(WardrobeOffset/12|0)+1}/${WardrobeSize/12}`,300,35,"White"),DrawCheckbox(10,74,64,64,"",n,!1,"white"),_e(h("Exclude body parts"),84,106,300,"white"),u}),g.hookFunction("WardrobeClick",b.ModifyBehaviourMedium,(l,o)=>MouseIn(10,74,64,64)?(n=!n,null):o(l)),g.hookFunction("WardrobeExit",b.OverrideBehaviour,(l,o)=>e?(CommonSetScreen("Character","Appearance"),e=!1,null):o(l)),g.hookFunction("WardrobeFastLoad",b.OverrideBehaviour,(l,o)=>{let[i]=l;const u=i.Appearance.filter(p=>p.Asset.Group.IsDefault&&!p.Asset.Group.Clothing);if(e&&ue(i)&&i.IsPlayer()){if(!t)throw new Error("targetCharacter is not defined in WardrobeFastLoad");l[0]=t,i=t,l[2]=!1}const d=o(l);return n&&(i.Appearance=[...u,...i.Appearance.filter(p=>!p.Asset.Group.IsDefault||p.Asset.Group.Clothing)],CharacterLoadCanvas(i)),d}),g.hookFunction("WardrobeFastSave",b.OverrideBehaviour,(l,o)=>{const[i]=l;if(e&&ue(i)&&i.IsPlayer()){if(!t)throw new Error("targetCharacter is not defined in WardrobeFastSave");l[0]=t}return c.confirmWardrobeSave&&Player.Wardrobe?.length>l[1]&&Player.Wardrobe[l[1]]?.some(u=>u.Group==="Pronouns")&&!window.confirm("Do you really want to override this wardrobe outfit?")?null:o(l)}),g.hookFunction("ServerPlayerIsInChatRoom",b.AddBehaviour,(l,o)=>e&&CharacterAppearanceReturnRoom==="ChatRoom"||o(l));function s(l){c.privateWardrobe&&l.key==="Escape"&&e&&(WardrobeExit(),l.stopPropagation(),l.preventDefault())}document.addEventListener("keydown",s,!0),document.addEventListener("keypress",s,!0)}const fr={Blush:[{Expression:"High",Limit:100},{Expression:"Medium",Limit:60},{Expression:"Low",Limit:10},{Expression:null,Limit:0}],Eyebrows:[{Expression:"Soft",Limit:80},{Expression:"Lowered",Limit:50},{Expression:"Raised",Limit:20},{Expression:null,Limit:0}],Fluids:[{Expression:"DroolMedium",Limit:100},{Expression:"DroolLow",Limit:40},{Expression:null,Limit:0}],Eyes:[{Expression:"Closed",Limit:100},{Expression:"Surprised",Limit:90},{Expression:"Horny",Limit:70},{Expression:"Dazed",Limit:20},{Expression:null,Limit:0}],Eyes2:[{Expression:"Closed",Limit:100},{Expression:"Surprised",Limit:90},{Expression:"Horny",Limit:70},{Expression:"Dazed",Limit:20},{Expression:null,Limit:0}],Pussy:[{Expression:"Hard",Limit:50},{Expression:null,Limit:0}]},br={PostOrgasm:{Type:"PostOrgasm",Duration:2e4,Priority:1e4,Expression:{Blush:[{Expression:"Extreme",Duration:5e3},{ExpressionModifier:-1,Duration:5e3},{ExpressionModifier:-1,Duration:5e3,Priority:1e3},{ExpressionModifier:-1,Duration:5e3,Priority:200}],Eyes:[{Expression:"Closed",Duration:8500},{Expression:"Heart",Duration:7500},{Expression:"Sad",Duration:4e3,Priority:200}],Eyes2:[{Expression:"Closed",Duration:8e3},{Expression:"Heart",Duration:8e3},{Expression:"Sad",Duration:4e3,Priority:200}],Mouth:[{Expression:"Ahegao",Duration:5e3},{Expression:"Moan",Duration:5e3},{Expression:"HalfOpen",Duration:1e4,Priority:200}],Fluids:[{Expression:"DroolMessy",Duration:5e3},{Expression:"DroolSides",Duration:9e3,Priority:400},{Expression:"DroolLow",Duration:6e3,Priority:200}],Eyebrows:[{Expression:"Soft",Duration:1e4},{Expression:"Lowered",Duration:5e3,Priority:200},{Expression:null,Duration:5e3,Priority:1}]}},Pout:{Type:"Pout",Duration:-1,Expression:{Mouth:[{Expression:"Pout",Duration:-1}],Eyes:[{Expression:"Dazed",Duration:-1}],Eyes2:[{Expression:"Dazed",Duration:-1}],Eyebrows:[{Expression:"Harsh",Duration:-1}]}},ResetBrows:{Type:"ResetBrows",Duration:-1,Expression:{Eyebrows:[{Expression:null,Duration:-1}]}},RaiseBrows:{Type:"RaiseBrows",Duration:-1,Expression:{Eyebrows:[{Expression:"Raised",Duration:-1}]}},Confused:{Type:"Confused",Duration:-1,Expression:{Eyebrows:[{Expression:"OneRaised",Duration:-1}]}},Smirk:{Type:"Smirk",Duration:-1,Expression:{Mouth:[{Expression:"Smirk",Duration:-1}]}},Wink:{Type:"Wink",Duration:1500,Expression:{Eyes:[{Expression:"Closed",Duration:1500}]}},Laugh:{Type:"Laugh",Duration:8e3,Expression:{Mouth:[{Expression:"Laughing",Duration:1e3},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:1e3},{Expression:"Happy",Duration:200},{Expression:"Laughing",Duration:800},{Expression:"Grin",Duration:400},{Expression:"Laughing",Duration:800},{Expression:"Happy",Duration:400},{Expression:"Laughing",Duration:600},{Expression:"Grin",Duration:600},{Expression:"Laughing",Duration:600},{Expression:"Happy",Duration:600},{Expression:"Laughing",Duration:200},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:200},{Expression:"Happy",Duration:200}]}},Giggle:{Type:"Giggle",Duration:4e3,Expression:{Mouth:[{Expression:"Laughing",Duration:800},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:700},{Expression:"Happy",Duration:200},{Expression:"Laughing",Duration:600},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:500},{Expression:"Grin",Duration:200},{Expression:"Laughing",Duration:400},{Expression:"Happy",Duration:200}]}},Chuckle:{Type:"Chuckle",Duration:4e3,Expression:{Mouth:[{Expression:"Grin",Duration:4e3}]}},Smile:{Type:"Smile",Duration:-1,Expression:{Mouth:[{Expression:"Grin",Duration:-1}]}},Blink:{Type:"Blink",Duration:200,Expression:{Eyes:[{Expression:"Closed",Duration:200}],Eyes2:[{Expression:"Closed",Duration:200}]}},Grin:{Type:"Grin",Duration:-1,Expression:{Eyes:[{Expression:"Horny",Duration:-1}],Eyes2:[{Expression:"Horny",Duration:-1}],Mouth:[{Expression:"Grin",Duration:-1}]}},Cuddle:{Type:"Cuddle",Duration:1e4,Priority:150,Expression:{Mouth:[{Expression:"Happy",Duration:1e4}],Eyes:[{Expression:"ShylyHappy",Duration:1e4}],Eyes2:[{Expression:"ShylyHappy",Duration:1e4}],Eyebrows:[{Expression:"Raised",Duration:1e4}]}},Blush:{Type:"Blush",Duration:1e4,Expression:{Blush:[{ExpressionModifier:1,Duration:1e4}]}},Choke:{Type:"Choke",Duration:4e3,Priority:150,Expression:{Blush:[{ExpressionModifier:3,Duration:4e3}],Eyes:[{Expression:"VeryLewd",Duration:3e3},{Expression:"Sad",Duration:1e3}],Eyes2:[{Expression:"VeryLewd",Duration:3e3},{Expression:"Sad",Duration:1e3}],Eyebrows:[{Expression:"Harsh",Duration:4e3}]}},Stimulated:{Type:"Stimulated",Duration:5e3,Priority:400,Expression:{Blush:[{ExpressionModifier:2,Duration:5e3}],Eyes:[{Expression:"VeryLewd",Duration:4e3},{Expression:"Sad",Duration:1e3}],Eyes2:[{Expression:"VeryLewd",Duration:4e3},{Expression:"Sad",Duration:1e3}],Eyebrows:[{Expression:"Soft",Duration:5e3}]}},StimulatedLong:{Type:"StimulatedLong",Duration:2e4,Priority:400,Expression:{Blush:[{ExpressionModifier:1,Duration:2e4}]}},Shock:{Type:"Shock",Duration:15e3,Priority:1e3,Expression:{Blush:[{ExpressionModifier:5,Duration:1e4},{ExpressionModifier:-1,Duration:2e3},{ExpressionModifier:-1,Duration:2e3},{ExpressionModifier:-1,Duration:1e3}],Eyes:[{Expression:"Dizzy",Duration:1e3},{Expression:"Scared",Duration:8e3},{Expression:"Surprised",Duration:7e3}],Eyes2:[{Expression:"Dizzy",Duration:1e3},{Expression:"Scared",Duration:8e3},{Expression:"Surprised",Duration:7e3}],Eyebrows:[{Expression:"Soft",Duration:15e3}],Mouth:[{Expression:"Pained",Duration:1e4},{Expression:"Angry",Duration:5e3}]}},ShockLight:{Type:"ShockLight",Duration:5e3,Priority:900,Expression:{Blush:[{ExpressionModifier:2,Duration:5e3}],Eyes:[{Expression:"Dizzy",Duration:2e3},{Expression:"Surprised",Duration:3e3}],Eyes2:[{Expression:"Dizzy",Duration:2e3},{Expression:"Surprised",Duration:3e3}],Eyebrows:[{Expression:"Soft",Duration:5e3}],Mouth:[{Expression:"Angry",Duration:5e3}]}},Hit:{Type:"Hit",Duration:7e3,Priority:500,Expression:{Blush:[{Expression:"VeryHigh",Duration:7e3}],Eyes:[{Expression:"Daydream",Duration:1e3},{Expression:"Closed",Duration:3e3},{Expression:"Daydream",Duration:3e3}],Eyes2:[{Expression:"Daydream",Duration:1e3},{Expression:"Closed",Duration:3e3},{Expression:"Daydream",Duration:3e3}],Eyebrows:[{Expression:"Soft",Duration:7e3}]}},Spank:{Type:"Spank",Duration:3e3,Priority:300,Expression:{Eyes:[{Expression:"Lewd",Duration:3e3}],Eyes2:[{Expression:"Lewd",Duration:3e3}],Eyebrows:[{Expression:"Soft",Duration:3e3}]}},Kiss:{Type:"Kiss",Duration:2e3,Priority:200,Expression:{Mouth:[{Expression:"HalfOpen",Duration:2e3}]}},KissOnLips:{Type:"KissOnLips",Duration:2e3,Priority:200,Expression:{Eyes:[{Expression:"Closed",Duration:2e3}],Eyes2:[{Expression:"Closed",Duration:2e3}],Mouth:[{Expression:"HalfOpen",Duration:2e3}],Blush:[{Skip:!0,Duration:1e3},{ExpressionModifier:1,Duration:1e3}]}},LongKiss:{Type:"LongKiss",Duration:4e3,Priority:200,Expression:{Eyes:[{Expression:"Closed",Duration:4e3}],Eyes2:[{Expression:"Closed",Duration:4e3}],Mouth:[{Expression:"Open",Duration:4e3}],Blush:[{Skip:!0,Duration:1e3},{ExpressionModifier:1,Duration:1e3},{ExpressionModifier:1,Duration:2e3}]}},Disoriented:{Type:"Disoriented",Duration:8e3,Priority:250,Expression:{Eyes:[{Expression:"Dizzy",Duration:8e3}],Eyes2:[{Expression:"Dizzy",Duration:8e3}],Eyebrows:[{Expression:"Raised",Duration:8e3}],Blush:[{ExpressionModifier:2,Duration:8e3}]}},Angry:{Type:"Angry",Duration:-1,Expression:{Mouth:[{Expression:"Angry",Duration:-1}],Eyes:[{Expression:"Angry",Duration:-1}],Eyes2:[{Expression:"Angry",Duration:-1}],Eyebrows:[{Expression:"Angry",Duration:-1}]}},Sad:{Type:"Sad",Duration:-1,Expression:{Mouth:[{Expression:"Frown",Duration:-1}],Eyes:[{Expression:"Shy",Duration:-1}],Eyes2:[{Expression:"Shy",Duration:-1}],Eyebrows:[{Expression:"Soft",Duration:-1}]}},Worried:{Type:"Worried",Duration:-1,Expression:{Eyes:[{Expression:"Surprised",Duration:-1}],Eyes2:[{Expression:"Surprised",Duration:-1}],Eyebrows:[{Expression:"Soft",Duration:-1}]}},Distressed:{Type:"Distressed",Duration:-1,Expression:{Eyes:[{Expression:"Scared",Duration:-1}],Eyes2:[{Expression:"Scared",Duration:-1}],Eyebrows:[{Expression:"Soft",Duration:-1}],Mouth:[{Expression:"Angry",Duration:-1}]}},Reset:{Type:"Reset",Duration:-1,Expression:{Mouth:[{Expression:null,Duration:-1}],Eyes:[{Expression:null,Duration:-1}],Eyes2:[{Expression:null,Duration:-1}],Eyebrows:[{Expression:null,Duration:-1}],Blush:[{Expression:null,Duration:-1}],Fluids:[{Expression:null,Duration:-1}]}},Cry:{Type:"Cry",Duration:-1,Expression:{Fluids:[{Expression:"TearsMedium",Duration:-1}]}},DroolReset:{Type:"DroolReset",Duration:-1,Expression:{Fluids:[{Expression:null,Duration:-1}]}},DroolSides:{Type:"DroolSides",Duration:-1,Expression:{Fluids:[{Expression:"DroolSides",Duration:-1}]}},BareTeeth:{Type:"BareTeeth",Duration:-1,Expression:{Mouth:[{Expression:"Angry",Duration:-1}]}},Happy:{Type:"Happy",Duration:-1,Expression:{Mouth:[{Expression:"Happy",Duration:-1}]}},Frown:{Type:"Frown",Duration:-1,Expression:{Mouth:[{Expression:"Frown",Duration:-1}]}},Glare:{Type:"Glare",Duration:-1,Expression:{Eyes:[{Expression:"Angry",Duration:-1}],Eyes2:[{Expression:"Angry",Duration:-1}],Eyebrows:[{Expression:"Harsh",Duration:-1}]}},NarrowEyes:{Type:"NarrowEyes",Duration:-1,Expression:{Eyes:[{Expression:"Horny",Duration:-1}],Eyes2:[{Expression:"Horny",Duration:-1}]}},OpenEyes:{Type:"OpenEyes",Duration:-1,Expression:{Eyes:[{Expression:null,Duration:-1}],Eyes2:[{Expression:null,Duration:-1}]}},CloseEyes:{Type:"CloseEyes",Duration:-1,Expression:{Eyes:[{Expression:"Closed",Duration:-1}],Eyes2:[{Expression:"Closed",Duration:-1}]}},CloseMouth:{Type:"CloseMouth",Duration:-1,Expression:{Mouth:[{Expression:null,Duration:-1}]}},OpenMouth:{Type:"OpenMouth",Duration:-1,Expression:{Mouth:[{Expression:"Moan",Duration:-1}]}},LipBite:{Type:"LipBite",Duration:-1,Expression:{Mouth:[{Expression:"LipBite",Duration:-1}]}},Lick:{Type:"Lick",Duration:4e3,Priority:200,Expression:{Mouth:[{Expression:"Ahegao",Duration:4e3}],Blush:[{ExpressionModifier:1,Duration:4e3}]}},GagInflate:{Type:"GagInflate",Duration:4e3,Priority:400,Expression:{Eyes:[{Expression:"Lewd",Duration:4e3}],Eyes2:[{Expression:"Lewd",Duration:4e3}],Blush:[{ExpressionModifier:2,Duration:2e3},{ExpressionModifier:-1,Duration:2e3}]}},Iced:{Type:"Iced",Duration:4e3,Priority:500,Expression:{Eyes:[{Expression:"Surprised",Duration:3e3},{Expression:null,Duration:1e3}],Eyes2:[{Expression:"Surprised",Duration:3e3},{Expression:null,Duration:1e3}],Mouth:[{Expression:"Angry",Duration:4e3}]}},AllFours:{Type:"AllFours",Duration:-1,Poses:[{Pose:["AllFours"],Duration:-1}]},SpreadKnees:{Type:"SpreadKnees",Duration:-1,Poses:[{Pose:["KneelingSpread"],Duration:-1}]},Hogtied:{Type:"Hogtied",Duration:-1,Poses:[{Pose:["Hogtied"],Duration:-1}]},Handstand:{Type:"Handstand",Duration:-1,Poses:[{Pose:["Suspension","OverTheHead"],Duration:-1}]},Stretch:{Type:"Stretch",Priority:100,Duration:6e3,Poses:[{Pose:["OverTheHead"],Duration:1e3},{Pose:["Yoked"],Duration:1e3},{Pose:["BaseUpper"],Duration:1e3},{Pose:["Spread"],Duration:1e3},{Pose:["LegsClosed"],Duration:1e3},{Pose:["BaseLower"],Duration:1e3}]},SpreadLegs:{Type:"SpreadLegs",Duration:-1,Poses:[{Pose:["Spread"],Duration:-1}]},JumpingJacks:{Type:"JumpingJacks",Priority:100,Duration:8e3,Poses:[{Pose:["OverTheHead","Spread"],Duration:1e3},{Pose:["BaseUpper","LegsClosed"],Duration:1e3},{Pose:["OverTheHead","Spread"],Duration:1e3},{Pose:["BaseUpper","LegsClosed"],Duration:1e3},{Pose:["OverTheHead","Spread"],Duration:1e3},{Pose:["BaseUpper","LegsClosed"],Duration:1e3},{Pose:["OverTheHead","Spread"],Duration:1e3},{Pose:["BaseUpper","LegsClosed"],Duration:1e3}]}},Cr=[{Event:"Blush",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemMouth-PoliteKiss$/u}]},{Event:"Stretch",Type:"Emote",Matchers:[{Tester:/^stretches (her|his|their) whole body/u}]},{Event:"JumpingJacks",Type:"Emote",Matchers:[{Tester:/^does jumping[ -]?jacks/u}]},{Event:"AllFours",Type:"Emote",Matchers:[{Tester:/^(gets on all fours|starts crawling)/u}]},{Event:"SpreadKnees",Type:"Emote",Matchers:[{Tester:/^spreads(( (her|his|their) legs)? on)? (her|his|their) knees/u}]},{Event:"SpreadLegs",Type:"Emote",Matchers:[{Tester:/^spreads (her|his|their) legs apart/u}]},{Event:"Handstand",Type:"Emote",Matchers:[{Tester:/^(does a handstand|stands on (her|his|their) hands)/u}]},{Event:"Hogtied",Type:"Emote",Matchers:[{Tester:/^lies( down)? on (the floor|(her|his|their) (tummy|stomach))/u}]},{Event:"Blush",Type:"Emote",Matchers:[{Tester:/^blushes/u}]},{Event:"Chuckle",Type:"Emote",Matchers:[{Tester:/^chuckles/u}]},{Event:"Laugh",Type:"Emote",Matchers:[{Tester:/^laughs/u}]},{Event:"Giggle",Type:"Emote",Matchers:[{Tester:/^giggles/u}]},{Event:"Smirk",Type:"Emote",Matchers:[{Tester:/^(smirk(s|ing)|.*with a smirk)/u}]},{Event:"Wink",Type:"Emote",Matchers:[{Tester:/^winks/u}]},{Event:"Pout",Type:"Emote",Matchers:[{Tester:/^pouts/u}]},{Event:"Blink",Type:"Emote",Matchers:[{Tester:/^blinks/u}]},{Event:"Frown",Type:"Emote",Matchers:[{Tester:/^frowns/u}]},{Event:"Grin",Type:"Emote",Matchers:[{Tester:/^(grins|is grinning)/u}]},{Event:"Confused",Type:"Emote",Matchers:[{Tester:/^((seems|looks) (confused|curious|suspicious)|raises an eyebrow)/u}]},{Event:"CloseMouth",Type:"Emote",Matchers:[{Tester:/^closes (her|his|their) mouth/u}]},{Event:"OpenMouth",Type:"Emote",Matchers:[{Tester:/^opens (her|his|their) mouth/u}]},{Event:"Happy",Type:"Emote",Matchers:[{Tester:/^(looks|seems|is|gets|smiles) happ(il)?y/u}]},{Event:"Smile",Type:"Emote",Matchers:[{Tester:/^smiles/u}]},{Event:"Distressed",Type:"Emote",Matchers:[{Tester:/^(looks|seems|is|gets) distressed/u}]},{Event:"Sad",Type:"Emote",Matchers:[{Tester:/^(looks|seems|is|gets) sad/u}]},{Event:"Worried",Type:"Emote",Matchers:[{Tester:/^(looks|seems|is|gets) (worried|surprised)/u}]},{Event:"BareTeeth",Type:"Emote",Matchers:[{Tester:/^(bares (her|his|their) teeth|snarls)/u}]},{Event:"Angry",Type:"Emote",Matchers:[{Tester:/^(looks angr(il)?y|(gets|is|seems) angry)/u}]},{Event:"Glare",Type:"Emote",Matchers:[{Tester:/^(glares|looks harshly|gives a (glare|harsh look))/u}]},{Event:"OpenEyes",Type:"Emote",Matchers:[{Tester:/^opens (her|his|their) eyes/u}]},{Event:"NarrowEyes",Type:"Emote",Matchers:[{Tester:/^((squints|narrows) (her|his|their) eyes|narrowly opens (her|his|their) eyes)/u}]},{Event:"CloseEyes",Type:"Emote",Matchers:[{Tester:/^closes (her|his|their) eyes/u}]},{Event:"ResetBrows",Type:"Emote",Matchers:[{Tester:/^lowers (her|his|their) eyebrows/u}]},{Event:"RaiseBrows",Type:"Emote",Matchers:[{Tester:/^raises (her|his|their) eyebrows/u}]},{Event:"DroolSides",Type:"Emote",Matchers:[{Tester:/^drools/u}]},{Event:"Cry",Type:"Emote",Matchers:[{Tester:/^(starts to cry|sheds .* tears?|eyes( start( to)?)? leak)/u}]},{Event:"Reset",Type:"Emote",Matchers:[{Tester:/^'s (expression|face) returns to normal/u}]},{Event:"Shock",Type:"Action",Matchers:[{Tester:/^(ActionActivityShockItem|FuturisticVibratorShockTrigger|FuturisticChastityBeltShock\w+|(TriggerShock|(ShockCollar|Collar(Auto)?ShockUnit|(LoveChastityBelt|SciFiPleasurePanties)Shock)Trigger)(1|2))$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:"ShockLight",Type:"Action",Matchers:[{Tester:/^(TriggerShock|(ShockCollar|Collar(Auto)?ShockUnit|(LoveChastityBelt|SciFiPleasurePanties)Shock)Trigger)0$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:"Hit",Type:"Action",Matchers:[{Tester:/^ActionActivitySpankItem$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:"Spank",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemButt-Spank$/u,Criteria:{TargetIsPlayer:!0}},{Tester:/^ChatSelf-ItemButt-Spank$/u}]},{Event:"Cuddle",Type:"Activity",Matchers:[{Tester:/^ChatOther-.*-Cuddle$/u},{Tester:/^ChatSelf-.*-Cuddle$/u}]},{Event:"Stimulated",Type:"Action",Matchers:[{Tester:/^ActionActivityMasturbateItem$/u,Criteria:{TargetIsPlayer:!0}}]},{Event:"StimulatedLong",Type:"Activity",Matchers:[{Tester:/^ChatOther-.*-(Masturbate|Penetrate).*$/u,Criteria:{TargetIsPlayer:!0}},{Tester:/^ChatSelf-.*-(Masturbate|Penetrate).*$/u}]},{Event:"KissOnLips",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemMouth-Kiss$/u}]},{Event:"Kiss",Type:"Activity",Matchers:[{Tester:/^ChatOther-.*-Kiss$/u,Criteria:{SenderIsPlayer:!0}}]},{Event:"Disoriented",Type:"Action",Matchers:[{Tester:/^(KneelDown|StandUp)Fail$/u}]},{Event:"LipBite",Type:"Activity",Matchers:[{Tester:/^ChatSelf-ItemMouth-Bite$/u}]},{Event:"Lick",Type:"Activity",Matchers:[{Tester:/^ChatOther-.*-(Lick|MasturbateTongue)$/u,Criteria:{SenderIsPlayer:!0}}]},{Event:"DroolReset",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemMouth-Caress$/u,Criteria:{TargetIsPlayer:!0}},{Tester:/^ChatSelf-ItemMouth-Caress$/u}]},{Event:"LongKiss",Type:"Activity",Matchers:[{Tester:/^ChatOther-ItemMouth-FrenchKiss$/u}]}];async function Er(){if(await _(()=>CurrentScreen==="ChatRoom"&&!!Player.ArousalSettings),!Player.ArousalSettings)throw new Error("Player.ArousalSettings is not defined");ne("StruggleMinigameHandleExpression",{'");':'", 3);'},"Resetting blush, eyes, and eyebrows after struggling");function e(){return!!c.animationEngine}globalThis.bceAnimationEngineEnabled=e,g.hookFunction("StruggleMinigameStop",b.ModifyBehaviourMedium,(C,x)=>(c.animationEngine&&(StruggleExpressionStore=void 0,V([a],[s])),x(C))),globalThis.bce_ArousalExpressionStages||(globalThis.bce_ArousalExpressionStages=fr);const t=Object.freeze({Blush:[null,"Low","Medium","High","VeryHigh","Extreme"]}),r="AutomatedByArousal",n="DEFAULT",a="GameTimer",s="ManualOverride",l="PostOrgasm",o=[];let i=0;function u(){return i=(i+1)%(Number.MAX_SAFE_INTEGER-1),i}const d={};function p(C){if(!C)return;switch(C.Type){case r:case l:if(!c.expressions)return;break;case s:break;default:if(!c.activityExpressions)return}const x=Date.now(),S=xe(C);if(S.At=x,S.Until=x+S.Duration,S.Id=u(),typeof S.Priority!="number"&&(S.Priority=1),S.Expression)for(const O of Object.values(S.Expression))for(const H of O)H.Id=u(),typeof H.Priority!="number"&&(H.Priority=1),typeof H.Duration!="number"&&(H.Duration=S.Duration);if(S.Poses)for(const O of S.Poses)O.Id=u(),typeof O.Priority!="number"&&(O.Priority=1);o.push(S)}globalThis.fbcPushEvent=p,globalThis.bce_EventExpressions||(globalThis.bce_EventExpressions=br),globalThis.bce_ActivityTriggers||(globalThis.bce_ActivityTriggers=Cr);function k(C){return C?.some(x=>x&&"TargetCharacter"in x&&x.TargetCharacter===Player.MemberNumber)||!1}pe("ChatRoomMessage",C=>{e:for(const x of globalThis.bce_ActivityTriggers.filter(S=>S.Type===C.Type)){if(Player.GhostList.includes(C.Sender))break;for(const S of x.Matchers)if(S.Tester.test(C.Content)){if(S.Criteria){if(S.Criteria.SenderIsPlayer&&C.Sender!==Player.MemberNumber||S.Criteria.TargetIsPlayer&&!k(C.Dictionary)||S.Criteria.DictionaryMatchers&&!S.Criteria.DictionaryMatchers.some(O=>C.Dictionary?.find(H=>Object.keys(O).every(Q=>O[Q]===H[Q]))))continue;p(globalThis.bce_EventExpressions[x.Event])}else if(C.Sender===Player.MemberNumber||k(C.Dictionary)){p(globalThis.bce_EventExpressions[x.Event]);break e}}}});function P(C){const x=Player.Appearance.find(S=>S.Asset.Group.Name===C)?.Property??null;return[x?.Expression||null,!x?.RemoveTimer]}function M(C,x,S){x||(x=null);for(const O of Player.Appearance)if(O.Asset.Group.Name===C){O.Property||(O.Property={}),O.Property.Expression=x,S&&(O.Color=S);break}}const w={BodyFull:{Conflicts:["BodyUpper","BodyLower"]},BodyUpper:{Conflicts:["BodyFull"]},BodyLower:{Conflicts:["BodyFull"]}};function v(C){return he(C)&&C in w}const m=["Eyes","Eyes2","Eyebrows","Mouth","Fluids","Emoticon","Blush","Pussy"];p({Type:s,Duration:-1,Expression:m.map(C=>{const[x]=P(C);return[C,x]}).filter(C=>C[1]!==null).map(C=>[C[0],[{Expression:C[1]}]]).reduce((C,x)=>({...C,[x[0]]:x[1]}),{})});let A=0,B=0,N=!1,L=Player.ArousalSettings;const R={None:0,Down:1,Up:2};let I=R.Up;function V(C,x=[]){if(delete Player.ExpressionQueue,o.push(...o.splice(0,o.length).map(S=>((C.includes(S.Type)||S.Duration<=0&&S.Type!==r&&!x.includes(S.Type))&&delete S.Expression,S))),!C.includes(s))p({Type:s,Duration:-1,Expression:Be(d).reduce((S,[O,H])=>({...S,[O]:[{Expression:H}]}),{})});else for(const[S]of Be(d))delete d[S]}CommandCombine([{Tag:"r",Description:h("[part of face or 'all']: resets expression overrides on part of or all of face"),Action:C=>{if(C.length===0||C==="all")V([s]),W(h("Reset all expressions"));else{const x=`${C[0].toUpperCase()}${C.substring(1).toLowerCase()}`;for(const S of o.map(O=>O.Expression).filter(Boolean))x==="Eyes"&&"Eyes2"in S&&delete S.Eyes2,x in S&&delete S[x];W(h("Reset expression on $component",{$component:x}))}}},{Tag:"anim",Description:h("['list' or name of emote]: run an animation"),Action:(C,x,S)=>{if(!c.activityExpressions){W(h("Activity expressions are not enabled in WCE settings. Unable to run animations."));return}S[0]==="list"&&W(h("Available animations: $anims",{$anims:Object.keys(globalThis.bce_EventExpressions).join(", ")}));const O=Object.keys(globalThis.bce_EventExpressions).find(H=>H.toLowerCase()===S[0]?.toLowerCase());O&&p(globalThis.bce_EventExpressions[O])}}]);function y(C){return PoseFemale3DCG.find(x=>x.Name===C)?.Category}function D(C){C=C.filter(S=>S).map(S=>S.toLowerCase()),o.forEach(S=>{S.Type===s?S.Poses=[]:S.Poses&&S.Poses.length>0&&S.Poses.forEach(O=>{if(O.Pose.length===0||typeof O.Pose[0]=="string")return;const H=O.Pose;O.Pose=H.filter(Q=>!!y(Q))})});const x=PoseFemale3DCG.filter(S=>C.includes(S.Name.toLowerCase())).map(S=>S.Name);for(const S of x)PoseSetActive(Player,S,!1)}CommandCombine({Tag:"pose",Description:h("['list' or list of poses]: set your pose"),Action:(C,x,S)=>{if(S[0]==="list"){const O=[...new Set(PoseFemale3DCG.map(H=>H.Category))];for(const H of O){const Q=PoseFemale3DCG.filter(Y=>Y.Category===H)?.map(Y=>Y.Name);Q.sort(),W(`=> ${H}:
${Q.join(`
`)}

`)}return}c.animationEngine||W(h("Warning: animation engine in WCE is disabled. Pose may not be synchronized or set. Enable animation engine in WCE settings.")),D(S)}}),ne("TimerInventoryRemove",{"CharacterSetFacialExpression(C, C.ExpressionQueue[0].Group, C.ExpressionQueue[0].Expression, undefined, undefined, true);":`if (bceAnimationEngineEnabled()) {
        fbcPushEvent({
          Type: "${a}",
          Duration: -1,
          Expression: {
            [C.ExpressionQueue[0].Group]: [{ Expression: C.ExpressionQueue[0].Expression, Duration: -1 }]
          }
        })
      } else {
        CharacterSetFacialExpression(C, C.ExpressionQueue[0].Group, C.ExpressionQueue[0].Expression, undefined, undefined, true);
      }`},"Game's timed expressions are not hooked to WCE's animation engine"),ne("ValidationSanitizeProperties",{"delete property.Expression;":`delete property.Expression;
      if (bceAnimationEngineEnabled()) {
        if (item?.Asset?.Group?.Name) {
          CharacterSetFacialExpression(C, item.Asset.Group.Name, null);
          console.warn("(WCE) Animation engine acknowledged validation-based expression removal for face component", item)
        } else {
          console.warn("Unable to determine asset group name for item", item);
        }
      }`},"Prevent animation engine from getting into an endless loop when another addon includes an invalid expression"),g.hookFunction("CharacterSetFacialExpression",b.OverrideBehaviour,(C,x)=>{let[S,O,H,Q,Y]=C;if(!ue(S)||!he(O)||!he(H)&&H!==null||!S.IsPlayer()||!c.animationEngine)return x(C);const j=typeof Q=="number"&&Q>0?Q*1e3:-1,oe={};let de=[];O==="Eyes"?de=["Eyes","Eyes2"]:O==="Eyes1"?de=["Eyes"]:de=[O],(!Y||!it(Y)||!CommonColorIsValid(Y))&&(Y=void 0);for(const re of de)oe[re]=[{Expression:H,Duration:j,Color:Y}],j<0&&(d[re]=H);return p({Type:s,Duration:j,Expression:oe}),U()});const F=["CharacterSetActivePose","PoseSetActive"];for(const C of F)g.hookFunction(C,b.OverrideBehaviour,(x,S)=>{const[O,H]=x;if(!ue(O)||!it(H)&&H!==null||!O.IsPlayer()||!c.animationEngine)return S(x);const Q={};return!H||Array.isArray(H)&&H.every(Y=>!Y)?Q.Pose=["BaseUpper","BaseLower"]:Q.Pose=[H],Q.Duration=-1,p({Type:s,Duration:-1,Poses:[Q]}),U()});pe("ChatRoomSyncPose",C=>{if(!(C===null||!le(C))){if(!Array.isArray(C.Pose)){K(`data.Pose in ChatRoomSyncPose for ${C.MemberNumber?.toString()} is not an array`);return}c.animationEngine&&C.MemberNumber===Player.MemberNumber&&D(C.Pose)}}),pe("ChatRoomSyncSingle",C=>{C===null||!le(C)||c.animationEngine&&C.Character?.MemberNumber===Player.MemberNumber&&D(C.Character.ActivePose??[])}),V([s,a]);function U(){if(!c.animationEngine||!Player?.AppearanceLayers)return;if(Player.Appearance.filter(T=>m.includes(T.Asset.Group.Name)&&T.Property?.RemoveTimer).forEach(T=>{delete T.Property.RemoveTimer}),!Player.ArousalSettings){K("Player.ArousalSettings is not defined");return}Player.ArousalSettings.AffectExpression=!1;const C=Player.ArousalSettings.OrgasmCount??0;B<C?B=C:B>C&&(Player.ArousalSettings.OrgasmCount=B,ActivityChatRoomArousalSync(Player));let x=!0;for(const T of m)P(T)[0]&&(x=!1);if(x){if(L.Progress=0,I=R.Up,!N)for(const T of o)T.Type!==r&&(T.Expression={});N=!0}else N=!1;const S=Player.ArousalSettings.Progress;let O=I;S<L.Progress?O=R.Down:S>L.Progress&&(O=R.Up),I=O;function H(){const T=Player.ArousalSettings?.OrgasmCount||0,G=Math.min(300,60+T*5),q=(Date.now()-A)/1e4|0;return q>G?0:Math.min(Math.max(0,90-S),30*(G-q)/G)}const Q=2;L.OrgasmStage!==Q&&Player.ArousalSettings.OrgasmStage===Q&&o.filter(T=>T.Type===l).length===0&&(p(globalThis.bce_EventExpressions.PostOrgasm),A=Date.now());const Y={};let j={};const oe={};function de(T,G,q,z){const X=G.Priority||q.Priority||0;(!oe[z]||(oe[z].Priority??0)<=X)&&(oe[z]={Id:G.Id,Expression:T,Duration:G.Duration,Priority:X,Color:G.Color})}for(let T=0;T<o.length;T++){const G=o[T],q=G.Until??0,z=G.At??0;let X=!1;if(q>Date.now()||q-z<0){const ee=G.Expression??{};if(Object.keys(ee).length>0)for(const J of Object.keys(ee)){let te=Date.now()-z;for(let ge=0;ge<ee[J].length;ge++){const ie=ee[J][ge];if(te-=ie.Duration,te<0||ie.Duration<0){if(X=!0,!ie.Skip)if(ie.ExpressionModifier&&J in t){const[be]=P(J);if(ie.Applied)de(be,ie,G,J);else{let ke=t[J].indexOf(be)+ie.ExpressionModifier;ke>=t[J].length?ke=t[J].length-1:ke<0&&(ke=0),de(t[J][ke],ie,G,J),o[T].Expression[J][ge].Applied=!0}}else de(ie.Expression??null,ie,G,J);break}}}if(G.Poses?.length){let J=Date.now()-z;for(const te of G.Poses)if(J-=te.Duration,J<0||te.Duration<0){X=!0;for(const ge of te.Pose){const ie=te.Priority||G.Priority||0,be=y(ge);if(!be){K(`Pose ${ge} has no category`);continue}te.Id||(K(`Pose ${ge} has no ID`),te.Id=u()),(!j[be]||j[be].Priority<=ie)&&(j[be]={Id:te.Id,Pose:ge,Category:be,Duration:te.Duration,Priority:ie,Type:G.Type})}break}}}if(!X){const ee=o.splice(T,1);if(T--,!c.expressions&&ee.length>0&&ee[0].Expression)for(const J of Object.keys(ee[0].Expression))de(null,{Duration:-1},{Priority:0,Type:n,Duration:500},J)}}for(let T=0;T<o.length;T++){const G=o[T].Expression,q=o[T].Poses;if(G)for(const z of Object.keys(G)){if(!oe[z]||oe[z].Duration>0)continue;const X=Ae(oe[z].Id),ee=Ae(oe[z].Priority,0);for(let J=0;J<G[z].length;J++){const te=G[z][J];te.Duration<0&&(Ae(te.Id)<X||Ae(te.Priority,0)<ee)&&(G[z].splice(J,1),J--)}G[z].length===0&&delete G[z]}if(q)for(let z=0;z<q.length;z++){const X=q[z],ee=X.Pose.every(J=>{const te=y(J);return!!te&&j[te]?.Duration<0&&j[te]?.Id>Ae(X.Id)&&(j[te]?.Type===s||o[T].Type!==s)});X.Duration<0&&ee&&(q.splice(z,1),z--)}Object.keys(o[T].Expression||{}).length===0&&o[T].Poses?.length===0&&(o.splice(T,1),T--)}let re=!1,De=!1;if(Player.ActivePose)for(let T=0;T<Player.ActivePose.length;T++){const G=Player.ActivePose[T];!PoseFemale3DCG.find(q=>q.Name===G)?.Category&&Object.values(j).every(q=>q.Pose!==G)&&(De=[...Player.ActivePose],De.splice(T,1),T--,re=!0)}e:for(const T of Object.keys(globalThis.bce_ArousalExpressionStages)){const[G]=P(T);let q=null,z=!1;for(const X of globalThis.bce_ArousalExpressionStages[T]){const ee=X.Limit-(O===R.Up?0:1);if(S+H()>=ee)if(X.Expression!==G){q=X.Expression,z=!0;break}else continue e}if(z){const X={};X[T]=[{Expression:q,Duration:-1,Priority:0}],p({Type:r,Duration:-1,Priority:0,Expression:X})}}for(const T of m){const[G]=P(T),q=oe[T]||{Duration:-1,Expression:null};q.Expression!==G&&typeof q.Expression<"u"&&(Y[T]={...q})}if(Object.keys(Y).length>0){for(const T of Object.keys(Y))Se?.getRuleState("block_changing_emoticon")?.isEnforced&&T==="Emoticon"||(M(T,Y[T].Expression??null,Y[T].Color),ServerSend("ChatRoomCharacterExpressionUpdate",{Name:Y[T].Expression??null,Group:T,Appearance:ServerAppearanceBundle(Player.Appearance)}));re=!0}function kt(){const T=Math.max(...Object.values(j).map(X=>X.Priority)),G=Be(j).filter(X=>X[1].Priority===T);let q="";if(G.length>1){const X=Math.max(...G.map(ee=>ee[1].Id));[[q]]=G.filter(ee=>ee[1].Id===X)}else{if(G.length===0)return 0;[[q]]=G}let z=0;if(v(q)){const X=w[q].Conflicts||[];for(const ee of Array.from(X).filter(J=>J in j))delete j[ee],z++}return z}for(;kt()>0;);Object.keys(j).length===0&&(j={BodyUpper:{Pose:"BaseUpper",Duration:-1,Id:u(),Priority:0,Type:n},BodyLower:{Pose:"BaseLower",Duration:-1,Id:u(),Priority:0,Type:n}});const Ft=/^Base(Lower|Upper)$/u,ot=Object.values(j).map(T=>T.Pose).filter(T=>!Ft.test(T));JSON.stringify(Player.ActivePose)!==JSON.stringify(ot)&&(De=ot,re=!0),De&&(Player.ActivePose=De,ServerSend("ChatRoomCharacterPoseUpdate",{Pose:De})),re&&CharacterRefresh(Player,!1,!1),L={...Player.ArousalSettings}}Ee(U,250)}async function Ar(){await _(()=>!!ServerSocket&&ServerIsConnected),Player.BCEArousalProgress=Math.min(Le,Player.ArousalSettings?.Progress??0),Player.BCEEnjoyment=1;const e=.2;pe("ChatRoomSyncArousal",t=>{if(t.MemberNumber===Player.MemberNumber)return;const r=ChatRoomCharacter.find(n=>n.MemberNumber===t.MemberNumber);r&&queueMicrotask(()=>{if(r.BCEArousalProgress=Math.min(Le,t.Progress||0),!r?.ArousalSettings){K("No arousal settings found for",r);return}r.ArousalSettings.Progress=Math.round(r.BCEArousalProgress)})}),ne("ActivitySetArousalTimer",{"if (Progress > 0 && (C.ArousalSettings.Progress + Progress) > Max)\n		Progress = (Max - C.ArousalSettings.Progress >= 0) ? Max - C.ArousalSettings.Progress : 0;":`
      if (!C.BCEArousal) {
        if ((Progress > 0) && (C.ArousalSettings.Progress + Progress > Max)) Progress = (Max - C.ArousalSettings.Progress >= 0) ? Max - C.ArousalSettings.Progress : 0;
      } else {
        if (Max === 100) Max = 105;
        const fromMax = Max - (C.BCEArousal ? C.BCEArousalProgress : C.ArousalSettings.Progress);
        if (Progress > 0 && fromMax < Progress) {
          if (fromMax <= 0) {
            Progress = 0;
          } else if (C.BCEArousal) {
            Progress = Math.floor(fromMax / ${e} / (C.BCEEnjoyment || 1));
          } else {
            Progress = fromMax;
          }
        }
      }
    `,"if (Progress < -25) Progress = -25;":`
      if (!C.BCEArousal) {
        if (Progress < -25) Progress = -25;
      } else {
        if (Progress < -20) Progress = -20;
      }
      `,"if (Progress > 25) Progress = 25;":`
      if (!C.BCEArousal) {
        if (Progress > 25) Progress = 25;
      } else {
        if (Progress > 20) Progress = 20;
      }
      `},"Alternate arousal algorithm will be incorrect."),g.hookFunction("ActivityChatRoomArousalSync",b.Observe,(t,r)=>{const[n]=t;if(ue(n)&&n.IsPlayer()&&CurrentScreen==="ChatRoom"){const a={Type:Ne,Content:qe,Dictionary:[{message:{type:Pe.ArousalSync,version:ve,alternateArousal:c.alternateArousal,progress:n.BCEArousalProgress,enjoyment:n.BCEEnjoyment}}]};ServerSend("ChatRoomChat",a)}return r(t)}),g.hookFunction("ActivitySetArousal",b.AddBehaviour,(t,r)=>{const[n,a]=t,s=r(t);return ue(n)&&typeof a=="number"&&Math.abs(n.BCEArousalProgress-a)>3&&(n.BCEArousalProgress=Math.min(Le,a)),s}),g.hookFunction("ActivitySetArousalTimer",b.AddBehaviour,(t,r)=>{const[n,,,a]=t;return ue(n)&&typeof a=="number"&&(n.BCEEnjoyment=1+(a>1?Math.round(Math.log2(a)):0)),r(t)}),g.hookFunction("ActivityTimerProgress",b.AddBehaviour,(t,r)=>{const[n,a]=t;if(ue(n)&&typeof a=="number"&&(n.BCEArousalProgress||(n.BCEArousalProgress=0),n.BCEEnjoyment||(n.BCEEnjoyment=1),n.BCEArousalProgress+=a*(a>0?n.BCEEnjoyment*e:1),n.BCEArousalProgress=Math.min(Le,n.BCEArousalProgress),n.BCEArousal)){if(!n.ArousalSettings)throw new Error(`No arousal settings found for ${n.Name}`);return n.ArousalSettings.Progress=Math.round(n.BCEArousalProgress),t[1]=0,r(t)}return r(t)}),ne("TimerProcess",{"// If the character is egged, we find the highest intensity factor and affect the progress, low and medium vibrations have a cap\n							let Factor = -1;":`
      let Factor = -1;
      if (Character[C].BCEArousal) {
        let maxIntensity = 0;
        let vibes = 0;
        let noOrgasmVibes = 0;
        for (let A = 0; A < Character[C].Appearance.length; A++) {
          let Item = Character[C].Appearance[A];
          let ZoneFactor = PreferenceGetZoneFactor(Character[C], Item.Asset.ArousalZone) - 2;
          if (InventoryItemHasEffect(Item, "Egged", true) && typeof Item.Property?.Intensity === "number" && !isNaN(Item.Property.Intensity) && Item.Property.Intensity >= 0 && ZoneFactor >= 0) {
            if (Item.Property.Intensity >= 0) {
              vibes++;
              if (!PreferenceGetZoneOrgasm(Character[C], Item.Asset.ArousalZone)) {
                noOrgasmVibes++;
              }
              maxIntensity = Math.max(Item.Property.Intensity, maxIntensity);
              Factor += Item.Property.Intensity + ZoneFactor + 1;
            }
          }
        }
        // Adds the fetish value to the factor
        if (Factor >= 0) {
          var Fetish = ActivityFetishFactor(Character[C]);
          if (Fetish > 0) Factor = Factor + Math.ceil(Fetish / 3);
          if (Fetish < 0) Factor = Factor + Math.floor(Fetish / 3);
        }

        let maxProgress = 100;
        switch (maxIntensity) {
          case 0:
            maxProgress = 40 + vibes * 5;
            break;
          case 1:
            maxProgress = 70 + vibes * 5;
            break;
          default:
            maxProgress = vibes === 0 || vibes > noOrgasmVibes ? 100 : 95;
            break;
        }
        const topStepInterval = 2;
        let stepInterval = topStepInterval;
        if (Factor < 0) {
          ActivityVibratorLevel(Character[C], 0);
        } else {
          if (Factor < 1) {
            ActivityVibratorLevel(Character[C], 1);
            maxProgress = Math.min(maxProgress, 35);
            stepInterval = 5;
          } else if (Factor < 2) {
            ActivityVibratorLevel(Character[C], 1);
            maxProgress = Math.min(maxProgress, 65);
            stepInterval = 4;
          } else if (Factor < 3) {
            maxProgress = Math.min(maxProgress, 95);
            stepInterval = 3;
            ActivityVibratorLevel(Character[C], 2);
          } else {
            ActivityVibratorLevel(Character[C], Math.min(4, Math.floor(Factor)));
          }
          if (maxProgress === 100) {
            maxProgress = 105;
          }
          let maxIncrease = maxProgress - Character[C].ArousalSettings.Progress;
          if (TimerLastArousalProgressCount % stepInterval === 0 && maxIncrease > 0) {
            Character[C].BCEEnjoyment = 1 + (Factor > 1 ? Math.round(1.5*Math.log2(Factor)) : 0);
            ActivityTimerProgress(Character[C], 1);
          }
        }
      } else {
      `,"if ((Factor == -1)) {ActivityVibratorLevel(Character[C], 0);}\n\n						}":`if (Factor == -1) {
          ActivityVibratorLevel(Character[C], 0);
        }
      }
    } else {
      ActivityVibratorLevel(Character[C], 0);
    }
    `,"// No decay if there's a vibrating item running":`// No decay if there's a vibrating item running
    Character[C].BCEEnjoyment = 1;`},"Alternative arousal algorithm will be incorrect.")}async function vr(){await _(()=>!!ServerSocket&&ServerIsConnected),pe("ChatRoomSyncMemberJoin",e=>{c.ghostNewUsers&&Date.now()-e.Character.Creation<3e4&&(ChatRoomListManipulation(Player.BlackList,!0,e.Character.MemberNumber.toString()),Player.GhostList||(Player.GhostList=[]),ChatRoomListManipulation(Player.GhostList,!0,e.Character.MemberNumber.toString()),f("Blacklisted",e.Character.Name,CharacterNickname(CharacterLoadOnline(e.Character,e.SourceMemberNumber)),e.Character.MemberNumber,"registered",(Date.now()-e.Character.Creation)/1e3,"seconds ago"))})}async function Sr(){await _(()=>!!Player&&!!Player.Appearance);function e(){const t=["Glasses1","Glasses2","Glasses3","Glasses4","Glasses5","Glasses6","SunGlasses1","SunGlasses2","SunGlassesClear","CatGlasses","VGlasses","GradientSunglasses","FuturisticVisor","InteractiveVisor","InteractiveVRHeadset","FuturisticMask","Goggles"];Player.Appearance.find(r=>t.includes(r.Asset.Name))?ze("BlurLight")&&W(h("Having recovered your glasses you can see again!")):lt("BlurLight")&&W(h("Having lost your glasses your eyesight is impaired!"))}g.hookFunction("CharacterAppearanceBuildCanvas",b.Observe,(t,r)=>(c.blindWithoutGlasses&&t[0].IsPlayer()&&e(),r(t)))}const Pt=Object.freeze({FriendList:"FriendList"});async function wr(){await _(()=>!!Player&&ServerSocket&&ServerIsConnected);function e(){!c.friendPresenceNotifications&&!c.instantMessenger||CurrentScreen==="FriendList"||CurrentScreen==="Relog"||CurrentScreen==="Login"||ServerSend("AccountQuery",{Query:"OnlineFriends"})}Ee(e,2e4);let t=[];pe("AccountQueryResult",r=>{if(CurrentScreen==="FriendList"||CurrentScreen==="Relog"||CurrentScreen==="Login"||!c.friendPresenceNotifications||r.Query!=="OnlineFriends")return;const n=r.Result.map(l=>l.MemberNumber),a=t.map(l=>l.MemberNumber).filter(l=>!n.includes(l)),s=n.filter(l=>!t.some(o=>o.MemberNumber===l));if(s.length){const l=s.map(o=>{const{MemberNumber:i,MemberName:u}=r.Result.find(d=>d.MemberNumber===o)??{MemberName:"",MemberNumber:-1};return`${u} (${i})`}).join(", ");c.friendNotificationsInChat&&CurrentScreen==="ChatRoom"?W(h("Now online: $list",{$list:l})):$e(h("Now online: $list",{$list:l}),5e3,{ClickAction:Pt.FriendList})}if(c.friendOfflineNotifications&&a.length){const l=a.map(o=>{const{MemberNumber:i,MemberName:u}=t.find(d=>d.MemberNumber===o)??{MemberName:"",MemberNumber:-1};return`${u} (${i})`}).join(", ");c.friendNotificationsInChat&&CurrentScreen==="ChatRoom"?W(h("Now offline: $list",{$list:l})):$e(h("Now offline: $list",{$list:l}),5e3,{ClickAction:Pt.FriendList})}t=r.Result})}function Dr(){const e=new Map;function t(a,s){return!s.Name||!s.Property?.LockedBy?!0:s.Property?.LockMemberNumber!==a.MemberNumber?(f("Bad lock member number",s.Property?.LockMemberNumber,"from",a.MemberNumber),!1):!0}function r(a,s,l,o,i){const u={changed:0,prohibited:!1};if(a.IsPlayer())return u;const d=`${CharacterNickname(a)} (${a.MemberNumber??"-1"})`;function p(P){if(!P)return P;const M=xe(P);return M&&(M.Property&&(o&&(delete M.Property.LockMemberNumber,delete M.Property.LockedBy,delete M.Property.RemoveTimer,delete M.Property.Effect),delete M.Property.BlinkState),i&&delete M.Color,M)}function k(){(a?.Reputation?.find(P=>P.Type==="Dominant")?.Value??0)>=50||a.Title==="Mistress"||a.MemberNumber===Player.Ownership?.MemberNumber||Player.Lovership?.some(P=>P.MemberNumber===a.MemberNumber)||((s?.Property?.LockedBy==="MistressPadlock"&&l?.Property?.LockedBy!=="MistressPadlock"||s?.Property?.LockedBy==="MistressTimerPadlock"&&l?.Property?.LockedBy!=="MistressTimerPadlock")&&(f("Not a mistress attempting to remove mistress lock",d),u.prohibited=!0),(s?.Property?.LockedBy!=="MistressPadlock"&&l?.Property?.LockedBy==="MistressPadlock"||s?.Property?.LockedBy!=="MistressTimerPadlock"&&l?.Property?.LockedBy==="MistressTimerPadlock")&&(f("Not a mistress attempting to add mistress lock",d),u.prohibited=!0),s?.Property?.LockedBy==="MistressTimerPadlock"&&Math.abs(Ae(s.Property?.RemoveTimer,Number.MAX_SAFE_INTEGER)-Ae(l?.Property?.RemoveTimer))>31*60*1e3&&(u.prohibited=!0,f("Not a mistress attempting to change mistress lock timer more than allowed by public entry",d)))}return l&&l.Property?.LockMemberNumber!==s?.Property?.LockMemberNumber&&(t(a,l)||(u.prohibited=!0)),k(),l=p(l),s=p(s),JSON.stringify(l)!==JSON.stringify(s)&&(f(d,"changed",JSON.stringify(s),"to",JSON.stringify(l),"changes:",u),u.changed++),u}function n(a){if(typeof a.MemberNumber!="number")throw new Error("change from invalid source character with no member number");const s=`${CharacterNickname(a)} (${a.MemberNumber??"-1"})`;f("Rejected changes from",s),W(h(`[Anti-Cheat] ${s} tried to make suspicious changes! Appearance changes rejected. Consider telling the user to stop, whitelisting the user (if trusted friend), or blacklisting the user (if the behaviour continues, chat command: "/blacklistadd ${a.MemberNumber}").`));const l=e.get(a.MemberNumber)||0;Date.now()-l>1e3*60*10&&(e.set(a.MemberNumber,Date.now()),Te(h(`A magical shield on ${CharacterNickname(Player)} repelled the suspiciously magical changes attempted by ${s}! [WCE Anti-Cheat]`))),c.antiCheatBlackList&&!Player.WhiteList.includes(a.MemberNumber)&&!Player.BlackList.includes(a.MemberNumber)&&(ChatRoomListManipulation(Player.BlackList,!0,a.MemberNumber.toString()),W(h(`[AntiCheat] ${s} blacklisted.`))),ChatRoomCharacterUpdate(Player)}g.hookFunction("ChatRoomSyncItem",b.OverrideBehaviour,(a,s)=>{const[l]=a;if(!c.itemAntiCheat)return s(a);const o=l?.Item;if(o?.Target!==Player.MemberNumber||Player.WhiteList.includes(l.Source))return s(a);const i=ChatRoomCharacter.find(P=>P.MemberNumber===l.Source)||(l.Source===Player.MemberNumber?Player:null);if(!i)throw new Error("change from invalid source character not in the current room");const u=Player.Appearance.some(P=>P.Asset.Name==="FuturisticCollar"),d=Player.Appearance.some(P=>P.Asset.Name==="FuturisticHarness")||u,p=Player.Appearance.find(P=>P.Asset.Group.Name===o.Group),k=p?ServerAppearanceBundle([p])[0]:null;return r(i,k,o,u,d).prohibited?(n(i),null):s(a)}),g.hookFunction("ChatRoomSyncSingle",b.OverrideBehaviour,(a,s)=>{const[l]=a;if(!c.itemAntiCheat||!l?.Character||l.Character.MemberNumber!==Player.MemberNumber||Player.WhiteList.includes(l.SourceMemberNumber))return s(a);const o=ChatRoomCharacter.find(w=>w.MemberNumber===l.SourceMemberNumber)||(l.SourceMemberNumber===Player.MemberNumber?Player:null);if(!o)throw new Error("change from invalid source character not in the current room");if(o.IsPlayer())return s(a);function i(w){const v=new Map;return w.reduce((m,A)=>(A=xe(A),delete A.Color,m.set(`${A.Group}/${A.Name}`,A),m),v)}const u=i(ServerAppearanceBundle(Player.Appearance.filter(w=>w.Asset.Group.Category==="Item")));if(!l.Character.Appearance)throw new Error("no appearance data in sync single");const d=i(l.Character.Appearance.filter(w=>ServerBundledItemToAppearanceItem("Female3DCG",w)?.Asset.Group.Category==="Item")),p=Array.from(u.values()).some(w=>w.Name==="FuturisticCollar")&&Array.from(d.values()).some(w=>w.Name==="FuturisticCollar"),k=Array.from(u.values()).some(w=>w.Name==="FuturisticHarness")&&Array.from(d.values()).some(w=>w.Name==="FuturisticHarness")||p;f("Anti-Cheat validating bulk change from",o.MemberNumber);const P=Array.from(d.keys()).reduce((w,v)=>{const m=d.get(v);if(!m)throw new Error("this should never happen: newItem is null inside map loop");if(!u.has(v))return t(o,m)||(w.prohibited=!0),w.new++,w;const A=u.get(v)??null,B=r(o,A,m,p,k);return w.prohibited=w.prohibited||B.prohibited,w.changed+=B.changed,w},{new:0,changed:0,prohibited:!1}),M=Array.from(u.keys()).reduce((w,v)=>d.has(v)?w:w+1,0);return P.new+P.changed+M>2||P.prohibited?(f("Anti-Cheat tripped on bulk change from",o.MemberNumber,P,M),n(o),null):s(a)})}function xr(){ne("ChatSearchQuery",{"// Prevent spam searching the same thing.":`if (ChatRoomJoinLeash) { SearchData.Language = ""; }
	// Prevent spam searching the same thing.`},"Leashing between language filters")}function Br(){function e(y){return y.split("\uF124")[0].trimEnd()}globalThis.bceStripBeepMetadata=e;const t=document.createElement("div");t.classList.add("bce-hidden"),t.id="bce-instant-messenger";const r=document.createElement("div");r.id="bce-message-left-container";const n=document.createElement("div");n.id="bce-friend-list";const a=document.createElement("div");a.id="bce-message-right-container";const s=document.createElement("div");s.id="bce-message-container";const l=document.createElement("textarea");l.id="bce-message-input",l.setAttribute("maxlength","2000"),l.addEventListener("keydown",y=>{y.stopPropagation()});const o=document.createElement("input");o.id="bce-friend-search",o.setAttribute("placeholder",h("Search for a friend")),o.autocomplete="off",o.addEventListener("keydown",y=>{y.stopPropagation()});const i="bce-friend-list-handshake-completed",u="bce-friend-list-handshake-false";t.appendChild(r),t.appendChild(a),r.appendChild(o),r.appendChild(n),a.appendChild(s),a.appendChild(l),document.body.appendChild(t);function d(){return`bce-instant-messenger-state-${Player.AccountName.toLowerCase()}`}let p=-1,k=0,P=!1;const M=new Map;function w(){const y=M.get(p);y&&(y.history.scrollTop=y.history.scrollHeight)}function v(){const y={};M.forEach((D,F)=>{if(D.historyRaw.length===0)return;const U=Math.min(D.historyRaw.length,100);y[F]={historyRaw:D.historyRaw.slice(-U)}}),localStorage.setItem(d(),JSON.stringify(y))}function m(y){const D=M.get(y);l.disabled=!D?.online,s.innerHTML="";for(const U of M.values())U.listElement.classList.remove("bce-friend-list-selected");D&&(D.listElement.classList.add("bce-friend-list-selected"),D.listElement.classList.remove("bce-friend-list-unread"),s.appendChild(D.history),D.unread=0);const F=M.get(p);if(F){const U=F.history.querySelector(".bce-message-divider");U&&F.history.removeChild(U)}L(),p=y,w()}function A(y,D,F,U,C){const x=M.get(y);if(!x||F.BeepType)return;const S=ce(F.Message?.split(`
`).find(re=>re.startsWith("\uF124"))?.substring(1)??"{}")??{messageType:"Message"};S.messageType||(S.messageType="Message");const O=["Message","Emote","Action"].includes(S.messageType)?S.messageType:"Message",H=S?.messageColor??"#ffffff",Q=F.Message?.split(`
`).filter(re=>!re.startsWith("\uF124")).join(`
`).trimEnd();if(!Q){f("skipped empty beep",y,F,D,U);return}const Y=x.history.scrollHeight-x.history.scrollTop-x.history.clientHeight<1,j=document.createElement("div");j.classList.add("bce-message"),j.classList.add(D?"bce-message-sent":"bce-message-received"),j.classList.add(`bce-message-${O}`),j.setAttribute("data-time",C.toLocaleString());const oe=D?CharacterNickname(Player):F.MemberName??"<Unknown>";switch(O){case"Emote":j.textContent=`*${oe}${Q}*`;break;case"Action":j.textContent=`*${Q}*`;break;case"Message":{const re=document.createElement("span");re.classList.add("bce-message-sender"),H&&(re.style.color=H),re.textContent=`${oe}: `,j.appendChild(re),j.appendChild(document.createTextNode(Q))}break;default:j.textContent=Q;break}if(!Player.MemberNumber)throw new Error("Player.MemberNumber is invalid");let de=Player.MemberNumber;if(!D){if(!F.MemberNumber)throw new Error("beep.MemberNumber is invalid");de=F.MemberNumber}if(!U){if(x.historyRaw.push({author:oe,authorId:de,message:Q,type:O,color:H,createdAt:Date.now()}),x.listElement.setAttribute("data-last-updated",Date.now().toString()),y!==p&&(x.listElement.classList.add("bce-friend-list-unread"),x.unread++),x.unread===1&&(t.classList.contains("bce-hidden")||y!==p)){const re=document.createElement("div");re.classList.add("bce-message-divider"),x.history.appendChild(re)}t.classList.contains("bce-hidden")&&k++}Oe(j,Y?w:()=>null),x.history.appendChild(j),Y&&w(),v()}function B(y){let D=M.get(y);if(!D){const F={statusText:document.createElement("span"),listElement:document.createElement("div"),historyRaw:[],history:document.createElement("div"),unread:0,online:!1};F.listElement.id=`bce-friend-list-entry-${y}`,F.listElement.classList.add("bce-friend-list-entry"),F.listElement.onclick=()=>{m(y)},F.history.classList.add("bce-friend-history");const U=document.createElement("div");U.classList.add("bce-friend-list-entry-name"),U.textContent=Player.FriendNames?.get(y)||"",F.listElement.appendChild(U);const C=document.createElement("div");C.classList.add("bce-friend-list-entry-member-number"),C.textContent=y.toString(),F.listElement.appendChild(C),F.listElement.appendChild(F.statusText),n.appendChild(F.listElement),M.set(y,F),D=F}return D}function N(){P=!0;const y=ce(localStorage.getItem(d())||"{}");for(const[D,F]of Be(y)){const U=parseInt(D),C=B(U);C.historyRaw=F.historyRaw;for(const x of F.historyRaw)A(U,x.authorId===Player.MemberNumber,{Message:`${x.message}

\uF124${JSON.stringify({messageType:x.type,messageColor:x.color})}`,MemberNumber:x.authorId,MemberName:x.author},!0,x.createdAt?new Date(x.createdAt):new Date(0)),x.createdAt&&C.listElement.setAttribute("data-last-updated",x.createdAt.toString())}}l.addEventListener("keydown",y=>{if(y.key==="Enter"&&!y.shiftKey){if(y.preventDefault(),Se?.getRuleState("speech_restrict_beep_send")?.isEnforced&&!c.allowIMBypassBCX){$e(h("Sending beeps is currently restricted by BCX rules"));return}let D=l.value;if(D.trim()==="")return;l.value="";let F="Message";D.startsWith("/me ")?(D=D.substring(4),/^[', ]/u.test(D)||(D=` ${D}`),F="Emote"):D.startsWith("/action ")?(D=D.substring(8),F="Action"):/^\*[^*]/u.test(D)?(D=D.substring(1),/^[', ]/u.test(D)||(D=` ${D}`),F="Emote"):D.startsWith("**")&&(D=D.substring(2),F="Action");const U={BeepType:"",MemberNumber:p,IsSecret:!0,Message:`${D}

\uF124${JSON.stringify({messageType:F,messageColor:Player.LabelColor})}`};A(p,!0,U,!1,new Date),FriendListBeepLog.push({...U,MemberName:Player.FriendNames?.get(p)||"aname",Sent:!0,Private:!1,Time:new Date}),ServerSend("AccountBeep",U)}}),o.onkeyup=()=>{const y=o.value.toLowerCase();for(const D of M.keys()){const F=M.get(D);if(!F)throw new Error("this should never happen, friend is null in map loop");const U=Player.FriendNames?.get(D)?.toLowerCase();y===""?F.listElement.classList.remove("bce-hidden"):!D.toString().includes(y)&&!U?.includes(y)?F.listElement.classList.add("bce-hidden"):F.listElement.classList.remove("bce-hidden")}L()},pe("AccountQueryResult",y=>{if(y.Query==="OnlineFriends"&&y.Result&&c.instantMessenger){for(const D of y.Result){const F=B(D.MemberNumber);F.online=!0,F.statusText.textContent=h("Online"),F.listElement.classList.remove(u),F.listElement.classList.add(i)}for(const D of Array.from(M.keys()).filter(F=>!y.Result.some(U=>U.MemberNumber===F))){const F=M.get(D);if(!F)throw new Error("this should never happen, f is null in map loop");F.online=!1,F.statusText.textContent=h("Offline"),F.listElement.classList.remove(i),F.listElement.classList.add(u)}y.Result.some(D=>D.MemberNumber===p)?l.disabled=!1:l.disabled=!0}});function L(){[...n.children].sort((y,D)=>{const F=!y.classList.contains(i),U=!D.classList.contains(i);if(F&&U||!F&&!U){const C=y.getAttribute("data-last-updated")??"",x=D.getAttribute("data-last-updated")??"",S=/^\d+$/u.test(C)?parseInt(C):0;return(/^\d+$/u.test(x)?parseInt(x):0)-S}return F?1:-1}).forEach(y=>{n.removeChild(y),n.appendChild(y)})}g.hookFunction("ServerAccountBeep",b.OverrideBehaviour,(y,D)=>{const[F]=y;F&&le(F)&&!F.BeepType&&c.instantMessenger&&(P||N(),A(F.MemberNumber,!1,F,!1,new Date)),D(y)}),g.hookFunction("ServerSend",b.Observe,(y,D)=>{const[F,U]=y;if(F!=="AccountBeep")return D(y);const C=U;return!C?.BeepType&&he(C?.Message)&&!C.Message.includes("\uF124")&&(P||N(),A(C.MemberNumber,!0,C,!1,new Date)),D(y)});const R=[126,905,60,60];g.hookFunction("DrawProcess",b.AddBehaviour,(y,D)=>{D(y),c.instantMessenger&&(!c.allowIMBypassBCX&&(Se?.getRuleState("speech_restrict_beep_receive")?.isEnforced||Se?.getRuleState("alt_hide_friends")?.isEnforced&&Player.GetBlindLevel()>=3)?(t.classList.contains("bce-hidden")||V(),DrawButton(...R,"","Gray","Icons/Small/Chat.png",h("Instant Messenger (Disabled by BCX)"),!1)):DrawButton(...R,"",k?"Red":"White","Icons/Small/Chat.png",h("Instant Messenger"),!1))}),g.hookFunction("CommonClick",b.OverrideBehaviour,(y,D)=>{if(c.instantMessenger&&MouseIn(...R)){if(!t.classList.contains("bce-hidden")){V();return}P||N(),L(),t.classList.toggle("bce-hidden"),ServerSend("AccountQuery",{Query:"OnlineFriends"}),k=0,w(),NotificationReset("Beep");return}D(y)}),g.hookFunction("NotificationRaise",b.ModifyBehaviourHigh,(y,D)=>(y[0]==="Beep"&&y[1]?.body&&(y[1].body=e(y[1].body)),D(y)));function I(y){c.instantMessenger&&y.key==="Escape"&&!t.classList.contains("bce-hidden")&&(V(),y.stopPropagation(),y.preventDefault())}function V(){t.classList.add("bce-hidden"),l.blur(),o.blur()}document.addEventListener("keydown",I,!0),document.addEventListener("keypress",I,!0)}function Pr(){const e=["CharacterSetActivePose","PoseSetActive"];for(const t of e)g.hookFunction(t,b.Top,(r,n)=>c.discreetMode?null:n(r));g.hookFunction("DrawImageEx",b.Top,(t,r)=>{if(c.discreetMode){if(!t)return!1;const n=he(t[0])&&t[0].startsWith("Backgrounds/"),a=/(^Backgrounds\/(?!Sheet(White)?|grey|White\.|BrickWall\.)|\b(Kneel|Arousal|Activity|Asylum|Cage|Cell|ChangeLayersMouth|Diaper|Kidnap|Logo|Player|Remote|Restriction|SpitOutPacifier|Struggle|Therapy|Orgasm\d|Poses|HouseVincula|Seducer\w+)\b|^data:|^Assets\/(?!Female3DCG\/Emoticon\/(Afk|Sleep|Read|Gaming|Hearing|Thumbs(Up|Down))\/))/u;if(he(t[0])&&a.test(t[0]))return n?(t[0]="Backgrounds/BrickWall.jpg",r(t)):!1;if(t[0]?.src&&a.test(t[0].src))return!1}return r(t)}),g.hookFunction("ChatRoomCharacterViewDraw",b.Top,(t,r)=>{if(c.discreetMode){let n;const a=DrawGetCustomBackground(Player);if(a)n=`Backgrounds/${a}.jpg`;else{if(ChatRoomCustomized&&ChatRoomCustomBackground)return!1;n=`Backgrounds/${ChatRoomData.Background}.jpg`}if(/(^Backgrounds\/(?!Sheet(White)?|grey|White\.|BrickWall\.)|\b(Kneel|Arousal|Activity|Asylum|Cage|Cell|ChangeLayersMouth|Diaper|Kidnap|Logo|Player|Remote|Restriction|SpitOutPacifier|Struggle|Therapy|Orgasm\d|Poses|HouseVincula|Seducer\w+)\b|^data:|^Assets\/(?!Female3DCG\/Emoticon\/(Afk|Sleep|Read|Gaming|Hearing|Thumbs(Up|Down))\/))/u.test(n)){const s=ChatRoomCharacterViewCharacterCount,l=ChatRoomCharacterViewCharactersPerRow,o=ChatRoomCharacterViewWidth,i=ChatRoomCharacterViewHeight,u={inverted:Player.GraphicsSettings.InvertRoom&&Player.IsInverted(),blur:Player.GetBlurLevel(),darken:DrawGetDarkFactor(),tints:Player.GetTints(),sizeMode:ChatRoomCustomSizeMode};ChatRoomCharacterViewLoopCharacters((d,p,k,P,M)=>{if(d%l===0){const w=s<=l?i*(1-M)/2:0,v=RectMakeRect(0,w+d*100,o,i*M);DrawRoomBackground("Backgrounds/BrickWall.jpg",v,u)}DrawCharacter(ChatRoomCharacterDrawlist[d],p,k,M),DrawStatus(ChatRoomCharacterDrawlist[d],p,k,M),ChatRoomCharacterDrawlist[d].MemberNumber!=null&&ChatRoomCharacterViewDrawOverlay(ChatRoomCharacterDrawlist[d],p,k,M)})}}return r(t)}),g.hookFunction("NotificationTitleUpdate",b.Top,(t,r)=>{if(c.discreetMode){const n=NotificationGetTotalCount(1);document.title=`${n>0?`(${n}) `:""}${h("OnlineChat")}`;return}return r(t)})}function kr(){g.hookFunction("StruggleFlexibilityCheck",b.OverrideBehaviour,(e,t)=>c.autoStruggle&&StruggleProgressFlexCircles&&StruggleProgressFlexCircles.length>0?(StruggleProgressFlexCircles.splice(0,1),!0):t(e)),Ee(()=>{c.autoStruggle&&(typeof StruggleProgress!="number"||StruggleProgress<0||(StruggleProgressCurrentMinigame==="Strength"?StruggleStrengthProcess(!1):StruggleProgressCurrentMinigame==="Flexibility"&&StruggleProgressFlexCircles&&StruggleProgressFlexCircles.length>0&&StruggleFlexibilityProcess(!1)))},60),Ee(()=>{c.autoStruggle&&(typeof StruggleProgress!="number"||StruggleProgress<0||StruggleProgressCurrentMinigame==="Dexterity"&&Math.max(-.5,Math.min(1,(85-Math.abs(StruggleProgressDexTarget-StruggleProgressDexCurrent))/75))>.5&&StruggleDexterityProcess())},0)}function Fr(){c.leashAlways?ut():ct()}async function Mr(){if(!c.pastProfiles)return;const{Dexie:e}=await import("./dexie.js"),t=new e("bce-past-profiles");t.version(3).stores({profiles:"memberNumber, name, lastNick, seen, characterBundle",notes:"memberNumber, note, updatedAt"}),ElementCreateTextArea("bceNoteInput");const r=document.getElementById("bceNoteInput");r.maxLength=1e4,r.classList.add("bce-hidden");const n=t.table("profiles"),a=t.table("notes");async function s(){try{const{quota:v,usage:m}=await navigator.storage.estimate();return f(`current quota usage ${m?.toLocaleString()??"?"} out of maximum ${v?.toLocaleString()??"?"}`),{quota:v??-1,usage:m??0}}catch(v){return se("reading storage quota information",v),{quota:-1,usage:-1}}}async function l(v){let m=await n.toArray();m.sort((A,B)=>A.seen-B.seen),m=m.slice(0,v),f("deleting",m),await n.bulkDelete(m.map(A=>A.memberNumber))}async function o(){const{quota:v,usage:m}=await s();m/v>.9&&(ye(`storage quota above 90% utilization (${m}/${v}), cleaning some of the least recently seen profiles before saving new one`),await l(10))}async function i(v){await o();const m=v.Name,A=v.Nickname,B=["ActivePose","Inventory","BlockItems","LimitedItems","FavoriteItems","ArousalSettings","OnlineSharedSettings","WhiteList","BlackList","Crafting"];for(const N of B)delete v[N];f(`saving profile of ${A??m} (${m})`);try{await n.put({memberNumber:v.MemberNumber,name:m,lastNick:A,seen:Date.now(),characterBundle:JSON.stringify(v)})}catch(N){const{quota:L,usage:R}=await s();se(`unable to save profile (${R}/${L}):`,N)}}g.hookFunction("ChatRoomSync",b.Top,(v,m)=>{const[A]=v;if(A?.Character?.length)for(const B of A.Character)i(xe(B));m(v)}),g.hookFunction("ChatRoomSyncSingle",b.Top,(v,m)=>{const[A]=v;A?.Character?.MemberNumber&&i(xe(A.Character)),m(v)}),g.hookFunction("InformationSheetRun",b.AddBehaviour,(v,m)=>{if(!InformationSheetSelection)throw new Error("InformationSheetSelection is null in InformationSheetRun");if(InformationSheetSelection.BCESeen){const A=window.MainCanvas.getContext("2d");if(!A)throw new Error("could not get canvas 2d context");A.textAlign="left",DrawText(h("Last seen: ")+new Date(InformationSheetSelection.BCESeen).toLocaleString(),1200,75,"grey","black"),A.textAlign="center"}return m(v)});async function u(v){try{const m=await n.get(v),A=CharacterLoadOnline(ce(m.characterBundle),v);A.BCESeen=m.seen,CurrentScreen==="ChatRoom"&&(ChatRoomHideElements(),ChatRoomData&&(ChatRoomBackground=ChatRoomData.Background)),InformationSheetLoadCharacter(A)}catch(m){W(h("No profile found")),se("reading profile",m)}}CommandCombine({Tag:"profiles",Description:h("<filter> - List seen profiles, optionally searching by member number or name"),Action:v=>{(async m=>{let A=await n.toArray();A=A.filter(I=>!m||I.name.toLowerCase().includes(m)||I.memberNumber.toString().includes(m)||I.lastNick?.toLowerCase().includes(m)),A.sort((I,V)=>V.seen-I.seen);const B=A.length;A=A.slice(0,100),A.sort((I,V)=>-(V.lastNick??V.name).localeCompare(I.lastNick??I.name));const N=A.map(I=>{const V=document.createElement("div");V.textContent=h("$nickAndName ($memberNumber) - Seen: $seen",{$nickAndName:I.lastNick?`${I.lastNick} / ${I.name}`:I.name,$memberNumber:I.memberNumber.toString(),$seen:new Date(I.seen).toLocaleDateString()});const y=document.createElement("a");return y.textContent=h("Open"),y.href="#",y.classList.add("bce-profile-open"),y.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation(),u(I.memberNumber)}),V.prepend(y),V}),L=document.createElement("h3");L.textContent=h("Saved Profiles"),L.style.marginTop="0";const R=document.createElement("div");R.textContent=h("showing $num most recent of $total total profiles matching search",{$num:A.length.toLocaleString(),$total:B.toLocaleString()}),W([L,...N,R])})(v)}});let d=!1,p=0;function k(v){return le(v)&&typeof v.note=="string"}function P(){if(!InformationSheetSelection?.MemberNumber)throw new Error("invalid InformationSheetSelection in notes");d=!0,r.classList.remove("bce-hidden"),r.value="Loading...",a.get(InformationSheetSelection.MemberNumber).then(v=>{if(k(v))r.value=v?.note||"",p=v?.updatedAt||0;else throw new Error("invalid note")}).catch(v=>{r.value="",se("getting note",v)})}g.hookFunction("CharacterLoadOnline",b.Top,(v,m)=>{const A=m(v);return ue(A)&&A.MemberNumber&&a.get(A.MemberNumber).then(B=>{A.FBCNoteExists=!!(k(B)&&B.note)}),A});function M(){r.classList.add("bce-hidden"),d=!1}function w(v){v.key==="Escape"&&d&&(M(),v.stopPropagation(),v.preventDefault())}document.addEventListener("keydown",w,!0),document.addEventListener("keypress",w,!0),g.hookFunction("OnlineProfileRun",b.OverrideBehaviour,(v,m)=>d?(DrawText(h("Personal notes (only you can read these):"),910,105,"Black","Gray"),p&&_e(h("Last saved: $date",{$date:new Date(p).toLocaleString()}),60,105,400,"Black","Gray"),ElementPositionFix("bceNoteInput",36,100,160,1790,750),DrawButton(1720,60,90,90,"","White","Icons/Accept.png",TextGet("LeaveSave")),DrawButton(1820,60,90,90,"","White","Icons/Cancel.png",TextGet("LeaveNoSave")),null):(DrawButton(1620,60,90,90,"","White","Icons/Notifications.png",h("[WCE] Notes")),m(v))),g.hookFunction("OnlineProfileClick",b.OverrideBehaviour,(v,m)=>{if(d){MouseIn(1720,60,90,90)?(o().then(()=>{if(!InformationSheetSelection?.MemberNumber)throw new Error("invalid InformationSheetSelection in notes");return a.put({memberNumber:InformationSheetSelection.MemberNumber,note:r.value,updatedAt:Date.now()})}),M()):MouseIn(1820,60,90,90)&&M();return}else!d&&MouseIn(1620,60,90,90)&&P();m(v)}),navigator.storage?.persisted&&!await navigator.storage.persisted()&&(await navigator.storage.persist()||K("Profile storage may not be persistent."))}function Tr(){function e(r,n,a){return Array.isArray(r)||(r=[]),r.push({Tag:n,Text:a}),r}let t=0;g.hookFunction("ChatRoomMessage",b.Observe,(r,n)=>{const a=n(r);if(c.pendingMessages&&r?.length&&at(r[0])&&Array.isArray(r[0].Dictionary)){const[s]=r,l=s.Dictionary?.find?.(o=>o.Tag==="fbc_nonce");if(l){const o=document.querySelector(`[data-nonce='${l.Text}']`);o&&o.remove()}}return a}),g.hookFunction("ServerSend",b.AddBehaviour,(r,n)=>{if(c.pendingMessages&&r?.length>=2&&r[0]==="ChatRoomChat"&&at(r[1])&&r[1].Type!==Ne&&!r[1].Target){t++,t>=Number.MAX_SAFE_INTEGER&&(t=0),r[1].Dictionary=e(r[1].Dictionary,"fbc_nonce",t);const a=document.createElement("div");switch(a.classList.add("ChatMessage","bce-pending"),a.setAttribute("data-time",ChatRoomCurrentTime()),a.setAttribute("data-sender",Player.MemberNumber?.toString()),a.setAttribute("data-nonce",t.toString()),r[1].Type){case"Chat":{a.classList.add("ChatMessageChat");const i=document.createElement("span");i.classList.add("ChatMessageName"),i.style.color=Player.LabelColor||"",i.textContent=CharacterNickname(Player),a.appendChild(i),a.appendChild(document.createTextNode(`: ${r[1].Content}`))}break;case"Emote":case"Action":a.classList.add("ChatMessageEmote"),a.appendChild(document.createTextNode(`*${r[1].Type==="Emote"?`${CharacterNickname(Player)}: `:""}${r[1].Content}*`));break;default:return n(r)}const s=document.createElement("div");s.classList.add("lds-ellipsis");for(let i=0;i<4;i++){const u=document.createElement("div");s.appendChild(u)}a.appendChild(s);const l=ElementIsScrolledToEnd("TextAreaChatLog"),o=document.getElementById("TextAreaChatLog");o&&(o.appendChild(a),l&&ElementScrollToEnd("TextAreaChatLog"))}return n(r)})}function Lr(){g.hookFunction("DrawCharacter",b.ModifyBehaviourLow,(e,t)=>{const[r]=e;if(!r||!c.hideHiddenItemsIcon)return t(e);const n=r.HasHiddenItems;r.HasHiddenItems=!1;const a=t(e);return r.HasHiddenItems=n,a})}function Ir(){const e="DescriptionInput",t="bceRichOnlineProfile";let r=!0;function n(){const u=document.getElementById(e);u&&(r=!1,u.style.display="none")}function a(){const u=document.getElementById(e);u&&(r=!0,u.style.display="")}function s(){n();const u=document.createElement("div");u.id=t,u.style.overflowY="scroll",u.style.overflowX="hidden",u.style.overflowWrap="break-word",u.style.whiteSpace="pre-wrap",u.style.background="rgb(244, 236, 216)",u.style.color="rgb(45, 35, 27)",u.style.border="2px solid black",u.style.padding="2px",u.classList.add("bce-rich-textarea"),u.textContent=InformationSheetSelection?.Description||"",Oe(u,()=>!1),document.body.append(u),l()}function l(){ElementPositionFix(t,36,100,160,1790,750)}function o(){const u=document.getElementById(t);u&&u.remove(),a()}g.hookFunction("OnlineProfileLoad",b.ModifyBehaviourMedium,(u,d)=>{r=!0;const p=d(u),k=document.getElementById(e);return!c.richOnlineProfile||!k||s(),p}),g.hookFunction("ChatRoomHideElements",b.ModifyBehaviourMedium,(u,d)=>(o(),d(u)));const i=[90,60,90,90];g.hookFunction("OnlineProfileRun",b.ModifyBehaviourMedium,(u,d)=>{if(!c.richOnlineProfile)return d(u);DrawButton(...i,"","White","Icons/Crafting.png",h("Toggle Editing Mode"));const p=d(u);return r||(n(),l()),p}),g.hookFunction("OnlineProfileClick",b.ModifyBehaviourMedium,(u,d)=>c.richOnlineProfile&&MouseIn(...i)?(r?s():o(),!0):d(u)),g.hookFunction("OnlineProfileUnload",b.ModifyBehaviourMedium,(u,d)=>(r||o(),d(u)))}async function Nr(){await _(()=>Array.isArray(Commands)&&Commands.length>0);const e=[1485,15,90,90],t=[1585,15,90,90];function r(){FUSAM.modals.open({prompt:h("Paste the craft here"),input:{initial:"",readonly:!1,type:"textarea"},callback:(n,a)=>{if(!(n!=="submit"||!a))try{const s=ce(LZString.decompressFromBase64(a));if(!le(s))throw se(s),new Error(`invalid craft type ${typeof s} ${a}`);for(const[l,o]of Be(s))!he(o)&&!Number.isInteger(o)&&o!==!1&&o!==!0&&o!==null&&!le(o)&&K("potentially invalid craft bundle:",l,"was",o);CraftingSelectedItem=CraftingConvertItemToSelected(s),CraftingModeSet("Name")}catch(s){se("importing craft",s)}}})}GameVersion==="R107"&&(g.hookFunction("CraftingClick",b.AddBehaviour,(n,a)=>{if(CraftingMode==="Name")if(MouseIn(...t)){const s=LZString.compressToBase64(JSON.stringify(CraftingConvertSelectedToItem()));FUSAM.modals.open({prompt:h("Copy the craft here"),input:{initial:s,readonly:!0,type:"textarea"},callback:()=>{f("exported craft")}}),navigator.clipboard.writeText(s)}else MouseIn(...e)&&r();return a(n)}),g.hookFunction("CraftingRun",b.ModifyBehaviourMedium,(n,a)=>{const s=a(n);return CraftingMode==="Name"&&(DrawButton(...e,h("Import"),"white"),DrawButton(...t,h("Export"),"white")),s})),g.hookFunction("DrawItemPreview",b.AddBehaviour,(n,a)=>{const s=a(n),[l,,o,i]=n;if(l){const{Craft:u}=l;MouseIn(o,i,DialogInventoryGrid.itemWidth,DialogInventoryGrid.itemHeight)&&u&&(Me(o,i,DialogInventoryGrid.itemWidth,h(u.Property),"center"),Me(1e3,i-70,975,`${h("Description:")} ${CraftingDescription.Decode(u.Description)||"<no description>"}`,"left"))}return s})}function Rr(){let e=!1,t=!1;g.hookFunction("DrawArousalMeter",b.Observe,(r,n)=>{const[a]=r;e=!!a.ArousalZoom;const s=(a.ArousalSettings?.ProgressTimer??0)>0,l=(a.ArousalSettings?.VibratorLevel??0)>0,o=a.ArousalSettings?.Progress??0,i=(a.IsEdged()||a.HasEffect("DenialMode"))&&o>=95;t=s||l&&!i;const u=n(r);return e=!1,u}),g.hookFunction("DrawArousalThermometer",b.Observe,(r,n)=>{const a=n(r);if(c.numericArousalMeter&&e){const[s,l,o,i]=r;let u="white";i>=95?t?u="red":u="hotpink":i>=70&&(u="pink"),DrawTextFit(i.toLocaleString()+(t?"\u2191":" "),s+50*o,l-30*o,100*o,u,"black")}return a})}function Wr(){ServerCharacterNicknameRegex=/^[\p{L}0-9\p{Z}'-]+$/u}function Or(){_(()=>ServerIsConnected&&ServerPlayerIsInChatRoom()),we(null,!0),Ee(()=>{const e=bcModSdk.getModsInfo();c.shareAddons&&JSON.stringify(e)!==JSON.stringify(Player.FBCOtherAddons)&&ServerIsConnected&&ServerPlayerIsInChatRoom()&&(Player.FBCOtherAddons=e,we(null,!0))},5e3)}function $r(){window.addEventListener("beforeunload",e=>{if(Z.client?.connected)for(const t of Z.client.devices.filter(r=>r.vibrateAttributes.length>0))t.vibrate(0);return c.confirmLeave?(e.preventDefault(),ServerSocket.io.disconnect(),CommonSetScreen("Character","Relog"),ServerSocket.io.connect(),e.returnValue="Are you sure you want to leave the club?"):null},{capture:!0})}function Gr(){const e={};g.hookFunction("ChatRoomMessageDisplay",b.AddBehaviour,(t,r)=>(c.whisperTargetFixes&&t[0].Type==="Action"&&t[0].Sender===ChatRoomTargetMemberNumber&&(["ServerLeave","ServerBan","ServerKick","ServerDisconnect"].some(n=>t[0].Content.startsWith(n))?e[t[0].Sender]=window.setTimeout(()=>{ChatRoomSetTarget(-1),ChatRoomSendLocal('<span style="color: red">[WCE] Your whisper target was cleared, because they left the room for more than a minute!</span>')},60*1e3):t[0].Content.startsWith("ServerEnter")&&e[t[0].Sender]&&(window.clearTimeout(e[t[0].Sender]),delete e[t[0].Sender])),r(t))),ne("ChatRoomSendChat",{'ChatRoomSendLocal(`<span style="color: red">${TextGet("WhisperTargetGone")}</span>`);':`ChatRoomSendLocal('<span style="color: red">' + TextGet("WhisperTargetGone") + " Resetting to talk to everyone now!</span>");
        if(fbcSettingValue("whisperTargetFixes")) ChatRoomSetTarget(-1);
        `},"Resetting blush, eyes, and eyebrows after struggling")}async function Hr(){await _(()=>AssetFemale3DCG?.some(e=>e.Group==="Pronouns")),AssetFemale3DCG.find(e=>e.Group==="Pronouns").Asset.forEach(e=>e.AllowEffect=[E.Leash,E.BlurLight]),await _(()=>Player?.Appearance?.some(e=>e.Asset.Group.Name==="Pronouns")),Player.Appearance.find(e=>e.Asset.Group.Name==="Pronouns").Asset.AllowEffect=[E.Leash,E.BlurLight]}const Ue=[];async function $(e,t){Ue.push(t);try{const r=e();r instanceof Promise&&await r,Ue.splice(Ue.indexOf(t),1)}catch(r){const n=r;se(`Error in ${t}: ${n?.toString()}
${n?.stack??""}`)}}async function Ur(){let e="init";g.hookFunction("LoginResponse",b.Top,(t,r)=>(e==="init"&&(e="disable"),r(t))),g.hookFunction("LoginStatusReset",b.Top,(t,r)=>(e==="disable"&&(e="init"),r(t))),g.hookFunction("GameRun",b.Top,(t,r)=>e==="disable"?(GameAnimationFrameId=requestAnimationFrame(GameRun),null):r(t)),g.hookFunction("GameRunBackground",b.Top,(t,r)=>e==="disable"?null:r(t)),await $(nr,"functionIntegrityCheck"),$(or,"wceStyles"),$(sr,"commonPatches"),$(zt,"extendedWardrobe"),$(Hr,"allowCustomEffect"),$(hr,"automaticReconnect"),$(Ht,"hiddenMessageHandler"),await $(Zt,"bceLoadSettings"),$(Yt,"postSettings"),$(Wt,"appendSocketListenersToInit"),f(c),$(Pr,"discreetMode"),$(lr,"beepImprovements"),$(cr,"settingsPage"),$(Ar,"alternateArousal"),$(Xt,"chatAugments"),$(Er,"automaticExpressions"),$(pr,"layeringMenu"),$(mr,"cacheClearer"),$(dr,"lockpickHelp"),$(ur,"commands"),$(gr,"chatRoomOverlay"),$(yr,"privateWardrobe"),$(Jt,"antiGarbling"),$(vr,"autoGhostBroadcast"),$(Sr,"blindWithoutGlasses"),$(wr,"friendPresenceNotifications"),$(Gt,"forcedClubSlave"),$(Br,"instantMessenger"),$(kr,"autoStruggle"),$(Wr,"nicknames"),$(Fr,"leashAlways"),$(Ut,"toySync"),$(Mr,"pastProfiles"),$(Tr,"pendingMessages"),$(Lr,"hideHiddenItemsIcon"),$(Nr,"crafting"),$(Dr,"itemAntiCheat"),$(xr,"leashFix"),$(Ot,"hookBCXAPI"),$(Kt,"customContentDomainCheck"),$(Rr,"numericArousalMeters"),$(Ir,"richOnlineProfile"),$(Or,"shareAddons"),$($r,"confirmLeave"),$(Gr,"chatRoomWhisperFixes"),e="enable"}if(await _(()=>typeof FUSAM=="object"&&FUSAM?.present&&typeof bcModSdk=="object"&&!!bcModSdk),globalThis.FBC_VERSION)throw new Error("FBC already loaded. Skipping load.");if(typeof ChatRoomCharacter>"u")throw new Error("Bondage Club not detected. Skipping WCE initialization.");GameVersion=new URLSearchParams(location.hash.slice(1)).get("version")??GameVersion,globalThis.FBC_VERSION=ve,globalThis.fbcDisplayText=h,globalThis.fbcChatNotify=W,globalThis.fbcSendAction=Te,globalThis.fbcSettingValue=tr,globalThis.bce_initializeDefaultExpression=()=>null,globalThis.fbcDebug=He,FUSAM.registerDebugMethod("WCE",()=>He(!1)),await Ur(),await $e(`Wholesome Club Extensions v${globalThis.FBC_VERSION} loaded!`),Player.FBC=ve,window.addEventListener("error",e=>{Fe("error",e.message,`${e.filename} (${e.lineno}:${e.colno})`,e.error)});
//# sourceMappingURL=wce.js.map
