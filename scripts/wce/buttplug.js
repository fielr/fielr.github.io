var e=typeof globalThis<`u`?globalThis:typeof window<`u`?window:typeof global<`u`?global:typeof self<`u`?self:{};function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,`default`)?e.default:e}var n={exports:{}};(function(e){var t=Object.prototype.hasOwnProperty,n=`~`;function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,r,a,o){if(typeof r!=`function`)throw TypeError(`The listener must be a function`);var s=new i(r,a||e,o),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],s]:e._events[c].push(s):(e._events[c]=s,e._eventsCount++),e}function o(e,t){--e._eventsCount===0?e._events=new r:delete e._events[t]}function s(){this._events=new r,this._eventsCount=0}s.prototype.eventNames=function(){var e=[],r,i;if(this._eventsCount===0)return e;for(i in r=this._events)t.call(r,i)&&e.push(n?i.slice(1):i);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(r)):e},s.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,a=r.length,o=Array(a);i<a;i++)o[i]=r[i].fn;return o},s.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},s.prototype.emit=function(e,t,r,i,a,o){var s=n?n+e:e;if(!this._events[s])return!1;var c=this._events[s],l=arguments.length,u,d;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,r),!0;case 4:return c.fn.call(c.context,t,r,i),!0;case 5:return c.fn.call(c.context,t,r,i,a),!0;case 6:return c.fn.call(c.context,t,r,i,a,o),!0}for(d=1,u=Array(l-1);d<l;d++)u[d-1]=arguments[d];c.fn.apply(c.context,u)}else{var f=c.length,p;for(d=0;d<f;d++)switch(c[d].once&&this.removeListener(e,c[d].fn,void 0,!0),l){case 1:c[d].fn.call(c[d].context);break;case 2:c[d].fn.call(c[d].context,t);break;case 3:c[d].fn.call(c[d].context,t,r);break;case 4:c[d].fn.call(c[d].context,t,r,i);break;default:if(!u)for(p=1,u=Array(l-1);p<l;p++)u[p-1]=arguments[p];c[d].fn.apply(c[d].context,u)}}return!0},s.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},s.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},s.prototype.removeListener=function(e,t,r,i){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return o(this,a),this;var s=this._events[a];if(s.fn)s.fn===t&&(!i||s.once)&&(!r||s.context===r)&&o(this,a);else{for(var c=0,l=[],u=s.length;c<u;c++)(s[c].fn!==t||i&&!s[c].once||r&&s[c].context!==r)&&l.push(s[c]);l.length?this._events[a]=l.length===1?l[0]:l:o(this,a)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&o(this,t)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,e.exports=s})(n);var r=n.exports;const i=t(r);var a=(e=>(e[e.Off=0]=`Off`,e[e.Error=1]=`Error`,e[e.Warn=2]=`Warn`,e[e.Info=3]=`Info`,e[e.Debug=4]=`Debug`,e[e.Trace=5]=`Trace`,e))(a||{}),o=class{constructor(e,t){let n=new Date,r=n.getHours(),i=n.getMinutes(),a=n.getSeconds();this.timestamp=`${r}:${i}:${a}`,this.logMessage=e,this.logLevel=t}get Message(){return this.logMessage}get LogLevel(){return this.logLevel}get Timestamp(){return this.timestamp}get FormattedMessage(){return`${a[this.logLevel]} : ${this.timestamp} : ${this.logMessage}`}};const s=class e extends i{constructor(){super(),this.maximumConsoleLogLevel=0,this.maximumEventLogLevel=0}static get Logger(){return e.sLogger===void 0&&(e.sLogger=new e),this.sLogger}get MaximumConsoleLogLevel(){return this.maximumConsoleLogLevel}set MaximumConsoleLogLevel(e){this.maximumConsoleLogLevel=e}get MaximumEventLogLevel(){return this.maximumEventLogLevel}set MaximumEventLogLevel(e){this.maximumEventLogLevel=e}Error(e){this.AddLogMessage(e,1)}Warn(e){this.AddLogMessage(e,2)}Info(e){this.AddLogMessage(e,3)}Debug(e){this.AddLogMessage(e,4)}Trace(e){this.AddLogMessage(e,5)}AddLogMessage(e,t){if(t>this.maximumEventLogLevel&&t>this.maximumConsoleLogLevel)return;let n=new o(e,t);t<=this.maximumConsoleLogLevel&&console.log(n.FormattedMessage),t<=this.maximumEventLogLevel&&this.emit(`log`,n)}};s.sLogger=void 0;let c=s;var l;(function(e){e[e.PLAIN_TO_CLASS=0]=`PLAIN_TO_CLASS`,e[e.CLASS_TO_PLAIN=1]=`CLASS_TO_PLAIN`,e[e.CLASS_TO_CLASS=2]=`CLASS_TO_CLASS`})(l||={});var u=function(){function e(){this._typeMetadatas=new Map,this._transformMetadatas=new Map,this._exposeMetadatas=new Map,this._excludeMetadatas=new Map,this._ancestorsMap=new Map}return e.prototype.addTypeMetadata=function(e){this._typeMetadatas.has(e.target)||this._typeMetadatas.set(e.target,new Map),this._typeMetadatas.get(e.target).set(e.propertyName,e)},e.prototype.addTransformMetadata=function(e){this._transformMetadatas.has(e.target)||this._transformMetadatas.set(e.target,new Map),this._transformMetadatas.get(e.target).has(e.propertyName)||this._transformMetadatas.get(e.target).set(e.propertyName,[]),this._transformMetadatas.get(e.target).get(e.propertyName).push(e)},e.prototype.addExposeMetadata=function(e){this._exposeMetadatas.has(e.target)||this._exposeMetadatas.set(e.target,new Map),this._exposeMetadatas.get(e.target).set(e.propertyName,e)},e.prototype.addExcludeMetadata=function(e){this._excludeMetadatas.has(e.target)||this._excludeMetadatas.set(e.target,new Map),this._excludeMetadatas.get(e.target).set(e.propertyName,e)},e.prototype.findTransformMetadatas=function(e,t,n){return this.findMetadatas(this._transformMetadatas,e,t).filter(function(e){return!e.options||e.options.toClassOnly===!0&&e.options.toPlainOnly===!0?!0:e.options.toClassOnly===!0?n===l.CLASS_TO_CLASS||n===l.PLAIN_TO_CLASS:e.options.toPlainOnly===!0?n===l.CLASS_TO_PLAIN:!0})},e.prototype.findExcludeMetadata=function(e,t){return this.findMetadata(this._excludeMetadatas,e,t)},e.prototype.findExposeMetadata=function(e,t){return this.findMetadata(this._exposeMetadatas,e,t)},e.prototype.findExposeMetadataByCustomName=function(e,t){return this.getExposedMetadatas(e).find(function(e){return e.options&&e.options.name===t})},e.prototype.findTypeMetadata=function(e,t){return this.findMetadata(this._typeMetadatas,e,t)},e.prototype.getStrategy=function(e){var t=this._excludeMetadatas.get(e),n=t&&t.get(void 0),r=this._exposeMetadatas.get(e),i=r&&r.get(void 0);return n&&i||!n&&!i?`none`:n?`excludeAll`:`exposeAll`},e.prototype.getExposedMetadatas=function(e){return this.getMetadata(this._exposeMetadatas,e)},e.prototype.getExcludedMetadatas=function(e){return this.getMetadata(this._excludeMetadatas,e)},e.prototype.getExposedProperties=function(e,t){return this.getExposedMetadatas(e).filter(function(e){return!e.options||e.options.toClassOnly===!0&&e.options.toPlainOnly===!0?!0:e.options.toClassOnly===!0?t===l.CLASS_TO_CLASS||t===l.PLAIN_TO_CLASS:e.options.toPlainOnly===!0?t===l.CLASS_TO_PLAIN:!0}).map(function(e){return e.propertyName})},e.prototype.getExcludedProperties=function(e,t){return this.getExcludedMetadatas(e).filter(function(e){return!e.options||e.options.toClassOnly===!0&&e.options.toPlainOnly===!0?!0:e.options.toClassOnly===!0?t===l.CLASS_TO_CLASS||t===l.PLAIN_TO_CLASS:e.options.toPlainOnly===!0?t===l.CLASS_TO_PLAIN:!0}).map(function(e){return e.propertyName})},e.prototype.clear=function(){this._typeMetadatas.clear(),this._exposeMetadatas.clear(),this._excludeMetadatas.clear(),this._ancestorsMap.clear()},e.prototype.getMetadata=function(e,t){var n=e.get(t),r;n&&(r=Array.from(n.values()).filter(function(e){return e.propertyName!==void 0}));for(var i=[],a=0,o=this.getAncestors(t);a<o.length;a++){var s=o[a],c=e.get(s);if(c){var l=Array.from(c.values()).filter(function(e){return e.propertyName!==void 0});i.push.apply(i,l)}}return i.concat(r||[])},e.prototype.findMetadata=function(e,t,n){var r=e.get(t);if(r){var i=r.get(n);if(i)return i}for(var a=0,o=this.getAncestors(t);a<o.length;a++){var s=o[a],c=e.get(s);if(c){var l=c.get(n);if(l)return l}}},e.prototype.findMetadatas=function(e,t,n){var r=e.get(t),i;r&&(i=r.get(n));for(var a=[],o=0,s=this.getAncestors(t);o<s.length;o++){var c=s[o],l=e.get(c);l&&l.has(n)&&a.push.apply(a,l.get(n))}return a.slice().reverse().concat((i||[]).slice().reverse())},e.prototype.getAncestors=function(e){if(!e)return[];if(!this._ancestorsMap.has(e)){for(var t=[],n=Object.getPrototypeOf(e.prototype.constructor);typeof n.prototype<`u`;n=Object.getPrototypeOf(n.prototype.constructor))t.push(n);this._ancestorsMap.set(e,t)}return this._ancestorsMap.get(e)},e}(),d=new u;function f(){if(typeof globalThis<`u`)return globalThis;if(typeof global<`u`)return global;if(typeof window<`u`)return window;if(typeof self<`u`)return self}function p(e){return typeof e==`object`&&!!e&&typeof e.then==`function`}var m=globalThis&&globalThis.__spreadArray||function(e,t,n){if(n||arguments.length===2)for(var r=0,i=t.length,a;r<i;r++)(a||!(r in t))&&(a||=Array.prototype.slice.call(t,0,r),a[r]=t[r]);return e.concat(a||Array.prototype.slice.call(t))};function h(e){var t=new e;return!(t instanceof Set)&&!(`push`in t)?[]:t}var g=function(){function e(e,t){this.transformationType=e,this.options=t,this.recursionStack=new Set}return e.prototype.transform=function(e,t,n,r,i,a){var o=this;if(a===void 0&&(a=0),Array.isArray(t)||t instanceof Set){var s=r&&this.transformationType===l.PLAIN_TO_CLASS?h(r):[];return t.forEach(function(t,r){var i=e?e[r]:void 0;if(!o.options.enableCircularCheck||!o.isCircular(t)){var c=void 0;if(typeof n!=`function`&&n&&n.options&&n.options.discriminator&&n.options.discriminator.property&&n.options.discriminator.subTypes){if(o.transformationType===l.PLAIN_TO_CLASS){c=n.options.discriminator.subTypes.find(function(e){return e.name===t[n.options.discriminator.property]});var u={newObject:s,object:t,property:void 0},d=n.typeFunction(u);c=c===void 0?d:c.value,n.options.keepDiscriminatorProperty||delete t[n.options.discriminator.property]}o.transformationType===l.CLASS_TO_CLASS&&(c=t.constructor),o.transformationType===l.CLASS_TO_PLAIN&&(t[n.options.discriminator.property]=n.options.discriminator.subTypes.find(function(e){return e.value===t.constructor}).name)}else c=n;var f=o.transform(i,t,c,void 0,t instanceof Map,a+1);s instanceof Set?s.add(f):s.push(f)}else o.transformationType===l.CLASS_TO_CLASS&&(s instanceof Set?s.add(t):s.push(t))}),s}else{if(n===String&&!i)return t==null?t:String(t);if(n===Number&&!i)return t==null?t:Number(t);if(n===Boolean&&!i)return t==null?t:!!t;if((n===Date||t instanceof Date)&&!i)return t instanceof Date?new Date(t.valueOf()):t==null?t:new Date(t);if(f().Buffer&&(n===Buffer||t instanceof Buffer)&&!i)return t==null?t:Buffer.from(t);if(p(t)&&!i)return new Promise(function(e,r){t.then(function(t){return e(o.transform(void 0,t,n,void 0,void 0,a+1))},r)});if(!i&&typeof t==`object`&&t&&typeof t.then==`function`)return t;if(typeof t==`object`&&t){!n&&t.constructor!==Object&&(!Array.isArray(t)&&t.constructor===Array||(n=t.constructor)),!n&&e&&(n=e.constructor),this.options.enableCircularCheck&&this.recursionStack.add(t);var c=this.getKeys(n,t,i),u=e||{};!e&&(this.transformationType===l.PLAIN_TO_CLASS||this.transformationType===l.CLASS_TO_CLASS)&&(u=i?new Map:n?new n:{});for(var m=function(r){if(r===`__proto__`||r===`constructor`)return`continue`;var o=r,s=r,c=r;if(!g.options.ignoreDecorators&&n){if(g.transformationType===l.PLAIN_TO_CLASS){var f=d.findExposeMetadataByCustomName(n,r);f&&(c=f.propertyName,s=f.propertyName)}else if(g.transformationType===l.CLASS_TO_PLAIN||g.transformationType===l.CLASS_TO_CLASS){var f=d.findExposeMetadata(n,r);f&&f.options&&f.options.name&&(s=f.options.name)}}var p=void 0;p=g.transformationType===l.PLAIN_TO_CLASS?t[o]:t instanceof Map?t.get(o):t[o]instanceof Function?t[o]():t[o];var m=void 0,h=p instanceof Map;if(n&&i)m=n;else if(n){var _=d.findTypeMetadata(n,c);if(_){var v={newObject:u,object:t,property:c},y=_.typeFunction?_.typeFunction(v):_.reflectedType;_.options&&_.options.discriminator&&_.options.discriminator.property&&_.options.discriminator.subTypes?t[o]instanceof Array?m=_:(g.transformationType===l.PLAIN_TO_CLASS&&(m=_.options.discriminator.subTypes.find(function(e){if(p&&p instanceof Object&&_.options.discriminator.property in p)return e.name===p[_.options.discriminator.property]}),m=m===void 0?y:m.value,_.options.keepDiscriminatorProperty||p&&p instanceof Object&&_.options.discriminator.property in p&&delete p[_.options.discriminator.property]),g.transformationType===l.CLASS_TO_CLASS&&(m=p.constructor),g.transformationType===l.CLASS_TO_PLAIN&&p&&(p[_.options.discriminator.property]=_.options.discriminator.subTypes.find(function(e){return e.value===p.constructor}).name)):m=y,h||=_.reflectedType===Map}else if(g.options.targetMaps)g.options.targetMaps.filter(function(e){return e.target===n&&!!e.properties[c]}).forEach(function(e){return m=e.properties[c]});else if(g.options.enableImplicitConversion&&g.transformationType===l.PLAIN_TO_CLASS){var b=Reflect.getMetadata(`design:type`,n.prototype,c);b&&(m=b)}}var x=Array.isArray(t[o])?g.getReflectedType(n,c):void 0,ee=e?e[o]:void 0;if(u.constructor.prototype){var te=Object.getOwnPropertyDescriptor(u.constructor.prototype,s);if((g.transformationType===l.PLAIN_TO_CLASS||g.transformationType===l.CLASS_TO_CLASS)&&(te&&!te.set||u[s]instanceof Function))return`continue`}if(!g.options.enableCircularCheck||!g.isCircular(p)){var S=g.transformationType===l.PLAIN_TO_CLASS?s:r,C=void 0;g.transformationType===l.CLASS_TO_PLAIN?(C=t[S],C=g.applyCustomTransformations(C,n,S,t,g.transformationType),C=t[S]===C?p:C,C=g.transform(ee,C,m,x,h,a+1)):p===void 0&&g.options.exposeDefaultValues?C=u[s]:(C=g.transform(ee,p,m,x,h,a+1),C=g.applyCustomTransformations(C,n,S,t,g.transformationType)),(C!==void 0||g.options.exposeUnsetFields)&&(u instanceof Map?u.set(s,C):u[s]=C)}else if(g.transformationType===l.CLASS_TO_CLASS){var C=p;C=g.applyCustomTransformations(C,n,r,t,g.transformationType),(C!==void 0||g.options.exposeUnsetFields)&&(u instanceof Map?u.set(s,C):u[s]=C)}},g=this,_=0,v=c;_<v.length;_++){var y=v[_];m(y)}return this.options.enableCircularCheck&&this.recursionStack.delete(t),u}else return t}},e.prototype.applyCustomTransformations=function(e,t,n,r,i){var a=this,o=d.findTransformMetadatas(t,n,this.transformationType);return this.options.version!==void 0&&(o=o.filter(function(e){return e.options?a.checkVersion(e.options.since,e.options.until):!0})),o=this.options.groups&&this.options.groups.length?o.filter(function(e){return e.options?a.checkGroups(e.options.groups):!0}):o.filter(function(e){return!e.options||!e.options.groups||!e.options.groups.length}),o.forEach(function(t){e=t.transformFn({value:e,key:n,obj:r,type:i,options:a.options})}),e},e.prototype.isCircular=function(e){return this.recursionStack.has(e)},e.prototype.getReflectedType=function(e,t){if(e){var n=d.findTypeMetadata(e,t);return n?n.reflectedType:void 0}},e.prototype.getKeys=function(e,t,n){var r=this,i=d.getStrategy(e);i===`none`&&(i=this.options.strategy||`exposeAll`);var a=[];if((i===`exposeAll`||n)&&(a=t instanceof Map?Array.from(t.keys()):Object.keys(t)),n)return a;if(this.options.ignoreDecorators&&this.options.excludeExtraneousValues&&e){var o=d.getExposedProperties(e,this.transformationType),s=d.getExcludedProperties(e,this.transformationType);a=m(m([],o,!0),s,!0)}if(!this.options.ignoreDecorators&&e){var o=d.getExposedProperties(e,this.transformationType);this.transformationType===l.PLAIN_TO_CLASS&&(o=o.map(function(t){var n=d.findExposeMetadata(e,t);return n&&n.options&&n.options.name?n.options.name:t})),a=this.options.excludeExtraneousValues?o:a.concat(o);var c=d.getExcludedProperties(e,this.transformationType);c.length>0&&(a=a.filter(function(e){return!c.includes(e)})),this.options.version!==void 0&&(a=a.filter(function(t){var n=d.findExposeMetadata(e,t);return!n||!n.options?!0:r.checkVersion(n.options.since,n.options.until)})),a=this.options.groups&&this.options.groups.length?a.filter(function(t){var n=d.findExposeMetadata(e,t);return!n||!n.options?!0:r.checkGroups(n.options.groups)}):a.filter(function(t){var n=d.findExposeMetadata(e,t);return!n||!n.options||!n.options.groups||!n.options.groups.length})}return this.options.excludePrefixes&&this.options.excludePrefixes.length&&(a=a.filter(function(e){return r.options.excludePrefixes.every(function(t){return e.substr(0,t.length)!==t})})),a=a.filter(function(e,t,n){return n.indexOf(e)===t}),a},e.prototype.checkVersion=function(e,t){var n=!0;return n&&e&&(n=this.options.version>=e),n&&t&&(n=this.options.version<t),n},e.prototype.checkGroups=function(e){return e?this.options.groups.some(function(t){return e.includes(t)}):!0},e}(),_={enableCircularCheck:!1,enableImplicitConversion:!1,excludeExtraneousValues:!1,excludePrefixes:void 0,exposeDefaultValues:!1,exposeUnsetFields:!0,groups:void 0,ignoreDecorators:!1,strategy:void 0,targetMaps:void 0,version:void 0},v=globalThis&&globalThis.__assign||function(){return v=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n],t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},v.apply(this,arguments)},y=function(){function e(){}return e.prototype.instanceToPlain=function(e,t){var n=new g(l.CLASS_TO_PLAIN,v(v({},_),t));return n.transform(void 0,e,void 0,void 0,void 0,void 0)},e.prototype.classToPlainFromExist=function(e,t,n){var r=new g(l.CLASS_TO_PLAIN,v(v({},_),n));return r.transform(t,e,void 0,void 0,void 0,void 0)},e.prototype.plainToInstance=function(e,t,n){var r=new g(l.PLAIN_TO_CLASS,v(v({},_),n));return r.transform(void 0,t,e,void 0,void 0,void 0)},e.prototype.plainToClassFromExist=function(e,t,n){var r=new g(l.PLAIN_TO_CLASS,v(v({},_),n));return r.transform(e,t,void 0,void 0,void 0,void 0)},e.prototype.instanceToInstance=function(e,t){var n=new g(l.CLASS_TO_CLASS,v(v({},_),t));return n.transform(void 0,e,void 0,void 0,void 0,void 0)},e.prototype.classToClassFromExist=function(e,t,n){var r=new g(l.CLASS_TO_CLASS,v(v({},_),n));return r.transform(t,e,void 0,void 0,void 0,void 0)},e.prototype.serialize=function(e,t){return JSON.stringify(this.instanceToPlain(e,t))},e.prototype.deserialize=function(e,t,n){var r=JSON.parse(t);return this.plainToInstance(e,r,n)},e.prototype.deserializeArray=function(e,t,n){var r=JSON.parse(t);return this.plainToInstance(e,r,n)},e}();function b(e,t){return t===void 0&&(t={}),function(n,r){var i=Reflect.getMetadata(`design:type`,n,r);d.addTypeMetadata({target:n.constructor,propertyName:r,reflectedType:i,typeFunction:e,options:t})}}var x=new y;function ee(e,t){return x.instanceToPlain(e,t)}function te(e,t,n){return x.plainToInstance(e,t,n)}var S;(function(t){(function(n){var r=typeof e==`object`?e:typeof self==`object`?self:typeof this==`object`?this:Function(`return this;`)(),i=a(t);typeof r.Reflect>`u`?r.Reflect=t:i=a(r.Reflect,i),n(i);function a(e,t){return function(n,r){typeof e[n]!=`function`&&Object.defineProperty(e,n,{configurable:!0,writable:!0,value:r}),t&&t(n,r)}}})(function(e){var t=Object.prototype.hasOwnProperty,n=typeof Symbol==`function`,r=n&&typeof Symbol.toPrimitive<`u`?Symbol.toPrimitive:`@@toPrimitive`,i=n&&typeof Symbol.iterator<`u`?Symbol.iterator:`@@iterator`,a=typeof Object.create==`function`,o={__proto__:[]}instanceof Array,s=!a&&!o,c={create:a?function(){return Y(Object.create(null))}:o?function(){return Y({__proto__:null})}:function(){return Y({})},has:s?function(e,n){return t.call(e,n)}:function(e,t){return t in e},get:s?function(e,n){return t.call(e,n)?e[n]:void 0}:function(e,t){return e[t]}},l=Object.getPrototypeOf(Function),u=typeof process==`object`&&process.env&&process.env.REFLECT_METADATA_USE_MAP_POLYFILL===`true`,d=!u&&typeof Map==`function`&&typeof Map.prototype.entries==`function`?Map:se(),f=!u&&typeof Set==`function`&&typeof Set.prototype.entries==`function`?Set:ce(),p=!u&&typeof WeakMap==`function`?WeakMap:J(),m=new p;function h(e,t,n,r){if(j(n)){if(!z(e)||!V(t))throw TypeError();return C(e,t)}else{if(!z(e)||!P(t)||!P(r)&&!j(r)&&!M(r))throw TypeError();return M(r)&&(r=void 0),n=R(n),ne(e,t,n,r)}}e(`decorate`,h);function g(e,t){function n(n,r){if(!P(n)||!j(r)&&!H(r))throw TypeError();O(e,t,n,r)}return n}e(`metadata`,g);function _(e,t,n,r){if(!P(n))throw TypeError();return j(r)||(r=R(r)),O(e,t,n,r)}e(`defineMetadata`,_);function v(e,t,n){if(!P(t))throw TypeError();return j(n)||(n=R(n)),T(e,t,n)}e(`hasMetadata`,v);function y(e,t,n){if(!P(t))throw TypeError();return j(n)||(n=R(n)),E(e,t,n)}e(`hasOwnMetadata`,y);function b(e,t,n){if(!P(t))throw TypeError();return j(n)||(n=R(n)),re(e,t,n)}e(`getMetadata`,b);function x(e,t,n){if(!P(t))throw TypeError();return j(n)||(n=R(n)),D(e,t,n)}e(`getOwnMetadata`,x);function ee(e,t){if(!P(e))throw TypeError();return j(t)||(t=R(t)),k(e,t)}e(`getMetadataKeys`,ee);function te(e,t){if(!P(e))throw TypeError();return j(t)||(t=R(t)),A(e,t)}e(`getOwnMetadataKeys`,te);function S(e,t,n){if(!P(t))throw TypeError();j(n)||(n=R(n));var r=w(t,n,!1);if(j(r)||!r.delete(e))return!1;if(r.size>0)return!0;var i=m.get(t);return i.delete(n),i.size>0||m.delete(t),!0}e(`deleteMetadata`,S);function C(e,t){for(var n=e.length-1;n>=0;--n){var r=e[n],i=r(t);if(!j(i)&&!M(i)){if(!V(i))throw TypeError();t=i}}return t}function ne(e,t,n,r){for(var i=e.length-1;i>=0;--i){var a=e[i],o=a(t,n,r);if(!j(o)&&!M(o)){if(!P(o))throw TypeError();r=o}}return r}function w(e,t,n){var r=m.get(e);if(j(r)){if(!n)return;r=new d,m.set(e,r)}var i=r.get(t);if(j(i)){if(!n)return;i=new d,r.set(t,i)}return i}function T(e,t,n){var r=E(e,t,n);if(r)return!0;var i=q(t);return M(i)?!1:T(e,i,n)}function E(e,t,n){var r=w(t,n,!1);return j(r)?!1:ae(r.has(e))}function re(e,t,n){var r=E(e,t,n);if(r)return D(e,t,n);var i=q(t);if(!M(i))return re(e,i,n)}function D(e,t,n){var r=w(t,n,!1);if(!j(r))return r.get(e)}function O(e,t,n,r){var i=w(n,r,!0);i.set(e,t)}function k(e,t){var n=A(e,t),r=q(e);if(r===null)return n;var i=k(r,t);if(i.length<=0)return n;if(n.length<=0)return i;for(var a=new f,o=[],s=0,c=n;s<c.length;s++){var l=c[s],u=a.has(l);u||(a.add(l),o.push(l))}for(var d=0,p=i;d<p.length;d++){var l=p[d],u=a.has(l);u||(a.add(l),o.push(l))}return o}function A(e,t){var n=[],r=w(e,t,!1);if(j(r))return n;for(var i=r.keys(),a=W(i),o=0;;){var s=K(a);if(!s)return n.length=o,n;var c=G(s);try{n[o]=c}catch(e){try{oe(a)}finally{throw e}}o++}}function ie(e){if(e===null)return 1;switch(typeof e){case`undefined`:return 0;case`boolean`:return 2;case`string`:return 3;case`symbol`:return 4;case`number`:return 5;case`object`:return e===null?1:6;default:return 6}}function j(e){return e===void 0}function M(e){return e===null}function N(e){return typeof e==`symbol`}function P(e){return typeof e==`object`?e!==null:typeof e==`function`}function F(e,t){switch(ie(e)){case 0:return e;case 1:return e;case 2:return e;case 3:return e;case 4:return e;case 5:return e}var n=t===3?`string`:t===5?`number`:`default`,i=U(e,r);if(i!==void 0){var a=i.call(e,n);if(P(a))throw TypeError();return a}return I(e,n===`default`?`number`:n)}function I(e,t){if(t===`string`){var n=e.toString;if(B(n)){var r=n.call(e);if(!P(r))return r}var i=e.valueOf;if(B(i)){var r=i.call(e);if(!P(r))return r}}else{var i=e.valueOf;if(B(i)){var r=i.call(e);if(!P(r))return r}var a=e.toString;if(B(a)){var r=a.call(e);if(!P(r))return r}}throw TypeError()}function ae(e){return!!e}function L(e){return``+e}function R(e){var t=F(e,3);return N(t)?t:L(t)}function z(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:Object.prototype.toString.call(e)===`[object Array]`}function B(e){return typeof e==`function`}function V(e){return typeof e==`function`}function H(e){switch(ie(e)){case 3:return!0;case 4:return!0;default:return!1}}function U(e,t){var n=e[t];if(n!=null){if(!B(n))throw TypeError();return n}}function W(e){var t=U(e,i);if(!B(t))throw TypeError();var n=t.call(e);if(!P(n))throw TypeError();return n}function G(e){return e.value}function K(e){var t=e.next();return t.done?!1:t}function oe(e){var t=e.return;t&&t.call(e)}function q(e){var t=Object.getPrototypeOf(e);if(typeof e!=`function`||e===l||t!==l)return t;var n=e.prototype,r=n&&Object.getPrototypeOf(n);if(r==null||r===Object.prototype)return t;var i=r.constructor;return typeof i!=`function`||i===e?t:i}function se(){var e={},t=[],n=function(){function e(e,t,n){this._index=0,this._keys=e,this._values=t,this._selector=n}return e.prototype[`@@iterator`]=function(){return this},e.prototype[i]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var n=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:n,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,`size`,{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var n=this._find(e,!0);return this._values[n]=t,this},t.prototype.delete=function(t){var n=this._find(t,!1);if(n>=0){for(var r=this._keys.length,i=n+1;i<r;i++)this._keys[i-1]=this._keys[i],this._values[i-1]=this._values[i];return this._keys.length--,this._values.length--,t===this._cacheKey&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new n(this._keys,this._values,r)},t.prototype.values=function(){return new n(this._keys,this._values,a)},t.prototype.entries=function(){return new n(this._keys,this._values,o)},t.prototype[`@@iterator`]=function(){return this.entries()},t.prototype[i]=function(){return this.entries()},t.prototype._find=function(e,t){return this._cacheKey!==e&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=e)),this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function r(e,t){return e}function a(e,t){return t}function o(e,t){return[e,t]}}function ce(){return function(){function e(){this._map=new d}return Object.defineProperty(e.prototype,`size`,{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.values()},e.prototype.entries=function(){return this._map.entries()},e.prototype[`@@iterator`]=function(){return this.keys()},e.prototype[i]=function(){return this.keys()},e}()}function J(){var e=16,n=c.create(),r=i();return function(){function e(){this._key=i()}return e.prototype.has=function(e){var t=a(e,!1);return t===void 0?!1:c.has(t,this._key)},e.prototype.get=function(e){var t=a(e,!1);return t===void 0?void 0:c.get(t,this._key)},e.prototype.set=function(e,t){var n=a(e,!0);return n[this._key]=t,this},e.prototype.delete=function(e){var t=a(e,!1);return t===void 0?!1:delete t[this._key]},e.prototype.clear=function(){this._key=i()},e}();function i(){var e;do e=`@@WeakMap@@`+l();while(c.has(n,e));return n[e]=!0,e}function a(e,n){if(!t.call(e,r)){if(!n)return;Object.defineProperty(e,r,{value:c.create()})}return e[r]}function o(e,t){for(var n=0;n<t;++n)e[n]=Math.random()*255|0;return e}function s(e){return typeof Uint8Array==`function`?typeof crypto<`u`?crypto.getRandomValues(new Uint8Array(e)):typeof msCrypto<`u`?msCrypto.getRandomValues(new Uint8Array(e)):o(new Uint8Array(e),e):o(Array(e),e)}function l(){var t=s(e);t[6]=t[6]&79|64,t[8]=t[8]&191|128;for(var n=``,r=0;r<e;++r){var i=t[r];(r===4||r===6||r===8)&&(n+=`-`),i<16&&(n+=`0`),n+=i.toString(16).toLowerCase()}return n}}function Y(e){return e.__=void 0,delete e.__,e}})})(S||={});var C=Object.defineProperty,ne=Object.getOwnPropertyDescriptor,w=(e,t,n,r)=>{for(var i=r>1?void 0:r?ne(t,n):t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&C(t,n,i),i};const T=0,E=1,re=4294967295,D=3;var O=class{constructor(e){Object.assign(this,e)}update(){var e,t,n,r,i;(e=this.ScalarCmd)==null||e.forEach((e,t)=>e.Index=t),(t=this.RotateCmd)==null||t.forEach((e,t)=>e.Index=t),(n=this.LinearCmd)==null||n.forEach((e,t)=>e.Index=t),(r=this.SensorReadCmd)==null||r.forEach((e,t)=>e.Index=t),(i=this.SensorSubscribeCmd)==null||i.forEach((e,t)=>e.Index=t)}},k=(e=>(e.Unknown=`Unknown`,e.Vibrate=`Vibrate`,e.Rotate=`Rotate`,e.Oscillate=`Oscillate`,e.Constrict=`Constrict`,e.Inflate=`Inflate`,e.Position=`Position`,e))(k||{}),A=(e=>(e.Unknown=`Unknown`,e.Battery=`Battery`,e.RSSI=`RSSI`,e.Button=`Button`,e.Pressure=`Pressure`,e))(A||{}),ie=class{constructor(e){this.Index=0,Object.assign(this,e)}},j=class{constructor(e){this.Endpoints=e}},M=class{constructor(e){this.Index=0,Object.assign(this,e)}},N=class{constructor(e){this.Id=e}get Type(){return this.constructor}toJSON(){return JSON.stringify(this.toProtocolFormat())}toProtocolFormat(){let e={};return e[this.constructor.Name]=ee(this),e}update(){}},P=class extends N{constructor(e,t){super(t),this.DeviceIndex=e,this.Id=t}},F=class extends N{constructor(e=T){super(e),this.Id=e}},I=class extends F{constructor(e=E){super(e),this.Id=e}};I.Name=`Ok`;var ae=class extends N{constructor(e=E){super(e),this.Id=e}};ae.Name=`Ping`;var L=(e=>(e[e.ERROR_UNKNOWN=0]=`ERROR_UNKNOWN`,e[e.ERROR_INIT=1]=`ERROR_INIT`,e[e.ERROR_PING=2]=`ERROR_PING`,e[e.ERROR_MSG=3]=`ERROR_MSG`,e[e.ERROR_DEVICE=4]=`ERROR_DEVICE`,e))(L||{});let R=class extends N{constructor(e,t=0,n=E){super(n),this.ErrorMessage=e,this.ErrorCode=t,this.Id=n}get Schemversion(){return 0}};R.Name=`Error`;var z=class{constructor(e){Object.assign(this,e)}};w([b(()=>O)],z.prototype,`DeviceMessages`,2);var B=class extends N{constructor(e,t=E){super(t),this.Devices=e,this.Id=t}update(){for(let e of this.Devices)e.DeviceMessages.update()}};B.Name=`DeviceList`,w([b(()=>z)],B.prototype,`Devices`,2);var V=class extends F{constructor(e){super(),Object.assign(this,e)}update(){this.DeviceMessages.update()}};V.Name=`DeviceAdded`,w([b(()=>O)],V.prototype,`DeviceMessages`,2);var H=class extends F{constructor(e){super(),this.DeviceIndex=e}};H.Name=`DeviceRemoved`;var U=class extends N{constructor(e=E){super(e),this.Id=e}};U.Name=`RequestDeviceList`;var W=class extends N{constructor(e=E){super(e),this.Id=e}};W.Name=`StartScanning`;var G=class extends N{constructor(e=E){super(e),this.Id=e}};G.Name=`StopScanning`;var K=class extends F{constructor(){super()}};K.Name=`ScanningFinished`;var oe=class extends N{constructor(e,t=0,n=E){super(n),this.ClientName=e,this.MessageVersion=t,this.Id=n}};oe.Name=`RequestServerInfo`;var q=class extends F{constructor(e,t,n,r=E){super(),this.MessageVersion=e,this.MaxPingTime=t,this.ServerName=n,this.Id=r}};q.Name=`ServerInfo`;var se=class extends P{constructor(e=-1,t=E){super(e,t),this.DeviceIndex=e,this.Id=t}};se.Name=`StopDeviceCmd`;var ce=class extends N{constructor(e=E){super(e),this.Id=e}};ce.Name=`StopAllDevices`;var J=class{constructor(e){this.Index=e}},Y=class extends J{constructor(e,t,n){super(e),this.Scalar=t,this.ActuatorType=n}},le=class extends P{constructor(e,t=-1,n=E){super(t,n),this.Scalars=e,this.DeviceIndex=t,this.Id=n}};le.Name=`ScalarCmd`;var ue=class extends J{constructor(e,t,n){super(e),this.Speed=t,this.Clockwise=n}};const de=class e extends P{constructor(e,t=-1,n=E){super(t,n),this.Rotations=e,this.DeviceIndex=t,this.Id=n}static Create(t,n){let r=[],i=0;for(let[e,t]of n)r.push(new ue(i,e,t)),++i;return new e(r,t)}};de.Name=`RotateCmd`;let fe=de;var pe=class extends J{constructor(e,t,n){super(e),this.Position=t,this.Duration=n}};const me=class e extends P{constructor(e,t=-1,n=E){super(t,n),this.Vectors=e,this.DeviceIndex=t,this.Id=n}static Create(t,n){let r=[],i=0;for(let e of n)r.push(new pe(i,e[0],e[1])),++i;return new e(r,t)}};me.Name=`LinearCmd`;let he=me;var ge=class extends P{constructor(e,t,n,r=E){super(e,r),this.DeviceIndex=e,this.SensorIndex=t,this.SensorType=n,this.Id=r}};ge.Name=`SensorReadCmd`;var _e=class extends P{constructor(e,t,n,r,i=E){super(e,i),this.DeviceIndex=e,this.SensorIndex=t,this.SensorType=n,this.Data=r,this.Id=i}};_e.Name=`SensorReading`;var ve=class extends P{constructor(e,t,n,r,i=E){super(e,i),this.DeviceIndex=e,this.Endpoint=t,this.ExpectedLength=n,this.Timeout=r,this.Id=i}};ve.Name=`RawReadCmd`;var ye=class extends P{constructor(e,t,n,r,i=E){super(e,i),this.DeviceIndex=e,this.Endpoint=t,this.Data=n,this.WriteWithResponse=r,this.Id=i}};ye.Name=`RawWriteCmd`;var be=class extends P{constructor(e,t,n=E){super(e,n),this.DeviceIndex=e,this.Endpoint=t,this.Id=n}};be.Name=`RawSubscribeCmd`;var xe=class extends P{constructor(e,t,n=E){super(e,n),this.DeviceIndex=e,this.Endpoint=t,this.Id=n}};xe.Name=`RawUnsubscribeCmd`;var Se=class extends P{constructor(e,t,n,r=E){super(e,r),this.DeviceIndex=e,this.Endpoint=t,this.Data=n,this.Id=r}};Se.Name=`RawReading`;const Ce=Object.freeze(Object.defineProperty({__proto__:null,ActuatorType:k,ButtplugDeviceMessage:P,ButtplugMessage:N,ButtplugSystemMessage:F,DEFAULT_MESSAGE_ID:E,DeviceAdded:V,DeviceInfo:z,DeviceList:B,DeviceRemoved:H,Error:R,ErrorClass:L,GenericDeviceMessageAttributes:ie,GenericMessageSubcommand:J,LinearCmd:he,MAX_ID:re,MESSAGE_SPEC_VERSION:D,MessageAttributes:O,Ok:I,Ping:ae,RawDeviceMessageAttributes:j,RawReadCmd:ve,RawReading:Se,RawSubscribeCmd:be,RawUnsubscribeCmd:xe,RawWriteCmd:ye,RequestDeviceList:U,RequestServerInfo:oe,RotateCmd:fe,RotateSubcommand:ue,SYSTEM_MESSAGE_ID:T,ScalarCmd:le,ScalarSubcommand:Y,ScanningFinished:K,SensorDeviceMessageAttributes:M,SensorReadCmd:ge,SensorReading:_e,SensorType:A,ServerInfo:q,StartScanning:W,StopAllDevices:ce,StopDeviceCmd:se,StopScanning:G,VectorSubcommand:pe},Symbol.toStringTag,{value:`Module`}));var X=class extends Error{constructor(e,t,n=T,r){super(e),this.errorClass=L.ERROR_UNKNOWN,this.errorClass=t,this.innerError=r,this.messageId=n}get ErrorClass(){return this.errorClass}get InnerError(){return this.innerError}get Id(){return this.messageId}get ErrorMessage(){return new R(this.message,this.ErrorClass,this.Id)}static LogAndError(e,t,n,r=T){return t.Error(n),new e(n,r)}static FromError(e){switch(e.ErrorCode){case L.ERROR_DEVICE:return new Z(e.ErrorMessage,e.Id);case L.ERROR_INIT:return new we(e.ErrorMessage,e.Id);case L.ERROR_UNKNOWN:return new Ee(e.ErrorMessage,e.Id);case L.ERROR_PING:return new Te(e.ErrorMessage,e.Id);case L.ERROR_MSG:return new Q(e.ErrorMessage,e.Id);default:throw Error(`Message type ${e.ErrorCode} not handled`)}}},we=class extends X{constructor(e,t=T){super(e,L.ERROR_INIT,t)}},Z=class extends X{constructor(e,t=T){super(e,L.ERROR_DEVICE,t)}},Q=class extends X{constructor(e,t=T){super(e,L.ERROR_MSG,t)}},Te=class extends X{constructor(e,t=T){super(e,L.ERROR_PING,t)}},Ee=class extends X{constructor(e,t=T){super(e,L.ERROR_UNKNOWN,t)}};function De(e){for(let t of Object.values(Ce))if(typeof t==`function`&&`Name`in t&&t.Name===e)return t;return null}function $(e){return De(Object.getPrototypeOf(e).constructor.Name)}function Oe(e){let t=JSON.parse(e),n=[];for(let e of Array.from(t)){let t=Object.getOwnPropertyNames(e)[0],r=De(t);if(r){let i=te(r,e[t]);i.update(),n.push(i)}}return n}var ke=class e extends i{constructor(e,t){super(),this._deviceInfo=e,this._sendClosure=t,this.allowedMsgs=new Map,e.DeviceMessages.update()}get name(){return this._deviceInfo.DeviceName}get displayName(){return this._deviceInfo.DeviceDisplayName}get index(){return this._deviceInfo.DeviceIndex}get messageTimingGap(){return this._deviceInfo.DeviceMessageTimingGap}get messageAttributes(){return this._deviceInfo.DeviceMessages}static fromMsg(t,n){return new e(t,n)}async send(e){return await this._sendClosure(this,e)}async sendExpectOk(e){let t=await this.send(e);switch($(t)){case I:return;case R:throw X.FromError(t);default:throw new Q(`Message type ${t.constructor} not handled by SendMsgExpectOk`)}}async scalar(e){Array.isArray(e)?await this.sendExpectOk(new le(e,this.index)):await this.sendExpectOk(new le([e],this.index))}async scalarCommandBuilder(e,t){var n;let r=(n=this.messageAttributes.ScalarCmd)?.filter(e=>e.ActuatorType===t);if(!r||r.length===0)throw new Z(`Device ${this.name} has no ${t} capabilities`);let i=[];if(typeof e==`number`)r.forEach(n=>i.push(new Y(n.Index,e,t)));else if(Array.isArray(e)){if(e.length>r.length)throw new Z(`${e.length} commands send to a device with ${r.length} vibrators`);r.forEach((n,r)=>{i.push(new Y(n.Index,e[r],t))})}else throw new Z(`${t} can only take numbers or arrays of numbers.`);await this.scalar(i)}get vibrateAttributes(){var e;return(e=this.messageAttributes.ScalarCmd)?.filter(e=>e.ActuatorType===k.Vibrate)??[]}async vibrate(e){await this.scalarCommandBuilder(e,k.Vibrate)}get oscillateAttributes(){var e;return(e=this.messageAttributes.ScalarCmd)?.filter(e=>e.ActuatorType===k.Oscillate)??[]}async oscillate(e){await this.scalarCommandBuilder(e,k.Oscillate)}get rotateAttributes(){return this.messageAttributes.RotateCmd??[]}async rotate(e,t){let n=this.messageAttributes.RotateCmd;if(!n||n.length===0)throw new Z(`Device ${this.name} has no Rotate capabilities`);let r;if(typeof e==`number`)r=fe.Create(this.index,Array(n.length).fill([e,t]));else if(Array.isArray(e))r=fe.Create(this.index,e);else throw new Z(`SendRotateCmd can only take a number and boolean, or an array of number/boolean tuples`);await this.sendExpectOk(r)}get linearAttributes(){return this.messageAttributes.LinearCmd??[]}async linear(e,t){let n=this.messageAttributes.LinearCmd;if(!n||n.length===0)throw new Z(`Device ${this.name} has no Linear capabilities`);let r;if(typeof e==`number`)r=he.Create(this.index,Array(n.length).fill([e,t]));else if(Array.isArray(e))r=he.Create(this.index,e);else throw new Z(`SendLinearCmd can only take a number and number, or an array of number/number tuples`);await this.sendExpectOk(r)}async sensorRead(e,t){let n=await this.send(new ge(this.index,e,t));switch($(n)){case _e:return n.Data;case R:throw X.FromError(n);default:throw new Q(`Message type ${n.constructor} not handled by sensorRead`)}}get hasBattery(){var e;let t=(e=this.messageAttributes.SensorReadCmd)?.filter(e=>e.SensorType===A.Battery);return t!==void 0&&t.length>0}async battery(){var e;if(!this.hasBattery)throw new Z(`Device ${this.name} has no Battery capabilities`);let t=(e=this.messageAttributes.SensorReadCmd)?.filter(e=>e.SensorType===A.Battery);return(await this.sensorRead(t[0].Index,A.Battery))[0]/100}get hasRssi(){var e;let t=(e=this.messageAttributes.SensorReadCmd)?.filter(e=>e.SensorType===A.RSSI);return t!==void 0&&t.length===0}async rssi(){var e;if(!this.hasRssi)throw new Z(`Device ${this.name} has no RSSI capabilities`);let t=(e=this.messageAttributes.SensorReadCmd)?.filter(e=>e.SensorType===A.RSSI);return(await this.sensorRead(t[0].Index,A.RSSI))[0]}async rawRead(e,t,n){if(!this.messageAttributes.RawReadCmd)throw new Z(`Device ${this.name} has no raw read capabilities`);if(this.messageAttributes.RawReadCmd.Endpoints.indexOf(e)===-1)throw new Z(`Device ${this.name} has no raw readable endpoint ${e}`);let r=await this.send(new ve(this.index,e,t,n));switch($(r)){case Se:return new Uint8Array(r.Data);case R:throw X.FromError(r);default:throw new Q(`Message type ${r.constructor} not handled by rawRead`)}}async rawWrite(e,t,n){if(!this.messageAttributes.RawWriteCmd)throw new Z(`Device ${this.name} has no raw write capabilities`);if(this.messageAttributes.RawWriteCmd.Endpoints.indexOf(e)===-1)throw new Z(`Device ${this.name} has no raw writable endpoint ${e}`);await this.sendExpectOk(new ye(this.index,e,t,n))}async rawSubscribe(e){if(!this.messageAttributes.RawSubscribeCmd)throw new Z(`Device ${this.name} has no raw subscribe capabilities`);if(this.messageAttributes.RawSubscribeCmd.Endpoints.indexOf(e)===-1)throw new Z(`Device ${this.name} has no raw subscribable endpoint ${e}`);await this.sendExpectOk(new be(this.index,e))}async rawUnsubscribe(e){if(!this.messageAttributes.RawSubscribeCmd)throw new Z(`Device ${this.name} has no raw unsubscribe capabilities`);if(this.messageAttributes.RawSubscribeCmd.Endpoints.indexOf(e)===-1)throw new Z(`Device ${this.name} has no raw unsubscribable endpoint ${e}`);await this.sendExpectOk(new xe(this.index,e))}async stop(){await this.sendExpectOk(new se(this.index))}emitDisconnected(){this.emit(`deviceremoved`)}},Ae=class{constructor(e){this._useCounter=e,this._counter=1,this._waitingMsgs=new Map}PrepareOutgoingMessage(e){this._useCounter&&(e.Id=this._counter,this._counter+=1);let t,n,r=new Promise((e,r)=>{t=e,n=r});return this._waitingMsgs.set(e.Id,[t,n]),r}ParseIncomingMessages(e){let t=[];for(let n of e)if(n.Id!==T&&this._waitingMsgs.has(n.Id)){let[e,t]=this._waitingMsgs.get(n.Id);if(n.Type===R){t(X.FromError(n));continue}e(n);continue}else t.push(n);return t}},je=class extends X{constructor(e){super(e,L.ERROR_UNKNOWN)}},Me=class extends i{constructor(e=`Generic Buttplug Client`){super(),this._pingTimer=null,this._connector=null,this._devices=new Map,this._logger=c.Logger,this._isScanning=!1,this._sorter=new Ae(!0),this.connect=async e=>{this._logger.Info(`ButtplugClient: Connecting using ${e.constructor.name}`),await e.connect(),this._connector=e,this._connector.addListener(`message`,this.parseMessages),this._connector.addListener(`disconnect`,this.disconnectHandler),await this.initializeConnection()},this.disconnect=async()=>{this._logger.Debug(`ButtplugClient: Disconnect called`),this.checkConnector(),await this.shutdownConnection(),await this._connector.disconnect()},this.startScanning=async()=>{this._logger.Debug(`ButtplugClient: StartScanning called`),this._isScanning=!0,await this.sendMsgExpectOk(new W)},this.stopScanning=async()=>{this._logger.Debug(`ButtplugClient: StopScanning called`),this._isScanning=!1,await this.sendMsgExpectOk(new G)},this.stopAllDevices=async()=>{this._logger.Debug(`ButtplugClient: StopAllDevices`),await this.sendMsgExpectOk(new ce)},this.disconnectHandler=()=>{this._logger.Info(`ButtplugClient: Disconnect event receieved.`),this.emit(`disconnect`)},this.parseMessages=e=>{let t=this._sorter.ParseIncomingMessages(e);for(let e of t)switch($(e)){case V:{let t=e,n=ke.fromMsg(t,this.sendDeviceMessageClosure);this._devices.set(t.DeviceIndex,n),this.emit(`deviceadded`,n);break}case H:{let t=e;if(this._devices.has(t.DeviceIndex)){let e=this._devices.get(t.DeviceIndex);e?.emitDisconnected(),this._devices.delete(t.DeviceIndex),this.emit(`deviceremoved`,e)}break}case K:this._isScanning=!1,this.emit(`scanningfinished`,e);break}},this.initializeConnection=async()=>{this.checkConnector();let e=await this.sendMessage(new oe(this._clientName,D));switch($(e)){case q:{let t=e;if(this._logger.Info(`ButtplugClient: Connected to Server ${t.ServerName}`),t.MaxPingTime,t.MessageVersion<D)throw await this._connector.disconnect(),X.LogAndError(we,this._logger,`Server protocol version ${t.MessageVersion} is older than client protocol version ${D}. Please update server.`);return await this.requestDeviceList(),!0}case R:{await this._connector.disconnect();let t=e;throw X.LogAndError(we,this._logger,`Cannot connect to server. ${t.ErrorMessage}`)}}return!1},this.requestDeviceList=async()=>{this.checkConnector(),this._logger.Debug(`ButtplugClient: ReceiveDeviceList called`),(await this.sendMessage(new U)).Devices.forEach(e=>{if(this._devices.has(e.DeviceIndex))this._logger.Debug(`ButtplugClient: Device already added: ${e}`);else{let t=ke.fromMsg(e,this.sendDeviceMessageClosure);this._logger.Debug(`ButtplugClient: Adding Device: ${t}`),this._devices.set(e.DeviceIndex,t),this.emit(`deviceadded`,t)}})},this.shutdownConnection=async()=>{await this.stopAllDevices(),this._pingTimer!==null&&(clearInterval(this._pingTimer),this._pingTimer=null)},this.sendMsgExpectOk=async e=>{let t=await this.sendMessage(e);switch($(t)){case I:return;case R:throw X.FromError(t);default:throw X.LogAndError(Q,this._logger,`Message type ${$(t).constructor} not handled by SendMsgExpectOk`)}},this.sendDeviceMessageClosure=async(e,t)=>await this.sendDeviceMessage(e,t),this._clientName=e,this._logger.Debug(`ButtplugClient: Client ${e} created.`)}get connected(){return this._connector!==null&&this._connector.Connected}get devices(){this.checkConnector();let e=[];return this._devices.forEach(t=>{e.push(t)}),e}get isScanning(){return this._isScanning}async sendDeviceMessage(e,t){if(this.checkConnector(),this._devices.get(e.index)===void 0)throw X.LogAndError(Z,this._logger,`Device ${e.index} not available.`);return t.DeviceIndex=e.index,await this.sendMessage(t)}async sendMessage(e){this.checkConnector();let t=this._sorter.PrepareOutgoingMessage(e);return await this._connector.send(e),await t}checkConnector(){if(!this.connected)throw new je(`ButtplugClient not connected`)}},Ne=class extends i{constructor(e){super(),this._url=e,this._websocketConstructor=null,this.connect=async()=>{let e=new(this._websocketConstructor??WebSocket)(this._url),t,n,r=new Promise((e,r)=>{t=e,n=r}),i=()=>n();return e.addEventListener(`open`,async()=>{this._ws=e;try{await this.initialize(),this._ws.addEventListener(`message`,e=>{this.parseIncomingMessage(e)}),this._ws.removeEventListener(`close`,i),this._ws.addEventListener(`close`,this.disconnect),t()}catch(e){console.log(e),n()}}),e.addEventListener(`close`,i),r},this.disconnect=async()=>{this.Connected&&(this._ws.close(),this._ws=void 0,this.emit(`disconnect`))},this.initialize=async()=>Promise.resolve()}get Connected(){return this._ws!==void 0}sendMessage(e){if(!this.Connected)throw Error(`ButtplugBrowserWebsocketConnector not connected`);this._ws.send(`[`+e.toJSON()+`]`)}parseIncomingMessage(e){if(typeof e.data==`string`){let t=Oe(e.data);this.emit(`message`,t)}else e.data instanceof Blob}onReaderLoad(e){let t=Oe(e.target.result);this.emit(`message`,t)}},Pe=class extends Ne{constructor(){super(...arguments),this.send=e=>{if(!this.Connected)throw Error(`ButtplugClient not connected`);this.sendMessage(e)}}};export{Pe as ButtplugBrowserWebsocketClientConnector,Me as ButtplugClient};
//# sourceMappingURL=buttplug.js.map